/*! jQuery UI - v1.11.4 - 2015-09-09
* http://jqueryui.com
* Includes: core.js, widget.js, mouse.js, sortable.js
* Copyright 2015 jQuery Foundation and other contributors; Licensed MIT */

(function(e){"function"==typeof define&&define.amd?define(["jquery"],e):e(jQuery)})(function(e){function t(t,s){var n,a,o,r=t.nodeName.toLowerCase();return"area"===r?(n=t.parentNode,a=n.name,t.href&&a&&"map"===n.nodeName.toLowerCase()?(o=e("img[usemap='#"+a+"']")[0],!!o&&i(o)):!1):(/^(input|select|textarea|button|object)$/.test(r)?!t.disabled:"a"===r?t.href||s:s)&&i(t)}function i(t){return e.expr.filters.visible(t)&&!e(t).parents().addBack().filter(function(){return"hidden"===e.css(this,"visibility")}).length}e.ui=e.ui||{},e.extend(e.ui,{version:"1.11.4",keyCode:{BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38}}),e.fn.extend({scrollParent:function(t){var i=this.css("position"),s="absolute"===i,n=t?/(auto|scroll|hidden)/:/(auto|scroll)/,a=this.parents().filter(function(){var t=e(this);return s&&"static"===t.css("position")?!1:n.test(t.css("overflow")+t.css("overflow-y")+t.css("overflow-x"))}).eq(0);return"fixed"!==i&&a.length?a:e(this[0].ownerDocument||document)},uniqueId:function(){var e=0;return function(){return this.each(function(){this.id||(this.id="ui-id-"+ ++e)})}}(),removeUniqueId:function(){return this.each(function(){/^ui-id-\d+$/.test(this.id)&&e(this).removeAttr("id")})}}),e.extend(e.expr[":"],{data:e.expr.createPseudo?e.expr.createPseudo(function(t){return function(i){return!!e.data(i,t)}}):function(t,i,s){return!!e.data(t,s[3])},focusable:function(i){return t(i,!isNaN(e.attr(i,"tabindex")))},tabbable:function(i){var s=e.attr(i,"tabindex"),n=isNaN(s);return(n||s>=0)&&t(i,!n)}}),e("<a>").outerWidth(1).jquery||e.each(["Width","Height"],function(t,i){function s(t,i,s,a){return e.each(n,function(){i-=parseFloat(e.css(t,"padding"+this))||0,s&&(i-=parseFloat(e.css(t,"border"+this+"Width"))||0),a&&(i-=parseFloat(e.css(t,"margin"+this))||0)}),i}var n="Width"===i?["Left","Right"]:["Top","Bottom"],a=i.toLowerCase(),o={innerWidth:e.fn.innerWidth,innerHeight:e.fn.innerHeight,outerWidth:e.fn.outerWidth,outerHeight:e.fn.outerHeight};e.fn["inner"+i]=function(t){return void 0===t?o["inner"+i].call(this):this.each(function(){e(this).css(a,s(this,t)+"px")})},e.fn["outer"+i]=function(t,n){return"number"!=typeof t?o["outer"+i].call(this,t):this.each(function(){e(this).css(a,s(this,t,!0,n)+"px")})}}),e.fn.addBack||(e.fn.addBack=function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}),e("<a>").data("a-b","a").removeData("a-b").data("a-b")&&(e.fn.removeData=function(t){return function(i){return arguments.length?t.call(this,e.camelCase(i)):t.call(this)}}(e.fn.removeData)),e.ui.ie=!!/msie [\w.]+/.exec(navigator.userAgent.toLowerCase()),e.fn.extend({focus:function(t){return function(i,s){return"number"==typeof i?this.each(function(){var t=this;setTimeout(function(){e(t).focus(),s&&s.call(t)},i)}):t.apply(this,arguments)}}(e.fn.focus),disableSelection:function(){var e="onselectstart"in document.createElement("div")?"selectstart":"mousedown";return function(){return this.bind(e+".ui-disableSelection",function(e){e.preventDefault()})}}(),enableSelection:function(){return this.unbind(".ui-disableSelection")},zIndex:function(t){if(void 0!==t)return this.css("zIndex",t);if(this.length)for(var i,s,n=e(this[0]);n.length&&n[0]!==document;){if(i=n.css("position"),("absolute"===i||"relative"===i||"fixed"===i)&&(s=parseInt(n.css("zIndex"),10),!isNaN(s)&&0!==s))return s;n=n.parent()}return 0}}),e.ui.plugin={add:function(t,i,s){var n,a=e.ui[t].prototype;for(n in s)a.plugins[n]=a.plugins[n]||[],a.plugins[n].push([i,s[n]])},call:function(e,t,i,s){var n,a=e.plugins[t];if(a&&(s||e.element[0].parentNode&&11!==e.element[0].parentNode.nodeType))for(n=0;a.length>n;n++)e.options[a[n][0]]&&a[n][1].apply(e.element,i)}};var s=0,n=Array.prototype.slice;e.cleanData=function(t){return function(i){var s,n,a;for(a=0;null!=(n=i[a]);a++)try{s=e._data(n,"events"),s&&s.remove&&e(n).triggerHandler("remove")}catch(o){}t(i)}}(e.cleanData),e.widget=function(t,i,s){var n,a,o,r,h={},l=t.split(".")[0];return t=t.split(".")[1],n=l+"-"+t,s||(s=i,i=e.Widget),e.expr[":"][n.toLowerCase()]=function(t){return!!e.data(t,n)},e[l]=e[l]||{},a=e[l][t],o=e[l][t]=function(e,t){return this._createWidget?(arguments.length&&this._createWidget(e,t),void 0):new o(e,t)},e.extend(o,a,{version:s.version,_proto:e.extend({},s),_childConstructors:[]}),r=new i,r.options=e.widget.extend({},r.options),e.each(s,function(t,s){return e.isFunction(s)?(h[t]=function(){var e=function(){return i.prototype[t].apply(this,arguments)},n=function(e){return i.prototype[t].apply(this,e)};return function(){var t,i=this._super,a=this._superApply;return this._super=e,this._superApply=n,t=s.apply(this,arguments),this._super=i,this._superApply=a,t}}(),void 0):(h[t]=s,void 0)}),o.prototype=e.widget.extend(r,{widgetEventPrefix:a?r.widgetEventPrefix||t:t},h,{constructor:o,namespace:l,widgetName:t,widgetFullName:n}),a?(e.each(a._childConstructors,function(t,i){var s=i.prototype;e.widget(s.namespace+"."+s.widgetName,o,i._proto)}),delete a._childConstructors):i._childConstructors.push(o),e.widget.bridge(t,o),o},e.widget.extend=function(t){for(var i,s,a=n.call(arguments,1),o=0,r=a.length;r>o;o++)for(i in a[o])s=a[o][i],a[o].hasOwnProperty(i)&&void 0!==s&&(t[i]=e.isPlainObject(s)?e.isPlainObject(t[i])?e.widget.extend({},t[i],s):e.widget.extend({},s):s);return t},e.widget.bridge=function(t,i){var s=i.prototype.widgetFullName||t;e.fn[t]=function(a){var o="string"==typeof a,r=n.call(arguments,1),h=this;return o?this.each(function(){var i,n=e.data(this,s);return"instance"===a?(h=n,!1):n?e.isFunction(n[a])&&"_"!==a.charAt(0)?(i=n[a].apply(n,r),i!==n&&void 0!==i?(h=i&&i.jquery?h.pushStack(i.get()):i,!1):void 0):e.error("no such method '"+a+"' for "+t+" widget instance"):e.error("cannot call methods on "+t+" prior to initialization; "+"attempted to call method '"+a+"'")}):(r.length&&(a=e.widget.extend.apply(null,[a].concat(r))),this.each(function(){var t=e.data(this,s);t?(t.option(a||{}),t._init&&t._init()):e.data(this,s,new i(a,this))})),h}},e.Widget=function(){},e.Widget._childConstructors=[],e.Widget.prototype={widgetName:"widget",widgetEventPrefix:"",defaultElement:"<div>",options:{disabled:!1,create:null},_createWidget:function(t,i){i=e(i||this.defaultElement||this)[0],this.element=e(i),this.uuid=s++,this.eventNamespace="."+this.widgetName+this.uuid,this.bindings=e(),this.hoverable=e(),this.focusable=e(),i!==this&&(e.data(i,this.widgetFullName,this),this._on(!0,this.element,{remove:function(e){e.target===i&&this.destroy()}}),this.document=e(i.style?i.ownerDocument:i.document||i),this.window=e(this.document[0].defaultView||this.document[0].parentWindow)),this.options=e.widget.extend({},this.options,this._getCreateOptions(),t),this._create(),this._trigger("create",null,this._getCreateEventData()),this._init()},_getCreateOptions:e.noop,_getCreateEventData:e.noop,_create:e.noop,_init:e.noop,destroy:function(){this._destroy(),this.element.unbind(this.eventNamespace).removeData(this.widgetFullName).removeData(e.camelCase(this.widgetFullName)),this.widget().unbind(this.eventNamespace).removeAttr("aria-disabled").removeClass(this.widgetFullName+"-disabled "+"ui-state-disabled"),this.bindings.unbind(this.eventNamespace),this.hoverable.removeClass("ui-state-hover"),this.focusable.removeClass("ui-state-focus")},_destroy:e.noop,widget:function(){return this.element},option:function(t,i){var s,n,a,o=t;if(0===arguments.length)return e.widget.extend({},this.options);if("string"==typeof t)if(o={},s=t.split("."),t=s.shift(),s.length){for(n=o[t]=e.widget.extend({},this.options[t]),a=0;s.length-1>a;a++)n[s[a]]=n[s[a]]||{},n=n[s[a]];if(t=s.pop(),1===arguments.length)return void 0===n[t]?null:n[t];n[t]=i}else{if(1===arguments.length)return void 0===this.options[t]?null:this.options[t];o[t]=i}return this._setOptions(o),this},_setOptions:function(e){var t;for(t in e)this._setOption(t,e[t]);return this},_setOption:function(e,t){return this.options[e]=t,"disabled"===e&&(this.widget().toggleClass(this.widgetFullName+"-disabled",!!t),t&&(this.hoverable.removeClass("ui-state-hover"),this.focusable.removeClass("ui-state-focus"))),this},enable:function(){return this._setOptions({disabled:!1})},disable:function(){return this._setOptions({disabled:!0})},_on:function(t,i,s){var n,a=this;"boolean"!=typeof t&&(s=i,i=t,t=!1),s?(i=n=e(i),this.bindings=this.bindings.add(i)):(s=i,i=this.element,n=this.widget()),e.each(s,function(s,o){function r(){return t||a.options.disabled!==!0&&!e(this).hasClass("ui-state-disabled")?("string"==typeof o?a[o]:o).apply(a,arguments):void 0}"string"!=typeof o&&(r.guid=o.guid=o.guid||r.guid||e.guid++);var h=s.match(/^([\w:-]*)\s*(.*)$/),l=h[1]+a.eventNamespace,u=h[2];u?n.delegate(u,l,r):i.bind(l,r)})},_off:function(t,i){i=(i||"").split(" ").join(this.eventNamespace+" ")+this.eventNamespace,t.unbind(i).undelegate(i),this.bindings=e(this.bindings.not(t).get()),this.focusable=e(this.focusable.not(t).get()),this.hoverable=e(this.hoverable.not(t).get())},_delay:function(e,t){function i(){return("string"==typeof e?s[e]:e).apply(s,arguments)}var s=this;return setTimeout(i,t||0)},_hoverable:function(t){this.hoverable=this.hoverable.add(t),this._on(t,{mouseenter:function(t){e(t.currentTarget).addClass("ui-state-hover")},mouseleave:function(t){e(t.currentTarget).removeClass("ui-state-hover")}})},_focusable:function(t){this.focusable=this.focusable.add(t),this._on(t,{focusin:function(t){e(t.currentTarget).addClass("ui-state-focus")},focusout:function(t){e(t.currentTarget).removeClass("ui-state-focus")}})},_trigger:function(t,i,s){var n,a,o=this.options[t];if(s=s||{},i=e.Event(i),i.type=(t===this.widgetEventPrefix?t:this.widgetEventPrefix+t).toLowerCase(),i.target=this.element[0],a=i.originalEvent)for(n in a)n in i||(i[n]=a[n]);return this.element.trigger(i,s),!(e.isFunction(o)&&o.apply(this.element[0],[i].concat(s))===!1||i.isDefaultPrevented())}},e.each({show:"fadeIn",hide:"fadeOut"},function(t,i){e.Widget.prototype["_"+t]=function(s,n,a){"string"==typeof n&&(n={effect:n});var o,r=n?n===!0||"number"==typeof n?i:n.effect||i:t;n=n||{},"number"==typeof n&&(n={duration:n}),o=!e.isEmptyObject(n),n.complete=a,n.delay&&s.delay(n.delay),o&&e.effects&&e.effects.effect[r]?s[t](n):r!==t&&s[r]?s[r](n.duration,n.easing,a):s.queue(function(i){e(this)[t](),a&&a.call(s[0]),i()})}}),e.widget;var a=!1;e(document).mouseup(function(){a=!1}),e.widget("ui.mouse",{version:"1.11.4",options:{cancel:"input,textarea,button,select,option",distance:1,delay:0},_mouseInit:function(){var t=this;this.element.bind("mousedown."+this.widgetName,function(e){return t._mouseDown(e)}).bind("click."+this.widgetName,function(i){return!0===e.data(i.target,t.widgetName+".preventClickEvent")?(e.removeData(i.target,t.widgetName+".preventClickEvent"),i.stopImmediatePropagation(),!1):void 0}),this.started=!1},_mouseDestroy:function(){this.element.unbind("."+this.widgetName),this._mouseMoveDelegate&&this.document.unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate)},_mouseDown:function(t){if(!a){this._mouseMoved=!1,this._mouseStarted&&this._mouseUp(t),this._mouseDownEvent=t;var i=this,s=1===t.which,n="string"==typeof this.options.cancel&&t.target.nodeName?e(t.target).closest(this.options.cancel).length:!1;return s&&!n&&this._mouseCapture(t)?(this.mouseDelayMet=!this.options.delay,this.mouseDelayMet||(this._mouseDelayTimer=setTimeout(function(){i.mouseDelayMet=!0},this.options.delay)),this._mouseDistanceMet(t)&&this._mouseDelayMet(t)&&(this._mouseStarted=this._mouseStart(t)!==!1,!this._mouseStarted)?(t.preventDefault(),!0):(!0===e.data(t.target,this.widgetName+".preventClickEvent")&&e.removeData(t.target,this.widgetName+".preventClickEvent"),this._mouseMoveDelegate=function(e){return i._mouseMove(e)},this._mouseUpDelegate=function(e){return i._mouseUp(e)},this.document.bind("mousemove."+this.widgetName,this._mouseMoveDelegate).bind("mouseup."+this.widgetName,this._mouseUpDelegate),t.preventDefault(),a=!0,!0)):!0}},_mouseMove:function(t){if(this._mouseMoved){if(e.ui.ie&&(!document.documentMode||9>document.documentMode)&&!t.button)return this._mouseUp(t);if(!t.which)return this._mouseUp(t)}return(t.which||t.button)&&(this._mouseMoved=!0),this._mouseStarted?(this._mouseDrag(t),t.preventDefault()):(this._mouseDistanceMet(t)&&this._mouseDelayMet(t)&&(this._mouseStarted=this._mouseStart(this._mouseDownEvent,t)!==!1,this._mouseStarted?this._mouseDrag(t):this._mouseUp(t)),!this._mouseStarted)},_mouseUp:function(t){return this.document.unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate),this._mouseStarted&&(this._mouseStarted=!1,t.target===this._mouseDownEvent.target&&e.data(t.target,this.widgetName+".preventClickEvent",!0),this._mouseStop(t)),a=!1,!1},_mouseDistanceMet:function(e){return Math.max(Math.abs(this._mouseDownEvent.pageX-e.pageX),Math.abs(this._mouseDownEvent.pageY-e.pageY))>=this.options.distance},_mouseDelayMet:function(){return this.mouseDelayMet},_mouseStart:function(){},_mouseDrag:function(){},_mouseStop:function(){},_mouseCapture:function(){return!0}}),e.widget("ui.sortable",e.ui.mouse,{version:"1.11.4",widgetEventPrefix:"sort",ready:!1,options:{appendTo:"parent",axis:!1,connectWith:!1,containment:!1,cursor:"auto",cursorAt:!1,dropOnEmpty:!0,forcePlaceholderSize:!1,forceHelperSize:!1,grid:!1,handle:!1,helper:"original",items:"> *",opacity:!1,placeholder:!1,revert:!1,scroll:!0,scrollSensitivity:20,scrollSpeed:20,scope:"default",tolerance:"intersect",zIndex:1e3,activate:null,beforeStop:null,change:null,deactivate:null,out:null,over:null,receive:null,remove:null,sort:null,start:null,stop:null,update:null},_isOverAxis:function(e,t,i){return e>=t&&t+i>e},_isFloating:function(e){return/left|right/.test(e.css("float"))||/inline|table-cell/.test(e.css("display"))},_create:function(){this.containerCache={},this.element.addClass("ui-sortable"),this.refresh(),this.offset=this.element.offset(),this._mouseInit(),this._setHandleClassName(),this.ready=!0},_setOption:function(e,t){this._super(e,t),"handle"===e&&this._setHandleClassName()},_setHandleClassName:function(){this.element.find(".ui-sortable-handle").removeClass("ui-sortable-handle"),e.each(this.items,function(){(this.instance.options.handle?this.item.find(this.instance.options.handle):this.item).addClass("ui-sortable-handle")})},_destroy:function(){this.element.removeClass("ui-sortable ui-sortable-disabled").find(".ui-sortable-handle").removeClass("ui-sortable-handle"),this._mouseDestroy();for(var e=this.items.length-1;e>=0;e--)this.items[e].item.removeData(this.widgetName+"-item");return this},_mouseCapture:function(t,i){var s=null,n=!1,a=this;return this.reverting?!1:this.options.disabled||"static"===this.options.type?!1:(this._refreshItems(t),e(t.target).parents().each(function(){return e.data(this,a.widgetName+"-item")===a?(s=e(this),!1):void 0}),e.data(t.target,a.widgetName+"-item")===a&&(s=e(t.target)),s?!this.options.handle||i||(e(this.options.handle,s).find("*").addBack().each(function(){this===t.target&&(n=!0)}),n)?(this.currentItem=s,this._removeCurrentsFromItems(),!0):!1:!1)},_mouseStart:function(t,i,s){var n,a,o=this.options;if(this.currentContainer=this,this.refreshPositions(),this.helper=this._createHelper(t),this._cacheHelperProportions(),this._cacheMargins(),this.scrollParent=this.helper.scrollParent(),this.offset=this.currentItem.offset(),this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left},e.extend(this.offset,{click:{left:t.pageX-this.offset.left,top:t.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()}),this.helper.css("position","absolute"),this.cssPosition=this.helper.css("position"),this.originalPosition=this._generatePosition(t),this.originalPageX=t.pageX,this.originalPageY=t.pageY,o.cursorAt&&this._adjustOffsetFromHelper(o.cursorAt),this.domPosition={prev:this.currentItem.prev()[0],parent:this.currentItem.parent()[0]},this.helper[0]!==this.currentItem[0]&&this.currentItem.hide(),this._createPlaceholder(),o.containment&&this._setContainment(),o.cursor&&"auto"!==o.cursor&&(a=this.document.find("body"),this.storedCursor=a.css("cursor"),a.css("cursor",o.cursor),this.storedStylesheet=e("<style>*{ cursor: "+o.cursor+" !important; }</style>").appendTo(a)),o.opacity&&(this.helper.css("opacity")&&(this._storedOpacity=this.helper.css("opacity")),this.helper.css("opacity",o.opacity)),o.zIndex&&(this.helper.css("zIndex")&&(this._storedZIndex=this.helper.css("zIndex")),this.helper.css("zIndex",o.zIndex)),this.scrollParent[0]!==this.document[0]&&"HTML"!==this.scrollParent[0].tagName&&(this.overflowOffset=this.scrollParent.offset()),this._trigger("start",t,this._uiHash()),this._preserveHelperProportions||this._cacheHelperProportions(),!s)for(n=this.containers.length-1;n>=0;n--)this.containers[n]._trigger("activate",t,this._uiHash(this));return e.ui.ddmanager&&(e.ui.ddmanager.current=this),e.ui.ddmanager&&!o.dropBehaviour&&e.ui.ddmanager.prepareOffsets(this,t),this.dragging=!0,this.helper.addClass("ui-sortable-helper"),this._mouseDrag(t),!0},_mouseDrag:function(t){var i,s,n,a,o=this.options,r=!1;for(this.position=this._generatePosition(t),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs),this.options.scroll&&(this.scrollParent[0]!==this.document[0]&&"HTML"!==this.scrollParent[0].tagName?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-t.pageY<o.scrollSensitivity?this.scrollParent[0].scrollTop=r=this.scrollParent[0].scrollTop+o.scrollSpeed:t.pageY-this.overflowOffset.top<o.scrollSensitivity&&(this.scrollParent[0].scrollTop=r=this.scrollParent[0].scrollTop-o.scrollSpeed),this.overflowOffset.left+this.scrollParent[0].offsetWidth-t.pageX<o.scrollSensitivity?this.scrollParent[0].scrollLeft=r=this.scrollParent[0].scrollLeft+o.scrollSpeed:t.pageX-this.overflowOffset.left<o.scrollSensitivity&&(this.scrollParent[0].scrollLeft=r=this.scrollParent[0].scrollLeft-o.scrollSpeed)):(t.pageY-this.document.scrollTop()<o.scrollSensitivity?r=this.document.scrollTop(this.document.scrollTop()-o.scrollSpeed):this.window.height()-(t.pageY-this.document.scrollTop())<o.scrollSensitivity&&(r=this.document.scrollTop(this.document.scrollTop()+o.scrollSpeed)),t.pageX-this.document.scrollLeft()<o.scrollSensitivity?r=this.document.scrollLeft(this.document.scrollLeft()-o.scrollSpeed):this.window.width()-(t.pageX-this.document.scrollLeft())<o.scrollSensitivity&&(r=this.document.scrollLeft(this.document.scrollLeft()+o.scrollSpeed))),r!==!1&&e.ui.ddmanager&&!o.dropBehaviour&&e.ui.ddmanager.prepareOffsets(this,t)),this.positionAbs=this._convertPositionTo("absolute"),this.options.axis&&"y"===this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"===this.options.axis||(this.helper[0].style.top=this.position.top+"px"),i=this.items.length-1;i>=0;i--)if(s=this.items[i],n=s.item[0],a=this._intersectsWithPointer(s),a&&s.instance===this.currentContainer&&n!==this.currentItem[0]&&this.placeholder[1===a?"next":"prev"]()[0]!==n&&!e.contains(this.placeholder[0],n)&&("semi-dynamic"===this.options.type?!e.contains(this.element[0],n):!0)){if(this.direction=1===a?"down":"up","pointer"!==this.options.tolerance&&!this._intersectsWithSides(s))break;this._rearrange(t,s),this._trigger("change",t,this._uiHash());break}return this._contactContainers(t),e.ui.ddmanager&&e.ui.ddmanager.drag(this,t),this._trigger("sort",t,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(t,i){if(t){if(e.ui.ddmanager&&!this.options.dropBehaviour&&e.ui.ddmanager.drop(this,t),this.options.revert){var s=this,n=this.placeholder.offset(),a=this.options.axis,o={};a&&"x"!==a||(o.left=n.left-this.offset.parent.left-this.margins.left+(this.offsetParent[0]===this.document[0].body?0:this.offsetParent[0].scrollLeft)),a&&"y"!==a||(o.top=n.top-this.offset.parent.top-this.margins.top+(this.offsetParent[0]===this.document[0].body?0:this.offsetParent[0].scrollTop)),this.reverting=!0,e(this.helper).animate(o,parseInt(this.options.revert,10)||500,function(){s._clear(t)})}else this._clear(t,i);return!1}},cancel:function(){if(this.dragging){this._mouseUp({target:null}),"original"===this.options.helper?this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper"):this.currentItem.show();for(var t=this.containers.length-1;t>=0;t--)this.containers[t]._trigger("deactivate",null,this._uiHash(this)),this.containers[t].containerCache.over&&(this.containers[t]._trigger("out",null,this._uiHash(this)),this.containers[t].containerCache.over=0)}return this.placeholder&&(this.placeholder[0].parentNode&&this.placeholder[0].parentNode.removeChild(this.placeholder[0]),"original"!==this.options.helper&&this.helper&&this.helper[0].parentNode&&this.helper.remove(),e.extend(this,{helper:null,dragging:!1,reverting:!1,_noFinalSort:null}),this.domPosition.prev?e(this.domPosition.prev).after(this.currentItem):e(this.domPosition.parent).prepend(this.currentItem)),this},serialize:function(t){var i=this._getItemsAsjQuery(t&&t.connected),s=[];return t=t||{},e(i).each(function(){var i=(e(t.item||this).attr(t.attribute||"id")||"").match(t.expression||/(.+)[\-=_](.+)/);i&&s.push((t.key||i[1]+"[]")+"="+(t.key&&t.expression?i[1]:i[2]))}),!s.length&&t.key&&s.push(t.key+"="),s.join("&")},toArray:function(t){var i=this._getItemsAsjQuery(t&&t.connected),s=[];return t=t||{},i.each(function(){s.push(e(t.item||this).attr(t.attribute||"id")||"")}),s},_intersectsWith:function(e){var t=this.positionAbs.left,i=t+this.helperProportions.width,s=this.positionAbs.top,n=s+this.helperProportions.height,a=e.left,o=a+e.width,r=e.top,h=r+e.height,l=this.offset.click.top,u=this.offset.click.left,d="x"===this.options.axis||s+l>r&&h>s+l,c="y"===this.options.axis||t+u>a&&o>t+u,p=d&&c;return"pointer"===this.options.tolerance||this.options.forcePointerForContainers||"pointer"!==this.options.tolerance&&this.helperProportions[this.floating?"width":"height"]>e[this.floating?"width":"height"]?p:t+this.helperProportions.width/2>a&&o>i-this.helperProportions.width/2&&s+this.helperProportions.height/2>r&&h>n-this.helperProportions.height/2},_intersectsWithPointer:function(e){var t="x"===this.options.axis||this._isOverAxis(this.positionAbs.top+this.offset.click.top,e.top,e.height),i="y"===this.options.axis||this._isOverAxis(this.positionAbs.left+this.offset.click.left,e.left,e.width),s=t&&i,n=this._getDragVerticalDirection(),a=this._getDragHorizontalDirection();return s?this.floating?a&&"right"===a||"down"===n?2:1:n&&("down"===n?2:1):!1},_intersectsWithSides:function(e){var t=this._isOverAxis(this.positionAbs.top+this.offset.click.top,e.top+e.height/2,e.height),i=this._isOverAxis(this.positionAbs.left+this.offset.click.left,e.left+e.width/2,e.width),s=this._getDragVerticalDirection(),n=this._getDragHorizontalDirection();return this.floating&&n?"right"===n&&i||"left"===n&&!i:s&&("down"===s&&t||"up"===s&&!t)},_getDragVerticalDirection:function(){var e=this.positionAbs.top-this.lastPositionAbs.top;return 0!==e&&(e>0?"down":"up")},_getDragHorizontalDirection:function(){var e=this.positionAbs.left-this.lastPositionAbs.left;return 0!==e&&(e>0?"right":"left")},refresh:function(e){return this._refreshItems(e),this._setHandleClassName(),this.refreshPositions(),this},_connectWith:function(){var e=this.options;return e.connectWith.constructor===String?[e.connectWith]:e.connectWith},_getItemsAsjQuery:function(t){function i(){r.push(this)}var s,n,a,o,r=[],h=[],l=this._connectWith();if(l&&t)for(s=l.length-1;s>=0;s--)for(a=e(l[s],this.document[0]),n=a.length-1;n>=0;n--)o=e.data(a[n],this.widgetFullName),o&&o!==this&&!o.options.disabled&&h.push([e.isFunction(o.options.items)?o.options.items.call(o.element):e(o.options.items,o.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),o]);for(h.push([e.isFunction(this.options.items)?this.options.items.call(this.element,null,{options:this.options,item:this.currentItem}):e(this.options.items,this.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),this]),s=h.length-1;s>=0;s--)h[s][0].each(i);return e(r)},_removeCurrentsFromItems:function(){var t=this.currentItem.find(":data("+this.widgetName+"-item)");this.items=e.grep(this.items,function(e){for(var i=0;t.length>i;i++)if(t[i]===e.item[0])return!1;return!0})},_refreshItems:function(t){this.items=[],this.containers=[this];var i,s,n,a,o,r,h,l,u=this.items,d=[[e.isFunction(this.options.items)?this.options.items.call(this.element[0],t,{item:this.currentItem}):e(this.options.items,this.element),this]],c=this._connectWith();if(c&&this.ready)for(i=c.length-1;i>=0;i--)for(n=e(c[i],this.document[0]),s=n.length-1;s>=0;s--)a=e.data(n[s],this.widgetFullName),a&&a!==this&&!a.options.disabled&&(d.push([e.isFunction(a.options.items)?a.options.items.call(a.element[0],t,{item:this.currentItem}):e(a.options.items,a.element),a]),this.containers.push(a));for(i=d.length-1;i>=0;i--)for(o=d[i][1],r=d[i][0],s=0,l=r.length;l>s;s++)h=e(r[s]),h.data(this.widgetName+"-item",o),u.push({item:h,instance:o,width:0,height:0,left:0,top:0})},refreshPositions:function(t){this.floating=this.items.length?"x"===this.options.axis||this._isFloating(this.items[0].item):!1,this.offsetParent&&this.helper&&(this.offset.parent=this._getParentOffset());var i,s,n,a;for(i=this.items.length-1;i>=0;i--)s=this.items[i],s.instance!==this.currentContainer&&this.currentContainer&&s.item[0]!==this.currentItem[0]||(n=this.options.toleranceElement?e(this.options.toleranceElement,s.item):s.item,t||(s.width=n.outerWidth(),s.height=n.outerHeight()),a=n.offset(),s.left=a.left,s.top=a.top);if(this.options.custom&&this.options.custom.refreshContainers)this.options.custom.refreshContainers.call(this);else for(i=this.containers.length-1;i>=0;i--)a=this.containers[i].element.offset(),this.containers[i].containerCache.left=a.left,this.containers[i].containerCache.top=a.top,this.containers[i].containerCache.width=this.containers[i].element.outerWidth(),this.containers[i].containerCache.height=this.containers[i].element.outerHeight();return this},_createPlaceholder:function(t){t=t||this;var i,s=t.options;s.placeholder&&s.placeholder.constructor!==String||(i=s.placeholder,s.placeholder={element:function(){var s=t.currentItem[0].nodeName.toLowerCase(),n=e("<"+s+">",t.document[0]).addClass(i||t.currentItem[0].className+" ui-sortable-placeholder").removeClass("ui-sortable-helper");return"tbody"===s?t._createTrPlaceholder(t.currentItem.find("tr").eq(0),e("<tr>",t.document[0]).appendTo(n)):"tr"===s?t._createTrPlaceholder(t.currentItem,n):"img"===s&&n.attr("src",t.currentItem.attr("src")),i||n.css("visibility","hidden"),n},update:function(e,n){(!i||s.forcePlaceholderSize)&&(n.height()||n.height(t.currentItem.innerHeight()-parseInt(t.currentItem.css("paddingTop")||0,10)-parseInt(t.currentItem.css("paddingBottom")||0,10)),n.width()||n.width(t.currentItem.innerWidth()-parseInt(t.currentItem.css("paddingLeft")||0,10)-parseInt(t.currentItem.css("paddingRight")||0,10)))}}),t.placeholder=e(s.placeholder.element.call(t.element,t.currentItem)),t.currentItem.after(t.placeholder),s.placeholder.update(t,t.placeholder)},_createTrPlaceholder:function(t,i){var s=this;t.children().each(function(){e("<td>&#160;</td>",s.document[0]).attr("colspan",e(this).attr("colspan")||1).appendTo(i)})},_contactContainers:function(t){var i,s,n,a,o,r,h,l,u,d,c=null,p=null;for(i=this.containers.length-1;i>=0;i--)if(!e.contains(this.currentItem[0],this.containers[i].element[0]))if(this._intersectsWith(this.containers[i].containerCache)){if(c&&e.contains(this.containers[i].element[0],c.element[0]))continue;c=this.containers[i],p=i}else this.containers[i].containerCache.over&&(this.containers[i]._trigger("out",t,this._uiHash(this)),this.containers[i].containerCache.over=0);if(c)if(1===this.containers.length)this.containers[p].containerCache.over||(this.containers[p]._trigger("over",t,this._uiHash(this)),this.containers[p].containerCache.over=1);else{for(n=1e4,a=null,u=c.floating||this._isFloating(this.currentItem),o=u?"left":"top",r=u?"width":"height",d=u?"clientX":"clientY",s=this.items.length-1;s>=0;s--)e.contains(this.containers[p].element[0],this.items[s].item[0])&&this.items[s].item[0]!==this.currentItem[0]&&(h=this.items[s].item.offset()[o],l=!1,t[d]-h>this.items[s][r]/2&&(l=!0),n>Math.abs(t[d]-h)&&(n=Math.abs(t[d]-h),a=this.items[s],this.direction=l?"up":"down"));if(!a&&!this.options.dropOnEmpty)return;if(this.currentContainer===this.containers[p])return this.currentContainer.containerCache.over||(this.containers[p]._trigger("over",t,this._uiHash()),this.currentContainer.containerCache.over=1),void 0;a?this._rearrange(t,a,null,!0):this._rearrange(t,null,this.containers[p].element,!0),this._trigger("change",t,this._uiHash()),this.containers[p]._trigger("change",t,this._uiHash(this)),this.currentContainer=this.containers[p],this.options.placeholder.update(this.currentContainer,this.placeholder),this.containers[p]._trigger("over",t,this._uiHash(this)),this.containers[p].containerCache.over=1}},_createHelper:function(t){var i=this.options,s=e.isFunction(i.helper)?e(i.helper.apply(this.element[0],[t,this.currentItem])):"clone"===i.helper?this.currentItem.clone():this.currentItem;return s.parents("body").length||e("parent"!==i.appendTo?i.appendTo:this.currentItem[0].parentNode)[0].appendChild(s[0]),s[0]===this.currentItem[0]&&(this._storedCSS={width:this.currentItem[0].style.width,height:this.currentItem[0].style.height,position:this.currentItem.css("position"),top:this.currentItem.css("top"),left:this.currentItem.css("left")}),(!s[0].style.width||i.forceHelperSize)&&s.width(this.currentItem.width()),(!s[0].style.height||i.forceHelperSize)&&s.height(this.currentItem.height()),s},_adjustOffsetFromHelper:function(t){"string"==typeof t&&(t=t.split(" ")),e.isArray(t)&&(t={left:+t[0],top:+t[1]||0}),"left"in t&&(this.offset.click.left=t.left+this.margins.left),"right"in t&&(this.offset.click.left=this.helperProportions.width-t.right+this.margins.left),"top"in t&&(this.offset.click.top=t.top+this.margins.top),"bottom"in t&&(this.offset.click.top=this.helperProportions.height-t.bottom+this.margins.top)},_getParentOffset:function(){this.offsetParent=this.helper.offsetParent();var t=this.offsetParent.offset();return"absolute"===this.cssPosition&&this.scrollParent[0]!==this.document[0]&&e.contains(this.scrollParent[0],this.offsetParent[0])&&(t.left+=this.scrollParent.scrollLeft(),t.top+=this.scrollParent.scrollTop()),(this.offsetParent[0]===this.document[0].body||this.offsetParent[0].tagName&&"html"===this.offsetParent[0].tagName.toLowerCase()&&e.ui.ie)&&(t={top:0,left:0}),{top:t.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:t.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if("relative"===this.cssPosition){var e=this.currentItem.position();return{top:e.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:e.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}return{top:0,left:0}},_cacheMargins:function(){this.margins={left:parseInt(this.currentItem.css("marginLeft"),10)||0,top:parseInt(this.currentItem.css("marginTop"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var t,i,s,n=this.options;"parent"===n.containment&&(n.containment=this.helper[0].parentNode),("document"===n.containment||"window"===n.containment)&&(this.containment=[0-this.offset.relative.left-this.offset.parent.left,0-this.offset.relative.top-this.offset.parent.top,"document"===n.containment?this.document.width():this.window.width()-this.helperProportions.width-this.margins.left,("document"===n.containment?this.document.width():this.window.height()||this.document[0].body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]),/^(document|window|parent)$/.test(n.containment)||(t=e(n.containment)[0],i=e(n.containment).offset(),s="hidden"!==e(t).css("overflow"),this.containment=[i.left+(parseInt(e(t).css("borderLeftWidth"),10)||0)+(parseInt(e(t).css("paddingLeft"),10)||0)-this.margins.left,i.top+(parseInt(e(t).css("borderTopWidth"),10)||0)+(parseInt(e(t).css("paddingTop"),10)||0)-this.margins.top,i.left+(s?Math.max(t.scrollWidth,t.offsetWidth):t.offsetWidth)-(parseInt(e(t).css("borderLeftWidth"),10)||0)-(parseInt(e(t).css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left,i.top+(s?Math.max(t.scrollHeight,t.offsetHeight):t.offsetHeight)-(parseInt(e(t).css("borderTopWidth"),10)||0)-(parseInt(e(t).css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top])
},_convertPositionTo:function(t,i){i||(i=this.position);var s="absolute"===t?1:-1,n="absolute"!==this.cssPosition||this.scrollParent[0]!==this.document[0]&&e.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,a=/(html|body)/i.test(n[0].tagName);return{top:i.top+this.offset.relative.top*s+this.offset.parent.top*s-("fixed"===this.cssPosition?-this.scrollParent.scrollTop():a?0:n.scrollTop())*s,left:i.left+this.offset.relative.left*s+this.offset.parent.left*s-("fixed"===this.cssPosition?-this.scrollParent.scrollLeft():a?0:n.scrollLeft())*s}},_generatePosition:function(t){var i,s,n=this.options,a=t.pageX,o=t.pageY,r="absolute"!==this.cssPosition||this.scrollParent[0]!==this.document[0]&&e.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,h=/(html|body)/i.test(r[0].tagName);return"relative"!==this.cssPosition||this.scrollParent[0]!==this.document[0]&&this.scrollParent[0]!==this.offsetParent[0]||(this.offset.relative=this._getRelativeOffset()),this.originalPosition&&(this.containment&&(t.pageX-this.offset.click.left<this.containment[0]&&(a=this.containment[0]+this.offset.click.left),t.pageY-this.offset.click.top<this.containment[1]&&(o=this.containment[1]+this.offset.click.top),t.pageX-this.offset.click.left>this.containment[2]&&(a=this.containment[2]+this.offset.click.left),t.pageY-this.offset.click.top>this.containment[3]&&(o=this.containment[3]+this.offset.click.top)),n.grid&&(i=this.originalPageY+Math.round((o-this.originalPageY)/n.grid[1])*n.grid[1],o=this.containment?i-this.offset.click.top>=this.containment[1]&&i-this.offset.click.top<=this.containment[3]?i:i-this.offset.click.top>=this.containment[1]?i-n.grid[1]:i+n.grid[1]:i,s=this.originalPageX+Math.round((a-this.originalPageX)/n.grid[0])*n.grid[0],a=this.containment?s-this.offset.click.left>=this.containment[0]&&s-this.offset.click.left<=this.containment[2]?s:s-this.offset.click.left>=this.containment[0]?s-n.grid[0]:s+n.grid[0]:s)),{top:o-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+("fixed"===this.cssPosition?-this.scrollParent.scrollTop():h?0:r.scrollTop()),left:a-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+("fixed"===this.cssPosition?-this.scrollParent.scrollLeft():h?0:r.scrollLeft())}},_rearrange:function(e,t,i,s){i?i[0].appendChild(this.placeholder[0]):t.item[0].parentNode.insertBefore(this.placeholder[0],"down"===this.direction?t.item[0]:t.item[0].nextSibling),this.counter=this.counter?++this.counter:1;var n=this.counter;this._delay(function(){n===this.counter&&this.refreshPositions(!s)})},_clear:function(e,t){function i(e,t,i){return function(s){i._trigger(e,s,t._uiHash(t))}}this.reverting=!1;var s,n=[];if(!this._noFinalSort&&this.currentItem.parent().length&&this.placeholder.before(this.currentItem),this._noFinalSort=null,this.helper[0]===this.currentItem[0]){for(s in this._storedCSS)("auto"===this._storedCSS[s]||"static"===this._storedCSS[s])&&(this._storedCSS[s]="");this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper")}else this.currentItem.show();for(this.fromOutside&&!t&&n.push(function(e){this._trigger("receive",e,this._uiHash(this.fromOutside))}),!this.fromOutside&&this.domPosition.prev===this.currentItem.prev().not(".ui-sortable-helper")[0]&&this.domPosition.parent===this.currentItem.parent()[0]||t||n.push(function(e){this._trigger("update",e,this._uiHash())}),this!==this.currentContainer&&(t||(n.push(function(e){this._trigger("remove",e,this._uiHash())}),n.push(function(e){return function(t){e._trigger("receive",t,this._uiHash(this))}}.call(this,this.currentContainer)),n.push(function(e){return function(t){e._trigger("update",t,this._uiHash(this))}}.call(this,this.currentContainer)))),s=this.containers.length-1;s>=0;s--)t||n.push(i("deactivate",this,this.containers[s])),this.containers[s].containerCache.over&&(n.push(i("out",this,this.containers[s])),this.containers[s].containerCache.over=0);if(this.storedCursor&&(this.document.find("body").css("cursor",this.storedCursor),this.storedStylesheet.remove()),this._storedOpacity&&this.helper.css("opacity",this._storedOpacity),this._storedZIndex&&this.helper.css("zIndex","auto"===this._storedZIndex?"":this._storedZIndex),this.dragging=!1,t||this._trigger("beforeStop",e,this._uiHash()),this.placeholder[0].parentNode.removeChild(this.placeholder[0]),this.cancelHelperRemoval||(this.helper[0]!==this.currentItem[0]&&this.helper.remove(),this.helper=null),!t){for(s=0;n.length>s;s++)n[s].call(this,e);this._trigger("stop",e,this._uiHash())}return this.fromOutside=!1,!this.cancelHelperRemoval},_trigger:function(){e.Widget.prototype._trigger.apply(this,arguments)===!1&&this.cancel()},_uiHash:function(t){var i=t||this;return{helper:i.helper,placeholder:i.placeholder||e([]),position:i.position,originalPosition:i.originalPosition,offset:i.positionAbs,item:i.currentItem,sender:t?t.element:null}}})});

//##################################################################################################################
// #CHANGELIST#
/* global CMS, tree_component */

(function ($) {
    'use strict';
    // CMS.$ will be passed for $
    $(document).ready(function () {

        /*!
         * TreeManager
         * Handles treeview
         * TODO this will be refactored in 3.2
         */
        CMS.TreeManager = new CMS.Class({

            options: {
                'lang': {}
            },

            initialize: function (options) {
                this.options = $.extend(true, {}, this.options, options);

                // load internal functions
                if (!this.options.settings.filtered) {
                    this.setupFunctions();
                    this.setupTreePublishing();
                    this.setupUIHacks();
                    this.setupGlobals();
                    this.setupTree();

                    // init tree component
                    window.initTree();
                } else {
                    // when filtered is active, prevent tree actions
                    this.setupFunctions();
                    this.setupUIHacks();
                    $.syncCols();
                }
            },

            setupFunctions: function () {
                var that = this;

                $.syncCols = function () {
                    $('#sitemap .col-softroot').syncWidth(0);
                    $('#sitemap .col-apphook').syncWidth(0);
                    $('#sitemap .col-language').syncWidth(0);
                    $('#sitemap .col-navigation').syncWidth(0);
                    $('#sitemap .col-actions').syncWidth(0);
                    $('#sitemap .col-info').syncWidth(0);

                    that.refreshColumns.call($('ul.tree-default li'));
                };

                /* Colums width sync */
                $.fn.syncWidth = function (max) {
                    var visible = false;

                    $(this).each(function () {
                        if ($(this).is(':visible')) {
                            visible = true;
                            var val = $(this).width();
                            if (val > max) {
                                max = val;
                            }
                        }
                    });
                    if (visible && max > 0) {
                        $(this).each(function () {
                            $(this).css('width', max);
                        });
                    }
                };

                // jquery.functional
                $.curry = function (fn) {
                    if (arguments.length < 2) {
                        return fn;
                    }
                    var args = $.makeArray(arguments).slice(1, arguments.length);
                    return function () {
                        return fn.apply(this, args.concat($.makeArray(arguments)));
                    };
                };

                $.__callbackPool = {};

                $.callbackRegister = function (name, fn /*, arg0, arg1, ..*/) {
                    if (arguments.length > 2) {
                        // create curried function
                        fn = $.curry.apply(this, $.makeArray(arguments).slice(1, arguments.length));
                    }
                    $.__callbackPool[name] = fn;
                    return name;
                };

                $.callbackCall = function (name/*, extra arg0, extra arg1, ..*/) {
                    if (!name || !(name in $.__callbackPool)) {
                        throw 'No callback registered with name: ' + name;
                    }
                    $.__callbackPool[name].apply(this, $.makeArray(arguments).slice(1, arguments.length));
                    $.callbackRemove(name);
                    return name;
                };

                $.callbackRemove = function (name) {
                    delete $.__callbackPool[name];
                };

                // very simple yellow fade plugin..
                $.fn.yft = function () {
                    this.effect('highlight', {}, 1000);
                };

                // jquery replace plugin :)
                $.fn.replace = function (o) {
                    return this.after(o).remove().end();
                };

            },

            setupTreePublishing: function () {
                // ADD DIRECT PUBLISHING
                var that = this;
                var tree = $('.tree');
                var langTrigger = '.col-language .trigger-tooltip span';
                var langTooltips = '.language-tooltip';
                var langTimer = function () {};
                var langDelay = 100;
                var langFadeDuration = 200;
                // workaround for the publishing tooltip on touch devices
                var touchUsedNode;

                // show the tooltip
                tree.delegate(langTrigger, 'pointerover touchstart', function (e) {
                    var el = $(this).closest('.col-language').find('.language-tooltip');
                    var anchors = el.find('a');
                    var span = $(this);

                    // clear timer
                    clearTimeout(langTimer);

                    // cancel if tooltip already visible
                    if (el.is(':visible') && !touchUsedNode) {
                        return false;
                    }

                    // set correct position
                    el.css('right', 20 + $(this).position().left);

                    // figure out what should be shown
                    anchors.hide();
                    if (span.hasClass('unpublished') || span.hasClass('unpublishedparent')) {
                        anchors.eq(1).show();
                    }
                    if (span.hasClass('published')) {
                        anchors.eq(0).show();
                    }
                    if (span.hasClass('dirty')) {
                        anchors.show().parent().addClass('language-tooltip-multiple');
                    }

                    // hide all elements
                    $(langTooltips).fadeOut(langDelay);

                    if (e.type === 'touchstart') {
                        e.preventDefault();
                        touchUsedNode = touchUsedNode === e.target ? false : e.target;
                        if (touchUsedNode) {
                            return;
                        }
                    }

                    // use a timeout to display the tooltip
                    langTimer = setTimeout(function () {
                        el.stop(true, true).fadeIn(langFadeDuration);
                    }, langDelay);
                });
                // hide the tooltip when leaving the area
                tree.delegate(langTrigger, 'pointerout', function () {
                    if (touchUsedNode) {
                        return;
                    }
                    // clear timer
                    clearTimeout(langTimer);
                    // hide all elements
                    langTimer = setTimeout(function () {
                        $(langTooltips).fadeOut(langFadeDuration);
                    }, langDelay * 2);
                });
                // reset hiding when entering the tooltip itself
                tree.delegate(langTooltips, 'pointerover', function () {
                    // clear timer
                    clearTimeout(langTimer);
                });
                tree.delegate(langTooltips, 'pointerout', function () {
                    // hide all elements
                    langTimer = setTimeout(function () {
                        $(langTooltips).fadeOut(langFadeDuration);
                    }, langDelay * 2);
                });
                // attach double check event if publish or unpublish should be triggered
                tree.delegate('.language-tooltip a', 'click', function (e) {
                    e.preventDefault();

                    // cancel if not confirmed
                    if (!confirm(that.options.lang.publish.replace('§', $(this).text().toLowerCase()))) {
                        return false;
                    }

                    // send post request to prevent xss attacks
                    $.ajax({
                        type: 'post',
                        url: $(this).prop('href'),
                        success: function () {
                            CMS.API.Helpers.reloadBrowser();
                        },
                        error: function (request) {
                            throw new Error(request);
                        }
                    });
                });
            },

            setupUIHacks: function () {
                // enables tab click on title entry to open in new window
                $('.tree').on('click', '.col1 .title', function (e) {
                    if (!e.metaKey) {
                        window.top.location.href = $(this).attr('href');
                    } else {
                        window.open($(this).attr('href'), '_blank');
                    }
                });

                // adds functionality to the filter
                $('#changelist-filter-button').bind('click', function () {
                    $('#changelist-filter').toggle();
                });

                // set correct active entry
                if (window.parent && window.parent.CMS && window.parent.CMS.config) {
                    var page_id = window.parent.CMS.config.request.page_id;

                    $('div[data-page_id="' + page_id + '"]').addClass('cont-active');
                }
            },

            setupGlobals: function () {
                var that = this;
                var msg = '';
                var parent = null;

                window.moveSuccess = function (node) {
                    $.syncCols();

                    msg = $('<span class="success">' + that.options.lang.success + '</span>');
                    parent = window.parent;

                    node.after(msg);
                    node.parent().find('.col2').hide();
                    msg.fadeOut(1000, function () {
                        node.parent().find('.col2').show();
                    });
                    // check for reload changes
                    if (window.self !== window.top) {
                        window.parent.CMS.API.Helpers.reloadBrowser(false, false, true);
                        window.parent.CMS.API.Toolbar.openMessage(that.options.lang.changes, false, 0);
                    }
                };

                window.moveError = function (node, message) {
                    if (message && message !== 'error') {
                        msg = $('<span class="success">' + message + '</span>');
                    } else {
                        msg = $('<span class="success">' + that.options.lang.error + '</span>');
                    }
                    node.parent().find('.col2').hide();
                    node.after(msg);
                };

            },

            setupTree: function () {
                var that = this;
                var tree;
                var origin = window.location.protocol + '//' + window.location.hostname +
                    (window.location.port ? ':' + window.location.port : '');
                // global initTree function
                window.initTree = function () {
                    // jshint newcap: false
                    // jscs:disable requireCapitalizedConstructors
                    tree = new tree_component();
                    // jscs:enable requireCapitalizedConstructors
                    // jshint newcap: true
                    var options = {
                        rules: {
                            clickable: 'all',
                            renameable: 'none',
                            deletable: 'all',
                            creatable: 'all',
                            draggable: 'all',
                            dragrules: 'all',
                            droppable: 'all',
                            metadata : 'mdata',
                            use_inline: true
                            //droppable : ['tree_drop']
                        },
                        // has to be absolute full path
                        path: origin + that.options.settings.staticPath + 'cms/js/jstree/',
                        ui: {
                            dots: true,
                            rtl: false,
                            animation: 0,
                            hover_mode: true,
                            //theme_path: script_url_path() + '/../jstree/themes/',
                            a_class: 'title',
                            context: false
                        },
                        cookies : {
                            prefix: 'djangocms_nodes'
                        },
                        callback: {
                            beforemove  : function (what, where, position) {
                                window.item_id = what.id.split('page_')[1];
                                window.target_id = where.id.split('page_')[1];
                                window.old_node = what;

                                if ($(what).parent().children('li').length > 1) {
                                    if ($(what).next('li').length) {
                                        window.old_target = $(what).next('li')[0];
                                        window.old_position = 'right';
                                    }
                                    if ($(what).prev('li').length) {
                                        window.old_target = $(what).prev('li')[0];
                                        window.old_position = 'left';
                                    }
                                } else {
                                    if ($(what).attr('rel') !== 'topnode') {
                                        window.old_target = $(what).parent().parent()[0];
                                        window.old_position = 'inside';
                                    }
                                }

                                addUndo(what, where, position);
                                return true;
                            },
                            onmove: function (what, where, position) {
                                window.item_id = what.id.split('page_')[1];
                                window.target_id = where.id.split('page_')[1];

                                if (position === 'before') {
                                    position = 'left';
                                } else if (position === 'after') {
                                    position = 'right';
                                } else if (position === 'inside') {
                                    position = 'last-child';
                                }
                                moveTreeItem(what, window.item_id, window.target_id, position, false);
                            },

                            onload: function () {
                                setTimeout(function () {
                                    reCalc();
                                }, 250);
                            }

                        }
                    };

                    if (!$($('div.tree').get(0)).hasClass('root_allow_children')) {
                        // disalow possibility for adding subnodes to main tree, user doesn't
                        // have permissions for this
                        options.rules.dragrules = ['node inside topnode', 'topnode inside topnode', 'node * node'];
                    }

                    tree.init($('div.tree'), options);
                };

                window.selected_page = false;
                action = false;

                var _oldAjax = $.ajax;

                $.ajax = function (s) {
                    // just override ajax function, so the loader message gets displayed
                    // always
                    $('#loader-message').show();

                    var callback = s.success || false;
                    s.success = function (data, status) {
                        if (callback) {
                            callback(data, status);
                        }
                        $('#loader-message').hide();
                    };

                    // just for debuging!!
                    /*s.complete = function (xhr, status) {
                        if (status == 'error' && that.options.settings.debug) {
                            $('body').before(xhr.responseText);
                        }
                    }*/
                    // end just for debuging

                    // TODO: add error state!
                    return _oldAjax(s);
                };

                // // defined but never used
                // function refresh() {
                //     window.location = window.location.href;
                // }

                // // defined but never used
                // function refreshIfChildren(pageId) {
                //     return $('#page_' + pageId).find('li[id^=page_]').length ?
                //     refresh :
                //     function () { return true; };
                // }

                /**
                 * Loads remote dialog to dialogs div.
                 *
                 * @param {String} url
                 * @param {Object} data Data to be send over post
                 * @param {Function} noDialogCallback Gets called when response is empty.
                 * @param {Function} callback Standard callback function.
                 */
                function loadDialog(url, data, noDialogCallback, callback) {
                    if (data === undefined) {
                        data = {};
                    }
                    $.post(url, data, function (response) {
                        if (response === '' && noDialogCallback) {
                            noDialogCallback();
                        }
                        $('#dialogs').empty().append(response);
                        if (callback) {
                            callback(response);
                        }
                    });
                }

                function mark_copy_node(id) {
                    $('a.move-target, span.move-target-container, span.line').show();
                    $('#page_' + id).addClass('selected');
                    $('#page_' + id).parent().parent()
                        .children('div.cont').find('a.move-target.first-child, span.second').hide();
                    $('#page_' + id).parent().parent()
                        .children('ul').children('li').children('div.cont')
                        .find('a.move-target.left, a.move-target.right, span.first, span.second').hide();
                    return 'copy';
                }


                // let's start event delegation
                $('#changelist li').on('click', function (e) {
                    // I want a link to check the class
                    if (e.target.tagName === 'IMG' || e.target.tagName === 'SPAN') {
                        window.target = e.target.parentNode;
                    } else {
                        window.target = e.target;
                    }
                    var jtarget = $(window.target);
                    var id;
                    var page_id;
                    if (jtarget.hasClass('move')) {
                        // prepare tree for move / cut paste
                        id = e.target.id.split('move-link-')[1];
                        if (!id) {
                            id = e.target.parentNode.id.split('move-link-')[1];
                        }
                        page_id = id;
                        window.selected_page = page_id;
                        action = 'move';
                        $('span.move-target-container, span.line, a.move-target').show();
                        $('#page_' + page_id).addClass('selected');
                        $('#page_' + page_id + ' span.move-target-container').hide();
                        e.stopPropagation();
                        return false;
                    }

                    if (jtarget.hasClass('copy')) {
                        // prepare tree for copy
                        id = e.target.id.split('copy-link-')[1];
                        if (!id) {
                            id = e.target.parentNode.id.split('copy-link-')[1];
                        }
                        window.selected_page = id;
                        action = mark_copy_node(id);
                        e.stopPropagation();
                        return false;
                    }

                    if (jtarget.hasClass('viewpage')) {
                        var view_page_url = $('#' + window.target.id + '-select').val();
                        if (view_page_url) {
                            window.open(view_page_url);
                        }
                    }

                    if (jtarget.hasClass('addlink')) {
                        if (!/#$/g.test(jtarget.attr('href'))) {
                            // if there is url instead of # inside href, follow this url
                            // used if user haves add_page
                            return true;
                        }

                        $('tr').removeClass('target');
                        $('#changelist table').removeClass('table-selected');
                        page_id = window.target.id.split('add-link-')[1];
                        window.selected_page = page_id;
                        action = 'add';
                        $('tr').removeClass('selected');
                        $('#page-row-' + page_id).addClass('selected');
                        $('.move-target-container').hide();
                        $('a.move-target, span.line, #move-target-' + page_id).show();
                        e.stopPropagation();
                        return false;
                    }

                    // don't assume admin site is root-level
                    // grab base url to construct full absolute URLs
                    window.admin_base_url = document.URL.split('/cms/page/')[0] + '/';

                    var pageId;
                    var language;
                    // in navigation
                    if (jtarget.hasClass('navigation-checkbox')) {
                        e.stopPropagation();

                        pageId = jtarget.attr('name').split('navigation-')[1];
                        language = jtarget.closest('.cont').find('a[lang]').attr('lang') || '';

                        // if I don't put data in the post, django doesn't get it
                        reloadItem(
                            jtarget,
                            window.admin_base_url + 'cms/page/' + pageId + '/change-navigation/?language=' + language,
                            { 1: 1 }
                        );
                    }

                    // lazy load descendants on tree open
                    if (jtarget.hasClass('closed')) {
                        // only load them once
                        if (jtarget.find('ul > li').length === 0 && !jtarget.hasClass('loading')) {
                            // keeps this event from firing multiple times before
                            // the dom as changed. it still needs to propagate for
                            // the other click event on this element to fire
                            jtarget.addClass('loading');
                            pageId = $(jtarget).attr('id').split('page_')[1];
                            language = $(jtarget)
                                .children('div.cont')
                                .children('div.col1')
                                .children('.title').attr('lang');
                            $.get(
                                window.admin_base_url + 'cms/page/' + pageId + '/' + language + '/descendants/',
                                {},
                                function (r) {
                                    jtarget.children('ul').append(r);
                                    // show move targets if needed
                                    if ($('span.move-target-container:visible').length > 0) {
                                        jtarget.children('ul')
                                            .find('a.move-target, span.move-target-container, span.line')
                                            .show();
                                    }
                                    reCalc();
                                }
                            );
                        } else {
                            reCalc();
                        }
                    }

                    if (jtarget.hasClass('move-target')) {
                        if (jtarget.hasClass('left')) {
                            window.position = 'left';
                        }
                        if (jtarget.hasClass('right')) {
                            window.position = 'right';
                        }
                        if (jtarget.hasClass('last-child')) {
                            window.position = 'last-child';
                        }
                        window.target_id = window.target.parentNode.id.split('move-target-')[1];

                        if (action === 'move') {
                            moveTreeItem(null, window.selected_page, window.target_id, window.position, tree);
                            $('.move-target-container').hide();
                        } else if (action === 'copy') {
                            window.site = $('#site-select')[0].value;
                            copyTreeItem(window.selected_page, window.target_id, window.position, window.site);
                            $('.move-target-container').hide();
                        } else if (action === 'add') {
                            window.site = $('#site-select')[0].value;
                            window.location.href = window.location.href.split('?')[0].split('#')[0] +
                                'add/?target=' + window.target_id + '&amp;position=' + window.position +
                                '&amp;site=' + window.site;
                        }
                        e.stopPropagation();
                        return false;
                    }
                    return true;
                });
                $('div#sitemap').show();

                function reCalc() {
                    $.syncCols();
                }

                $(window).bind('resize', reCalc);
                /* Site Selector */
                $('#site-select').change(function () {
                    var form = $(this).closest('form');
                    // add correct value for copy
                    if (action === 'copy') {
                        $('#site-copy').val(window.selected_page);
                    }
                    // submit form
                    form.submit();
                });

                //
                // If an A element has a data-attribute 'alt-class'. At this time,
                // this is only the edit button in the page-tree, but could be
                // more in future. It is important that the CSS be written in such
                // a manner that the alt-class is defined after the normal class,
                // so that it can be overridden when the alt-key is depressed.
                //
                // NOTE: This 'preview' part of the 'alt-click to [alternative
                // function]' feature may not work in some environments (Windows
                // in a some virtual machine environments, notably), but is only a
                // nice-'extra', not a requirement for the feature.
                //
                $(document).on('keydown keyup', function (evt) {
                    if (evt.which === 18) {
                        $('a[data-alt-class]').each(function () {
                            var self = $(this);
                            self.toggleClass(self.data('alt-class'), evt.type === 'keydown');
                        });
                    }
                });

                //
                // If the A-element has a data-attribute 'alt-href', then this
                // click-handler uses that instead of the normal href attribute as
                // the click-destination. Again, currently this is only on the
                // edit button, but could be more in future.
                //
                $('a[data-alt-href]').on('click', function (evt) {
                    var href;
                    evt.preventDefault();
                    if (evt.shiftKey) {
                        href = $(this).data('alt-href');
                    } else {
                        href = $(this).attr('href');
                    }
                    window.location = href;
                });

                var copy_splits = window.location.href.split('copy=');
                if (copy_splits.length > 1) {
                    var id = copy_splits[1].split('&')[0];
                    // jshint latedef: false
                    var action = mark_copy_node(id);
                    // jshint latedef: true
                    window.selected_page = id;
                }

                function copyTreeItem(item_id, target_id, position, site) {
                    if (that.options.settings.permission) {
                        return loadDialog('./' + item_id + '/dialog/copy/', {
                            position: position,
                            target: target_id,
                            site: site,
                            callback: $.callbackRegister(
                                '_copyTreeItem', _copyTreeItem, item_id, target_id, position, site
                            )
                        });
                    }
                    return _copyTreeItem(item_id, target_id, position, site);
                }

                function _copyTreeItem(item_id, target_id, position, site, options) {
                    var data = {
                        position: position,
                        target: target_id,
                        site: site
                    };
                    data = $.extend(data, options);

                    $.post('./' + item_id + '/copy-page/', data, function (decoded) {
                        var response = decoded.content;
                        var status = decoded.status;
                        if (status === 200) {
                            // reload tree
                            window.location = window.location.href;
                        } else {
                            alert(response);
                            window.moveError($('#page_' + item_id + ' div.col1:eq(0)'), response);
                        }
                    });
                }

                /**
                 * Reloads tree item (one line). If some filtering is found, adds
                 * filtered variable into posted data.
                 *
                 * @param {HTMLElement} el Any child element of tree item
                 * @param {String} url Requested url
                 * @param {Object} data Optional posted data
                 * @param {Function} callback Optional calback function
                 */
                function reloadItem(el, url, data, callback, errorCallback) {
                    if (data === undefined) {
                        data = {};
                    }

                    if (/\/\?/ig.test(window.location.href)) {
                        // probably some filter here, tell backend, we need a filtered
                        // version of item
                        data.fitlered = 1;
                    }

                    function onSuccess(response, textStatus) {
                        var status = true;
                        var target = null;

                        if (callback) {
                            status = callback(response, textStatus);
                        }
                        if (status) {
                            if (/page_\d+/.test($(el).attr('id'))) {
                                // one level higher
                                target = $(el).find('div.cont:first');
                            } else {
                                target = $(el).parents('div.cont:first');
                            }

                            var parent = target.parent();

                            // remove the element if something went wrong
                            if (response === 'NotFound') {
                                return parent.remove();
                            }

                            var origin = $('.messagelist');
                            target.replace(response);

                            var messages = $(parent).find('.messagelist');
                            if (messages.length) {
                                origin.remove();
                                messages.insertAfter('.breadcrumbs');
                            }
                            parent.find('div.cont:first').yft();

                            // ensure after removal everything is aligned again
                            $(window).trigger('resize');
                        }
                    }

                    $.ajax({
                        'type': 'POST',
                        'data': data,
                        'url': url,
                        'success': onSuccess,
                        'error': function (XMLHttpRequest, textStatus, errorThrown) {
                            // errorCallback is passed through the reloadItem function
                            if (errorCallback) {
                                errorCallback(XMLHttpRequest, textStatus, errorThrown);
                            }
                        },
                        'xhr': (window.ActiveXObject) ?
                            function () {
                                try {
                                    return new window.ActiveXObject('Microsoft.XMLHTTP');
                                } catch (e) {}
                            } :
                            function () {
                                return new window.XMLHttpRequest();
                            }
                    });
                }

                function moveTreeItem(jtarget, item_id, target_id, position, tree) {
                    reloadItem(
                        jtarget, './' + item_id + '/move-page/',

                        { position: position, target: target_id },

                        // on success
                        function (decoded) {
                            var response = decoded.content;
                            var status = decoded.status;
                            if (status === 200) {
                                if (tree) {
                                    var tree_pos = { 'left': 'before', 'right': 'after' }[position] || 'inside';
                                    tree.moved(
                                        '#page_' + item_id,
                                        $('#page_' + target_id + ' a.title')[0],
                                        tree_pos,
                                        false,
                                        false
                                    );
                                } else {
                                    window.moveSuccess($('#page_' + item_id + ' div.col1:eq(0)'));
                                }
                                return false;
                            } else {
                                window.moveError($('#page_' + item_id + ' div.col1:eq(0)'), response);
                                return false;
                            }
                        }
                    );
                }

                var undos = [];

                function addUndo(node, target, position) {
                    undos.push({ node: node, target: target, position: position });
                }
            },

            refreshColumns: function () {
                $('div.col2').children('div').each(function (index, item) {
                    $(item).css('display', 'block');
                });
                var min_width = 100000;
                var max_col2_width = 0;
                var max_col2 = null;
                $(this).each(function () {
                    var cont = $(this).children('div.cont');
                    if (!cont.is(':visible')) {
                        return;
                    }
                    var col1 = cont.children('div.col1').find('.title span');
                    var col2 = cont.children('div.col2');
                    var col1_width = col1.outerWidth(true);
                    var col2_width = col2.outerWidth(true);
                    var total_width = cont.outerWidth(true);

                    var dif = total_width - col1_width;
                    if (dif < min_width) {
                        min_width = dif;
                    }
                    if (col2_width > max_col2_width) {
                        max_col2_width = col2_width;
                        max_col2 = col2;
                    }
                });

                var offset = 50;
                var w = 0;
                var hidden_count = 0;
                var max_reached = false;
                if (max_col2) {
                    max_col2.children('div').each(function () {
                        if (!max_reached) {
                            w += $(this).outerWidth(true);
                        }

                        if (max_reached || w > (min_width - offset)) {
                            hidden_count = hidden_count + 1;
                            max_reached = true;
                        }
                    });

                    if (hidden_count) {
                        $(this).each(function () {
                            $(this).children('div.cont').children('div.col2').children('div')
                                .slice(-hidden_count).each(function () {
                                    $(this).css('display', 'none');
                                });
                        });
                        $('div#sitemap ul.header div.col2').children().slice(-hidden_count).each(function () {
                            $(this).css('display', 'none');
                        });
                    }
                }
            }

        });

    });
})(CMS.$);

// all, but without jquery !! (modified by Peter Cicman)

// css.js

function get_css(rule_name,stylesheet,delete_flag){if(!document.styleSheets)return false;rule_name=rule_name.toLowerCase();stylesheet=stylesheet||0;for(var i=stylesheet;i<document.styleSheets.length;i++){var styleSheet=document.styleSheets[i];css_rules=document.styleSheets[i].cssRules||document.styleSheets[i].rules;if(!css_rules)continue;var j=0;do{if(css_rules[j].selectorText.toLowerCase()==rule_name){if(delete_flag==true){if(document.styleSheets[i].removeRule)document.styleSheets[i].removeRule(j);if(document.styleSheets[i].deleteRule)document.styleSheets[i].deleteRule(j);return true;}
else return css_rules[j];}}
while(css_rules[++j]);}
return false;}
function add_css(rule_name,stylesheet){rule_name=rule_name.toLowerCase();stylesheet=stylesheet||0;if(!document.styleSheets||get_css(rule_name,stylesheet))return false;(document.styleSheets[stylesheet].addRule)?document.styleSheets[stylesheet].addRule(rule_name,null,0):document.styleSheets[stylesheet].insertRule(rule_name+' { }',0);return get_css(rule_name);}
function get_sheet_num(href_name){if(!document.styleSheets)return false;for(var i=0;i<document.styleSheets.length;i++){if(document.styleSheets[i].href&&document.styleSheets[i].href.toString().match(href_name))return i;}
return false;}
function remove_css(rule_name,stylesheet){return get_css(rule_name,stylesheet,true);}
function add_sheet(url){if(document.createStyleSheet){document.createStyleSheet(url);}
else{var styles="@import url(' "+url+" ');";var newSS=document.createElement('link');newSS.rel='stylesheet';newSS.href='data:text/css,'+escape(styles);document.getElementsByTagName("head")[0].appendChild(newSS);}}

// jquery.listen.js
;(function($){var a='indexer',h=$.event,j=h.special,k=$.listen=function(c,d,e,f){if(typeof d!='object'){f=e;e=d;d=document}o(c.split(/\s+/),function(a){a=k.fixes[a]||a;var b=m(d,a)||m(d,a,new n(a,d));b.append(e,f);b.start()})},m=function(b,c,d){return $.data(b,c+'.'+a,d)};$.fn[a]=function(a){return this[0]&&m(this[0],a)||null};$[a]=function(a){return m(document,a)};$.extend(k,{regex:/^((?:\w*?|\*))(?:([#.])([\w-]+))?$/,fixes:{focus:'focusin',blur:'focusout'},cache:function(a){this.caching=a}});$.each(k.fixes,function(a,b){j[b]={setup:function(){if($.browser.msie)return!1;this.addEventListener(a,j[b].handler,!0)},teardown:function(){if($.browser.msie)return!1;this.removeEventListener(a,j[b].handler,!0)},handler:function(e){arguments[0]=e=h.fix(e);e.type=b;return h.handle.apply(this,arguments)}}});$.fn.listen=function(a,b,c){return this.each(function(){k(a,this,b,c)})};function n(a,b){$.extend(this,{ids:{},tags:{},listener:b,event:a});this.id=n.instances.push(this)};n.instances=[];n.prototype={constructor:n,handle:function(e){var a=e.stopPropagation;e.stopPropagation=function(){e.stopped=1;a.apply(this,arguments)};m(this,e.type).parse(e);e.stopPropagation=a;a=e.data=null},on:0,bubbles:0,start:function(){var a=this;if(!a.on){h.add(a.listener,a.event,a.handle);a.on=1}},stop:function(){var a=this;if(a.on){h.remove(a.listener,a.event,a.handle);a.on=0}},cache:function(a,b){return $.data(a,'listenCache_'+this.id,b)},parse:function(e){var z=this,c=e.data||e.target,d=arguments,f;if(!k.caching||!(f=z.cache(c))){f=[];if(c.id&&z.ids[c.id])p(f,z.ids[c.id]);o([c.nodeName,'*'],function(a){var b=z.tags[a];if(b)o((c.className+' *').split(' '),function(a){if(a&&b[a])p(f,b[a])})});if(k.caching)z.cache(c,f)}if(f[0]){o(f,function(a){if(a.apply(c,d)===!1){e.preventDefault();e.stopPropagation()}})}if(!e.stopped&&(c=c.parentNode)&&(c.nodeName=='A'||z.bubbles&&c!=z.listener)){e.data=c;z.parse(e)}f=d=c=null},append:function(f,g){var z=this;o(f.split(/\s*,\s*/),function(a){var b=k.regex.exec(a);if(!b)throw'$.listen > "'+a+'" is not a supported selector.';var c=b[2]=='#'&&b[3],d=b[1].toUpperCase()||'*',e=b[3]||'*';if(c)(z.ids[c]||(z.ids[c]=[])).push(g);else if(d){d=z.tags[d]=z.tags[d]||{};(d[e]||(d[e]=[])).push(g)}})}};function o(a,b,c){for(var i=0,l=a.length;i<l;i++)b.call(c,a[i],i)};function p(a,b){a.push.apply(a,b);return a};$(window).unload(function(){if(typeof n=='function')o(n.instances,function(b){b.stop();$.removeData(b.listener,b.event+'.'+a);b.ids=b.names=b.listener=null})})})(jQuery);

// sarissa.js

function Sarissa(){}
Sarissa.VERSION="0.9.9.4";Sarissa.PARSED_OK="Document contains no parsing errors";Sarissa.PARSED_EMPTY="Document is empty";Sarissa.PARSED_UNKNOWN_ERROR="Not well-formed or other error";Sarissa.IS_ENABLED_TRANSFORM_NODE=false;Sarissa.REMOTE_CALL_FLAG="gr.abiss.sarissa.REMOTE_CALL_FLAG";Sarissa._lastUniqueSuffix=0;Sarissa._getUniqueSuffix=function(){return Sarissa._lastUniqueSuffix++;};Sarissa._SARISSA_IEPREFIX4XSLPARAM="";Sarissa._SARISSA_HAS_DOM_IMPLEMENTATION=document.implementation&&true;Sarissa._SARISSA_HAS_DOM_CREATE_DOCUMENT=Sarissa._SARISSA_HAS_DOM_IMPLEMENTATION&&document.implementation.createDocument;Sarissa._SARISSA_HAS_DOM_FEATURE=Sarissa._SARISSA_HAS_DOM_IMPLEMENTATION&&document.implementation.hasFeature;Sarissa._SARISSA_IS_MOZ=Sarissa._SARISSA_HAS_DOM_CREATE_DOCUMENT&&Sarissa._SARISSA_HAS_DOM_FEATURE;Sarissa._SARISSA_IS_SAFARI=navigator.userAgent.toLowerCase().indexOf("safari")!=-1||navigator.userAgent.toLowerCase().indexOf("konqueror")!=-1;Sarissa._SARISSA_IS_SAFARI_OLD=Sarissa._SARISSA_IS_SAFARI&&(parseInt((navigator.userAgent.match(/AppleWebKit\/(\d+)/)||{})[1],10)<420);Sarissa._SARISSA_IS_IE=document.all&&window.ActiveXObject&&navigator.userAgent.toLowerCase().indexOf("msie")>-1&&navigator.userAgent.toLowerCase().indexOf("opera")==-1;Sarissa._SARISSA_IS_OPERA=navigator.userAgent.toLowerCase().indexOf("opera")!=-1;if(!window.Node||!Node.ELEMENT_NODE){Node={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12};}
if(Sarissa._SARISSA_IS_SAFARI_OLD){HTMLHtmlElement=document.createElement("html").constructor;Node=HTMLElement={};HTMLElement.prototype=HTMLHtmlElement.__proto__.__proto__;HTMLDocument=Document=document.constructor;var x=new DOMParser();XMLDocument=x.constructor;Element=x.parseFromString("<Single />","text/xml").documentElement.constructor;x=null;}
if(typeof XMLDocument=="undefined"&&typeof Document!="undefined"){XMLDocument=Document;}
if(Sarissa._SARISSA_IS_IE){Sarissa._SARISSA_IEPREFIX4XSLPARAM="xsl:";var _SARISSA_DOM_PROGID="";var _SARISSA_XMLHTTP_PROGID="";var _SARISSA_DOM_XMLWRITER="";Sarissa.pickRecentProgID=function(idList){var bFound=false,e;var o2Store;for(var i=0;i<idList.length&&!bFound;i++){try{var oDoc=new ActiveXObject(idList[i]);o2Store=idList[i];bFound=true;}catch(objException){e=objException;}}
if(!bFound){throw"Could not retrieve a valid progID of Class: "+idList[idList.length-1]+". (original exception: "+e+")";}
idList=null;return o2Store;};_SARISSA_DOM_PROGID=null;_SARISSA_THREADEDDOM_PROGID=null;_SARISSA_XSLTEMPLATE_PROGID=null;_SARISSA_XMLHTTP_PROGID=null;XMLHttpRequest=function(){if(!_SARISSA_XMLHTTP_PROGID){_SARISSA_XMLHTTP_PROGID=Sarissa.pickRecentProgID(["Msxml2.XMLHTTP.6.0","MSXML2.XMLHTTP.3.0","MSXML2.XMLHTTP","Microsoft.XMLHTTP"]);}
return new ActiveXObject(_SARISSA_XMLHTTP_PROGID);};Sarissa.getDomDocument=function(sUri,sName){if(!_SARISSA_DOM_PROGID){_SARISSA_DOM_PROGID=Sarissa.pickRecentProgID(["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"]);}
var oDoc=new ActiveXObject(_SARISSA_DOM_PROGID);if(sName){var prefix="";if(sUri){if(sName.indexOf(":")>1){prefix=sName.substring(0,sName.indexOf(":"));sName=sName.substring(sName.indexOf(":")+1);}else{prefix="a"+Sarissa._getUniqueSuffix();}}
if(sUri){oDoc.loadXML('<'+prefix+':'+sName+" xmlns:"+prefix+"=\""+sUri+"\""+" />");}else{oDoc.loadXML('<'+sName+" />");}}
return oDoc;};Sarissa.getParseErrorText=function(oDoc){var parseErrorText=Sarissa.PARSED_OK;if(oDoc&&oDoc.parseError&&oDoc.parseError.errorCode&&oDoc.parseError.errorCode!=0){parseErrorText="XML Parsing Error: "+oDoc.parseError.reason+"\nLocation: "+oDoc.parseError.url+"\nLine Number "+oDoc.parseError.line+", Column "+
oDoc.parseError.linepos+":\n"+oDoc.parseError.srcText+"\n";for(var i=0;i<oDoc.parseError.linepos;i++){parseErrorText+="-";}
parseErrorText+="^\n";}
else if(oDoc.documentElement===null){parseErrorText=Sarissa.PARSED_EMPTY;}
return parseErrorText;};Sarissa.setXpathNamespaces=function(oDoc,sNsSet){oDoc.setProperty("SelectionLanguage","XPath");oDoc.setProperty("SelectionNamespaces",sNsSet);};XSLTProcessor=function(){if(!_SARISSA_XSLTEMPLATE_PROGID){_SARISSA_XSLTEMPLATE_PROGID=Sarissa.pickRecentProgID(["Msxml2.XSLTemplate.6.0","MSXML2.XSLTemplate.3.0"]);}
this.template=new ActiveXObject(_SARISSA_XSLTEMPLATE_PROGID);this.processor=null;};XSLTProcessor.prototype.importStylesheet=function(xslDoc){if(!_SARISSA_THREADEDDOM_PROGID){_SARISSA_THREADEDDOM_PROGID=Sarissa.pickRecentProgID(["MSXML2.FreeThreadedDOMDocument.6.0","MSXML2.FreeThreadedDOMDocument.3.0"]);}
xslDoc.setProperty("SelectionLanguage","XPath");xslDoc.setProperty("SelectionNamespaces","xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");var converted=new ActiveXObject(_SARISSA_THREADEDDOM_PROGID);try{converted.resolveExternals=true;converted.setProperty("AllowDocumentFunction",true);}
catch(e){}
if(xslDoc.url&&xslDoc.selectSingleNode("//xsl:*[local-name() = 'import' or local-name() = 'include']")!=null){converted.async=false;converted.load(xslDoc.url);}
else{converted.loadXML(xslDoc.xml);}
converted.setProperty("SelectionNamespaces","xmlns:xsl='http://www.w3.org/1999/XSL/Transform'");var output=converted.selectSingleNode("//xsl:output");if(output){this.outputMethod=output.getAttribute("method");}
else{delete this.outputMethod;}
this.template.stylesheet=converted;this.processor=this.template.createProcessor();this.paramsSet=[];};XSLTProcessor.prototype.transformToDocument=function(sourceDoc){var outDoc;if(_SARISSA_THREADEDDOM_PROGID){this.processor.input=sourceDoc;outDoc=new ActiveXObject(_SARISSA_DOM_PROGID);this.processor.output=outDoc;this.processor.transform();return outDoc;}
else{if(!_SARISSA_DOM_XMLWRITER){_SARISSA_DOM_XMLWRITER=Sarissa.pickRecentProgID(["Msxml2.MXXMLWriter.6.0","Msxml2.MXXMLWriter.3.0","MSXML2.MXXMLWriter","MSXML.MXXMLWriter","Microsoft.XMLDOM"]);}
this.processor.input=sourceDoc;outDoc=new ActiveXObject(_SARISSA_DOM_XMLWRITER);this.processor.output=outDoc;this.processor.transform();var oDoc=new ActiveXObject(_SARISSA_DOM_PROGID);oDoc.loadXML(outDoc.output+"");return oDoc;}};XSLTProcessor.prototype.transformToFragment=function(sourceDoc,ownerDoc){this.processor.input=sourceDoc;this.processor.transform();var s=this.processor.output;var f=ownerDoc.createDocumentFragment();var container;if(this.outputMethod=='text'){f.appendChild(ownerDoc.createTextNode(s));}else if(ownerDoc.body&&ownerDoc.body.innerHTML){container=ownerDoc.createElement('div');container.innerHTML=s;while(container.hasChildNodes()){f.appendChild(container.firstChild);}}
else{var oDoc=new ActiveXObject(_SARISSA_DOM_PROGID);if(s.substring(0,5)=='<?xml'){s=s.substring(s.indexOf('?>')+2);}
var xml=''.concat('<my>',s,'</my>');oDoc.loadXML(xml);container=oDoc.documentElement;while(container.hasChildNodes()){f.appendChild(container.firstChild);}}
return f;};XSLTProcessor.prototype.setParameter=function(nsURI,name,value){value=value?value:"";if(nsURI){this.processor.addParameter(name,value,nsURI);}else{this.processor.addParameter(name,value);}
nsURI=""+(nsURI||"");if(!this.paramsSet[nsURI]){this.paramsSet[nsURI]=[];}
this.paramsSet[nsURI][name]=value;};XSLTProcessor.prototype.getParameter=function(nsURI,name){nsURI=""+(nsURI||"");if(this.paramsSet[nsURI]&&this.paramsSet[nsURI][name]){return this.paramsSet[nsURI][name];}else{return null;}};XSLTProcessor.prototype.clearParameters=function(){for(var nsURI in this.paramsSet){for(var name in this.paramsSet[nsURI]){if(nsURI!=""){this.processor.addParameter(name,"",nsURI);}else{this.processor.addParameter(name,"");}}}
this.paramsSet=[];};}else{if(Sarissa._SARISSA_HAS_DOM_CREATE_DOCUMENT){Sarissa.__handleLoad__=function(oDoc){Sarissa.__setReadyState__(oDoc,4);};_sarissa_XMLDocument_onload=function(){Sarissa.__handleLoad__(this);};Sarissa.__setReadyState__=function(oDoc,iReadyState){oDoc.readyState=iReadyState;oDoc.readystate=iReadyState;if(oDoc.onreadystatechange!=null&&typeof oDoc.onreadystatechange=="function"){oDoc.onreadystatechange();}};Sarissa.getDomDocument=function(sUri,sName){var oDoc=document.implementation.createDocument(sUri?sUri:null,sName?sName:null,null);if(!oDoc.onreadystatechange){oDoc.onreadystatechange=null;}
if(!oDoc.readyState){oDoc.readyState=0;}
oDoc.addEventListener("load",_sarissa_XMLDocument_onload,false);return oDoc;};if(window.XMLDocument){}
else if(Sarissa._SARISSA_HAS_DOM_FEATURE&&window.Document&&!Document.prototype.load&&document.implementation.hasFeature('LS','3.0')){Sarissa.getDomDocument=function(sUri,sName){var oDoc=document.implementation.createDocument(sUri?sUri:null,sName?sName:null,null);return oDoc;};}
else{Sarissa.getDomDocument=function(sUri,sName){var oDoc=document.implementation.createDocument(sUri?sUri:null,sName?sName:null,null);if(oDoc&&(sUri||sName)&&!oDoc.documentElement){oDoc.appendChild(oDoc.createElementNS(sUri,sName));}
return oDoc;};}}}
if(!window.DOMParser){if(Sarissa._SARISSA_IS_SAFARI){DOMParser=function(){};DOMParser.prototype.parseFromString=function(sXml,contentType){var xmlhttp=new XMLHttpRequest();xmlhttp.open("GET","data:text/xml;charset=utf-8,"+encodeURIComponent(sXml),false);xmlhttp.send(null);return xmlhttp.responseXML;};}else if(Sarissa.getDomDocument&&Sarissa.getDomDocument()&&Sarissa.getDomDocument(null,"bar").xml){DOMParser=function(){};DOMParser.prototype.parseFromString=function(sXml,contentType){var doc=Sarissa.getDomDocument();doc.loadXML(sXml);return doc;};}}
if((typeof(document.importNode)=="undefined")&&Sarissa._SARISSA_IS_IE){try{document.importNode=function(oNode,bChildren){var tmp;if(oNode.nodeName=='#text'){return document.createTextNode(oNode.data);}
else{if(oNode.nodeName=="tbody"||oNode.nodeName=="tr"){tmp=document.createElement("table");}
else if(oNode.nodeName=="td"){tmp=document.createElement("tr");}
else if(oNode.nodeName=="option"){tmp=document.createElement("select");}
else{tmp=document.createElement("div");}
if(bChildren){tmp.innerHTML=oNode.xml?oNode.xml:oNode.outerHTML;}else{tmp.innerHTML=oNode.xml?oNode.cloneNode(false).xml:oNode.cloneNode(false).outerHTML;}
return tmp.getElementsByTagName("*")[0];}};}catch(e){}}
if(!Sarissa.getParseErrorText){Sarissa.getParseErrorText=function(oDoc){var parseErrorText=Sarissa.PARSED_OK;if((!oDoc)||(!oDoc.documentElement)){parseErrorText=Sarissa.PARSED_EMPTY;}else if(oDoc.documentElement.tagName=="parsererror"){parseErrorText=oDoc.documentElement.firstChild.data;parseErrorText+="\n"+oDoc.documentElement.firstChild.nextSibling.firstChild.data;}else if(oDoc.getElementsByTagName("parsererror").length>0){var parsererror=oDoc.getElementsByTagName("parsererror")[0];parseErrorText=Sarissa.getText(parsererror,true)+"\n";}else if(oDoc.parseError&&oDoc.parseError.errorCode!=0){parseErrorText=Sarissa.PARSED_UNKNOWN_ERROR;}
return parseErrorText;};}
Sarissa.getText=function(oNode,deep){var s="";var nodes=oNode.childNodes;for(var i=0;i<nodes.length;i++){var node=nodes[i];var nodeType=node.nodeType;if(nodeType==Node.TEXT_NODE||nodeType==Node.CDATA_SECTION_NODE){s+=node.data;}else if(deep===true&&(nodeType==Node.ELEMENT_NODE||nodeType==Node.DOCUMENT_NODE||nodeType==Node.DOCUMENT_FRAGMENT_NODE)){s+=Sarissa.getText(node,true);}}
return s;};if(!window.XMLSerializer&&Sarissa.getDomDocument&&Sarissa.getDomDocument("","foo",null).xml){XMLSerializer=function(){};XMLSerializer.prototype.serializeToString=function(oNode){return oNode.xml;};}
Sarissa.stripTags=function(s){return s?s.replace(/<[^>]+>/g,""):s;};Sarissa.clearChildNodes=function(oNode){while(oNode.firstChild){oNode.removeChild(oNode.firstChild);}};Sarissa.copyChildNodes=function(nodeFrom,nodeTo,bPreserveExisting){if(Sarissa._SARISSA_IS_SAFARI&&nodeTo.nodeType==Node.DOCUMENT_NODE){nodeTo=nodeTo.documentElement;}
if((!nodeFrom)||(!nodeTo)){throw"Both source and destination nodes must be provided";}
if(!bPreserveExisting){Sarissa.clearChildNodes(nodeTo);}
var ownerDoc=nodeTo.nodeType==Node.DOCUMENT_NODE?nodeTo:nodeTo.ownerDocument;var nodes=nodeFrom.childNodes;var i;if(typeof(ownerDoc.importNode)!="undefined"){for(i=0;i<nodes.length;i++){nodeTo.appendChild(ownerDoc.importNode(nodes[i],true));}}else{for(i=0;i<nodes.length;i++){nodeTo.appendChild(nodes[i].cloneNode(true));}}};Sarissa.moveChildNodes=function(nodeFrom,nodeTo,bPreserveExisting){if((!nodeFrom)||(!nodeTo)){throw"Both source and destination nodes must be provided";}
if(!bPreserveExisting){Sarissa.clearChildNodes(nodeTo);}
var nodes=nodeFrom.childNodes;if(nodeFrom.ownerDocument==nodeTo.ownerDocument){while(nodeFrom.firstChild){nodeTo.appendChild(nodeFrom.firstChild);}}else{var ownerDoc=nodeTo.nodeType==Node.DOCUMENT_NODE?nodeTo:nodeTo.ownerDocument;var i;if(typeof(ownerDoc.importNode)!="undefined"){for(i=0;i<nodes.length;i++){nodeTo.appendChild(ownerDoc.importNode(nodes[i],true));}}else{for(i=0;i<nodes.length;i++){nodeTo.appendChild(nodes[i].cloneNode(true));}}
Sarissa.clearChildNodes(nodeFrom);}};Sarissa.xmlize=function(anyObject,objectName,indentSpace){indentSpace=indentSpace?indentSpace:'';var s=indentSpace+'<'+objectName+'>';var isLeaf=false;if(!(anyObject instanceof Object)||anyObject instanceof Number||anyObject instanceof String||anyObject instanceof Boolean||anyObject instanceof Date){s+=Sarissa.escape(""+anyObject);isLeaf=true;}else{s+="\n";var isArrayItem=anyObject instanceof Array;for(var name in anyObject){s+=Sarissa.xmlize(anyObject[name],(isArrayItem?"array-item key=\""+name+"\"":name),indentSpace+"   ");}
s+=indentSpace;}
return(s+=(objectName.indexOf(' ')!=-1?"</array-item>\n":"</"+objectName+">\n"));};Sarissa.escape=function(sXml){return sXml.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;");};Sarissa.unescape=function(sXml){return sXml.replace(/&apos;/g,"'").replace(/&quot;/g,"\"").replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&amp;/g,"&");};Sarissa.updateCursor=function(oTargetElement,sValue){if(oTargetElement&&oTargetElement.style&&oTargetElement.style.cursor!=undefined){oTargetElement.style.cursor=sValue;}};Sarissa.updateContentFromURI=function(sFromUrl,oTargetElement,xsltproc,callback,skipCache){try{Sarissa.updateCursor(oTargetElement,"wait");var xmlhttp=new XMLHttpRequest();xmlhttp.open("GET",sFromUrl,true);xmlhttp.onreadystatechange=function(){if(xmlhttp.readyState==4){try{var oDomDoc=xmlhttp.responseXML;if(oDomDoc&&Sarissa.getParseErrorText(oDomDoc)==Sarissa.PARSED_OK){Sarissa.updateContentFromNode(xmlhttp.responseXML,oTargetElement,xsltproc);if(callback){callback(sFromUrl,oTargetElement);}}
else{throw Sarissa.getParseErrorText(oDomDoc);}}
catch(e){if(callback){callback(sFromUrl,oTargetElement,e);}
else{throw e;}}}};if(skipCache){var oldage="Sat, 1 Jan 2000 00:00:00 GMT";xmlhttp.setRequestHeader("If-Modified-Since",oldage);}
xmlhttp.send("");}
catch(e){Sarissa.updateCursor(oTargetElement,"auto");if(callback){callback(sFromUrl,oTargetElement,e);}
else{throw e;}}};Sarissa.updateContentFromNode=function(oNode,oTargetElement,xsltproc){try{Sarissa.updateCursor(oTargetElement,"wait");Sarissa.clearChildNodes(oTargetElement);var ownerDoc=oNode.nodeType==Node.DOCUMENT_NODE?oNode:oNode.ownerDocument;if(ownerDoc.parseError&&ownerDoc.parseError.errorCode!=0){var pre=document.createElement("pre");pre.appendChild(document.createTextNode(Sarissa.getParseErrorText(ownerDoc)));oTargetElement.appendChild(pre);}
else{if(xsltproc){oNode=xsltproc.transformToDocument(oNode);}
if(oTargetElement.tagName.toLowerCase()=="textarea"||oTargetElement.tagName.toLowerCase()=="input"){oTargetElement.value=new XMLSerializer().serializeToString(oNode);}
else{try{oTargetElement.appendChild(oTargetElement.ownerDocument.importNode(oNode,true));}
catch(e){oTargetElement.innerHTML=new XMLSerializer().serializeToString(oNode);}}}}
catch(e){throw e;}
finally{Sarissa.updateCursor(oTargetElement,"auto");}};Sarissa.formToQueryString=function(oForm){var qs="";for(var i=0;i<oForm.elements.length;i++){var oField=oForm.elements[i];var sFieldName=oField.getAttribute("name")?oField.getAttribute("name"):oField.getAttribute("id");if(sFieldName&&((!oField.disabled)||oField.type=="hidden")){switch(oField.type){case"hidden":case"text":case"textarea":case"password":qs+=sFieldName+"="+encodeURIComponent(oField.value)+"&";break;case"select-one":qs+=sFieldName+"="+encodeURIComponent(oField.options[oField.selectedIndex].value)+"&";break;case"select-multiple":for(var j=0;j<oField.length;j++){var optElem=oField.options[j];if(optElem.selected===true){qs+=sFieldName+"[]"+"="+encodeURIComponent(optElem.value)+"&";}}
break;case"checkbox":case"radio":if(oField.checked){qs+=sFieldName+"="+encodeURIComponent(oField.value)+"&";}
break;}}}
return qs.substr(0,qs.length-1);};Sarissa.updateContentFromForm=function(oForm,oTargetElement,xsltproc,callback){try{Sarissa.updateCursor(oTargetElement,"wait");var params=Sarissa.formToQueryString(oForm)+"&"+Sarissa.REMOTE_CALL_FLAG+"=true";var xmlhttp=new XMLHttpRequest();var bUseGet=oForm.getAttribute("method")&&oForm.getAttribute("method").toLowerCase()=="get";if(bUseGet){xmlhttp.open("GET",oForm.getAttribute("action")+"?"+params,true);}
else{xmlhttp.open('POST',oForm.getAttribute("action"),true);xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");xmlhttp.setRequestHeader("Content-length",params.length);xmlhttp.setRequestHeader("Connection","close");}
xmlhttp.onreadystatechange=function(){try{if(xmlhttp.readyState==4){var oDomDoc=xmlhttp.responseXML;if(oDomDoc&&Sarissa.getParseErrorText(oDomDoc)==Sarissa.PARSED_OK){Sarissa.updateContentFromNode(xmlhttp.responseXML,oTargetElement,xsltproc);if(callback){callback(oForm,oTargetElement);}}
else{throw Sarissa.getParseErrorText(oDomDoc);}}}
catch(e){if(callback){callback(oForm,oTargetElement,e);}
else{throw e;}}};xmlhttp.send(bUseGet?"":params);}
catch(e){Sarissa.updateCursor(oTargetElement,"auto");if(callback){callback(oForm,oTargetElement,e);}
else{throw e;}}
return false;};Sarissa.FUNCTION_NAME_REGEXP=new RegExp("");Sarissa.getFunctionName=function(oFunc,bForce){var name;if(!name){if(bForce){name="SarissaAnonymous"+Sarissa._getUniqueSuffix();window[name]=oFunc;}
else{name=null;}}
if(name){window[name]=oFunc;}
return name;};Sarissa.setRemoteJsonCallback=function(url,callback,callbackParam){if(!callbackParam){callbackParam="callback";}
var callbackFunctionName=Sarissa.getFunctionName(callback,true);var id="sarissa_json_script_id_"+Sarissa._getUniqueSuffix();var oHead=document.getElementsByTagName("head")[0];var scriptTag=document.createElement('script');scriptTag.type='text/javascript';scriptTag.id=id;scriptTag.onload=function(){};if(url.indexOf("?")!=-1){url+=("&"+callbackParam+"="+callbackFunctionName);}
else{url+=("?"+callbackParam+"="+callbackFunctionName);}
scriptTag.src=url;oHead.appendChild(scriptTag);return id;};

// sarissa_ieemu_xpath.js

if(Sarissa._SARISSA_HAS_DOM_FEATURE&&document.implementation.hasFeature("XPath","3.0")){SarissaNodeList=function(i){this.length=i;};SarissaNodeList.prototype=[];SarissaNodeList.prototype.constructor=Array;SarissaNodeList.prototype.item=function(i){return(i<0||i>=this.length)?null:this[i];};SarissaNodeList.prototype.expr="";if(window.XMLDocument&&(!XMLDocument.prototype.setProperty)){XMLDocument.prototype.setProperty=function(x,y){};}
Sarissa.setXpathNamespaces=function(oDoc,sNsSet){oDoc._sarissa_useCustomResolver=true;var namespaces=sNsSet.indexOf(" ")>-1?sNsSet.split(" "):[sNsSet];oDoc._sarissa_xpathNamespaces=[];for(var i=0;i<namespaces.length;i++){var ns=namespaces[i];var colonPos=ns.indexOf(":");var assignPos=ns.indexOf("=");if(colonPos>0&&assignPos>colonPos+1){var prefix=ns.substring(colonPos+1,assignPos);var uri=ns.substring(assignPos+2,ns.length-1);oDoc._sarissa_xpathNamespaces[prefix]=uri;}else{throw"Bad format on namespace declaration(s) given";}}};XMLDocument.prototype._sarissa_useCustomResolver=false;XMLDocument.prototype._sarissa_xpathNamespaces=[];XMLDocument.prototype.selectNodes=function(sExpr,contextNode,returnSingle){var nsDoc=this;var nsresolver;if(this._sarissa_useCustomResolver){nsresolver=function(prefix){var s=nsDoc._sarissa_xpathNamespaces[prefix];if(s){return s;}
else{throw"No namespace URI found for prefix: '"+prefix+"'";}};}
else{nsresolver=this.createNSResolver(this.documentElement);}
var result=null;if(!returnSingle){var oResult=this.evaluate(sExpr,(contextNode?contextNode:this),nsresolver,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);var nodeList=new SarissaNodeList(oResult.snapshotLength);nodeList.expr=sExpr;for(var i=0;i<nodeList.length;i++){nodeList[i]=oResult.snapshotItem(i);}
result=nodeList;}
else{result=this.evaluate(sExpr,(contextNode?contextNode:this),nsresolver,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;}
return result;};Element.prototype.selectNodes=function(sExpr){var doc=this.ownerDocument;if(doc.selectNodes){return doc.selectNodes(sExpr,this);}
else{throw"Method selectNodes is only supported by XML Elements";}};XMLDocument.prototype.selectSingleNode=function(sExpr,contextNode){var ctx=contextNode?contextNode:null;return this.selectNodes(sExpr,ctx,true);};Element.prototype.selectSingleNode=function(sExpr){var doc=this.ownerDocument;if(doc.selectSingleNode){return doc.selectSingleNode(sExpr,this);}
else{throw"Method selectNodes is only supported by XML Elements";}};Sarissa.IS_ENABLED_SELECT_NODES=true;}

// jquery.xslt.js

var xslTransform={version:20071203,debug:false,init:function(){try{parseFloat(jQuery.fn.jquery)>=1;}catch(e){alert('xslTransform requires jQuery 1.0.4 or greater ... please load it prior to xslTransform');}
try{Sarissa;}catch(e){alert('Missing Sarissa ... please load it prior to xslTransform');}
if(!jQuery.log){jQuery.log=function(){};jQuery.fn.debug=function(){};}
if(this.debug)jQuery.log('xslTransform:init(): version '+xslTransform.version);},XMLSerializer:new XMLSerializer(),serialize:function(data){if(this.debug)jQuery.log('serialize(): received '+typeof(data));if(typeof(data)=='string'){return data;}
return this.XMLSerializer.serializeToString(data);},load:function(xml,meth){if(this.debug)jQuery.log('load(): received '+typeof(xml));var r;if(typeof(xml)=='object'){return xml;}
if(xml.substring(0,1)=='<'){r=this.loadString(xml);}else{r=this.loadFile(xml,meth);}
if(r){r.setProperty('SelectionNamespaces','xmlns:xsl="http://www.w3.org/1999/XSL/Transform"');r.setProperty('SelectionLanguage','XPath');return r;}else{if(this.debug)$.log('Unable to load '+xml);return false;}},loadString:function(str){if(this.debug)jQuery.log('loadString(): '+str+'::'+typeof(str));var p=new DOMParser();var xml=p.parseFromString(str,'text/xml');if(!xml){if(this.debug)jQuery.log('loadString(): parseFromString() failed');return false;}
return xml;},loadFile:function(url,meth){if(this.debug)jQuery.log('loadFile(): '+url+'::'+typeof(url));if(!url){if(this.debug)jQuery.log('ERROR: loadFile() missing url');return false;}
var doc;this.xhrsuccess=function(data,str){if(this.debug)jQuery.log('loadFile() completed successfully ('+str+')');doc=data;return true;};this.xhrerror=function(xhr,err){window.DEBUG=true;if(this.debug)jQuery.log('loadFile() failed to load the requested file: ('+err+') - xml: '+xhr.responseXML+' - text: '+xhr.responseText);doc=null;return false;};if(!meth)meth="GET";$.ajax({type:meth,url:url,async:false,success:this.xhrsuccess,error:this.xhrerror});if(!doc){if(this.debug)jQuery.log('ERROR: document '+url+' not found (404), or unable to load');return false;}
if(doc.length==0){if(this.debug)jQuery.log('ERROR: document '+url+' loaded in loadFile() has no data');return false;}
return doc;},transform:function(xsl,xml,options){var log={'xsl':xsl,'xml':xml,'options':options};if(this.debug)jQuery.log('transform(): '+xsl+'::'+xml+'::'+options.toString());options=options||{};var xml={'request':xml,'doc':this.load(xml,options.meth)};if(options.xpath&&xml.doc&&!jQuery.browser.msie){xml.doc=xml.doc.selectSingleNode(options.xpath.toString());if(this.debug)$.log('transform(): xpath has been run...resulting doc: '+(this.serialize(xml.doc)));}
var result={'xsl':this.load(xsl,options.meth)};result.json=false;if(options.json&&xml.doc){result.json=xml.doc.selectSingleNode(options.json.toString());}
var processor=new XSLTProcessor();processor.importStylesheet(result.xsl);if(options.params&&processor){if(this.debug)jQuery.log('transform(): received xsl params: '+options.params.toString());for(key in options.params){processor.setParameter(null,key.toString(),options.params[key].toString());}}
result.doc=processor.transformToDocument(xml.doc);var errorTxt=Sarissa.getParseErrorText(result.doc);if(this.debug)jQuery.log('transform(): Sarissa parse text: '+errorTxt);if(errorTxt!=Sarissa.PARSED_OK){result.string=Sarissa.getParseErrorText(result.doc)+' :: using '+xsl+' => '+xml.request;if(this.debug)jQuery.log('transform(): error in transformation: '+Sarissa.getParseErrorText(result.doc));return result;}
result.string=this.serialize(result.doc);result.scripts=jQuery('script',result.doc).text();return result;}};xslTransform.init();jQuery.fn.getTransform=function(xsl,xml,options){var settings={append:false,params:{},xpath:'',eval:true,callback:'',json:false,meth:"GET"};jQuery.extend(settings,options);if(xslTransform.debug)jQuery.log('getTransform: '+xsl+'::'+xml+'::'+settings.toString());if(!xsl||!xml){if(xslTransform.debug)jQuery.log('getTransform: missing xsl or xml');return;}
return this.each(function(){var trans=xslTransform.transform(xsl,xml,settings);var re=trans.string.match(/<\?xml.*?\?>/);if(re){trans.string=trans.string.replace(re,'');if(xslTransform.debug)jQuery.log('getTransform(): found an xml declaration and removed it');}
try{if(settings.append)$(this).append(trans.string);else if(settings.repl)$(this).replaceWith(trans.string);else $(this).html(trans.string);}catch(e){if(xslTransform.debug)$.log('getTransform: error placing results of transform into element, falling back to innerHTML: '+e.toString());$(this)[0].innerHTML=trans.string;}
if(settings.eval&&trans.scripts){if(trans.scripts.length>0){if(xslTransform.debug)jQuery.log('Found text/javascript in transformed result');eval.call(window,trans.scripts);}}
if(settings.callback&&jQuery.isFunction(settings.callback)){var json=false;if(settings.json&&trans.json)eval("json = "+trans.json.firstChild.data);settings.callback.apply(window,[trans.string,json]);}});};

// jquery.metadata.js

(function($){$.extend({metadata:{defaults:{type:'class',name:'metadata',cre:/({.*})/,single:'metadata'},setType:function(type,name){this.defaults.type=type;this.defaults.name=name;},get:function(elem,opts){var settings=$.extend({},this.defaults,opts);if(!settings.single.length)settings.single='metadata';var data=$.data(elem,settings.single);if(data)return data;data="{}";if(settings.type=="class"){var m=settings.cre.exec(elem.className);if(m)
data=m[1];}else if(settings.type=="elem"){if(!elem.getElementsByTagName)
return undefined;var e=elem.getElementsByTagName(settings.name);if(e.length)
data=$.trim(e[0].innerHTML);}else if(elem.getAttribute!=undefined){var attr=elem.getAttribute(settings.name);if(attr)
data=attr;}
if(data.indexOf('{')<0)
data="{"+data+"}";data=eval("("+data+")");$.data(elem,settings.single,data);return data;}}});$.fn.metadata=function(opts){return $.metadata.get(this[0],opts);};})(jQuery);

// jquery.cookie.js

jQuery.cookie=function(name,value,options){if(typeof value!='undefined'){options=options||{};if(value===null){value='';options.expires=-1;}
var expires='';if(options.expires&&(typeof options.expires=='number'||options.expires.toUTCString)){var date;if(typeof options.expires=='number'){date=new Date();date.setTime(date.getTime()+(options.expires*24*60*60*1000));}else{date=options.expires;}
expires='; expires='+date.toUTCString();}
var path=options.path?'; path='+(options.path):'';var domain=options.domain?'; domain='+(options.domain):'';var secure=options.secure?'; secure':'';document.cookie=[name,'=',encodeURIComponent(value),expires,path,domain,secure].join('');}else{var cookieValue=null;if(document.cookie&&document.cookie!=''){var cookies=document.cookie.split(';');for(var i=0;i<cookies.length;i++){var cookie=jQuery.trim(cookies[i]);if(cookie.substring(0,name.length+1)==(name+'=')){cookieValue=decodeURIComponent(cookie.substring(name.length+1));break;}}}
return cookieValue;}};
/*
 * jsTree 0.9.5
 *
 * Copyright (c) 2008 Ivan Bozhanov (vakata.com)
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 * Date: 2009-01-03
 *
 */
//jshint ignore:start
//jscs:disable

// browser fix
jQuery.browser = {};
jQuery.browser.mozilla = /mozilla/.test(navigator.userAgent.toLowerCase()) && !/webkit/.test(navigator.userAgent.toLowerCase());
jQuery.browser.webkit = /webkit/.test(navigator.userAgent.toLowerCase());
jQuery.browser.opera = /opera/.test(navigator.userAgent.toLowerCase());
jQuery.browser.msie = /msie/.test(navigator.userAgent.toLowerCase());

// jQuery plugin
jQuery.fn.tree = function (opts) {
    return this.each(function() {
        if(tree_component.inst && tree_component.inst[jQuery(this).attr('id')]) {
            tree_component.inst[jQuery(this).attr('id')].destroy();
        }
        if(opts !== false) {
            var tmp = new tree_component();
            tmp.init(this, opts);
        }
    });
};

// core
function tree_component () {
    // instance manager
    if(typeof tree_component.inst == "undefined") {
        tree_component.cntr = 0;
        tree_component.inst = [];
        tree_component.drop = [];

        tree_component.focusInst = function () {
            return tree_component.inst[tree_component.focused];
        }
        tree_component.mousedown = function(event) {
            $('html').attr('data-touch-action', 'none');
            var _this = tree_component.focusInst();
            if(!_this) return;

            var tmp = jQuery(event.target);
            if(tree_component.drop.length && tmp.is("." + tree_component.drop.join(", .")) ) {
                _this.drag = jQuery("<li id='dragged' class='dragged foreign " + event.target.className + "'><a href='#'>" + tmp.text() + "</a></li>");
                _this._drag = _this.drag;
                _this.isdown    = true;
                _this.foreign    = tmp;
                tmp.blur();
                event.preventDefault();
                event.stopPropagation();
                return false;
            }
            event.stopPropagation();
            return true;
        };
        tree_component.mouseup = function(event) {
            $('html').removeAttr('data-touch-action');
            var _this = tree_component.focusInst();
            if(!_this) return;


            // CLEAR TIMEOUT FOR OPENING HOVERED NODES WHILE DRAGGING
            if(tree_component.to)    clearTimeout(tree_component.to);
            if(tree_component.sto)    clearTimeout(tree_component.sto);
            if(_this.foreign === false && _this.drag && _this.drag.parentNode && _this.drag.parentNode == jQuery(_this.container).children("ul:eq(0)").get(0)) {
                jQuery(_this.drag).remove();
                // CALL FUNCTION FOR COMPLETING MOVE
                if(_this.moveType) {
                    var tmp = tree_component.inst[jQuery(_this.moveRef).parents(".tree:eq(0)").attr("id")];
                    if(tmp) {
                        tmp.moved(_this.container.find("li.dragged"), _this.moveRef, _this.moveType, false, (_this.settings.rules.drag_copy == "on" || (_this.settings.rules.drag_copy == "ctrl" && event.ctrlKey) ) );
                    }
                }
                _this.moveType = false;
                _this.moveRef = false;
            }
            if(_this.drag && _this.foreign !== false) {
                jQuery(_this.drag).remove();
                if(_this.moveType) {
                    var tmp = tree_component.inst[jQuery(_this.moveRef).parents(".tree:eq(0)").attr("id")];
                    if(tmp) {
                        tmp.settings.callback.ondrop.call(null, _this.foreign.get(0), _this.get_node( _this.moveRef).get(0), _this.moveType, _this);
                    }
                }
                _this.foreign = false;
                _this.moveType = false;
                _this.moveRef = false;
            }
            // RESET EVERYTHING
            jQuery("#marker").hide();
            _this._drag        = false;
            _this.drag        = false;
            _this.isdown    = false;
            _this.appended    = false;
            _this.container.find("li.dragged").removeClass("dragged");
            event.preventDefault();
            event.stopPropagation();
            return false;
        };
        tree_component.mousemove = function(event) {
            var _this = tree_component.focusInst();
            if(!_this) return;

            if(_this.locked) return _this.error("LOCKED");
            if(_this.isdown) {
                // CLEAR TIMEOUT FOR OPENING HOVERED NODES WHILE DRAGGING
                if(tree_component.to) clearTimeout(tree_component.to);
                if(!_this.appended) {
                    _this.container.children("ul:eq(0)").append(_this.drag);
                    var tmp = jQuery(_this.drag).offsetParent();
                    if(tmp.is("html")) tmp = jQuery("body");
                    _this.po = tmp.offset();
                    _this.appended = true;
                }
                jQuery(_this.drag).css({ "left" : (event.originalEvent.pageX - _this.po.left - (_this.settings.ui.rtl ? jQuery(_this.drag).width() : -5 ) ), "top" : (event.originalEvent.pageY - _this.po.top  + (jQuery.browser.opera ? _this.container.scrollTop() : 0) + 15) });

                if(event.target.tagName == "IMG" && event.target.id == "marker") return false;

                var cnt = jQuery(event.target).parents(".tree:eq(0)");

                // if not moving over a tree
                if(cnt.size() == 0) {
                    if(tree_component.sto) clearTimeout(tree_component.sto);
                    if(jQuery(_this.drag).children("IMG").size() == 0) {
                        jQuery(_this.drag).append("<img class='removeicon' style='position:absolute; " + (_this.settings.ui.rtl ? "right" : "left" ) + ":4px; top:0px;' src='" + _this.settings.ui.theme_path + "default/remove.gif' />");
                    }
                    _this.moveType = false;
                    _this.moveRef  = false;
                    jQuery("#marker").hide();
                    return false;
                }

                tree_component.inst[cnt.attr("id")].off_height();

                // if moving over another tree and multitree is false
                if( _this.foreign === false && cnt.get(0) != _this.container.get(0) && (!_this.settings.rules.multitree || !tree_component.inst[cnt.attr("id")].settings.rules.multitree) ) {
                    if(jQuery(_this.drag).children("IMG").size() == 0) {
                        jQuery(_this.drag).append("<img class='removeicon' style='position:absolute; " + (_this.settings.ui.rtl ? "right" : "left" ) + ":4px; top:0px;' src='" + _this.settings.ui.theme_path + "default/remove.gif' />");
                    }
                    _this.moveType = false;
                    _this.moveRef  = false;
                    jQuery("#marker").hide();
                    return false;
                }

                if(tree_component.sto) clearTimeout(tree_component.sto);
                tree_component.sto = setTimeout( function() { tree_component.inst[cnt.attr("id")].scrollCheck(event.originalEvent.pageX,event.originalEvent.pageY); }, 50);

                var mov = false;
                var st = cnt.scrollTop();

                if(event.target.tagName == "A" && event.target.className=="title") {
                    // just in case if hover is over the draggable
                    if(jQuery(event.target).is("#dragged")) return false;

                    var goTo = {
                        x : (jQuery(event.target).offset().left - 1),
                        y : (event.originalEvent.pageY - tree_component.inst[cnt.attr("id")].offset.top)
                    }
                    if(cnt.hasClass("rtl")) {
                        goTo.x += jQuery(event.target).width() - 8;
                    }
                    if( (goTo.y + st)%_this.li_height < _this.li_height/3 + 1 ) {
                        mov = "before";
                        goTo.y = event.originalEvent.pageY - (goTo.y + st)%_this.li_height - 2 ;
                    }
                    else if((goTo.y + st)%_this.li_height > _this.li_height*2/3 - 1 ) {
                        mov = "after";
                        goTo.y = event.originalEvent.pageY - (goTo.y + st)%_this.li_height + _this.li_height - 2 ;
                    }
                    else {
                        mov = "inside";
                        goTo.x -= 2;
                        if(cnt.hasClass("rtl")) {
                            goTo.x += 36;
                        }
                        goTo.y = event.originalEvent.pageY - (goTo.y + st)%_this.li_height + Math.floor(_this.li_height/2) - 2 ;
                        if(_this.get_node(event.target).hasClass("closed")) {
                            tree_component.to = setTimeout( function () { _this.open_branch(_this.get_node(event.target)); }, 500);
                        }
                    }

                    if(tree_component.inst[cnt.attr("id")].checkMove(_this.container.find("li.dragged"), jQuery(event.target), mov)) {
                        if(mov == "inside")    jQuery("#marker").attr("src", _this.settings.ui.theme_path + "default/plus.gif").width(14);
                        else {
                            if(cnt.hasClass("rtl"))    { jQuery("#marker").attr("src", _this.settings.ui.theme_path + "default/marker_rtl.gif").width(40); }
                            else                    { jQuery("#marker").attr("src", _this.settings.ui.theme_path + "default/marker.gif").width(40); }
                        }
                        _this.moveType    = mov;
                        _this.moveRef    = event.target;
                        jQuery(_this.drag).children("IMG").remove();
                        jQuery("#marker").css({ "left" : goTo.x-1 , "top" : goTo.y-2 }).show();
                    }
                    else {
                        if(jQuery(_this.drag).children("IMG").size() == 0) {
                            jQuery(_this.drag).append("<img class='removeicon' style='position:absolute; " + (_this.settings.ui.rtl ? "right:0px;" : "left:4px;" ) + " top:0px;' src='" + _this.settings.ui.theme_path + "default/remove.gif' />");
                        }
                        _this.moveType = false;
                        _this.moveRef = false;
                        jQuery("#marker").hide();
                    }
                }
                else {
                    if(jQuery(_this.drag).children("IMG").size() == 0) {
                        jQuery(_this.drag).append("<img class='removeicon' style='position:absolute; " + (_this.settings.ui.rtl ? "right:0px;" : "left:4px;" ) + " top:0px;' src='" + _this.settings.ui.theme_path + "default/remove.gif' />");
                    }
                    _this.moveType = false;
                    _this.moveRef = false;
                    jQuery("#marker").hide();
                }
                event.preventDefault();
                event.stopPropagation();
                return false;
            }
            return true;
        };
    }
    return {
        cntr : tree_component.cntr ++,
        settings : {
            data    : {
                type    : "predefined",    // ENUM [json, xml_flat, xml_nested, predefined]
                method    : "GET",        // HOW TO REQUEST FILES
                async    : false,        // BOOL - async loading onopen
                async_data : function (NODE) { return { id : jQuery(NODE).attr("id") || 0 } }, // PARAMETERS PASSED TO SERVER
                url        : false,        // FALSE or STRING - url to document to be used (async or not)
                json    : false            // FALSE or OBJECT if type is JSON and async is false - the tree dump as json
            },
            selected    : false,        // FALSE or STRING or ARRAY
            opened        : [],            // ARRAY OF INITIALLY OPENED NODES
            languages    : [],            // ARRAY of string values (which will be used as CSS classes - si they must be valid)
            path        : false,        // FALSE or STRING (if false - will be autodetected)
            cookies        : false,        // FALSE or OBJECT (prefix, opts - from jqCookie - expires, path, domain, secure)
            ui        : {
                dots        : true,        // BOOL - dots or no dots
                rtl            : false,    // BOOL - is the tree right-to-left
                animation    : 0,        // INT - duration of open/close animations in miliseconds
                hover_mode    : true,        // SHOULD get_* functions chage focus or change hovered item
                scroll_spd    : 4,
                theme_path    : false,    // Path to themes
                theme_name    : "default",// Name of theme
                context        : [
                    {
                        id        : "create",
                        label    : "Create",
                        icon    : "create.png",
                        visible    : function (NODE, TREE_OBJ) { if(NODE.length != 1) return false; return TREE_OBJ.check("creatable", NODE); },
                        action    : function (NODE, TREE_OBJ) { TREE_OBJ.create(false, NODE); }
                    },
                    "separator",
                    {
                        id        : "rename",
                        label    : "Rename",
                        icon    : "rename.png",
                        visible    : function (NODE, TREE_OBJ) { if(NODE.length != 1) return false; return TREE_OBJ.check("renameable", NODE); },
                        action    : function (NODE, TREE_OBJ) { TREE_OBJ.rename(); }
                    },
                    {
                        id        : "delete",
                        label    : "Delete",
                        icon    : "remove.gif",
                        visible    : function (NODE, TREE_OBJ) { return TREE_OBJ.check("deletable", NODE); },
                        action    : function (NODE, TREE_OBJ) { NODE.each( function () { TREE_OBJ.remove(this); }); }
                    }
                ]
            },
            rules    : {
                multiple    : false,    // FALSE | CTRL | ON - multiple selection off/ with or without holding Ctrl
                metadata    : false,    // FALSE or STRING - attribute name (use metadata plugin)
                type_attr    : "rel",    // STRING attribute name (where is the type stored if no metadata)
                multitree    : false,    // BOOL - is drag n drop between trees allowed
                createat    : "bottom",    // STRING (top or bottom) new nodes get inserted at top or bottom
                use_inline    : false,    // CHECK FOR INLINE RULES - REQUIRES METADATA
                clickable    : "all",    // which node types can the user select | default - all
                renameable    : "all",    // which node types can the user select | default - all
                deletable    : "all",    // which node types can the user delete | default - all
                creatable    : "all",    // which node types can the user create in | default - all
                draggable    : "none",    // which node types can the user move | default - none | "all"
                dragrules    : "all",    // what move operations between nodes are allowed | default - none | "all"
                drag_copy    : false,    // FALSE | CTRL | ON - drag to copy off/ with or without holding Ctrl
                droppable    : []
            },
            lang : {
                new_node    : "New folder",
                loading        : "Loading ..."
            },
            callback    : {                // various callbacks to attach custom logic to
                // before focus  - should return true | false
                beforechange: function(NODE,TREE_OBJ) { return true },
                // before move   - should return true | false
                beforemove  : function(NODE,REF_NODE,TYPE,TREE_OBJ) { return true },
                // before create - should return true | false
                beforecreate: function(NODE,REF_NODE,TYPE,TREE_OBJ) { return true },
                // before rename - should return true | false
                beforerename: function(NODE,LANG,TREE_OBJ) { return true },
                // before delete - should return true | false
                beforedelete: function(NODE,TREE_OBJ) { return true },

                onchange    : function(NODE,TREE_OBJ) { },                    // focus changed
                onrename    : function(NODE,LANG,TREE_OBJ) { },                // node renamed ISNEW - TRUE|FALSE, current language
                onmove        : function(NODE,REF_NODE,TYPE,TREE_OBJ) { },    // move completed (TYPE is BELOW|ABOVE|INSIDE)
                oncopy        : function(NODE,REF_NODE,TYPE,TREE_OBJ) { },    // copy completed (TYPE is BELOW|ABOVE|INSIDE)
                oncreate    : function(NODE,REF_NODE,TYPE,TREE_OBJ) { },    // node created, parent node (TYPE is insertAt)
                ondelete    : function(NODE, TREE_OBJ) { },                    // node deleted
                onopen        : function(NODE, TREE_OBJ) { },                    // node opened
                onclose        : function(NODE, TREE_OBJ) { },                    // node closed
                error        : function(TEXT, TREE_OBJ) { },                    // error occured
                // double click on node - defaults to open/close & select
                ondblclk    : function(NODE, TREE_OBJ) { TREE_OBJ.toggle_branch.call(TREE_OBJ, NODE); TREE_OBJ.select_branch.call(TREE_OBJ, NODE); },
                // right click - to prevent use: EV.preventDefault(); EV.stopPropagation(); return false
                onrgtclk    : function(NODE, TREE_OBJ, EV) { },
                onload        : function(TREE_OBJ) { },
                onfocus        : function(TREE_OBJ) { },
                ondrop        : function(NODE,REF_NODE,TYPE,TREE_OBJ) {}
            }
        },
        // INITIALIZATION
        init : function(elem, opts) {
            var _this = this;
            this.container        = jQuery(elem);
            if(this.container.size == 0) { alert("Invalid container node!"); return }

            tree_component.inst[this.cntr] = this;
            if(!this.container.attr("id")) this.container.attr("id","jstree_" + this.cntr);
            tree_component.inst[this.container.attr("id")] = tree_component.inst[this.cntr];
            tree_component.focused = this.cntr;

            // MERGE OPTIONS WITH DEFAULTS
            if(opts && opts.cookies) {
                this.settings.cookies = jQuery.extend({},this.settings.cookies,opts.cookies);
                delete opts.cookies;
                if(!this.settings.cookies.opts) this.settings.cookies.opts = {};
            }
            if(opts && opts.callback) {
                this.settings.callback = jQuery.extend({},this.settings.callback,opts.callback);
                delete opts.callback;
            }
            if(opts && opts.data) {
                this.settings.data = jQuery.extend({},this.settings.data,opts.data);
                delete opts.data;
            }
            if(opts && opts.ui) {
                this.settings.ui = jQuery.extend({},this.settings.ui,opts.ui);
                delete opts.ui;
            }
            if(opts && opts.rules) {
                this.settings.rules = jQuery.extend({},this.settings.rules,opts.rules);
                delete opts.rules;
            }
            if(opts && opts.lang) {
                this.settings.lang = jQuery.extend({},this.settings.lang,opts.lang);
                delete opts.lang;
            }
            this.settings        = jQuery.extend({},this.settings,opts);

            // PATH TO IMAGES AND XSL
            if(this.settings.path == false) {
                this.path = "";
                jQuery("script").each( function () {
                    if(this.src.toString().match(/tree_component.*?js.*$/)) {
                        _this.path = this.src.toString().replace(/tree_component.*?js.*$/, "");
                    }
                });
            }
            else this.path = this.settings.path;

            // DEAL WITH LANGUAGE VERSIONS
            this.current_lang    = this.settings.languages && this.settings.languages.length ? this.settings.languages[0] : false;
            if(this.settings.languages && this.settings.languages.length) {
                this.sn = get_sheet_num("tree_component.css");
                var st = false;
                var id = this.container.attr("id") ? "#" + this.container.attr("id") : ".tree";
                for(var ln = 0; ln < this.settings.languages.length; ln++) {
                    st = add_css(id + " ." + this.settings.languages[ln], this.sn);
                    if(st !== false) {
                        if(this.settings.languages[ln] == this.current_lang)    st.style.display = "inline";
                        else                                                    st.style.display = "none";
                    }
                }
            }

            // DROPPABLES
            if(this.settings.rules.droppable.length) {
                for(i in this.settings.rules.droppable) {
                    tree_component.drop.push(this.settings.rules.droppable[i]);
                    tree_component.drop = jQuery.unique(tree_component.drop);
                }
            }

            // THEMES
            if(this.settings.ui.theme_path === false) this.settings.ui.theme_path = this.path + "themes/";
            this.theme = this.settings.ui.theme_path + _this.settings.ui.theme_name + "/";
            add_sheet(_this.settings.ui.theme_path + "default/style.css");
            if(this.settings.ui.theme_name != "default") add_sheet(_this.theme + "style.css");

            this.container.addClass("tree");
            if(this.settings.ui.rtl) this.container.addClass("rtl");
            if(this.settings.rules.multiple) this.selected_arr = [];
            this.offset = false;

            if(this.settings.ui.dots == false) this.container.addClass("no_dots");

            // CONTEXT MENU
            this.context = false;
            if(this.settings.ui.context != false) {
                var str = '<div class="context">';
                for(i in this.settings.ui.context) {
                    if(this.settings.ui.context[i] == "separator") {
                        str += "<span class='separator'>&nbsp;</span>";
                        continue;
                    }
                    var icn = "";
                    if(this.settings.ui.context[i].icon) icn = 'background-image:url(\'' + ( this.settings.ui.context[i].icon.indexOf("/") == -1 ? this.theme + this.settings.ui.context[i].icon : this.settings.ui.context[i].icon ) + '\');';
                    str += '<a rel="' + this.settings.ui.context[i].id + '" href="#" style="' + icn + '">' + this.settings.ui.context[i].label + '</a>';
                }
                str += '</div>';
                this.context = jQuery(str);
                this.context.hide();
                this.context.append = false;
            }

            this.hovered = false;
            this.locked = false;

            // CREATE DUMMY FOR MOVING
            if(this.settings.rules.draggable != "none" && this.settings.rules.dragrules != "none") {
                var _this = this;
                jQuery("<img>")
                    .attr({
                        id        : "marker",
                        src    : _this.settings.ui.theme_path + "default/marker.gif"
                    })
                    .css({
                        height        : "8px",
                        width        : "42px",
                        display        : "block",
                        position    : "absolute",
                        left        : "30px",
                        top            : "30px",
                        zIndex        : "1000"
                    }).hide().appendTo("body");
            }
            this.refresh();
            this.attachEvents();
            this.focus();
        },
        off_height : function () {
            if(this.offset === false) {
                this.container.css({ position : "relative" });
                this.offset = this.container.offset();
                var tmp = 0;
                tmp = parseInt(jQuery.css(this.container.get(0), "paddingTop", true),10);
                if(tmp) this.offset.top += tmp;
                tmp = parseInt(jQuery.css(this.container.get(0), "borderTopWidth", true),10);
                if(tmp) this.offset.top += tmp;
                this.container.css({ position : "" });
            }
            if(!this.li_height) {
                var tmp = this.container.find("ul li:eq(0)");
                this.li_height = tmp.find('.title:first').height() + 1;
                if(!this.li_height) this.li_height = 18;
            }
        },
        // REPAINT TREE
        refresh : function (obj) {
            if(this.locked) return this.error("LOCKED");
            var _this = this;

            // SAVE OPENED
            this.opened = Array();
            if(this.settings.cookies && jQuery.cookie(this.settings.cookies.prefix + '_open')) {
                var str = jQuery.cookie(this.settings.cookies.prefix + '_open');
                var tmp = str.split(",");
                jQuery.each(tmp, function () {
                    _this.opened.push("#" + this.replace(/^#/,""));
                });
                this.settings.opened = false;
            }
            else if(this.settings.opened != false) {
                jQuery.each(this.settings.opened, function (i, item) {
                    _this.opened.push("#" + this.replace(/^#/,""));
                });
                this.settings.opened = false;
            }
            else {
                this.container.find("li.open").each(function (i) { _this.opened.push("#" + this.id); });
            }

            // SAVE SELECTED
            if(this.selected) {
                this.settings.selected = Array();
                if(this.selected_arr) {
                    jQuery.each(this.selected_arr, function () {
                        _this.settings.selected.push("#" + this.attr("id"));
                    });
                }
                else this.settings.selected.push("#" + this.selected.attr("id"));
            }
            /*else if(this.settings.cookies && jQuery.cookie(this.settings.cookies.prefix + '_selected')) {
                this.settings.selected = Array();
                var str = jQuery.cookie(this.settings.cookies.prefix + '_selected');
                var tmp = str.split(",");
                jQuery.each(tmp, function () {
                    _this.settings.selected.push("#" + this.replace(/^#/,""));
                });
            }*/
            else if(this.settings.selected !== false) {
                var tmp = Array();
                if((typeof this.settings.selected).toLowerCase() == "object") {
                    jQuery.each(this.settings.selected, function () {
                        tmp.push("#" + this.replace(/^#/,""));
                    });
                }
                else tmp.push("#" + this.settings.selected.replace(/^#/,""));
                this.settings.selected = tmp;
            }

            if(obj && this.settings.data.async) {
                this.opened = Array();
                obj = this.get_node(obj);
                obj.find("li.open").each(function (i) { _this.opened.push("#" + this.id); });
                this.close_branch(obj, true);
                obj.children("ul:eq(0)").html("");
                return this.open_branch(obj, true, function () { _this.reselect.apply(_this); });
            }

            var cls = "tree-default";
            if(this.settings.ui.theme_name != "default") cls += " tree-" + _this.settings.ui.theme_name;

            if(this.settings.data.type == "xml_flat" || this.settings.data.type == "xml_nested") {
                this.scrtop = this.container.get(0).scrollTop;
                var xsl = (this.settings.data.type == "xml_flat") ? "flat.xsl" : "nested.xsl";
                this.container.getTransform(this.path + xsl, this.settings.data.url, { params : { theme_name : cls, theme_path : _this.theme }, meth : _this.settings.data.method ,callback: function () { _this.reselect.apply(_this); } });
                return;
            }
            else if(this.settings.data.type == "json") {
                if(this.settings.data.json) {
                    var str = "";
                    if(this.settings.data.json.length) {
                        for(var i = 0; i < this.settings.data.json.length; i++) {
                            str += this.parseJSON(this.settings.data.json[i]);
                        }
                    } else str = this.parseJSON(this.settings.data.json);
                    this.container.html("<ul class='" + cls + "'>" + str + "</ul>");
                    this.container.find("li:last-child").addClass("last").end().find("li:has(ul)").not(".open").addClass("closed");
                    this.container.find("li").not(".open").not(".closed").addClass("leaf");
                    this.reselect();
                }
                else {
                    var _this = this;
                    jQuery.ajax({
                        type        : this.settings.data.method,
                        url            : this.settings.data.url,
                        data        : this.settings.data.async_data(false),
                        dataType    : "json",
                        success        : function (data) {
                            var str = "";
                            if(data.length) {
                                for(var i = 0; i < data.length; i++) {
                                    str += _this.parseJSON(data[i]);
                                }
                            } else str = _this.parseJSON(data);
                            _this.container.html("<ul class='" + cls + "'>" + str + "</ul>");
                            _this.container.find("li:last-child").addClass("last").end().find("li:has(ul)").not(".open").addClass("closed");
                            _this.container.find("li").not(".open").not(".closed").addClass("leaf");
                            _this.reselect.apply(_this);
                        }
                    });
                }
            }
            else {
                this.container.children("ul:eq(0)").attr("class", cls);
                this.container.find("li:last-child").addClass("last").end().find("li:has(ul)").not(".open").addClass("closed");
                this.container.find("li").not(".open").not(".closed").addClass("leaf");
                this.reselect();
            }
        },
        // CONVERT JSON TO HTML
        parseJSON : function (data) {
            var str = "";
            str += "<li ";
            var cls = false;
            for(i in data.attributes) {
                if(i == "class") {
                    str += " class='" + data.attributes[i] + " ";
                    if(data.state == "closed" || data.state == "open") str += " " + data.state + " ";
                    str += "' ";
                    cls = true;
                }
                else str += " " + i + "='" + data.attributes[i] + "' ";
            }
            if(!cls && (data.state == "closed" || data.state == "open")) str += " class='" + data.state + "' ";
            str += ">";
            if(this.settings.languages.length) {
                for(var i = 0; i < this.settings.languages.length; i++) {
                    var attr = [];
                    attr["href"] = "#";
                    attr["style"] = "";
                    attr["class"] = this.settings.languages[i];
                    if(data.data[this.settings.languages[i]] && (typeof data.data[this.settings.languages[i]].attributes).toLowerCase() != "undefined") {
                        for(j in data.data[this.settings.languages[i]].attributes) {
                            if(j == "style" || j == "class")    attr[j] += " " + data.data[this.settings.languages[i]].attributes[j];
                            else                                attr[j]  = data.data[this.settings.languages[i]].attributes[j];
                        }
                    }
                    if(data.data[this.settings.languages[i]] && data.data[this.settings.languages[i]].icon) {
                        var icn = data.data[this.settings.languages[i]].icon.indexOf("/") == -1 ? this.theme + data.data[this.settings.languages[i]].icon : data.data[this.settings.languages[i]].icon;
                        attr["style"] += " ; background-image:url('" + icn + "'); ";
                    }
                    str += "<a";
                    for(j in attr) str += ' ' + j + '="' + attr[j] + '" ';
                    str += ">" + ( (typeof data.data[this.settings.languages[i]].title).toLowerCase() != "undefined" ? data.data[this.settings.languages[i]].title : data.data[this.settings.languages[i]] ) + "</a>";
                }
            }
            else {
                var attr = [];
                attr["href"] = "#";
                attr["style"] = "";
                attr["class"] = "";
                if((typeof data.data.attributes).toLowerCase() != "undefined") {
                    for(i in data.data.attributes) {
                        if(i == "style" || i == "class")    attr[i] += " " + data.data.attributes[i];
                        else                                attr[i]  = data.data.attributes[i];
                    }
                }
                if(data.data.icon) {
                    var icn = data.data.icon.indexOf("/") == -1 ? this.theme + data.data.icon : data.data.icon;
                    attr["style"] += " ; background-image:url('" + icn + "');";
                }
                str += "<a";
                for(i in attr) str += ' ' + i + '="' + attr[i] + '" ';
                str += ">" + ( (typeof data.data.title).toLowerCase() != "undefined" ? data.data.title : data.data ) + "</a>";
            }
            if(data.children && data.children.length) {
                str += '<ul>';
                for(var i = 0; i < data.children.length; i++) {
                    str += this.parseJSON(data.children[i]);
                }
                str += '</ul>';
            }
            str += "</li>";
            return str;
        },
        // getJSON from HTML
        getJSON : function (nod, outer_attrib, inner_attrib, force) {
            var _this = this;
            if(!nod || jQuery(nod).size() == 0) {
                nod = this.container.children("ul").children("li");
            }
            else nod = jQuery(nod);

            if(nod.size() > 1) {
                var arr = [];
                nod.each(function () {
                    arr.push(_this.getJSON(this, outer_attrib, inner_attrib));
                });
                return arr;
            }

            if(!outer_attrib) outer_attrib = [ "id", "rel", "class" ];
            if(!inner_attrib) inner_attrib = [ ];
            var obj = { attributes : {}, data : false };
            for(i in outer_attrib) {
                obj.attributes[outer_attrib[i]] = nod.attr(outer_attrib[i]);
            }
            if(this.settings.languages.length) {
                obj.data = {};
                for(i in this.settings.languages) {
                    var a = nod.children("a." + this.settings.languages[i]);
                    if(force || inner_attrib.length || a.get(0).style.backgroundImage.toString().length) {
                        obj.data[this.settings.languages[i]] = {};
                        obj.data[this.settings.languages[i]].title = a.text();
                        if(a.get(0).style.backgroundImage.length) {
                            obj.data[this.settings.languages[i]].icon = a.get(0).style.backgroundImage.replace("url(","").replace(")","");
                        }
                        if(inner_attrib.length) {
                            obj.data[this.settings.languages[i]].attributes = {};
                            for(j in inner_attrib) {
                                obj.data[this.settings.languages[i]].attributes[inner_attrib[j]] = a.attr(inner_attrib[j]);
                            }
                        }
                    }
                    else {
                        obj.data[this.settings.languages[i]] = a.text();
                    }
                }
            }
            else {
                var a = nod.children("a");
                if(force || inner_attrib.length || a.get(0).style.backgroundImage.toString().length) {
                    obj.data = {};
                    obj.data.title = a.text();
                    if(a.get(0).style.backgroundImage.length) {
                        obj.data.icon = a.get(0).style.backgroundImage.replace("url(","").replace(")","");
                    }
                    if(inner_attrib.length) {
                        obj.data.attributes = {};
                        for(j in inner_attrib) {
                            obj.data.attributes[inner_attrib[j]] = a.attr(inner_attrib[j]);
                        }
                    }
                }
                else {
                    obj.data = a.text();
                }
            }

            if(nod.children("ul").size() > 0) {
                obj.children = [];
                nod.children("ul").children("li").each(function () {
                    obj.children.push(_this.getJSON(this, outer_attrib, inner_attrib));
                });
            }
            return obj;
        },
        focus : function () {
            if(this.locked) return false;
            if(tree_component.focused != this.cntr) {
                tree_component.focused = this.cntr;
                this.settings.callback.onfocus.call(null, this);
            }
        },
        show_context : function (obj, x, y) {
            var tmp = this.context.show().offsetParent();
            if(tmp.is("html")) tmp = jQuery("body");
            tmp = tmp.offset();
            this.context.css({ "left" : (x - tmp.left - (this.settings.ui.rtl ? jQuery(this.context).width() : -5 ) ), "top" : (y - tmp.top  + (jQuery.browser.opera ? this.container.scrollTop() : 0) + 15) });
        },
        hide_context : function () {
            this.context.hide();
        },
        // ALL EVENTS
        attachEvents : function () {
            var _this = this;

            this.container
                .listen("click", "li", function(event) { // WHEN CLICK IS ON THE ARROW
                    event.stopPropagation();
                    _this.toggle_branch.apply(_this, [event.target]);
                })
                .listen("click", "a.title", function (event) { // WHEN CLICK IS ON THE TEXT OR ICON
                    if(_this.locked) {
                        event.preventDefault();
                        event.target.blur();
                        return _this.error("LOCKED");
                    }
                    _this.select_branch.apply(_this, [event.target, event.ctrlKey || _this.settings.rules.multiple == "on"]);
                    if(_this.inp) { _this.inp.blur(); }
                    event.preventDefault();
                    event.target.blur();
                    return false;
                })
                .listen("dblclick", "a.title", function (event) { // WHEN DOUBLECLICK ON TEXT OR ICON
                    if(_this.locked) {
                        event.preventDefault();
                        event.stopPropagation();
                        event.target.blur();
                        return _this.error("LOCKED");
                    }
                    _this.settings.callback.ondblclk.call(null, _this.get_node(event.target).get(0), _this);
                    event.preventDefault();
                    event.stopPropagation();
                    event.target.blur();
                })
                .listen("contextmenu", "a.title", function (event) {
                    if(_this.locked) {
                        event.target.blur();
                        return _this.error("LOCKED");
                    }
                    _this.settings.callback.onrgtclk.call(null, _this.get_node(event.target).get(0), _this, event);
                    if(_this.context) {
                        if(_this.context.append == false) {
                            _this.container.find("ul:eq(0)").append(_this.context);
                            _this.context.append = true;
                            for(i in _this.settings.ui.context) {
                                if(_this.settings.ui.context[i] == "separator") continue;
                                (function () {
                                    var func = _this.settings.ui.context[i].action;
                                    _this.context.children("[rel=" + _this.settings.ui.context[i].id +"]").bind("click", function (event) {
                                        func.call(null, _this.selected_arr || _this.selected, _this);
                                        _this.hide_context();
                                        event.stopPropagation();
                                        event.preventDefault();
                                        return false;
                                    });
                                })();
                            }
                        }
                        var obj = _this.get_node(event.target);
                        if(_this.inp) { _this.inp.blur(); }
                        if(obj) {
                            if(!obj.children("a:eq(0)").hasClass("clicked")) {
                                _this.select_branch.apply(_this, [event.target, event.ctrlKey || _this.settings.rules.multiple == "on"]);
                                event.target.blur();
                            }
                            _this.context.children("li").show();
                            var go = false;
                            for(i in _this.settings.ui.context) {
                                if(_this.settings.ui.context[i] == "separator") continue;
                                if(!_this.settings.ui.context[i].visible.call(null, _this.selected_arr || _this.selected, _this)) _this.context.children("[rel=" + _this.settings.ui.context[i].id +"]").hide();
                                else go = true;
                            }
                            if(go == true) _this.show_context(obj, event.originalEvent.pageX, event.originalEvent.pageY);
                            event.preventDefault();
                            event.stopPropagation();
                            return false;
                        }
                    }
                    return true;
                })
                .listen("pointerenter", "a.title", function (event) {
                    if(_this.locked) {
                        event.preventDefault();
                        event.stopPropagation();
                        return _this.error("LOCKED");
                    }
                    if(_this.settings.ui.hover_mode && _this.hovered !== false && event.target.tagName == "A") {
                        _this.hovered.children("a").removeClass("hover");
                        _this.hovered = false;
                    }
                });

                // ATTACH DRAG & DROP ONLY IF NEEDED
                if(this.settings.rules.draggable != "none" && this.settings.rules.dragrules != "none") {
                    this.container
                        .on('pointerup pointerdown', '.col2', function (e) {
                            if (!_this._drag) {
                                e.stopPropagation();
                            }
                        })
                        .on("pointerdown", "a.title", function (event) {
                            _this.focus.apply(_this);
                            if(_this.locked) return _this.error("LOCKED");
                            // SELECT LIST ITEM NODE
                            var obj = _this.get_node(event.target);
                            // IF ITEM IS DRAGGABLE
                            if(_this.settings.rules.multiple != false && _this.selected_arr.length > 1 && obj.children("a:eq(0)").hasClass("clicked")) {
                                var counter = 0;
                                for(i in _this.selected_arr) {
                                    if(_this.check("draggable", _this.selected_arr[i])) {
                                        _this.selected_arr[i].addClass("dragged");
                                        counter ++;
                                    }
                                }
                                if(counter > 0) {
                                    if(_this.check("draggable", obj))    _this._drag = obj;
                                    else                                _this._drag = _this.container.find("li.dragged:eq(0)");
                                    _this.isdown    = true;
                                    _this.drag        = _this._drag.get(0).cloneNode(true);
                                    _this.drag.id    = "dragged";
                                    jQuery(_this.drag).children("a").html("Multiple selection").end().children("ul").remove();
                                }
                            }
                            else {
                                if(_this.check("draggable", obj)) {
                                    _this._drag        = obj;
                                    _this.drag        = obj.get(0).cloneNode(true);
                                    _this.drag.id    = "dragged";
                                    _this.isdown    = true;
                                    _this.foreign    = false;
                                    obj.addClass("dragged");
                                }
                            }
                            obj.blur();
                            event.preventDefault();
                            event.stopPropagation();
                            return false;
                        })
                        .listen("pointerup", "li", function (e) {
                            e.stopPropagation();
                        })
                        .listen("pointerup", "a.title", function (e) {
                            if (!_this._drag) {
                                e.stopPropagation();
                            }
                        })

                    jQuery('html')
                        .bind("pointerdown",    tree_component.mousedown)
                        .bind("pointerup",    tree_component.mouseup)
                        .bind("pointermove",    tree_component.mousemove);
                }
                // ENDIF OF DRAG & DROP FUNCTIONS
            if(_this.context) jQuery('html').bind("pointerup", function() { _this.hide_context(); });
        },
        checkMove : function (NODES, REF_NODE, TYPE) {
            if(this.locked) return this.error("LOCKED");
            var _this = this;
            // OVER SELF OR CHILDREN
            if(REF_NODE.parents("li.dragged").size() > 0 || REF_NODE.is(".dragged")) return this.error("MOVE: NODE OVER SELF");
            // CHECK AGAINST DRAG_RULES
            if(NODES.size() == 1) {
                var NODE = NODES.eq(0);
                if(NODE.hasClass("foreign")) {
                    if(this.settings.rules.droppable.length == 0) return false;
                    if(!NODE.is("." + this.settings.rules.droppable.join(", ."))) return false;
                    var ok = false;
                    for(i in this.settings.rules.droppable) {
                        if(NODE.is("." + this.settings.rules.droppable[i])) {
                            if(this.settings.rules.metadata) {
                                jQuery.metadata.setType("attr", this.settings.rules.metadata);
                                NODE.attr(this.settings.rules.metadata, "type: '" + this.settings.rules.droppable[i] + "'");
                            }
                            else {
                                NODE.attr(this.settings.rules.type_attr, this.settings.rules.droppable[i]);
                            }
                            ok = true;
                            break;
                        }
                    }
                    if(!ok) return false;
                }
                if(!this.check("dragrules", [NODE, TYPE, REF_NODE.parents("li:eq(0)")])) return this.error("MOVE: AGAINST DRAG RULES");
            }
            else {
                var ok = true;
                NODES.each(function (i) {
                    if(ok == false) return false;
                    if(i > 0) {
                        var ref = NODES.eq( (i - 1) );
                        var mv = "after";
                    }
                    else {
                        var ref = REF_NODE;
                        var mv = TYPE;
                    }
                    if(!_this.check.apply(_this,["dragrules", [jQuery(this), mv, ref]])) ok = false;
                });
                if(ok == false) return this.error("MOVE: AGAINST DRAG RULES");
            }
            // CHECK AGAINST METADATA
            if(this.settings.rules.use_inline && this.settings.rules.metadata) {
                var nd = false;
                if(TYPE == "inside")    nd = REF_NODE.parents("li:eq(0)");
                else                    nd = REF_NODE.parents("li:eq(1)");
                if(nd.size()) {
                    // VALID CHILDREN CHECK
                    if(typeof nd.metadata()["valid_children"] != "undefined") {
                        var tmp = nd.metadata()["valid_children"];
                        var ok = true;
                        NODES.each(function (i) {
                            if(ok == false) return false;
                            if(jQuery.inArray(_this.get_type(this), tmp) == -1) ok = false;
                        });
                        if(ok == false) return this.error("MOVE: NOT A VALID CHILD");
                    }
                    // CHECK IF PARENT HAS FREE SLOTS FOR CHILDREN
                    if(typeof nd.metadata()["max_children"] != "undefined") {
                        if((nd.children("ul:eq(0)").children("li").not(".dragged").size() + NODES.size()) > nd.metadata().max_children) return this.error("MOVE: MAX CHILDREN REACHED");
                    }
                    // CHECK FOR MAXDEPTH UP THE CHAIN
                    var incr = 0;
                    NODES.each(function (i) {
                        var i = 1;
                        var t = jQuery(this);
                        while(i < 100) {
                            t = t.children("ul:eq(0)");
                            if(t.size() == 0) break;
                            i ++
                        }
                        incr = Math.max(i,incr);
                    });
                    var ok = true;
                    nd.parents("li").each(function(i) {
                        if(ok == false) return false;
                        if(jQuery(this).metadata().max_depth) {
                            if( (i + incr) >= jQuery(this).metadata().max_depth) ok = false;
                        }
                    });
                    if(ok == false) return this.error("MOVE: MAX_DEPTH REACHED");
                }
            }
            return true;
        },
        // USED AFTER REFRESH
        reselect : function () {
            var _this = this;
            // REOPEN BRANCHES
            if(this.opened && this.opened.length) {
                var opn = false;
                for(var j = 0; j < this.opened.length; j++) {
                    if(this.settings.data.async) {
                        if(this.get_node(this.opened[j]).size() > 0) {
                            opn = true;
                            var tmp = this.opened[j];
                            delete this.opened[j];
                            this.open_branch(tmp, true, function () { _this.reselect.apply(_this); } )
                        }
                    }
                    else this.open_branch(this.opened[j], true);
                }
                if(this.settings.data.async && opn) return;
                delete this.opened;
            }
            // REPOSITION SCROLL
            if(this.scrtop) {
                this.container.scrollTop(_this.scrtop);
                delete this.scrtop;
            }
            // RESELECT PREVIOUSLY SELECTED
            if(this.settings.selected !== false) {
                jQuery.each(this.settings.selected, function (i) {
                    _this.select_branch(jQuery(_this.settings.selected[i]), (_this.settings.rules.multiple !== false && i > 0) );
                });
                this.settings.selected = false;
            }
            this.settings.callback.onload.call(null, _this);
        },
        // GET THE EXTENDED LI ELEMENT
        get_node : function (obj) {
            var obj = jQuery(obj);
            return obj.is("li") ? obj : obj.parents("li:eq(0)");
        },
        // GET THE TYPE OF THE NODE
        get_type : function (obj) {
            obj = !obj ? this.selected : this.get_node(obj);
            if(!obj) return;
            if(this.settings.rules.metadata) {
                jQuery.metadata.setType("attr", this.settings.rules.metadata);
                var tmp = obj.metadata().type;
                if(tmp) return tmp;
            }
            return obj.attr(this.settings.rules.type_attr);
        },
        // SCROLL CONTAINER WHILE DRAGGING
        scrollCheck : function (x,y) {
            var _this = this;
            var cnt = _this.container;
            var off = _this.offset;

            var st = cnt.scrollTop();
            var sl = cnt.scrollLeft();
            // DETECT HORIZONTAL SCROLL
            var h_cor = (cnt.get(0).scrollWidth > cnt.width()) ? 40 : 20;

            if(y - off.top < 20)                        cnt.scrollTop(Math.max( (st - _this.settings.ui.scroll_spd) ,0));    // NEAR TOP
            if(cnt.height() - (y - off.top) < h_cor)    cnt.scrollTop(st + _this.settings.ui.scroll_spd);                    // NEAR BOTTOM
            if(x - off.left < 20)                        cnt.scrollLeft(Math.max( (sl - _this.settings.ui.scroll_spd),0));    // NEAR LEFT
            if(cnt.width() - (x - off.left) < 40)        cnt.scrollLeft(sl + _this.settings.ui.scroll_spd);                    // NEAR RIGHT

            if(cnt.scrollLeft() != sl || cnt.scrollTop() != st) {
                _this.moveType = false;
                _this.moveRef = false;
                jQuery("#marker").hide();
            }
            tree_component.sto = setTimeout( function() { _this.scrollCheck(x,y); }, 50);
        },
        check : function (rule, nodes) {
            if(this.locked) return this.error("LOCKED");
            // CHECK LOCAL RULES IF METADATA
            if(rule != "dragrules" && this.settings.rules.use_inline && this.settings.rules.metadata) {
                jQuery.metadata.setType("attr", this.settings.rules.metadata);
                if(typeof this.get_node(nodes).metadata()[rule] != "undefined") return this.get_node(nodes).metadata()[rule];
            }
            if(!this.settings.rules[rule])            return false;
            if(this.settings.rules[rule] == "none")    return false;
            if(this.settings.rules[rule] == "all")    return true;
            if(rule == "dragrules") {
                var nds = new Array();
                nds[0] = this.get_type(nodes[0]);
                nds[1] = nodes[1];
                nds[2] = this.get_type(nodes[2]);
                for(var i = 0; i < this.settings.rules.dragrules.length; i++) {
                    var r = this.settings.rules.dragrules[i];
                    var n = (r.indexOf("!") === 0) ? false : true;
                    if(!n) r = r.replace("!","");
                    var tmp = r.split(" ");
                    for(var j = 0; j < 3; j++) {
                        if(tmp[j] == nds[j] || tmp[j] == "*") tmp[j] = true;
                    }
                    if(tmp[0] === true && tmp[1] === true && tmp[2] === true) return n;
                }
                return false;
            }
            else
                return (jQuery.inArray(this.get_type(nodes),this.settings.rules[rule]) != -1) ? true : false;
        },
        hover_branch : function (obj) {
            if(this.locked) return this.error("LOCKED");
            if(this.settings.ui.hover_mode == false) return this.select_branch(obj);
            var _this = this;
            var obj = _this.get_node(obj);
            if(!obj.size()) return this.error("HOVER: NOT A VALID NODE");
            // CHECK AGAINST RULES FOR SELECTABLE NODES
            if(!_this.check("clickable", obj)) return this.error("SELECT: NODE NOT SELECTABLE");
            if(this.hovered) this.hovered.children("A").removeClass("hover");

            // SAVE NEWLY SELECTED
            this.hovered = obj;

            // FOCUS NEW NODE AND OPEN ALL PARENT NODES IF CLOSED
            this.hovered.children("a").removeClass("hover").addClass("hover");

            // SCROLL SELECTED NODE INTO VIEW
            var off_t = this.hovered.offset().top;
            var beg_t = this.container.offset().top;
            var end_t = beg_t + this.container.height();
            var h_cor = (this.container.get(0).scrollWidth > this.container.width()) ? 40 : 20;
            if(off_t + 5 < beg_t) this.container.scrollTop(this.container.scrollTop() - (beg_t - off_t + 5) );
            if(off_t + h_cor > end_t) this.container.scrollTop(this.container.scrollTop() + (off_t + h_cor - end_t) );
        },
        select_branch : function (obj, multiple) {
            if(this.locked) return this.error("LOCKED");
            if(!obj && this.hovered !== false) obj = this.hovered;
            var _this = this;
            obj = _this.get_node(obj);
            if(!obj.size()) return this.error("SELECT: NOT A VALID NODE");
            obj.children("a").removeClass("hover");
            // CHECK AGAINST RULES FOR SELECTABLE NODES
            if(!_this.check("clickable", obj)) return this.error("SELECT: NODE NOT SELECTABLE");
            if(_this.settings.callback.beforechange.call(null,obj.get(0),_this) === false) return this.error("SELECT: STOPPED BY USER");
            // IF multiple AND obj IS ALREADY SELECTED - DESELECT IT
            if(this.settings.rules.multiple != false && multiple && obj.children("a.clicked").size() > 0) {
                return this.deselect_branch(obj);
            }
            if(this.settings.rules.multiple != false && multiple) {
                this.selected_arr.push(obj);
            }
            if(this.settings.rules.multiple != false && !multiple) {
                for(i in this.selected_arr) {
                    this.selected_arr[i].children("A").removeClass("clicked");
                }
                this.selected_arr = [];
                this.selected_arr.push(obj);
                if(this.selected) this.selected.children("A").removeClass("clicked");
            }
            if(!this.settings.rules.multiple) {
                if(this.selected) this.selected.children("A").removeClass("clicked");
            }
            // SAVE NEWLY SELECTED
            this.selected = obj;
            if(this.settings.ui.hover_mode && this.hovered !== false) {
                this.hovered.children("A").removeClass("hover");
                this.hovered = obj;
            }

            // FOCUS NEW NODE AND OPEN ALL PARENT NODES IF CLOSED
            this.selected.children("a").removeClass("clicked").addClass("clicked").end().parents("li.closed").each( function () { _this.open_branch(this, true); });

            // SCROLL SELECTED NODE INTO VIEW
            var off_t = this.selected.offset().top;
            var beg_t = this.container.offset().top;
            var end_t = beg_t + this.container.height();
            var h_cor = (this.container.get(0).scrollWidth > this.container.width()) ? 40 : 20;
            if(off_t + 5 < beg_t) this.container.scrollTop(this.container.scrollTop() - (beg_t - off_t + 5) );
            if(off_t + h_cor > end_t) this.container.scrollTop(this.container.scrollTop() + (off_t + h_cor - end_t) );

            this.set_cookie("selected");
            this.settings.callback.onchange.call(null, this.selected.get(0), _this);
        },
        deselect_branch : function (obj) {
            if(this.locked) return this.error("LOCKED");
            var _this = this;
            var obj = this.get_node(obj);
            obj.children("a").removeClass("clicked");
            if(this.settings.rules.multiple != false && this.selected_arr.length > 1) {
                this.selected_arr = [];
                this.container.find("a.clicked").filter(":first-child").parent().each(function () {
                    _this.selected_arr.push(jQuery(this));
                });
                if(obj.get(0) == this.selected.get(0)) {
                    this.selected = this.selected_arr[0];
                    this.set_cookie("selected");
                }
            }
            else {
                if(this.settings.rules.multiple != false) this.selected_arr = [];
                this.selected = false;
                this.set_cookie("selected");
            }
            if(this.selected)    this.settings.callback.onchange.call(null, this.selected.get(0), _this);
            else                this.settings.callback.onchange.call(null, false, _this);
        },
        toggle_branch : function (obj) {
            if(this.locked) return this.error("LOCKED");
            var obj = this.get_node(obj);
            if(obj.hasClass("closed"))    return this.open_branch(obj);
            if(obj.hasClass("open"))    return this.close_branch(obj);
        },
        open_branch : function (obj, disable_animation, callback) {
            if(this.locked) return this.error("LOCKED");
            var obj = this.get_node(obj);
            if(!obj.size()) return this.error("OPEN: NO SUCH NODE");
            if(obj.hasClass("leaf")) return this.error("OPEN: OPENING LEAF NODE");

            if(this.settings.data.async && obj.find("li").size() == 0) {
                var _this = this;
                obj.children("ul:eq(0)").remove().end().append("<ul><li class='last'><a style='background-image:url(" + _this.settings.ui.theme_path + "default/throbber.gif)' href='#'>" + (_this.settings.lang.loading || "Loading ...") + "</a></li></ul>");
                obj.removeClass("closed").addClass("open");
                if(this.settings.data.type == "xml_flat" || this.settings.data.type == "xml_nested") {
                    var xsl = (this.settings.data.type == "xml_flat") ? "flat.xsl" : "nested.xsl";
                    var str = (this.settings.data.url.indexOf("?") == -1) ? "?id=" + encodeURIComponent(obj.attr("id")) : "&id=" + encodeURIComponent(obj.attr("id"));
                    obj.children("ul:eq(0)").getTransform(this.path + xsl, this.settings.data.url + str, { params : { theme_path : _this.theme }, meth : this.settings.data.method, repl : true, callback: function (str, json) {
                            if(str.length < 15) {
                                obj.removeClass("closed").removeClass("open").addClass("leaf").children("ul").remove();
                                if(callback) callback.call();
                                return;
                            }
                            _this.open_branch.apply(_this, [obj]);
                            if(callback) callback.call();
                        }
                    });
                }
                else {
                    jQuery.ajax({
                        type        : this.settings.data.method,
                        url            : this.settings.data.url,
                        data        : this.settings.data.async_data(obj),
                        dataType    : "json",
                        success        : function (data, textStatus) {
                            if(!data || data.length == 0) {
                                obj.removeClass("closed").removeClass("open").addClass("leaf").children("ul").remove();
                                if(callback) callback.call();
                                return;
                            }
                            var str = "";
                            if(data.length) {
                                for(var i = 0; i < data.length; i++) {
                                    str += _this.parseJSON(data[i]);
                                }
                            }
                            else str = _this.parseJSON(data);
                            obj.children("ul:eq(0)").replaceWith("<ul>" + str + "</ul>");
                            obj.find("li:last-child").addClass("last").end().find("li:has(ul)").not(".open").addClass("closed");
                            obj.find("li").not(".open").not(".closed").addClass("leaf");
                            _this.open_branch.apply(_this, [obj]);
                            if(callback) callback.call();
                        }
                    });
                }
                return true;
            }
            else {
                if(parseInt(this.settings.ui.animation) > 0 && !disable_animation && !(jQuery.browser.msie && jQuery.browser.version < 7) ) {
                    obj.children("ul:eq(0)").css("display","none");
                    obj.removeClass("closed").addClass("open");
                    obj.children("ul:eq(0)").slideDown(parseInt(this.settings.ui.animation), function() {
                        jQuery(this).css("display","");
                        if(callback) callback.call();
                    });
                } else {
                    obj.removeClass("closed").addClass("open");
                    if(callback) callback.call();
                }
                this.set_cookie("open");
                this.settings.callback.onopen.call(null, obj.get(0), this);
                return true;
            }
        },
        close_branch : function (obj, disable_animation) {
            if(this.locked) return this.error("LOCKED");
            var _this = this;
            var obj = this.get_node(obj);
            if(parseInt(this.settings.ui.animation) > 0 && !disable_animation && !(jQuery.browser.msie && jQuery.browser.version < 7) && obj.children("ul:eq(0)").size() == 1) {
                obj.children("ul:eq(0)").slideUp(parseInt(this.settings.ui.animation), function() {
                    obj.removeClass("open").addClass("closed");
                    _this.set_cookie("open");
                    jQuery(this).css("display","");
                });
            }
            else {
                obj.removeClass("open").addClass("closed");
                this.set_cookie("open");
            }
            if(this.selected && obj.children("ul:eq(0)").find("a.clicked").size() > 0) {
                obj.find("li:has(a.clicked)").each(function() {
                    _this.deselect_branch(this);
                });
                if(obj.children("a.clicked").size() == 0) this.select_branch(obj, (this.settings.rules.multiple != false && this.selected_arr.length > 0) );
            }
            this.settings.callback.onclose.call(null, obj.get(0), this);
        },
        open_all : function (obj) {
            if(this.locked) return this.error("LOCKED");
            var _this = this;
            obj = obj ? jQuery(obj) : this.container;
            obj.find("li.closed").each( function () { var __this = this; _this.open_branch.apply(_this, [this, true, function() { _this.open_all.apply(_this, [__this]); } ]); });
        },
        close_all : function () {
            if(this.locked) return this.error("LOCKED");
            var _this = this;
            jQuery(this.container).find("li.open").each( function () { _this.close_branch(this, true); });
        },
        show_lang : function (i) {
            if(this.locked) return this.error("LOCKED");
            if(this.settings.languages[i] == this.current_lang) return true;
            var st = false;
            var id = this.container.attr("id") ? "#" + this.container.attr("id") : ".tree";
            st = get_css(id + " ." + this.current_lang, this.sn);
            if(st !== false) st.style.display = "none";
            st = get_css(id + " ." + this.settings.languages[i], this.sn);
            if(st !== false) st.style.display = "block";
            this.current_lang = this.settings.languages[i];
            return true;
        },
        cycle_lang : function() {
            if(this.locked) return this.error("LOCKED");
            var i = jQuery.inArray(this.current_lang, this.settings.languages);
            i ++;
            if(i > this.settings.languages.length - 1) i = 0;
            this.show_lang(i);
        },
        create : function (type, obj, data, icon, id ) {
            if(this.locked) return this.error("LOCKED");
            // NOTHING SELECTED
            obj = obj ? this.get_node(obj) : this.selected;
            if(!obj || !obj.size()) return this.error("CREATE: NO NODE SELECTED");
            if(!this.check("creatable", obj)) return this.error("CREATE: CANNOT CREATE IN NODE");

            var t = type || this.get_type(obj) || "";
            if(this.settings.rules.use_inline && this.settings.rules.metadata) {
                jQuery.metadata.setType("attr", this.settings.rules.metadata);
                if(typeof obj.metadata()["valid_children"] != "undefined") {
                    if(jQuery.inArray(t, obj.metadata()["valid_children"]) == -1) return this.error("CREATE: NODE NOT A VALID CHILD");
                }
                if(typeof obj.metadata()["max_children"] != "undefined") {
                    if( (obj.children("ul:eq(0)").children("li").size() + 1) > obj.metadata().max_children) return this.error("CREATE: MAX_CHILDREN REACHED");
                }
                var ok = true;
                obj.parents("li").each(function(i) {
                    if(jQuery(this).metadata().max_depth) {
                        if( (i + 1) >= jQuery(this).metadata().max_depth) {
                            ok = false;
                        }
                    }
                });
                if(!ok) return this.error("CREATE: MAX_DEPTH REACHED");
            }
            if(obj.hasClass("closed")) {
                var _this = this;
                return this.open_branch(obj, true, function () { _this.create.apply(_this, [type, obj, data, icon, id]); } );
            }

            if(id)    $li = jQuery("<li id='" + id + "' />");
            else    $li = jQuery("<li />");
            // NEW NODE IS OF PASSED TYPE OR PARENT'S TYPE
            if(this.settings.rules.metadata) {
                jQuery.metadata.setType("attr", this.settings.rules.metadata);
                $li.attr(this.settings.rules.metadata, "type: '" + t + "'");
            }
            else {
                $li.attr(this.settings.rules.type_attr, t)
            }

            var icn = "";
            if((typeof icon).toLowerCase() == "string") {
                icn = icon;
                icn = icn.indexOf("/") == -1 ? this.theme + icn : icn;
            }
            if(this.settings.languages.length) {
                for(i = 0; i < this.settings.languages.length; i++) {
                    if((typeof data).toLowerCase() == "string") val = data;
                    else if(data && data[i]) {
                        val = data[i];
                    }
                    else if(this.settings.lang.new_node) {
                        if((typeof this.settings.lang.new_node).toLowerCase() != "string" && this.settings.lang.new_node[i])
                            val = this.settings.lang.new_node[i];
                        else
                            val = this.settings.lang.new_node;
                    }
                    else {
                        val = "New folder";
                    }
                    if((typeof icon).toLowerCase() != "string" && icon && icon[i]) {
                        icn = icon[i];
                        icn = icn.indexOf("/") == -1 ? this.theme + icn : icn;
                    }
                    $li.append("<a href='#'" + ( icn.length ? " style='background-image:url(\"" + icn + "\");' " : " ") + "class='" + this.settings.languages[i] + "'>" + val + "</a>");
                }
            }
            else { $li.append("<a href='#'" + ( icn.length ? " style='background-image:url(\"" + icn + "\");' " : " ") + ">" + (data || this.settings.lang.new_node || "New folder") + "</a>"); }
            $li.addClass("leaf");
            if(this.settings.rules.createat == "top" || obj.children("ul").size() == 0) {
                this.moved($li,obj.children("a:eq(0)"),"inside", true);
            }
            else {
                this.moved($li,obj.children("ul:eq(0)").children("li:last").children("a:eq(0)"),"after",true);
            }
            this.select_branch($li.children("a:eq(0)"));
            if(!data) this.rename();
            return $li;
        },
        rename : function () {
            if(this.locked) return this.error("LOCKED");
            if(this.selected) {
                var _this = this;
                if(!this.check("renameable", this.selected)) return this.error("RENAME: NODE NOT RENAMABLE");
                if(!this.settings.callback.beforerename.call(null,this.selected.get(0), _this.current_lang, _this)) return this.error("RENAME: STOPPED BY USER");
                var obj = this.selected;
                if(this.current_lang)    obj = obj.find("a." + this.current_lang).get(0);
                else                    obj = obj.find("a:first").get(0);
                last_value = obj.innerHTML;
                _this.inp = jQuery("<input type='text' />");
                _this.inp
                    .val(last_value)
                    .bind("pointerdown",        function (event) { event.stopPropagation(); })
                    .bind("pointerup",        function (event) { event.stopPropagation(); })
                    .bind("click",            function (event) { event.stopPropagation(); })
                    .bind("keyup",            function (event) {
                            var key = event.keyCode || event.which;
                            if(key == 27) { this.value = last_value; this.blur(); return }
                            if(key == 13) { this.blur(); return }
                        });
                _this.inp.blur(function(event) {
                        if(this.value == "") this.value == last_value;
                        jQuery(obj).html( jQuery(obj).parent().find("input").eq(0).attr("value") ).get(0).style.display = "";
                        jQuery(obj).prevAll("span").remove();
                        if(this.value != last_value) _this.settings.callback.onrename.call(null, _this.get_node(obj).get(0), _this.current_lang, _this);
                        _this.inp = false;
                    });
                var spn = jQuery("<span />").addClass(obj.className).append(_this.inp);
                spn.attr("style", jQuery(obj).attr("style"));
                obj.style.display = "none";
                jQuery(obj).parent().prepend(spn);
                _this.inp.get(0).focus();
                _this.inp.get(0).select();
            }
            else return this.error("RENAME: NO NODE SELECTED");
        },
        // REMOVE NODES
        remove : function(obj) {
            if(this.locked) return this.error("LOCKED");
            if(obj) {
                obj = this.get_node(obj);
                if(obj.size()) {
                    if(!this.check("deletable", obj)) return this.error("DELETE: NODE NOT DELETABLE");
                    if(!this.settings.callback.beforedelete.call(null,obj.get(0), _this)) return this.error("DELETE: STOPPED BY USER");
                    $parent = obj.parent();
                    obj = obj.remove();
                    $parent.children("li:last").addClass("last");
                    if($parent.children("li").size() == 0) {
                        $li = $parent.parents("li:eq(0)");
                        $li.removeClass("open").removeClass("closed").addClass("leaf").children("ul").remove();
                        this.set_cookie("open");
                    }
                    this.settings.callback.ondelete.call(null, obj, this);
                }
            }
            else if(this.selected) {
                if(!this.check("deletable", this.selected)) return this.error("DELETE: NODE NOT DELETABLE");
                if(!this.settings.callback.beforedelete.call(null,this.selected.get(0), _this)) return this.error("DELETE: STOPPED BY USER");
                $parent = this.selected.parent();
                var obj = this.selected;
                if(this.settings.rules.multiple == false || this.selected_arr.length == 1) {
                    var stop = true;
                    var tmp = (this.selected.prev("li:eq(0)").size()) ? this.selected.prev("li:eq(0)") : this.selected.parents("li:eq(0)");
                    // this.get_prev(true);
                }
                obj = obj.remove();
                $parent.children("li:last").addClass("last");
                if($parent.children("li").size() == 0) {
                    $li = $parent.parents("li:eq(0)");
                    $li.removeClass("open").removeClass("closed").addClass("leaf").children("ul").remove();
                    this.set_cookie("open");
                }
                //this.selected = false;
                this.settings.callback.ondelete.call(null, obj, this);
                if(stop && tmp) this.select_branch(tmp);
                if(this.settings.rules.multiple != false && !stop) {
                    var _this = this;
                    this.selected_arr = [];
                    this.container.find("a.clicked").filter(":first-child").parent().each(function () {
                        _this.selected_arr.push(jQuery(this));
                    });
                    if(this.selected_arr.length > 0) {
                        this.selected = this.selected_arr[0];
                        this.remove();
                    }
                }
            }
            else return this.error("DELETE: NO NODE SELECTED");
        },
        // FOR EXPLORER-LIKE KEYBOARD SHORTCUTS
        get_next : function(force) {
            var obj = this.hovered || this.selected;
            if(obj) {
                if(obj.hasClass("open"))                        return force ? this.select_branch(obj.find("li:eq(0)")) : this.hover_branch(obj.find("li:eq(0)"));
                else if(jQuery(obj).nextAll("li").size() > 0)    return force ? this.select_branch(obj.nextAll("li:eq(0)")) : this.hover_branch(obj.nextAll("li:eq(0)"));
                else                                            return force ? this.select_branch(obj.parents("li").next("li").eq(0)) : this.hover_branch(obj.parents("li").next("li").eq(0));
            }
        },
        get_prev : function(force) {
            var obj = this.hovered || this.selected;
            if(obj) {
                if(obj.prev("li").size()) {
                    var obj = obj.prev("li").eq(0);
                    while(obj.hasClass("open")) obj = obj.children("ul:eq(0)").children("li:last");
                    return force ? this.select_branch(obj) : this.hover_branch(obj);
                }
                else { return force ? this.select_branch(obj.parents("li:eq(0)")) : this.hover_branch(obj.parents("li:eq(0)")); }
            }
        },
        get_left : function(force, rtl) {
            if(this.settings.ui.rtl && !rtl) return this.get_right(force, true);
            var obj = this.hovered || this.selected;
            if(obj) {
                if(obj.hasClass("open"))    this.close_branch(obj);
                else {
                    return force ? this.select_branch(obj.parents("li:eq(0)")) : this.hover_branch(obj.parents("li:eq(0)"));
                }
            }
        },
        get_right : function(force, rtl) {
            if(this.settings.ui.rtl && !rtl) return this.get_left(force, true);
            var obj = this.hovered || this.selected;
            if(obj) {
                if(obj.hasClass("closed"))    this.open_branch(obj);
                else {
                    return force ? this.select_branch(obj.find("li:eq(0)")) : this.hover_branch(obj.find("li:eq(0)"));
                }
            }
        },
        toggleDots : function () {
            this.container.toggleClass("no_dots");
        },
        set_cookie : function (type) {
            if(this.settings.cookies === false) return false;
            switch(type) {
                /*case "selected":
                    if(this.settings.rules.multiple != false && this.selected_arr.length > 1) {
                        var val = Array();
                        jQuery.each(this.selected_arr, function () {
                            val.push(this.attr("id"));
                        });
                        val = val.join(",");
                    }
                    else var val = this.selected ? this.selected.attr("id") : false;
                    jQuery.cookie(this.settings.cookies.prefix + '_selected',val,this.settings.cookies.opts);
                    break;*/
                case "open":
                    var str = "";
                    this.container.find("li.open").each(function (i) { str += this.id + ","; });
                    jQuery.cookie(this.settings.cookies.prefix + '_open',str.replace(/,$/ig,""),this.settings.cookies.opts);
                    break;
            }
        },
        moved : function (what, where, how, is_new, is_copy) {
            var what    = jQuery(what);
            var $parent    = jQuery(what).parents("ul:eq(0)");
            var $where    = jQuery(where);
            // IF MULTIPLE
            if(what.size() > 1) {
                var _this = this;
                var tmp = this.moved(what.eq(0),where,how, false, is_copy);
                what.each(function (i) {
                    if(i == 0) return;
                    tmp = _this.moved(this, tmp.children("a:eq(0)"), "after", false, is_copy);
                })
                return;
            }
            if(is_copy) {
                what = what.clone();
                what.each(function (i) {
                    this.id = this.id + "_copy";
                    jQuery(this).find("li").each(function () {
                        this.id = this.id + "_copy";
                    })
                    jQuery(this).find("a.clicked").removeClass("clicked");
                });
            }
            if(is_new) {
                if(!this.settings.callback.beforecreate.call(null,this.get_node(what).get(0), this.get_node(where).get(0),how,this)) return;
            }
            else {
                if(!this.settings.callback.beforemove.call(null,this.get_node(what).get(0), this.get_node(where).get(0),how,this)) return;
            }

            if(!is_new) {
                var tmp = jQuery(what).parents(".tree:eq(0)");
                // if different trees
                if(tmp.get(0) != this.container.get(0)) {
                    tmp = tree_component.inst[tmp.attr("id")];
                    // if there are languages - otherwise - no cleanup needed
                    if(tmp.settings.languages.length) {
                        var res = [];
                        // if new tree has no languages - use current visible
                        if(this.settings.languages.length == 0) res.push("." + tmp.current_lang);
                        else {
                            for(i in this.settings.languages) {
                                for(j in tmp.settings.languages) {
                                    if(this.settings.languages[i] == tmp.settings.languages[j]) res.push("." + this.settings.languages[i]);
                                }
                            }
                        }
                        if(res.length == 0) return this.error("MOVE: NO COMMON LANGUAGES");
                        what.find("a").removeClass("clicked").not(res.join(",")).remove();
                    }
                }
            }

            // ADD NODE TO NEW PLACE
            switch(how) {
                case "before":
                    $where.parents("ul:eq(0)").children("li.last").removeClass("last");
                    $where.parents("li:eq(0)").before(what.removeClass("last"));
                    $where.parents("ul:eq(0)").children("li:last").addClass("last");
                    break;
                case "after":
                    $where.parents("ul:eq(0)").children("li.last").removeClass("last");
                    $where.parents("li:eq(0)").after(what.removeClass("last"));
                    $where.parents("ul:eq(0)").children("li:last").addClass("last");
                    break;
                case "inside":
                    if(this.settings.data.async) {
                        var obj = this.get_node($where);
                        if(obj.hasClass("closed")) {
                            var _this = this;
                            return this.open_branch(obj, true, function () { _this.moved.apply(_this, [what, where, how, is_new, is_copy]); })
                        }
                    }
                    if($where.parents("li:eq(0)").children("ul:first").size()) {
                        if(this.settings.rules.createat == "top")    $where.parents("li:eq(0)").children("ul:first").prepend(what.removeClass("last")).children("li:last").addClass("last");
                        else                                        $where.parents("li:eq(0)").children("ul:first").children(".last").removeClass("last").end().append(what.removeClass("last")).children("li:last").addClass("last");
                    }
                    else {
                        what.addClass("last");
                        $where.parents("li:eq(0)").append("<ul/>").removeClass("leaf").addClass("closed");
                        $where.parents("li:eq(0)").children("ul:first").prepend(what);
                    }
                    if(!this.settings.data.async) {
                        this.open_branch($where);
                    }
                    break;
                default:
                    break;
            }
            // CLEANUP OLD PARENT
            if($parent.find("li").size() == 0) {
                var $li = $parent.parent();
                $li.removeClass("open").removeClass("closed").addClass("leaf").children("ul").remove();
                $li.parents("ul:eq(0)").children("li.last").removeClass("last").end().children("li:last").addClass("last");
                this.set_cookie("open");
            }
            else {
                $parent.children("li.last").removeClass("last");
                $parent.children("li:last").addClass("last");
            }
            if(is_new && how != "inside") where = this.get_node(where).parents("li:eq(0)");
            if(is_copy)        this.settings.callback.oncopy.call(null, this.get_node(what).get(0), this.get_node(where).get(0), how, this)
            else if(is_new)    this.settings.callback.oncreate.call(null, this.get_node(what).get(0), this.get_node(where).get(0), this.settings.insertAt, this);
            else            this.settings.callback.onmove.call(null, this.get_node(what).get(0), this.get_node(where).get(0), how, this);
            return what;
        },
        error : function (code) {
            this.settings.callback.error.call(null,code,this);
            return false;
        },
        lock : function (state) {
            this.locked = state;
            if(this.locked)    this.container.addClass("locked");
            else            this.container.removeClass("locked");
        },
        cut : function () {
            if(this.locked) return this.error("LOCKED");
            if(!this.selected) return this.error("CUT: NO NODE SELECTED");
            this.copy_nodes = false;
            this.cut_nodes = this.container.find("a.clicked").filter(":first-child").parent();
        },
        copy : function () {
            if(this.locked) return this.error("LOCKED");
            if(!this.selected) return this.error("COPY: NO NODE SELECTED");
            this.copy_nodes = this.container.find("a.clicked").filter(":first-child").parent();
            this.cut_nodes = false;
        },
        paste : function () {
            if(this.locked) return this.error("LOCKED");
            if(!this.selected) return this.error("PASTE: NO NODE SELECTED");
            if(!this.copy_nodes && !this.cut_nodes) return this.error("PASTE: NOTHING TO DO");
            if(this.copy_nodes && this.copy_nodes.size()) {
                if(!this.checkMove(this.copy_nodes, this.selected.children("a:eq(0)"), "inside")) return false;
                this.moved(this.copy_nodes, this.selected.children("a:eq(0)"), "inside", false, true);
                this.copy_nodes = false;
            }
            if(this.cut_nodes && this.cut_nodes.size()) {
                if(!this.checkMove(this.cut_nodes, this.selected.children("a:eq(0)"), "inside")) return false;
                this.moved(this.cut_nodes, this.selected.children("a:eq(0)"), "inside");
                this.cut_nodes = false;
            }
        },
        search : function(str) {
            var _this = this;
            if(!str || (this.srch && str != this.srch) ) {
                this.srch = "";
                this.srch_opn = false;
                this.container.find("a.search").removeClass("search");
            }
            this.srch = str;
            if(!str) return;
            if(this.settings.data.async) {
                if(!this.srch_opn) {
                    var dd = jQuery.extend( { "search" : str } , this.settings.data.async_data(false) );
                    jQuery.ajax({
                        type        : this.settings.data.method,
                        url            : this.settings.data.url,
                        data        : dd,
                        dataType    : "text",
                        success        : function (data) {
                            _this.srch_opn = jQuery.unique(data.split(","));
                            _this.search.apply(_this,[str]);
                        }
                    });
                }
                else if(this.srch_opn.length) {
                    if(this.srch_opn && this.srch_opn.length) {
                        var opn = false;
                        for(var j = 0; j < this.srch_opn.length; j++) {
                            if(this.get_node("#" + this.srch_opn[j]).size() > 0) {
                                opn = true;
                                var tmp = "#" + this.srch_opn[j];
                                delete this.srch_opn[j];
                                this.open_branch(tmp, true, function () { _this.search.apply(_this,[str]); } );
                            }
                        }
                        if(!opn) {
                            this.srch_opn = [];
                             _this.search.apply(_this,[str]);
                        }
                    }
                }
                else {
                    var selector = "a";
                    // IF LANGUAGE VERSIONS
                    if(this.settings.languages.length) selector += "." + this.current_lang;
                    this.container.find(selector + ":contains('" + str + "')").addClass("search");
                    this.srch_opn = false;
                }
            }
            else {
                var selector = "a";
                // IF LANGUAGE VERSIONS
                if(this.settings.languages.length) selector += "." + this.current_lang;
                this.container.find(selector + ":contains('" + str + "')").addClass("search").parents("li.closed").each( function () { _this.open_branch(this, true); });
            }
        },

        destroy : function() {
            try {
                var evts = ["click","dblclick","contextmenu","pointerover","pointerdown"];
                for(i in evts) {
                    var idxer = this.container.indexer(evts[i]);
                    idxer.stop();
                    jQuery.removeData( idxer.listener, idxer.event + '.indexer' );
                }
            } catch(err) { }
            this.container.unbind();

            this.container.removeClass("tree").children("ul").removeClass("tree-" + this.settings.ui.theme_name).find("li").removeClass("leaf").removeClass("open").removeClass("closed").removeClass("last").children("a").removeClass("clicked");

            if(this.cntr == tree_component.focused) {
                for(i in tree_component.inst) {
                    if(i != this.cntr && i != this.container.attr("id")) {
                        tree_component.inst[i].focus();
                        break;
                    }
                }
            }
            delete tree_component.inst[this.cntr];
            delete tree_component.inst[this.container.attr("id")];
            tree_component.cntr --;
        }
    }
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpxdWVyeS51aS5jdXN0b20uanMiLCJjbXMuY2hhbmdlbGlzdC5qcyIsIl9hbGwuanMiLCJ0cmVlX2NvbXBvbmVudC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDUEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3QzQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDOUpBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6ImJ1bmRsZS5hZG1pbi5jaGFuZ2VsaXN0Lm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qISBqUXVlcnkgVUkgLSB2MS4xMS40IC0gMjAxNS0wOS0wOVxuKiBodHRwOi8vanF1ZXJ5dWkuY29tXG4qIEluY2x1ZGVzOiBjb3JlLmpzLCB3aWRnZXQuanMsIG1vdXNlLmpzLCBzb3J0YWJsZS5qc1xuKiBDb3B5cmlnaHQgMjAxNSBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzOyBMaWNlbnNlZCBNSVQgKi9cblxuKGZ1bmN0aW9uKGUpe1wiZnVuY3Rpb25cIj09dHlwZW9mIGRlZmluZSYmZGVmaW5lLmFtZD9kZWZpbmUoW1wianF1ZXJ5XCJdLGUpOmUoalF1ZXJ5KX0pKGZ1bmN0aW9uKGUpe2Z1bmN0aW9uIHQodCxzKXt2YXIgbixhLG8scj10Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7cmV0dXJuXCJhcmVhXCI9PT1yPyhuPXQucGFyZW50Tm9kZSxhPW4ubmFtZSx0LmhyZWYmJmEmJlwibWFwXCI9PT1uLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk/KG89ZShcImltZ1t1c2VtYXA9JyNcIithK1wiJ11cIilbMF0sISFvJiZpKG8pKTohMSk6KC9eKGlucHV0fHNlbGVjdHx0ZXh0YXJlYXxidXR0b258b2JqZWN0KSQvLnRlc3Qocik/IXQuZGlzYWJsZWQ6XCJhXCI9PT1yP3QuaHJlZnx8czpzKSYmaSh0KX1mdW5jdGlvbiBpKHQpe3JldHVybiBlLmV4cHIuZmlsdGVycy52aXNpYmxlKHQpJiYhZSh0KS5wYXJlbnRzKCkuYWRkQmFjaygpLmZpbHRlcihmdW5jdGlvbigpe3JldHVyblwiaGlkZGVuXCI9PT1lLmNzcyh0aGlzLFwidmlzaWJpbGl0eVwiKX0pLmxlbmd0aH1lLnVpPWUudWl8fHt9LGUuZXh0ZW5kKGUudWkse3ZlcnNpb246XCIxLjExLjRcIixrZXlDb2RlOntCQUNLU1BBQ0U6OCxDT01NQToxODgsREVMRVRFOjQ2LERPV046NDAsRU5EOjM1LEVOVEVSOjEzLEVTQ0FQRToyNyxIT01FOjM2LExFRlQ6MzcsUEFHRV9ET1dOOjM0LFBBR0VfVVA6MzMsUEVSSU9EOjE5MCxSSUdIVDozOSxTUEFDRTozMixUQUI6OSxVUDozOH19KSxlLmZuLmV4dGVuZCh7c2Nyb2xsUGFyZW50OmZ1bmN0aW9uKHQpe3ZhciBpPXRoaXMuY3NzKFwicG9zaXRpb25cIikscz1cImFic29sdXRlXCI9PT1pLG49dD8vKGF1dG98c2Nyb2xsfGhpZGRlbikvOi8oYXV0b3xzY3JvbGwpLyxhPXRoaXMucGFyZW50cygpLmZpbHRlcihmdW5jdGlvbigpe3ZhciB0PWUodGhpcyk7cmV0dXJuIHMmJlwic3RhdGljXCI9PT10LmNzcyhcInBvc2l0aW9uXCIpPyExOm4udGVzdCh0LmNzcyhcIm92ZXJmbG93XCIpK3QuY3NzKFwib3ZlcmZsb3cteVwiKSt0LmNzcyhcIm92ZXJmbG93LXhcIikpfSkuZXEoMCk7cmV0dXJuXCJmaXhlZFwiIT09aSYmYS5sZW5ndGg/YTplKHRoaXNbMF0ub3duZXJEb2N1bWVudHx8ZG9jdW1lbnQpfSx1bmlxdWVJZDpmdW5jdGlvbigpe3ZhciBlPTA7cmV0dXJuIGZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpe3RoaXMuaWR8fCh0aGlzLmlkPVwidWktaWQtXCIrICsrZSl9KX19KCkscmVtb3ZlVW5pcXVlSWQ6ZnVuY3Rpb24oKXtyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7L151aS1pZC1cXGQrJC8udGVzdCh0aGlzLmlkKSYmZSh0aGlzKS5yZW1vdmVBdHRyKFwiaWRcIil9KX19KSxlLmV4dGVuZChlLmV4cHJbXCI6XCJdLHtkYXRhOmUuZXhwci5jcmVhdGVQc2V1ZG8/ZS5leHByLmNyZWF0ZVBzZXVkbyhmdW5jdGlvbih0KXtyZXR1cm4gZnVuY3Rpb24oaSl7cmV0dXJuISFlLmRhdGEoaSx0KX19KTpmdW5jdGlvbih0LGkscyl7cmV0dXJuISFlLmRhdGEodCxzWzNdKX0sZm9jdXNhYmxlOmZ1bmN0aW9uKGkpe3JldHVybiB0KGksIWlzTmFOKGUuYXR0cihpLFwidGFiaW5kZXhcIikpKX0sdGFiYmFibGU6ZnVuY3Rpb24oaSl7dmFyIHM9ZS5hdHRyKGksXCJ0YWJpbmRleFwiKSxuPWlzTmFOKHMpO3JldHVybihufHxzPj0wKSYmdChpLCFuKX19KSxlKFwiPGE+XCIpLm91dGVyV2lkdGgoMSkuanF1ZXJ5fHxlLmVhY2goW1wiV2lkdGhcIixcIkhlaWdodFwiXSxmdW5jdGlvbih0LGkpe2Z1bmN0aW9uIHModCxpLHMsYSl7cmV0dXJuIGUuZWFjaChuLGZ1bmN0aW9uKCl7aS09cGFyc2VGbG9hdChlLmNzcyh0LFwicGFkZGluZ1wiK3RoaXMpKXx8MCxzJiYoaS09cGFyc2VGbG9hdChlLmNzcyh0LFwiYm9yZGVyXCIrdGhpcytcIldpZHRoXCIpKXx8MCksYSYmKGktPXBhcnNlRmxvYXQoZS5jc3ModCxcIm1hcmdpblwiK3RoaXMpKXx8MCl9KSxpfXZhciBuPVwiV2lkdGhcIj09PWk/W1wiTGVmdFwiLFwiUmlnaHRcIl06W1wiVG9wXCIsXCJCb3R0b21cIl0sYT1pLnRvTG93ZXJDYXNlKCksbz17aW5uZXJXaWR0aDplLmZuLmlubmVyV2lkdGgsaW5uZXJIZWlnaHQ6ZS5mbi5pbm5lckhlaWdodCxvdXRlcldpZHRoOmUuZm4ub3V0ZXJXaWR0aCxvdXRlckhlaWdodDplLmZuLm91dGVySGVpZ2h0fTtlLmZuW1wiaW5uZXJcIitpXT1mdW5jdGlvbih0KXtyZXR1cm4gdm9pZCAwPT09dD9vW1wiaW5uZXJcIitpXS5jYWxsKHRoaXMpOnRoaXMuZWFjaChmdW5jdGlvbigpe2UodGhpcykuY3NzKGEscyh0aGlzLHQpK1wicHhcIil9KX0sZS5mbltcIm91dGVyXCIraV09ZnVuY3Rpb24odCxuKXtyZXR1cm5cIm51bWJlclwiIT10eXBlb2YgdD9vW1wib3V0ZXJcIitpXS5jYWxsKHRoaXMsdCk6dGhpcy5lYWNoKGZ1bmN0aW9uKCl7ZSh0aGlzKS5jc3MoYSxzKHRoaXMsdCwhMCxuKStcInB4XCIpfSl9fSksZS5mbi5hZGRCYWNrfHwoZS5mbi5hZGRCYWNrPWZ1bmN0aW9uKGUpe3JldHVybiB0aGlzLmFkZChudWxsPT1lP3RoaXMucHJldk9iamVjdDp0aGlzLnByZXZPYmplY3QuZmlsdGVyKGUpKX0pLGUoXCI8YT5cIikuZGF0YShcImEtYlwiLFwiYVwiKS5yZW1vdmVEYXRhKFwiYS1iXCIpLmRhdGEoXCJhLWJcIikmJihlLmZuLnJlbW92ZURhdGE9ZnVuY3Rpb24odCl7cmV0dXJuIGZ1bmN0aW9uKGkpe3JldHVybiBhcmd1bWVudHMubGVuZ3RoP3QuY2FsbCh0aGlzLGUuY2FtZWxDYXNlKGkpKTp0LmNhbGwodGhpcyl9fShlLmZuLnJlbW92ZURhdGEpKSxlLnVpLmllPSEhL21zaWUgW1xcdy5dKy8uZXhlYyhuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkpLGUuZm4uZXh0ZW5kKHtmb2N1czpmdW5jdGlvbih0KXtyZXR1cm4gZnVuY3Rpb24oaSxzKXtyZXR1cm5cIm51bWJlclwiPT10eXBlb2YgaT90aGlzLmVhY2goZnVuY3Rpb24oKXt2YXIgdD10aGlzO3NldFRpbWVvdXQoZnVuY3Rpb24oKXtlKHQpLmZvY3VzKCkscyYmcy5jYWxsKHQpfSxpKX0pOnQuYXBwbHkodGhpcyxhcmd1bWVudHMpfX0oZS5mbi5mb2N1cyksZGlzYWJsZVNlbGVjdGlvbjpmdW5jdGlvbigpe3ZhciBlPVwib25zZWxlY3RzdGFydFwiaW4gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKT9cInNlbGVjdHN0YXJ0XCI6XCJtb3VzZWRvd25cIjtyZXR1cm4gZnVuY3Rpb24oKXtyZXR1cm4gdGhpcy5iaW5kKGUrXCIudWktZGlzYWJsZVNlbGVjdGlvblwiLGZ1bmN0aW9uKGUpe2UucHJldmVudERlZmF1bHQoKX0pfX0oKSxlbmFibGVTZWxlY3Rpb246ZnVuY3Rpb24oKXtyZXR1cm4gdGhpcy51bmJpbmQoXCIudWktZGlzYWJsZVNlbGVjdGlvblwiKX0sekluZGV4OmZ1bmN0aW9uKHQpe2lmKHZvaWQgMCE9PXQpcmV0dXJuIHRoaXMuY3NzKFwiekluZGV4XCIsdCk7aWYodGhpcy5sZW5ndGgpZm9yKHZhciBpLHMsbj1lKHRoaXNbMF0pO24ubGVuZ3RoJiZuWzBdIT09ZG9jdW1lbnQ7KXtpZihpPW4uY3NzKFwicG9zaXRpb25cIiksKFwiYWJzb2x1dGVcIj09PWl8fFwicmVsYXRpdmVcIj09PWl8fFwiZml4ZWRcIj09PWkpJiYocz1wYXJzZUludChuLmNzcyhcInpJbmRleFwiKSwxMCksIWlzTmFOKHMpJiYwIT09cykpcmV0dXJuIHM7bj1uLnBhcmVudCgpfXJldHVybiAwfX0pLGUudWkucGx1Z2luPXthZGQ6ZnVuY3Rpb24odCxpLHMpe3ZhciBuLGE9ZS51aVt0XS5wcm90b3R5cGU7Zm9yKG4gaW4gcylhLnBsdWdpbnNbbl09YS5wbHVnaW5zW25dfHxbXSxhLnBsdWdpbnNbbl0ucHVzaChbaSxzW25dXSl9LGNhbGw6ZnVuY3Rpb24oZSx0LGkscyl7dmFyIG4sYT1lLnBsdWdpbnNbdF07aWYoYSYmKHN8fGUuZWxlbWVudFswXS5wYXJlbnROb2RlJiYxMSE9PWUuZWxlbWVudFswXS5wYXJlbnROb2RlLm5vZGVUeXBlKSlmb3Iobj0wO2EubGVuZ3RoPm47bisrKWUub3B0aW9uc1thW25dWzBdXSYmYVtuXVsxXS5hcHBseShlLmVsZW1lbnQsaSl9fTt2YXIgcz0wLG49QXJyYXkucHJvdG90eXBlLnNsaWNlO2UuY2xlYW5EYXRhPWZ1bmN0aW9uKHQpe3JldHVybiBmdW5jdGlvbihpKXt2YXIgcyxuLGE7Zm9yKGE9MDtudWxsIT0obj1pW2FdKTthKyspdHJ5e3M9ZS5fZGF0YShuLFwiZXZlbnRzXCIpLHMmJnMucmVtb3ZlJiZlKG4pLnRyaWdnZXJIYW5kbGVyKFwicmVtb3ZlXCIpfWNhdGNoKG8pe310KGkpfX0oZS5jbGVhbkRhdGEpLGUud2lkZ2V0PWZ1bmN0aW9uKHQsaSxzKXt2YXIgbixhLG8scixoPXt9LGw9dC5zcGxpdChcIi5cIilbMF07cmV0dXJuIHQ9dC5zcGxpdChcIi5cIilbMV0sbj1sK1wiLVwiK3Qsc3x8KHM9aSxpPWUuV2lkZ2V0KSxlLmV4cHJbXCI6XCJdW24udG9Mb3dlckNhc2UoKV09ZnVuY3Rpb24odCl7cmV0dXJuISFlLmRhdGEodCxuKX0sZVtsXT1lW2xdfHx7fSxhPWVbbF1bdF0sbz1lW2xdW3RdPWZ1bmN0aW9uKGUsdCl7cmV0dXJuIHRoaXMuX2NyZWF0ZVdpZGdldD8oYXJndW1lbnRzLmxlbmd0aCYmdGhpcy5fY3JlYXRlV2lkZ2V0KGUsdCksdm9pZCAwKTpuZXcgbyhlLHQpfSxlLmV4dGVuZChvLGEse3ZlcnNpb246cy52ZXJzaW9uLF9wcm90bzplLmV4dGVuZCh7fSxzKSxfY2hpbGRDb25zdHJ1Y3RvcnM6W119KSxyPW5ldyBpLHIub3B0aW9ucz1lLndpZGdldC5leHRlbmQoe30sci5vcHRpb25zKSxlLmVhY2gocyxmdW5jdGlvbih0LHMpe3JldHVybiBlLmlzRnVuY3Rpb24ocyk/KGhbdF09ZnVuY3Rpb24oKXt2YXIgZT1mdW5jdGlvbigpe3JldHVybiBpLnByb3RvdHlwZVt0XS5hcHBseSh0aGlzLGFyZ3VtZW50cyl9LG49ZnVuY3Rpb24oZSl7cmV0dXJuIGkucHJvdG90eXBlW3RdLmFwcGx5KHRoaXMsZSl9O3JldHVybiBmdW5jdGlvbigpe3ZhciB0LGk9dGhpcy5fc3VwZXIsYT10aGlzLl9zdXBlckFwcGx5O3JldHVybiB0aGlzLl9zdXBlcj1lLHRoaXMuX3N1cGVyQXBwbHk9bix0PXMuYXBwbHkodGhpcyxhcmd1bWVudHMpLHRoaXMuX3N1cGVyPWksdGhpcy5fc3VwZXJBcHBseT1hLHR9fSgpLHZvaWQgMCk6KGhbdF09cyx2b2lkIDApfSksby5wcm90b3R5cGU9ZS53aWRnZXQuZXh0ZW5kKHIse3dpZGdldEV2ZW50UHJlZml4OmE/ci53aWRnZXRFdmVudFByZWZpeHx8dDp0fSxoLHtjb25zdHJ1Y3RvcjpvLG5hbWVzcGFjZTpsLHdpZGdldE5hbWU6dCx3aWRnZXRGdWxsTmFtZTpufSksYT8oZS5lYWNoKGEuX2NoaWxkQ29uc3RydWN0b3JzLGZ1bmN0aW9uKHQsaSl7dmFyIHM9aS5wcm90b3R5cGU7ZS53aWRnZXQocy5uYW1lc3BhY2UrXCIuXCIrcy53aWRnZXROYW1lLG8saS5fcHJvdG8pfSksZGVsZXRlIGEuX2NoaWxkQ29uc3RydWN0b3JzKTppLl9jaGlsZENvbnN0cnVjdG9ycy5wdXNoKG8pLGUud2lkZ2V0LmJyaWRnZSh0LG8pLG99LGUud2lkZ2V0LmV4dGVuZD1mdW5jdGlvbih0KXtmb3IodmFyIGkscyxhPW4uY2FsbChhcmd1bWVudHMsMSksbz0wLHI9YS5sZW5ndGg7cj5vO28rKylmb3IoaSBpbiBhW29dKXM9YVtvXVtpXSxhW29dLmhhc093blByb3BlcnR5KGkpJiZ2b2lkIDAhPT1zJiYodFtpXT1lLmlzUGxhaW5PYmplY3Qocyk/ZS5pc1BsYWluT2JqZWN0KHRbaV0pP2Uud2lkZ2V0LmV4dGVuZCh7fSx0W2ldLHMpOmUud2lkZ2V0LmV4dGVuZCh7fSxzKTpzKTtyZXR1cm4gdH0sZS53aWRnZXQuYnJpZGdlPWZ1bmN0aW9uKHQsaSl7dmFyIHM9aS5wcm90b3R5cGUud2lkZ2V0RnVsbE5hbWV8fHQ7ZS5mblt0XT1mdW5jdGlvbihhKXt2YXIgbz1cInN0cmluZ1wiPT10eXBlb2YgYSxyPW4uY2FsbChhcmd1bWVudHMsMSksaD10aGlzO3JldHVybiBvP3RoaXMuZWFjaChmdW5jdGlvbigpe3ZhciBpLG49ZS5kYXRhKHRoaXMscyk7cmV0dXJuXCJpbnN0YW5jZVwiPT09YT8oaD1uLCExKTpuP2UuaXNGdW5jdGlvbihuW2FdKSYmXCJfXCIhPT1hLmNoYXJBdCgwKT8oaT1uW2FdLmFwcGx5KG4sciksaSE9PW4mJnZvaWQgMCE9PWk/KGg9aSYmaS5qcXVlcnk/aC5wdXNoU3RhY2soaS5nZXQoKSk6aSwhMSk6dm9pZCAwKTplLmVycm9yKFwibm8gc3VjaCBtZXRob2QgJ1wiK2ErXCInIGZvciBcIit0K1wiIHdpZGdldCBpbnN0YW5jZVwiKTplLmVycm9yKFwiY2Fubm90IGNhbGwgbWV0aG9kcyBvbiBcIit0K1wiIHByaW9yIHRvIGluaXRpYWxpemF0aW9uOyBcIitcImF0dGVtcHRlZCB0byBjYWxsIG1ldGhvZCAnXCIrYStcIidcIil9KTooci5sZW5ndGgmJihhPWUud2lkZ2V0LmV4dGVuZC5hcHBseShudWxsLFthXS5jb25jYXQocikpKSx0aGlzLmVhY2goZnVuY3Rpb24oKXt2YXIgdD1lLmRhdGEodGhpcyxzKTt0Pyh0Lm9wdGlvbihhfHx7fSksdC5faW5pdCYmdC5faW5pdCgpKTplLmRhdGEodGhpcyxzLG5ldyBpKGEsdGhpcykpfSkpLGh9fSxlLldpZGdldD1mdW5jdGlvbigpe30sZS5XaWRnZXQuX2NoaWxkQ29uc3RydWN0b3JzPVtdLGUuV2lkZ2V0LnByb3RvdHlwZT17d2lkZ2V0TmFtZTpcIndpZGdldFwiLHdpZGdldEV2ZW50UHJlZml4OlwiXCIsZGVmYXVsdEVsZW1lbnQ6XCI8ZGl2PlwiLG9wdGlvbnM6e2Rpc2FibGVkOiExLGNyZWF0ZTpudWxsfSxfY3JlYXRlV2lkZ2V0OmZ1bmN0aW9uKHQsaSl7aT1lKGl8fHRoaXMuZGVmYXVsdEVsZW1lbnR8fHRoaXMpWzBdLHRoaXMuZWxlbWVudD1lKGkpLHRoaXMudXVpZD1zKyssdGhpcy5ldmVudE5hbWVzcGFjZT1cIi5cIit0aGlzLndpZGdldE5hbWUrdGhpcy51dWlkLHRoaXMuYmluZGluZ3M9ZSgpLHRoaXMuaG92ZXJhYmxlPWUoKSx0aGlzLmZvY3VzYWJsZT1lKCksaSE9PXRoaXMmJihlLmRhdGEoaSx0aGlzLndpZGdldEZ1bGxOYW1lLHRoaXMpLHRoaXMuX29uKCEwLHRoaXMuZWxlbWVudCx7cmVtb3ZlOmZ1bmN0aW9uKGUpe2UudGFyZ2V0PT09aSYmdGhpcy5kZXN0cm95KCl9fSksdGhpcy5kb2N1bWVudD1lKGkuc3R5bGU/aS5vd25lckRvY3VtZW50OmkuZG9jdW1lbnR8fGkpLHRoaXMud2luZG93PWUodGhpcy5kb2N1bWVudFswXS5kZWZhdWx0Vmlld3x8dGhpcy5kb2N1bWVudFswXS5wYXJlbnRXaW5kb3cpKSx0aGlzLm9wdGlvbnM9ZS53aWRnZXQuZXh0ZW5kKHt9LHRoaXMub3B0aW9ucyx0aGlzLl9nZXRDcmVhdGVPcHRpb25zKCksdCksdGhpcy5fY3JlYXRlKCksdGhpcy5fdHJpZ2dlcihcImNyZWF0ZVwiLG51bGwsdGhpcy5fZ2V0Q3JlYXRlRXZlbnREYXRhKCkpLHRoaXMuX2luaXQoKX0sX2dldENyZWF0ZU9wdGlvbnM6ZS5ub29wLF9nZXRDcmVhdGVFdmVudERhdGE6ZS5ub29wLF9jcmVhdGU6ZS5ub29wLF9pbml0OmUubm9vcCxkZXN0cm95OmZ1bmN0aW9uKCl7dGhpcy5fZGVzdHJveSgpLHRoaXMuZWxlbWVudC51bmJpbmQodGhpcy5ldmVudE5hbWVzcGFjZSkucmVtb3ZlRGF0YSh0aGlzLndpZGdldEZ1bGxOYW1lKS5yZW1vdmVEYXRhKGUuY2FtZWxDYXNlKHRoaXMud2lkZ2V0RnVsbE5hbWUpKSx0aGlzLndpZGdldCgpLnVuYmluZCh0aGlzLmV2ZW50TmFtZXNwYWNlKS5yZW1vdmVBdHRyKFwiYXJpYS1kaXNhYmxlZFwiKS5yZW1vdmVDbGFzcyh0aGlzLndpZGdldEZ1bGxOYW1lK1wiLWRpc2FibGVkIFwiK1widWktc3RhdGUtZGlzYWJsZWRcIiksdGhpcy5iaW5kaW5ncy51bmJpbmQodGhpcy5ldmVudE5hbWVzcGFjZSksdGhpcy5ob3ZlcmFibGUucmVtb3ZlQ2xhc3MoXCJ1aS1zdGF0ZS1ob3ZlclwiKSx0aGlzLmZvY3VzYWJsZS5yZW1vdmVDbGFzcyhcInVpLXN0YXRlLWZvY3VzXCIpfSxfZGVzdHJveTplLm5vb3Asd2lkZ2V0OmZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMuZWxlbWVudH0sb3B0aW9uOmZ1bmN0aW9uKHQsaSl7dmFyIHMsbixhLG89dDtpZigwPT09YXJndW1lbnRzLmxlbmd0aClyZXR1cm4gZS53aWRnZXQuZXh0ZW5kKHt9LHRoaXMub3B0aW9ucyk7aWYoXCJzdHJpbmdcIj09dHlwZW9mIHQpaWYobz17fSxzPXQuc3BsaXQoXCIuXCIpLHQ9cy5zaGlmdCgpLHMubGVuZ3RoKXtmb3Iobj1vW3RdPWUud2lkZ2V0LmV4dGVuZCh7fSx0aGlzLm9wdGlvbnNbdF0pLGE9MDtzLmxlbmd0aC0xPmE7YSsrKW5bc1thXV09bltzW2FdXXx8e30sbj1uW3NbYV1dO2lmKHQ9cy5wb3AoKSwxPT09YXJndW1lbnRzLmxlbmd0aClyZXR1cm4gdm9pZCAwPT09blt0XT9udWxsOm5bdF07blt0XT1pfWVsc2V7aWYoMT09PWFyZ3VtZW50cy5sZW5ndGgpcmV0dXJuIHZvaWQgMD09PXRoaXMub3B0aW9uc1t0XT9udWxsOnRoaXMub3B0aW9uc1t0XTtvW3RdPWl9cmV0dXJuIHRoaXMuX3NldE9wdGlvbnMobyksdGhpc30sX3NldE9wdGlvbnM6ZnVuY3Rpb24oZSl7dmFyIHQ7Zm9yKHQgaW4gZSl0aGlzLl9zZXRPcHRpb24odCxlW3RdKTtyZXR1cm4gdGhpc30sX3NldE9wdGlvbjpmdW5jdGlvbihlLHQpe3JldHVybiB0aGlzLm9wdGlvbnNbZV09dCxcImRpc2FibGVkXCI9PT1lJiYodGhpcy53aWRnZXQoKS50b2dnbGVDbGFzcyh0aGlzLndpZGdldEZ1bGxOYW1lK1wiLWRpc2FibGVkXCIsISF0KSx0JiYodGhpcy5ob3ZlcmFibGUucmVtb3ZlQ2xhc3MoXCJ1aS1zdGF0ZS1ob3ZlclwiKSx0aGlzLmZvY3VzYWJsZS5yZW1vdmVDbGFzcyhcInVpLXN0YXRlLWZvY3VzXCIpKSksdGhpc30sZW5hYmxlOmZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMuX3NldE9wdGlvbnMoe2Rpc2FibGVkOiExfSl9LGRpc2FibGU6ZnVuY3Rpb24oKXtyZXR1cm4gdGhpcy5fc2V0T3B0aW9ucyh7ZGlzYWJsZWQ6ITB9KX0sX29uOmZ1bmN0aW9uKHQsaSxzKXt2YXIgbixhPXRoaXM7XCJib29sZWFuXCIhPXR5cGVvZiB0JiYocz1pLGk9dCx0PSExKSxzPyhpPW49ZShpKSx0aGlzLmJpbmRpbmdzPXRoaXMuYmluZGluZ3MuYWRkKGkpKToocz1pLGk9dGhpcy5lbGVtZW50LG49dGhpcy53aWRnZXQoKSksZS5lYWNoKHMsZnVuY3Rpb24ocyxvKXtmdW5jdGlvbiByKCl7cmV0dXJuIHR8fGEub3B0aW9ucy5kaXNhYmxlZCE9PSEwJiYhZSh0aGlzKS5oYXNDbGFzcyhcInVpLXN0YXRlLWRpc2FibGVkXCIpPyhcInN0cmluZ1wiPT10eXBlb2Ygbz9hW29dOm8pLmFwcGx5KGEsYXJndW1lbnRzKTp2b2lkIDB9XCJzdHJpbmdcIiE9dHlwZW9mIG8mJihyLmd1aWQ9by5ndWlkPW8uZ3VpZHx8ci5ndWlkfHxlLmd1aWQrKyk7dmFyIGg9cy5tYXRjaCgvXihbXFx3Oi1dKilcXHMqKC4qKSQvKSxsPWhbMV0rYS5ldmVudE5hbWVzcGFjZSx1PWhbMl07dT9uLmRlbGVnYXRlKHUsbCxyKTppLmJpbmQobCxyKX0pfSxfb2ZmOmZ1bmN0aW9uKHQsaSl7aT0oaXx8XCJcIikuc3BsaXQoXCIgXCIpLmpvaW4odGhpcy5ldmVudE5hbWVzcGFjZStcIiBcIikrdGhpcy5ldmVudE5hbWVzcGFjZSx0LnVuYmluZChpKS51bmRlbGVnYXRlKGkpLHRoaXMuYmluZGluZ3M9ZSh0aGlzLmJpbmRpbmdzLm5vdCh0KS5nZXQoKSksdGhpcy5mb2N1c2FibGU9ZSh0aGlzLmZvY3VzYWJsZS5ub3QodCkuZ2V0KCkpLHRoaXMuaG92ZXJhYmxlPWUodGhpcy5ob3ZlcmFibGUubm90KHQpLmdldCgpKX0sX2RlbGF5OmZ1bmN0aW9uKGUsdCl7ZnVuY3Rpb24gaSgpe3JldHVybihcInN0cmluZ1wiPT10eXBlb2YgZT9zW2VdOmUpLmFwcGx5KHMsYXJndW1lbnRzKX12YXIgcz10aGlzO3JldHVybiBzZXRUaW1lb3V0KGksdHx8MCl9LF9ob3ZlcmFibGU6ZnVuY3Rpb24odCl7dGhpcy5ob3ZlcmFibGU9dGhpcy5ob3ZlcmFibGUuYWRkKHQpLHRoaXMuX29uKHQse21vdXNlZW50ZXI6ZnVuY3Rpb24odCl7ZSh0LmN1cnJlbnRUYXJnZXQpLmFkZENsYXNzKFwidWktc3RhdGUtaG92ZXJcIil9LG1vdXNlbGVhdmU6ZnVuY3Rpb24odCl7ZSh0LmN1cnJlbnRUYXJnZXQpLnJlbW92ZUNsYXNzKFwidWktc3RhdGUtaG92ZXJcIil9fSl9LF9mb2N1c2FibGU6ZnVuY3Rpb24odCl7dGhpcy5mb2N1c2FibGU9dGhpcy5mb2N1c2FibGUuYWRkKHQpLHRoaXMuX29uKHQse2ZvY3VzaW46ZnVuY3Rpb24odCl7ZSh0LmN1cnJlbnRUYXJnZXQpLmFkZENsYXNzKFwidWktc3RhdGUtZm9jdXNcIil9LGZvY3Vzb3V0OmZ1bmN0aW9uKHQpe2UodC5jdXJyZW50VGFyZ2V0KS5yZW1vdmVDbGFzcyhcInVpLXN0YXRlLWZvY3VzXCIpfX0pfSxfdHJpZ2dlcjpmdW5jdGlvbih0LGkscyl7dmFyIG4sYSxvPXRoaXMub3B0aW9uc1t0XTtpZihzPXN8fHt9LGk9ZS5FdmVudChpKSxpLnR5cGU9KHQ9PT10aGlzLndpZGdldEV2ZW50UHJlZml4P3Q6dGhpcy53aWRnZXRFdmVudFByZWZpeCt0KS50b0xvd2VyQ2FzZSgpLGkudGFyZ2V0PXRoaXMuZWxlbWVudFswXSxhPWkub3JpZ2luYWxFdmVudClmb3IobiBpbiBhKW4gaW4gaXx8KGlbbl09YVtuXSk7cmV0dXJuIHRoaXMuZWxlbWVudC50cmlnZ2VyKGkscyksIShlLmlzRnVuY3Rpb24obykmJm8uYXBwbHkodGhpcy5lbGVtZW50WzBdLFtpXS5jb25jYXQocykpPT09ITF8fGkuaXNEZWZhdWx0UHJldmVudGVkKCkpfX0sZS5lYWNoKHtzaG93OlwiZmFkZUluXCIsaGlkZTpcImZhZGVPdXRcIn0sZnVuY3Rpb24odCxpKXtlLldpZGdldC5wcm90b3R5cGVbXCJfXCIrdF09ZnVuY3Rpb24ocyxuLGEpe1wic3RyaW5nXCI9PXR5cGVvZiBuJiYobj17ZWZmZWN0Om59KTt2YXIgbyxyPW4/bj09PSEwfHxcIm51bWJlclwiPT10eXBlb2Ygbj9pOm4uZWZmZWN0fHxpOnQ7bj1ufHx7fSxcIm51bWJlclwiPT10eXBlb2YgbiYmKG49e2R1cmF0aW9uOm59KSxvPSFlLmlzRW1wdHlPYmplY3Qobiksbi5jb21wbGV0ZT1hLG4uZGVsYXkmJnMuZGVsYXkobi5kZWxheSksbyYmZS5lZmZlY3RzJiZlLmVmZmVjdHMuZWZmZWN0W3JdP3NbdF0obik6ciE9PXQmJnNbcl0/c1tyXShuLmR1cmF0aW9uLG4uZWFzaW5nLGEpOnMucXVldWUoZnVuY3Rpb24oaSl7ZSh0aGlzKVt0XSgpLGEmJmEuY2FsbChzWzBdKSxpKCl9KX19KSxlLndpZGdldDt2YXIgYT0hMTtlKGRvY3VtZW50KS5tb3VzZXVwKGZ1bmN0aW9uKCl7YT0hMX0pLGUud2lkZ2V0KFwidWkubW91c2VcIix7dmVyc2lvbjpcIjEuMTEuNFwiLG9wdGlvbnM6e2NhbmNlbDpcImlucHV0LHRleHRhcmVhLGJ1dHRvbixzZWxlY3Qsb3B0aW9uXCIsZGlzdGFuY2U6MSxkZWxheTowfSxfbW91c2VJbml0OmZ1bmN0aW9uKCl7dmFyIHQ9dGhpczt0aGlzLmVsZW1lbnQuYmluZChcIm1vdXNlZG93bi5cIit0aGlzLndpZGdldE5hbWUsZnVuY3Rpb24oZSl7cmV0dXJuIHQuX21vdXNlRG93bihlKX0pLmJpbmQoXCJjbGljay5cIit0aGlzLndpZGdldE5hbWUsZnVuY3Rpb24oaSl7cmV0dXJuITA9PT1lLmRhdGEoaS50YXJnZXQsdC53aWRnZXROYW1lK1wiLnByZXZlbnRDbGlja0V2ZW50XCIpPyhlLnJlbW92ZURhdGEoaS50YXJnZXQsdC53aWRnZXROYW1lK1wiLnByZXZlbnRDbGlja0V2ZW50XCIpLGkuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCksITEpOnZvaWQgMH0pLHRoaXMuc3RhcnRlZD0hMX0sX21vdXNlRGVzdHJveTpmdW5jdGlvbigpe3RoaXMuZWxlbWVudC51bmJpbmQoXCIuXCIrdGhpcy53aWRnZXROYW1lKSx0aGlzLl9tb3VzZU1vdmVEZWxlZ2F0ZSYmdGhpcy5kb2N1bWVudC51bmJpbmQoXCJtb3VzZW1vdmUuXCIrdGhpcy53aWRnZXROYW1lLHRoaXMuX21vdXNlTW92ZURlbGVnYXRlKS51bmJpbmQoXCJtb3VzZXVwLlwiK3RoaXMud2lkZ2V0TmFtZSx0aGlzLl9tb3VzZVVwRGVsZWdhdGUpfSxfbW91c2VEb3duOmZ1bmN0aW9uKHQpe2lmKCFhKXt0aGlzLl9tb3VzZU1vdmVkPSExLHRoaXMuX21vdXNlU3RhcnRlZCYmdGhpcy5fbW91c2VVcCh0KSx0aGlzLl9tb3VzZURvd25FdmVudD10O3ZhciBpPXRoaXMscz0xPT09dC53aGljaCxuPVwic3RyaW5nXCI9PXR5cGVvZiB0aGlzLm9wdGlvbnMuY2FuY2VsJiZ0LnRhcmdldC5ub2RlTmFtZT9lKHQudGFyZ2V0KS5jbG9zZXN0KHRoaXMub3B0aW9ucy5jYW5jZWwpLmxlbmd0aDohMTtyZXR1cm4gcyYmIW4mJnRoaXMuX21vdXNlQ2FwdHVyZSh0KT8odGhpcy5tb3VzZURlbGF5TWV0PSF0aGlzLm9wdGlvbnMuZGVsYXksdGhpcy5tb3VzZURlbGF5TWV0fHwodGhpcy5fbW91c2VEZWxheVRpbWVyPXNldFRpbWVvdXQoZnVuY3Rpb24oKXtpLm1vdXNlRGVsYXlNZXQ9ITB9LHRoaXMub3B0aW9ucy5kZWxheSkpLHRoaXMuX21vdXNlRGlzdGFuY2VNZXQodCkmJnRoaXMuX21vdXNlRGVsYXlNZXQodCkmJih0aGlzLl9tb3VzZVN0YXJ0ZWQ9dGhpcy5fbW91c2VTdGFydCh0KSE9PSExLCF0aGlzLl9tb3VzZVN0YXJ0ZWQpPyh0LnByZXZlbnREZWZhdWx0KCksITApOighMD09PWUuZGF0YSh0LnRhcmdldCx0aGlzLndpZGdldE5hbWUrXCIucHJldmVudENsaWNrRXZlbnRcIikmJmUucmVtb3ZlRGF0YSh0LnRhcmdldCx0aGlzLndpZGdldE5hbWUrXCIucHJldmVudENsaWNrRXZlbnRcIiksdGhpcy5fbW91c2VNb3ZlRGVsZWdhdGU9ZnVuY3Rpb24oZSl7cmV0dXJuIGkuX21vdXNlTW92ZShlKX0sdGhpcy5fbW91c2VVcERlbGVnYXRlPWZ1bmN0aW9uKGUpe3JldHVybiBpLl9tb3VzZVVwKGUpfSx0aGlzLmRvY3VtZW50LmJpbmQoXCJtb3VzZW1vdmUuXCIrdGhpcy53aWRnZXROYW1lLHRoaXMuX21vdXNlTW92ZURlbGVnYXRlKS5iaW5kKFwibW91c2V1cC5cIit0aGlzLndpZGdldE5hbWUsdGhpcy5fbW91c2VVcERlbGVnYXRlKSx0LnByZXZlbnREZWZhdWx0KCksYT0hMCwhMCkpOiEwfX0sX21vdXNlTW92ZTpmdW5jdGlvbih0KXtpZih0aGlzLl9tb3VzZU1vdmVkKXtpZihlLnVpLmllJiYoIWRvY3VtZW50LmRvY3VtZW50TW9kZXx8OT5kb2N1bWVudC5kb2N1bWVudE1vZGUpJiYhdC5idXR0b24pcmV0dXJuIHRoaXMuX21vdXNlVXAodCk7aWYoIXQud2hpY2gpcmV0dXJuIHRoaXMuX21vdXNlVXAodCl9cmV0dXJuKHQud2hpY2h8fHQuYnV0dG9uKSYmKHRoaXMuX21vdXNlTW92ZWQ9ITApLHRoaXMuX21vdXNlU3RhcnRlZD8odGhpcy5fbW91c2VEcmFnKHQpLHQucHJldmVudERlZmF1bHQoKSk6KHRoaXMuX21vdXNlRGlzdGFuY2VNZXQodCkmJnRoaXMuX21vdXNlRGVsYXlNZXQodCkmJih0aGlzLl9tb3VzZVN0YXJ0ZWQ9dGhpcy5fbW91c2VTdGFydCh0aGlzLl9tb3VzZURvd25FdmVudCx0KSE9PSExLHRoaXMuX21vdXNlU3RhcnRlZD90aGlzLl9tb3VzZURyYWcodCk6dGhpcy5fbW91c2VVcCh0KSksIXRoaXMuX21vdXNlU3RhcnRlZCl9LF9tb3VzZVVwOmZ1bmN0aW9uKHQpe3JldHVybiB0aGlzLmRvY3VtZW50LnVuYmluZChcIm1vdXNlbW92ZS5cIit0aGlzLndpZGdldE5hbWUsdGhpcy5fbW91c2VNb3ZlRGVsZWdhdGUpLnVuYmluZChcIm1vdXNldXAuXCIrdGhpcy53aWRnZXROYW1lLHRoaXMuX21vdXNlVXBEZWxlZ2F0ZSksdGhpcy5fbW91c2VTdGFydGVkJiYodGhpcy5fbW91c2VTdGFydGVkPSExLHQudGFyZ2V0PT09dGhpcy5fbW91c2VEb3duRXZlbnQudGFyZ2V0JiZlLmRhdGEodC50YXJnZXQsdGhpcy53aWRnZXROYW1lK1wiLnByZXZlbnRDbGlja0V2ZW50XCIsITApLHRoaXMuX21vdXNlU3RvcCh0KSksYT0hMSwhMX0sX21vdXNlRGlzdGFuY2VNZXQ6ZnVuY3Rpb24oZSl7cmV0dXJuIE1hdGgubWF4KE1hdGguYWJzKHRoaXMuX21vdXNlRG93bkV2ZW50LnBhZ2VYLWUucGFnZVgpLE1hdGguYWJzKHRoaXMuX21vdXNlRG93bkV2ZW50LnBhZ2VZLWUucGFnZVkpKT49dGhpcy5vcHRpb25zLmRpc3RhbmNlfSxfbW91c2VEZWxheU1ldDpmdW5jdGlvbigpe3JldHVybiB0aGlzLm1vdXNlRGVsYXlNZXR9LF9tb3VzZVN0YXJ0OmZ1bmN0aW9uKCl7fSxfbW91c2VEcmFnOmZ1bmN0aW9uKCl7fSxfbW91c2VTdG9wOmZ1bmN0aW9uKCl7fSxfbW91c2VDYXB0dXJlOmZ1bmN0aW9uKCl7cmV0dXJuITB9fSksZS53aWRnZXQoXCJ1aS5zb3J0YWJsZVwiLGUudWkubW91c2Use3ZlcnNpb246XCIxLjExLjRcIix3aWRnZXRFdmVudFByZWZpeDpcInNvcnRcIixyZWFkeTohMSxvcHRpb25zOnthcHBlbmRUbzpcInBhcmVudFwiLGF4aXM6ITEsY29ubmVjdFdpdGg6ITEsY29udGFpbm1lbnQ6ITEsY3Vyc29yOlwiYXV0b1wiLGN1cnNvckF0OiExLGRyb3BPbkVtcHR5OiEwLGZvcmNlUGxhY2Vob2xkZXJTaXplOiExLGZvcmNlSGVscGVyU2l6ZTohMSxncmlkOiExLGhhbmRsZTohMSxoZWxwZXI6XCJvcmlnaW5hbFwiLGl0ZW1zOlwiPiAqXCIsb3BhY2l0eTohMSxwbGFjZWhvbGRlcjohMSxyZXZlcnQ6ITEsc2Nyb2xsOiEwLHNjcm9sbFNlbnNpdGl2aXR5OjIwLHNjcm9sbFNwZWVkOjIwLHNjb3BlOlwiZGVmYXVsdFwiLHRvbGVyYW5jZTpcImludGVyc2VjdFwiLHpJbmRleDoxZTMsYWN0aXZhdGU6bnVsbCxiZWZvcmVTdG9wOm51bGwsY2hhbmdlOm51bGwsZGVhY3RpdmF0ZTpudWxsLG91dDpudWxsLG92ZXI6bnVsbCxyZWNlaXZlOm51bGwscmVtb3ZlOm51bGwsc29ydDpudWxsLHN0YXJ0Om51bGwsc3RvcDpudWxsLHVwZGF0ZTpudWxsfSxfaXNPdmVyQXhpczpmdW5jdGlvbihlLHQsaSl7cmV0dXJuIGU+PXQmJnQraT5lfSxfaXNGbG9hdGluZzpmdW5jdGlvbihlKXtyZXR1cm4vbGVmdHxyaWdodC8udGVzdChlLmNzcyhcImZsb2F0XCIpKXx8L2lubGluZXx0YWJsZS1jZWxsLy50ZXN0KGUuY3NzKFwiZGlzcGxheVwiKSl9LF9jcmVhdGU6ZnVuY3Rpb24oKXt0aGlzLmNvbnRhaW5lckNhY2hlPXt9LHRoaXMuZWxlbWVudC5hZGRDbGFzcyhcInVpLXNvcnRhYmxlXCIpLHRoaXMucmVmcmVzaCgpLHRoaXMub2Zmc2V0PXRoaXMuZWxlbWVudC5vZmZzZXQoKSx0aGlzLl9tb3VzZUluaXQoKSx0aGlzLl9zZXRIYW5kbGVDbGFzc05hbWUoKSx0aGlzLnJlYWR5PSEwfSxfc2V0T3B0aW9uOmZ1bmN0aW9uKGUsdCl7dGhpcy5fc3VwZXIoZSx0KSxcImhhbmRsZVwiPT09ZSYmdGhpcy5fc2V0SGFuZGxlQ2xhc3NOYW1lKCl9LF9zZXRIYW5kbGVDbGFzc05hbWU6ZnVuY3Rpb24oKXt0aGlzLmVsZW1lbnQuZmluZChcIi51aS1zb3J0YWJsZS1oYW5kbGVcIikucmVtb3ZlQ2xhc3MoXCJ1aS1zb3J0YWJsZS1oYW5kbGVcIiksZS5lYWNoKHRoaXMuaXRlbXMsZnVuY3Rpb24oKXsodGhpcy5pbnN0YW5jZS5vcHRpb25zLmhhbmRsZT90aGlzLml0ZW0uZmluZCh0aGlzLmluc3RhbmNlLm9wdGlvbnMuaGFuZGxlKTp0aGlzLml0ZW0pLmFkZENsYXNzKFwidWktc29ydGFibGUtaGFuZGxlXCIpfSl9LF9kZXN0cm95OmZ1bmN0aW9uKCl7dGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKFwidWktc29ydGFibGUgdWktc29ydGFibGUtZGlzYWJsZWRcIikuZmluZChcIi51aS1zb3J0YWJsZS1oYW5kbGVcIikucmVtb3ZlQ2xhc3MoXCJ1aS1zb3J0YWJsZS1oYW5kbGVcIiksdGhpcy5fbW91c2VEZXN0cm95KCk7Zm9yKHZhciBlPXRoaXMuaXRlbXMubGVuZ3RoLTE7ZT49MDtlLS0pdGhpcy5pdGVtc1tlXS5pdGVtLnJlbW92ZURhdGEodGhpcy53aWRnZXROYW1lK1wiLWl0ZW1cIik7cmV0dXJuIHRoaXN9LF9tb3VzZUNhcHR1cmU6ZnVuY3Rpb24odCxpKXt2YXIgcz1udWxsLG49ITEsYT10aGlzO3JldHVybiB0aGlzLnJldmVydGluZz8hMTp0aGlzLm9wdGlvbnMuZGlzYWJsZWR8fFwic3RhdGljXCI9PT10aGlzLm9wdGlvbnMudHlwZT8hMToodGhpcy5fcmVmcmVzaEl0ZW1zKHQpLGUodC50YXJnZXQpLnBhcmVudHMoKS5lYWNoKGZ1bmN0aW9uKCl7cmV0dXJuIGUuZGF0YSh0aGlzLGEud2lkZ2V0TmFtZStcIi1pdGVtXCIpPT09YT8ocz1lKHRoaXMpLCExKTp2b2lkIDB9KSxlLmRhdGEodC50YXJnZXQsYS53aWRnZXROYW1lK1wiLWl0ZW1cIik9PT1hJiYocz1lKHQudGFyZ2V0KSkscz8hdGhpcy5vcHRpb25zLmhhbmRsZXx8aXx8KGUodGhpcy5vcHRpb25zLmhhbmRsZSxzKS5maW5kKFwiKlwiKS5hZGRCYWNrKCkuZWFjaChmdW5jdGlvbigpe3RoaXM9PT10LnRhcmdldCYmKG49ITApfSksbik/KHRoaXMuY3VycmVudEl0ZW09cyx0aGlzLl9yZW1vdmVDdXJyZW50c0Zyb21JdGVtcygpLCEwKTohMTohMSl9LF9tb3VzZVN0YXJ0OmZ1bmN0aW9uKHQsaSxzKXt2YXIgbixhLG89dGhpcy5vcHRpb25zO2lmKHRoaXMuY3VycmVudENvbnRhaW5lcj10aGlzLHRoaXMucmVmcmVzaFBvc2l0aW9ucygpLHRoaXMuaGVscGVyPXRoaXMuX2NyZWF0ZUhlbHBlcih0KSx0aGlzLl9jYWNoZUhlbHBlclByb3BvcnRpb25zKCksdGhpcy5fY2FjaGVNYXJnaW5zKCksdGhpcy5zY3JvbGxQYXJlbnQ9dGhpcy5oZWxwZXIuc2Nyb2xsUGFyZW50KCksdGhpcy5vZmZzZXQ9dGhpcy5jdXJyZW50SXRlbS5vZmZzZXQoKSx0aGlzLm9mZnNldD17dG9wOnRoaXMub2Zmc2V0LnRvcC10aGlzLm1hcmdpbnMudG9wLGxlZnQ6dGhpcy5vZmZzZXQubGVmdC10aGlzLm1hcmdpbnMubGVmdH0sZS5leHRlbmQodGhpcy5vZmZzZXQse2NsaWNrOntsZWZ0OnQucGFnZVgtdGhpcy5vZmZzZXQubGVmdCx0b3A6dC5wYWdlWS10aGlzLm9mZnNldC50b3B9LHBhcmVudDp0aGlzLl9nZXRQYXJlbnRPZmZzZXQoKSxyZWxhdGl2ZTp0aGlzLl9nZXRSZWxhdGl2ZU9mZnNldCgpfSksdGhpcy5oZWxwZXIuY3NzKFwicG9zaXRpb25cIixcImFic29sdXRlXCIpLHRoaXMuY3NzUG9zaXRpb249dGhpcy5oZWxwZXIuY3NzKFwicG9zaXRpb25cIiksdGhpcy5vcmlnaW5hbFBvc2l0aW9uPXRoaXMuX2dlbmVyYXRlUG9zaXRpb24odCksdGhpcy5vcmlnaW5hbFBhZ2VYPXQucGFnZVgsdGhpcy5vcmlnaW5hbFBhZ2VZPXQucGFnZVksby5jdXJzb3JBdCYmdGhpcy5fYWRqdXN0T2Zmc2V0RnJvbUhlbHBlcihvLmN1cnNvckF0KSx0aGlzLmRvbVBvc2l0aW9uPXtwcmV2OnRoaXMuY3VycmVudEl0ZW0ucHJldigpWzBdLHBhcmVudDp0aGlzLmN1cnJlbnRJdGVtLnBhcmVudCgpWzBdfSx0aGlzLmhlbHBlclswXSE9PXRoaXMuY3VycmVudEl0ZW1bMF0mJnRoaXMuY3VycmVudEl0ZW0uaGlkZSgpLHRoaXMuX2NyZWF0ZVBsYWNlaG9sZGVyKCksby5jb250YWlubWVudCYmdGhpcy5fc2V0Q29udGFpbm1lbnQoKSxvLmN1cnNvciYmXCJhdXRvXCIhPT1vLmN1cnNvciYmKGE9dGhpcy5kb2N1bWVudC5maW5kKFwiYm9keVwiKSx0aGlzLnN0b3JlZEN1cnNvcj1hLmNzcyhcImN1cnNvclwiKSxhLmNzcyhcImN1cnNvclwiLG8uY3Vyc29yKSx0aGlzLnN0b3JlZFN0eWxlc2hlZXQ9ZShcIjxzdHlsZT4qeyBjdXJzb3I6IFwiK28uY3Vyc29yK1wiICFpbXBvcnRhbnQ7IH08L3N0eWxlPlwiKS5hcHBlbmRUbyhhKSksby5vcGFjaXR5JiYodGhpcy5oZWxwZXIuY3NzKFwib3BhY2l0eVwiKSYmKHRoaXMuX3N0b3JlZE9wYWNpdHk9dGhpcy5oZWxwZXIuY3NzKFwib3BhY2l0eVwiKSksdGhpcy5oZWxwZXIuY3NzKFwib3BhY2l0eVwiLG8ub3BhY2l0eSkpLG8uekluZGV4JiYodGhpcy5oZWxwZXIuY3NzKFwiekluZGV4XCIpJiYodGhpcy5fc3RvcmVkWkluZGV4PXRoaXMuaGVscGVyLmNzcyhcInpJbmRleFwiKSksdGhpcy5oZWxwZXIuY3NzKFwiekluZGV4XCIsby56SW5kZXgpKSx0aGlzLnNjcm9sbFBhcmVudFswXSE9PXRoaXMuZG9jdW1lbnRbMF0mJlwiSFRNTFwiIT09dGhpcy5zY3JvbGxQYXJlbnRbMF0udGFnTmFtZSYmKHRoaXMub3ZlcmZsb3dPZmZzZXQ9dGhpcy5zY3JvbGxQYXJlbnQub2Zmc2V0KCkpLHRoaXMuX3RyaWdnZXIoXCJzdGFydFwiLHQsdGhpcy5fdWlIYXNoKCkpLHRoaXMuX3ByZXNlcnZlSGVscGVyUHJvcG9ydGlvbnN8fHRoaXMuX2NhY2hlSGVscGVyUHJvcG9ydGlvbnMoKSwhcylmb3Iobj10aGlzLmNvbnRhaW5lcnMubGVuZ3RoLTE7bj49MDtuLS0pdGhpcy5jb250YWluZXJzW25dLl90cmlnZ2VyKFwiYWN0aXZhdGVcIix0LHRoaXMuX3VpSGFzaCh0aGlzKSk7cmV0dXJuIGUudWkuZGRtYW5hZ2VyJiYoZS51aS5kZG1hbmFnZXIuY3VycmVudD10aGlzKSxlLnVpLmRkbWFuYWdlciYmIW8uZHJvcEJlaGF2aW91ciYmZS51aS5kZG1hbmFnZXIucHJlcGFyZU9mZnNldHModGhpcyx0KSx0aGlzLmRyYWdnaW5nPSEwLHRoaXMuaGVscGVyLmFkZENsYXNzKFwidWktc29ydGFibGUtaGVscGVyXCIpLHRoaXMuX21vdXNlRHJhZyh0KSwhMH0sX21vdXNlRHJhZzpmdW5jdGlvbih0KXt2YXIgaSxzLG4sYSxvPXRoaXMub3B0aW9ucyxyPSExO2Zvcih0aGlzLnBvc2l0aW9uPXRoaXMuX2dlbmVyYXRlUG9zaXRpb24odCksdGhpcy5wb3NpdGlvbkFicz10aGlzLl9jb252ZXJ0UG9zaXRpb25UbyhcImFic29sdXRlXCIpLHRoaXMubGFzdFBvc2l0aW9uQWJzfHwodGhpcy5sYXN0UG9zaXRpb25BYnM9dGhpcy5wb3NpdGlvbkFicyksdGhpcy5vcHRpb25zLnNjcm9sbCYmKHRoaXMuc2Nyb2xsUGFyZW50WzBdIT09dGhpcy5kb2N1bWVudFswXSYmXCJIVE1MXCIhPT10aGlzLnNjcm9sbFBhcmVudFswXS50YWdOYW1lPyh0aGlzLm92ZXJmbG93T2Zmc2V0LnRvcCt0aGlzLnNjcm9sbFBhcmVudFswXS5vZmZzZXRIZWlnaHQtdC5wYWdlWTxvLnNjcm9sbFNlbnNpdGl2aXR5P3RoaXMuc2Nyb2xsUGFyZW50WzBdLnNjcm9sbFRvcD1yPXRoaXMuc2Nyb2xsUGFyZW50WzBdLnNjcm9sbFRvcCtvLnNjcm9sbFNwZWVkOnQucGFnZVktdGhpcy5vdmVyZmxvd09mZnNldC50b3A8by5zY3JvbGxTZW5zaXRpdml0eSYmKHRoaXMuc2Nyb2xsUGFyZW50WzBdLnNjcm9sbFRvcD1yPXRoaXMuc2Nyb2xsUGFyZW50WzBdLnNjcm9sbFRvcC1vLnNjcm9sbFNwZWVkKSx0aGlzLm92ZXJmbG93T2Zmc2V0LmxlZnQrdGhpcy5zY3JvbGxQYXJlbnRbMF0ub2Zmc2V0V2lkdGgtdC5wYWdlWDxvLnNjcm9sbFNlbnNpdGl2aXR5P3RoaXMuc2Nyb2xsUGFyZW50WzBdLnNjcm9sbExlZnQ9cj10aGlzLnNjcm9sbFBhcmVudFswXS5zY3JvbGxMZWZ0K28uc2Nyb2xsU3BlZWQ6dC5wYWdlWC10aGlzLm92ZXJmbG93T2Zmc2V0LmxlZnQ8by5zY3JvbGxTZW5zaXRpdml0eSYmKHRoaXMuc2Nyb2xsUGFyZW50WzBdLnNjcm9sbExlZnQ9cj10aGlzLnNjcm9sbFBhcmVudFswXS5zY3JvbGxMZWZ0LW8uc2Nyb2xsU3BlZWQpKToodC5wYWdlWS10aGlzLmRvY3VtZW50LnNjcm9sbFRvcCgpPG8uc2Nyb2xsU2Vuc2l0aXZpdHk/cj10aGlzLmRvY3VtZW50LnNjcm9sbFRvcCh0aGlzLmRvY3VtZW50LnNjcm9sbFRvcCgpLW8uc2Nyb2xsU3BlZWQpOnRoaXMud2luZG93LmhlaWdodCgpLSh0LnBhZ2VZLXRoaXMuZG9jdW1lbnQuc2Nyb2xsVG9wKCkpPG8uc2Nyb2xsU2Vuc2l0aXZpdHkmJihyPXRoaXMuZG9jdW1lbnQuc2Nyb2xsVG9wKHRoaXMuZG9jdW1lbnQuc2Nyb2xsVG9wKCkrby5zY3JvbGxTcGVlZCkpLHQucGFnZVgtdGhpcy5kb2N1bWVudC5zY3JvbGxMZWZ0KCk8by5zY3JvbGxTZW5zaXRpdml0eT9yPXRoaXMuZG9jdW1lbnQuc2Nyb2xsTGVmdCh0aGlzLmRvY3VtZW50LnNjcm9sbExlZnQoKS1vLnNjcm9sbFNwZWVkKTp0aGlzLndpbmRvdy53aWR0aCgpLSh0LnBhZ2VYLXRoaXMuZG9jdW1lbnQuc2Nyb2xsTGVmdCgpKTxvLnNjcm9sbFNlbnNpdGl2aXR5JiYocj10aGlzLmRvY3VtZW50LnNjcm9sbExlZnQodGhpcy5kb2N1bWVudC5zY3JvbGxMZWZ0KCkrby5zY3JvbGxTcGVlZCkpKSxyIT09ITEmJmUudWkuZGRtYW5hZ2VyJiYhby5kcm9wQmVoYXZpb3VyJiZlLnVpLmRkbWFuYWdlci5wcmVwYXJlT2Zmc2V0cyh0aGlzLHQpKSx0aGlzLnBvc2l0aW9uQWJzPXRoaXMuX2NvbnZlcnRQb3NpdGlvblRvKFwiYWJzb2x1dGVcIiksdGhpcy5vcHRpb25zLmF4aXMmJlwieVwiPT09dGhpcy5vcHRpb25zLmF4aXN8fCh0aGlzLmhlbHBlclswXS5zdHlsZS5sZWZ0PXRoaXMucG9zaXRpb24ubGVmdCtcInB4XCIpLHRoaXMub3B0aW9ucy5heGlzJiZcInhcIj09PXRoaXMub3B0aW9ucy5heGlzfHwodGhpcy5oZWxwZXJbMF0uc3R5bGUudG9wPXRoaXMucG9zaXRpb24udG9wK1wicHhcIiksaT10aGlzLml0ZW1zLmxlbmd0aC0xO2k+PTA7aS0tKWlmKHM9dGhpcy5pdGVtc1tpXSxuPXMuaXRlbVswXSxhPXRoaXMuX2ludGVyc2VjdHNXaXRoUG9pbnRlcihzKSxhJiZzLmluc3RhbmNlPT09dGhpcy5jdXJyZW50Q29udGFpbmVyJiZuIT09dGhpcy5jdXJyZW50SXRlbVswXSYmdGhpcy5wbGFjZWhvbGRlclsxPT09YT9cIm5leHRcIjpcInByZXZcIl0oKVswXSE9PW4mJiFlLmNvbnRhaW5zKHRoaXMucGxhY2Vob2xkZXJbMF0sbikmJihcInNlbWktZHluYW1pY1wiPT09dGhpcy5vcHRpb25zLnR5cGU/IWUuY29udGFpbnModGhpcy5lbGVtZW50WzBdLG4pOiEwKSl7aWYodGhpcy5kaXJlY3Rpb249MT09PWE/XCJkb3duXCI6XCJ1cFwiLFwicG9pbnRlclwiIT09dGhpcy5vcHRpb25zLnRvbGVyYW5jZSYmIXRoaXMuX2ludGVyc2VjdHNXaXRoU2lkZXMocykpYnJlYWs7dGhpcy5fcmVhcnJhbmdlKHQscyksdGhpcy5fdHJpZ2dlcihcImNoYW5nZVwiLHQsdGhpcy5fdWlIYXNoKCkpO2JyZWFrfXJldHVybiB0aGlzLl9jb250YWN0Q29udGFpbmVycyh0KSxlLnVpLmRkbWFuYWdlciYmZS51aS5kZG1hbmFnZXIuZHJhZyh0aGlzLHQpLHRoaXMuX3RyaWdnZXIoXCJzb3J0XCIsdCx0aGlzLl91aUhhc2goKSksdGhpcy5sYXN0UG9zaXRpb25BYnM9dGhpcy5wb3NpdGlvbkFicywhMX0sX21vdXNlU3RvcDpmdW5jdGlvbih0LGkpe2lmKHQpe2lmKGUudWkuZGRtYW5hZ2VyJiYhdGhpcy5vcHRpb25zLmRyb3BCZWhhdmlvdXImJmUudWkuZGRtYW5hZ2VyLmRyb3AodGhpcyx0KSx0aGlzLm9wdGlvbnMucmV2ZXJ0KXt2YXIgcz10aGlzLG49dGhpcy5wbGFjZWhvbGRlci5vZmZzZXQoKSxhPXRoaXMub3B0aW9ucy5heGlzLG89e307YSYmXCJ4XCIhPT1hfHwoby5sZWZ0PW4ubGVmdC10aGlzLm9mZnNldC5wYXJlbnQubGVmdC10aGlzLm1hcmdpbnMubGVmdCsodGhpcy5vZmZzZXRQYXJlbnRbMF09PT10aGlzLmRvY3VtZW50WzBdLmJvZHk/MDp0aGlzLm9mZnNldFBhcmVudFswXS5zY3JvbGxMZWZ0KSksYSYmXCJ5XCIhPT1hfHwoby50b3A9bi50b3AtdGhpcy5vZmZzZXQucGFyZW50LnRvcC10aGlzLm1hcmdpbnMudG9wKyh0aGlzLm9mZnNldFBhcmVudFswXT09PXRoaXMuZG9jdW1lbnRbMF0uYm9keT8wOnRoaXMub2Zmc2V0UGFyZW50WzBdLnNjcm9sbFRvcCkpLHRoaXMucmV2ZXJ0aW5nPSEwLGUodGhpcy5oZWxwZXIpLmFuaW1hdGUobyxwYXJzZUludCh0aGlzLm9wdGlvbnMucmV2ZXJ0LDEwKXx8NTAwLGZ1bmN0aW9uKCl7cy5fY2xlYXIodCl9KX1lbHNlIHRoaXMuX2NsZWFyKHQsaSk7cmV0dXJuITF9fSxjYW5jZWw6ZnVuY3Rpb24oKXtpZih0aGlzLmRyYWdnaW5nKXt0aGlzLl9tb3VzZVVwKHt0YXJnZXQ6bnVsbH0pLFwib3JpZ2luYWxcIj09PXRoaXMub3B0aW9ucy5oZWxwZXI/dGhpcy5jdXJyZW50SXRlbS5jc3ModGhpcy5fc3RvcmVkQ1NTKS5yZW1vdmVDbGFzcyhcInVpLXNvcnRhYmxlLWhlbHBlclwiKTp0aGlzLmN1cnJlbnRJdGVtLnNob3coKTtmb3IodmFyIHQ9dGhpcy5jb250YWluZXJzLmxlbmd0aC0xO3Q+PTA7dC0tKXRoaXMuY29udGFpbmVyc1t0XS5fdHJpZ2dlcihcImRlYWN0aXZhdGVcIixudWxsLHRoaXMuX3VpSGFzaCh0aGlzKSksdGhpcy5jb250YWluZXJzW3RdLmNvbnRhaW5lckNhY2hlLm92ZXImJih0aGlzLmNvbnRhaW5lcnNbdF0uX3RyaWdnZXIoXCJvdXRcIixudWxsLHRoaXMuX3VpSGFzaCh0aGlzKSksdGhpcy5jb250YWluZXJzW3RdLmNvbnRhaW5lckNhY2hlLm92ZXI9MCl9cmV0dXJuIHRoaXMucGxhY2Vob2xkZXImJih0aGlzLnBsYWNlaG9sZGVyWzBdLnBhcmVudE5vZGUmJnRoaXMucGxhY2Vob2xkZXJbMF0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0aGlzLnBsYWNlaG9sZGVyWzBdKSxcIm9yaWdpbmFsXCIhPT10aGlzLm9wdGlvbnMuaGVscGVyJiZ0aGlzLmhlbHBlciYmdGhpcy5oZWxwZXJbMF0ucGFyZW50Tm9kZSYmdGhpcy5oZWxwZXIucmVtb3ZlKCksZS5leHRlbmQodGhpcyx7aGVscGVyOm51bGwsZHJhZ2dpbmc6ITEscmV2ZXJ0aW5nOiExLF9ub0ZpbmFsU29ydDpudWxsfSksdGhpcy5kb21Qb3NpdGlvbi5wcmV2P2UodGhpcy5kb21Qb3NpdGlvbi5wcmV2KS5hZnRlcih0aGlzLmN1cnJlbnRJdGVtKTplKHRoaXMuZG9tUG9zaXRpb24ucGFyZW50KS5wcmVwZW5kKHRoaXMuY3VycmVudEl0ZW0pKSx0aGlzfSxzZXJpYWxpemU6ZnVuY3Rpb24odCl7dmFyIGk9dGhpcy5fZ2V0SXRlbXNBc2pRdWVyeSh0JiZ0LmNvbm5lY3RlZCkscz1bXTtyZXR1cm4gdD10fHx7fSxlKGkpLmVhY2goZnVuY3Rpb24oKXt2YXIgaT0oZSh0Lml0ZW18fHRoaXMpLmF0dHIodC5hdHRyaWJ1dGV8fFwiaWRcIil8fFwiXCIpLm1hdGNoKHQuZXhwcmVzc2lvbnx8LyguKylbXFwtPV9dKC4rKS8pO2kmJnMucHVzaCgodC5rZXl8fGlbMV0rXCJbXVwiKStcIj1cIisodC5rZXkmJnQuZXhwcmVzc2lvbj9pWzFdOmlbMl0pKX0pLCFzLmxlbmd0aCYmdC5rZXkmJnMucHVzaCh0LmtleStcIj1cIikscy5qb2luKFwiJlwiKX0sdG9BcnJheTpmdW5jdGlvbih0KXt2YXIgaT10aGlzLl9nZXRJdGVtc0FzalF1ZXJ5KHQmJnQuY29ubmVjdGVkKSxzPVtdO3JldHVybiB0PXR8fHt9LGkuZWFjaChmdW5jdGlvbigpe3MucHVzaChlKHQuaXRlbXx8dGhpcykuYXR0cih0LmF0dHJpYnV0ZXx8XCJpZFwiKXx8XCJcIil9KSxzfSxfaW50ZXJzZWN0c1dpdGg6ZnVuY3Rpb24oZSl7dmFyIHQ9dGhpcy5wb3NpdGlvbkFicy5sZWZ0LGk9dCt0aGlzLmhlbHBlclByb3BvcnRpb25zLndpZHRoLHM9dGhpcy5wb3NpdGlvbkFicy50b3Asbj1zK3RoaXMuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0LGE9ZS5sZWZ0LG89YStlLndpZHRoLHI9ZS50b3AsaD1yK2UuaGVpZ2h0LGw9dGhpcy5vZmZzZXQuY2xpY2sudG9wLHU9dGhpcy5vZmZzZXQuY2xpY2subGVmdCxkPVwieFwiPT09dGhpcy5vcHRpb25zLmF4aXN8fHMrbD5yJiZoPnMrbCxjPVwieVwiPT09dGhpcy5vcHRpb25zLmF4aXN8fHQrdT5hJiZvPnQrdSxwPWQmJmM7cmV0dXJuXCJwb2ludGVyXCI9PT10aGlzLm9wdGlvbnMudG9sZXJhbmNlfHx0aGlzLm9wdGlvbnMuZm9yY2VQb2ludGVyRm9yQ29udGFpbmVyc3x8XCJwb2ludGVyXCIhPT10aGlzLm9wdGlvbnMudG9sZXJhbmNlJiZ0aGlzLmhlbHBlclByb3BvcnRpb25zW3RoaXMuZmxvYXRpbmc/XCJ3aWR0aFwiOlwiaGVpZ2h0XCJdPmVbdGhpcy5mbG9hdGluZz9cIndpZHRoXCI6XCJoZWlnaHRcIl0/cDp0K3RoaXMuaGVscGVyUHJvcG9ydGlvbnMud2lkdGgvMj5hJiZvPmktdGhpcy5oZWxwZXJQcm9wb3J0aW9ucy53aWR0aC8yJiZzK3RoaXMuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0LzI+ciYmaD5uLXRoaXMuaGVscGVyUHJvcG9ydGlvbnMuaGVpZ2h0LzJ9LF9pbnRlcnNlY3RzV2l0aFBvaW50ZXI6ZnVuY3Rpb24oZSl7dmFyIHQ9XCJ4XCI9PT10aGlzLm9wdGlvbnMuYXhpc3x8dGhpcy5faXNPdmVyQXhpcyh0aGlzLnBvc2l0aW9uQWJzLnRvcCt0aGlzLm9mZnNldC5jbGljay50b3AsZS50b3AsZS5oZWlnaHQpLGk9XCJ5XCI9PT10aGlzLm9wdGlvbnMuYXhpc3x8dGhpcy5faXNPdmVyQXhpcyh0aGlzLnBvc2l0aW9uQWJzLmxlZnQrdGhpcy5vZmZzZXQuY2xpY2subGVmdCxlLmxlZnQsZS53aWR0aCkscz10JiZpLG49dGhpcy5fZ2V0RHJhZ1ZlcnRpY2FsRGlyZWN0aW9uKCksYT10aGlzLl9nZXREcmFnSG9yaXpvbnRhbERpcmVjdGlvbigpO3JldHVybiBzP3RoaXMuZmxvYXRpbmc/YSYmXCJyaWdodFwiPT09YXx8XCJkb3duXCI9PT1uPzI6MTpuJiYoXCJkb3duXCI9PT1uPzI6MSk6ITF9LF9pbnRlcnNlY3RzV2l0aFNpZGVzOmZ1bmN0aW9uKGUpe3ZhciB0PXRoaXMuX2lzT3ZlckF4aXModGhpcy5wb3NpdGlvbkFicy50b3ArdGhpcy5vZmZzZXQuY2xpY2sudG9wLGUudG9wK2UuaGVpZ2h0LzIsZS5oZWlnaHQpLGk9dGhpcy5faXNPdmVyQXhpcyh0aGlzLnBvc2l0aW9uQWJzLmxlZnQrdGhpcy5vZmZzZXQuY2xpY2subGVmdCxlLmxlZnQrZS53aWR0aC8yLGUud2lkdGgpLHM9dGhpcy5fZ2V0RHJhZ1ZlcnRpY2FsRGlyZWN0aW9uKCksbj10aGlzLl9nZXREcmFnSG9yaXpvbnRhbERpcmVjdGlvbigpO3JldHVybiB0aGlzLmZsb2F0aW5nJiZuP1wicmlnaHRcIj09PW4mJml8fFwibGVmdFwiPT09biYmIWk6cyYmKFwiZG93blwiPT09cyYmdHx8XCJ1cFwiPT09cyYmIXQpfSxfZ2V0RHJhZ1ZlcnRpY2FsRGlyZWN0aW9uOmZ1bmN0aW9uKCl7dmFyIGU9dGhpcy5wb3NpdGlvbkFicy50b3AtdGhpcy5sYXN0UG9zaXRpb25BYnMudG9wO3JldHVybiAwIT09ZSYmKGU+MD9cImRvd25cIjpcInVwXCIpfSxfZ2V0RHJhZ0hvcml6b250YWxEaXJlY3Rpb246ZnVuY3Rpb24oKXt2YXIgZT10aGlzLnBvc2l0aW9uQWJzLmxlZnQtdGhpcy5sYXN0UG9zaXRpb25BYnMubGVmdDtyZXR1cm4gMCE9PWUmJihlPjA/XCJyaWdodFwiOlwibGVmdFwiKX0scmVmcmVzaDpmdW5jdGlvbihlKXtyZXR1cm4gdGhpcy5fcmVmcmVzaEl0ZW1zKGUpLHRoaXMuX3NldEhhbmRsZUNsYXNzTmFtZSgpLHRoaXMucmVmcmVzaFBvc2l0aW9ucygpLHRoaXN9LF9jb25uZWN0V2l0aDpmdW5jdGlvbigpe3ZhciBlPXRoaXMub3B0aW9ucztyZXR1cm4gZS5jb25uZWN0V2l0aC5jb25zdHJ1Y3Rvcj09PVN0cmluZz9bZS5jb25uZWN0V2l0aF06ZS5jb25uZWN0V2l0aH0sX2dldEl0ZW1zQXNqUXVlcnk6ZnVuY3Rpb24odCl7ZnVuY3Rpb24gaSgpe3IucHVzaCh0aGlzKX12YXIgcyxuLGEsbyxyPVtdLGg9W10sbD10aGlzLl9jb25uZWN0V2l0aCgpO2lmKGwmJnQpZm9yKHM9bC5sZW5ndGgtMTtzPj0wO3MtLSlmb3IoYT1lKGxbc10sdGhpcy5kb2N1bWVudFswXSksbj1hLmxlbmd0aC0xO24+PTA7bi0tKW89ZS5kYXRhKGFbbl0sdGhpcy53aWRnZXRGdWxsTmFtZSksbyYmbyE9PXRoaXMmJiFvLm9wdGlvbnMuZGlzYWJsZWQmJmgucHVzaChbZS5pc0Z1bmN0aW9uKG8ub3B0aW9ucy5pdGVtcyk/by5vcHRpb25zLml0ZW1zLmNhbGwoby5lbGVtZW50KTplKG8ub3B0aW9ucy5pdGVtcyxvLmVsZW1lbnQpLm5vdChcIi51aS1zb3J0YWJsZS1oZWxwZXJcIikubm90KFwiLnVpLXNvcnRhYmxlLXBsYWNlaG9sZGVyXCIpLG9dKTtmb3IoaC5wdXNoKFtlLmlzRnVuY3Rpb24odGhpcy5vcHRpb25zLml0ZW1zKT90aGlzLm9wdGlvbnMuaXRlbXMuY2FsbCh0aGlzLmVsZW1lbnQsbnVsbCx7b3B0aW9uczp0aGlzLm9wdGlvbnMsaXRlbTp0aGlzLmN1cnJlbnRJdGVtfSk6ZSh0aGlzLm9wdGlvbnMuaXRlbXMsdGhpcy5lbGVtZW50KS5ub3QoXCIudWktc29ydGFibGUtaGVscGVyXCIpLm5vdChcIi51aS1zb3J0YWJsZS1wbGFjZWhvbGRlclwiKSx0aGlzXSkscz1oLmxlbmd0aC0xO3M+PTA7cy0tKWhbc11bMF0uZWFjaChpKTtyZXR1cm4gZShyKX0sX3JlbW92ZUN1cnJlbnRzRnJvbUl0ZW1zOmZ1bmN0aW9uKCl7dmFyIHQ9dGhpcy5jdXJyZW50SXRlbS5maW5kKFwiOmRhdGEoXCIrdGhpcy53aWRnZXROYW1lK1wiLWl0ZW0pXCIpO3RoaXMuaXRlbXM9ZS5ncmVwKHRoaXMuaXRlbXMsZnVuY3Rpb24oZSl7Zm9yKHZhciBpPTA7dC5sZW5ndGg+aTtpKyspaWYodFtpXT09PWUuaXRlbVswXSlyZXR1cm4hMTtyZXR1cm4hMH0pfSxfcmVmcmVzaEl0ZW1zOmZ1bmN0aW9uKHQpe3RoaXMuaXRlbXM9W10sdGhpcy5jb250YWluZXJzPVt0aGlzXTt2YXIgaSxzLG4sYSxvLHIsaCxsLHU9dGhpcy5pdGVtcyxkPVtbZS5pc0Z1bmN0aW9uKHRoaXMub3B0aW9ucy5pdGVtcyk/dGhpcy5vcHRpb25zLml0ZW1zLmNhbGwodGhpcy5lbGVtZW50WzBdLHQse2l0ZW06dGhpcy5jdXJyZW50SXRlbX0pOmUodGhpcy5vcHRpb25zLml0ZW1zLHRoaXMuZWxlbWVudCksdGhpc11dLGM9dGhpcy5fY29ubmVjdFdpdGgoKTtpZihjJiZ0aGlzLnJlYWR5KWZvcihpPWMubGVuZ3RoLTE7aT49MDtpLS0pZm9yKG49ZShjW2ldLHRoaXMuZG9jdW1lbnRbMF0pLHM9bi5sZW5ndGgtMTtzPj0wO3MtLSlhPWUuZGF0YShuW3NdLHRoaXMud2lkZ2V0RnVsbE5hbWUpLGEmJmEhPT10aGlzJiYhYS5vcHRpb25zLmRpc2FibGVkJiYoZC5wdXNoKFtlLmlzRnVuY3Rpb24oYS5vcHRpb25zLml0ZW1zKT9hLm9wdGlvbnMuaXRlbXMuY2FsbChhLmVsZW1lbnRbMF0sdCx7aXRlbTp0aGlzLmN1cnJlbnRJdGVtfSk6ZShhLm9wdGlvbnMuaXRlbXMsYS5lbGVtZW50KSxhXSksdGhpcy5jb250YWluZXJzLnB1c2goYSkpO2ZvcihpPWQubGVuZ3RoLTE7aT49MDtpLS0pZm9yKG89ZFtpXVsxXSxyPWRbaV1bMF0scz0wLGw9ci5sZW5ndGg7bD5zO3MrKyloPWUocltzXSksaC5kYXRhKHRoaXMud2lkZ2V0TmFtZStcIi1pdGVtXCIsbyksdS5wdXNoKHtpdGVtOmgsaW5zdGFuY2U6byx3aWR0aDowLGhlaWdodDowLGxlZnQ6MCx0b3A6MH0pfSxyZWZyZXNoUG9zaXRpb25zOmZ1bmN0aW9uKHQpe3RoaXMuZmxvYXRpbmc9dGhpcy5pdGVtcy5sZW5ndGg/XCJ4XCI9PT10aGlzLm9wdGlvbnMuYXhpc3x8dGhpcy5faXNGbG9hdGluZyh0aGlzLml0ZW1zWzBdLml0ZW0pOiExLHRoaXMub2Zmc2V0UGFyZW50JiZ0aGlzLmhlbHBlciYmKHRoaXMub2Zmc2V0LnBhcmVudD10aGlzLl9nZXRQYXJlbnRPZmZzZXQoKSk7dmFyIGkscyxuLGE7Zm9yKGk9dGhpcy5pdGVtcy5sZW5ndGgtMTtpPj0wO2ktLSlzPXRoaXMuaXRlbXNbaV0scy5pbnN0YW5jZSE9PXRoaXMuY3VycmVudENvbnRhaW5lciYmdGhpcy5jdXJyZW50Q29udGFpbmVyJiZzLml0ZW1bMF0hPT10aGlzLmN1cnJlbnRJdGVtWzBdfHwobj10aGlzLm9wdGlvbnMudG9sZXJhbmNlRWxlbWVudD9lKHRoaXMub3B0aW9ucy50b2xlcmFuY2VFbGVtZW50LHMuaXRlbSk6cy5pdGVtLHR8fChzLndpZHRoPW4ub3V0ZXJXaWR0aCgpLHMuaGVpZ2h0PW4ub3V0ZXJIZWlnaHQoKSksYT1uLm9mZnNldCgpLHMubGVmdD1hLmxlZnQscy50b3A9YS50b3ApO2lmKHRoaXMub3B0aW9ucy5jdXN0b20mJnRoaXMub3B0aW9ucy5jdXN0b20ucmVmcmVzaENvbnRhaW5lcnMpdGhpcy5vcHRpb25zLmN1c3RvbS5yZWZyZXNoQ29udGFpbmVycy5jYWxsKHRoaXMpO2Vsc2UgZm9yKGk9dGhpcy5jb250YWluZXJzLmxlbmd0aC0xO2k+PTA7aS0tKWE9dGhpcy5jb250YWluZXJzW2ldLmVsZW1lbnQub2Zmc2V0KCksdGhpcy5jb250YWluZXJzW2ldLmNvbnRhaW5lckNhY2hlLmxlZnQ9YS5sZWZ0LHRoaXMuY29udGFpbmVyc1tpXS5jb250YWluZXJDYWNoZS50b3A9YS50b3AsdGhpcy5jb250YWluZXJzW2ldLmNvbnRhaW5lckNhY2hlLndpZHRoPXRoaXMuY29udGFpbmVyc1tpXS5lbGVtZW50Lm91dGVyV2lkdGgoKSx0aGlzLmNvbnRhaW5lcnNbaV0uY29udGFpbmVyQ2FjaGUuaGVpZ2h0PXRoaXMuY29udGFpbmVyc1tpXS5lbGVtZW50Lm91dGVySGVpZ2h0KCk7cmV0dXJuIHRoaXN9LF9jcmVhdGVQbGFjZWhvbGRlcjpmdW5jdGlvbih0KXt0PXR8fHRoaXM7dmFyIGkscz10Lm9wdGlvbnM7cy5wbGFjZWhvbGRlciYmcy5wbGFjZWhvbGRlci5jb25zdHJ1Y3RvciE9PVN0cmluZ3x8KGk9cy5wbGFjZWhvbGRlcixzLnBsYWNlaG9sZGVyPXtlbGVtZW50OmZ1bmN0aW9uKCl7dmFyIHM9dC5jdXJyZW50SXRlbVswXS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLG49ZShcIjxcIitzK1wiPlwiLHQuZG9jdW1lbnRbMF0pLmFkZENsYXNzKGl8fHQuY3VycmVudEl0ZW1bMF0uY2xhc3NOYW1lK1wiIHVpLXNvcnRhYmxlLXBsYWNlaG9sZGVyXCIpLnJlbW92ZUNsYXNzKFwidWktc29ydGFibGUtaGVscGVyXCIpO3JldHVyblwidGJvZHlcIj09PXM/dC5fY3JlYXRlVHJQbGFjZWhvbGRlcih0LmN1cnJlbnRJdGVtLmZpbmQoXCJ0clwiKS5lcSgwKSxlKFwiPHRyPlwiLHQuZG9jdW1lbnRbMF0pLmFwcGVuZFRvKG4pKTpcInRyXCI9PT1zP3QuX2NyZWF0ZVRyUGxhY2Vob2xkZXIodC5jdXJyZW50SXRlbSxuKTpcImltZ1wiPT09cyYmbi5hdHRyKFwic3JjXCIsdC5jdXJyZW50SXRlbS5hdHRyKFwic3JjXCIpKSxpfHxuLmNzcyhcInZpc2liaWxpdHlcIixcImhpZGRlblwiKSxufSx1cGRhdGU6ZnVuY3Rpb24oZSxuKXsoIWl8fHMuZm9yY2VQbGFjZWhvbGRlclNpemUpJiYobi5oZWlnaHQoKXx8bi5oZWlnaHQodC5jdXJyZW50SXRlbS5pbm5lckhlaWdodCgpLXBhcnNlSW50KHQuY3VycmVudEl0ZW0uY3NzKFwicGFkZGluZ1RvcFwiKXx8MCwxMCktcGFyc2VJbnQodC5jdXJyZW50SXRlbS5jc3MoXCJwYWRkaW5nQm90dG9tXCIpfHwwLDEwKSksbi53aWR0aCgpfHxuLndpZHRoKHQuY3VycmVudEl0ZW0uaW5uZXJXaWR0aCgpLXBhcnNlSW50KHQuY3VycmVudEl0ZW0uY3NzKFwicGFkZGluZ0xlZnRcIil8fDAsMTApLXBhcnNlSW50KHQuY3VycmVudEl0ZW0uY3NzKFwicGFkZGluZ1JpZ2h0XCIpfHwwLDEwKSkpfX0pLHQucGxhY2Vob2xkZXI9ZShzLnBsYWNlaG9sZGVyLmVsZW1lbnQuY2FsbCh0LmVsZW1lbnQsdC5jdXJyZW50SXRlbSkpLHQuY3VycmVudEl0ZW0uYWZ0ZXIodC5wbGFjZWhvbGRlcikscy5wbGFjZWhvbGRlci51cGRhdGUodCx0LnBsYWNlaG9sZGVyKX0sX2NyZWF0ZVRyUGxhY2Vob2xkZXI6ZnVuY3Rpb24odCxpKXt2YXIgcz10aGlzO3QuY2hpbGRyZW4oKS5lYWNoKGZ1bmN0aW9uKCl7ZShcIjx0ZD4mIzE2MDs8L3RkPlwiLHMuZG9jdW1lbnRbMF0pLmF0dHIoXCJjb2xzcGFuXCIsZSh0aGlzKS5hdHRyKFwiY29sc3BhblwiKXx8MSkuYXBwZW5kVG8oaSl9KX0sX2NvbnRhY3RDb250YWluZXJzOmZ1bmN0aW9uKHQpe3ZhciBpLHMsbixhLG8scixoLGwsdSxkLGM9bnVsbCxwPW51bGw7Zm9yKGk9dGhpcy5jb250YWluZXJzLmxlbmd0aC0xO2k+PTA7aS0tKWlmKCFlLmNvbnRhaW5zKHRoaXMuY3VycmVudEl0ZW1bMF0sdGhpcy5jb250YWluZXJzW2ldLmVsZW1lbnRbMF0pKWlmKHRoaXMuX2ludGVyc2VjdHNXaXRoKHRoaXMuY29udGFpbmVyc1tpXS5jb250YWluZXJDYWNoZSkpe2lmKGMmJmUuY29udGFpbnModGhpcy5jb250YWluZXJzW2ldLmVsZW1lbnRbMF0sYy5lbGVtZW50WzBdKSljb250aW51ZTtjPXRoaXMuY29udGFpbmVyc1tpXSxwPWl9ZWxzZSB0aGlzLmNvbnRhaW5lcnNbaV0uY29udGFpbmVyQ2FjaGUub3ZlciYmKHRoaXMuY29udGFpbmVyc1tpXS5fdHJpZ2dlcihcIm91dFwiLHQsdGhpcy5fdWlIYXNoKHRoaXMpKSx0aGlzLmNvbnRhaW5lcnNbaV0uY29udGFpbmVyQ2FjaGUub3Zlcj0wKTtpZihjKWlmKDE9PT10aGlzLmNvbnRhaW5lcnMubGVuZ3RoKXRoaXMuY29udGFpbmVyc1twXS5jb250YWluZXJDYWNoZS5vdmVyfHwodGhpcy5jb250YWluZXJzW3BdLl90cmlnZ2VyKFwib3ZlclwiLHQsdGhpcy5fdWlIYXNoKHRoaXMpKSx0aGlzLmNvbnRhaW5lcnNbcF0uY29udGFpbmVyQ2FjaGUub3Zlcj0xKTtlbHNle2ZvcihuPTFlNCxhPW51bGwsdT1jLmZsb2F0aW5nfHx0aGlzLl9pc0Zsb2F0aW5nKHRoaXMuY3VycmVudEl0ZW0pLG89dT9cImxlZnRcIjpcInRvcFwiLHI9dT9cIndpZHRoXCI6XCJoZWlnaHRcIixkPXU/XCJjbGllbnRYXCI6XCJjbGllbnRZXCIscz10aGlzLml0ZW1zLmxlbmd0aC0xO3M+PTA7cy0tKWUuY29udGFpbnModGhpcy5jb250YWluZXJzW3BdLmVsZW1lbnRbMF0sdGhpcy5pdGVtc1tzXS5pdGVtWzBdKSYmdGhpcy5pdGVtc1tzXS5pdGVtWzBdIT09dGhpcy5jdXJyZW50SXRlbVswXSYmKGg9dGhpcy5pdGVtc1tzXS5pdGVtLm9mZnNldCgpW29dLGw9ITEsdFtkXS1oPnRoaXMuaXRlbXNbc11bcl0vMiYmKGw9ITApLG4+TWF0aC5hYnModFtkXS1oKSYmKG49TWF0aC5hYnModFtkXS1oKSxhPXRoaXMuaXRlbXNbc10sdGhpcy5kaXJlY3Rpb249bD9cInVwXCI6XCJkb3duXCIpKTtpZighYSYmIXRoaXMub3B0aW9ucy5kcm9wT25FbXB0eSlyZXR1cm47aWYodGhpcy5jdXJyZW50Q29udGFpbmVyPT09dGhpcy5jb250YWluZXJzW3BdKXJldHVybiB0aGlzLmN1cnJlbnRDb250YWluZXIuY29udGFpbmVyQ2FjaGUub3Zlcnx8KHRoaXMuY29udGFpbmVyc1twXS5fdHJpZ2dlcihcIm92ZXJcIix0LHRoaXMuX3VpSGFzaCgpKSx0aGlzLmN1cnJlbnRDb250YWluZXIuY29udGFpbmVyQ2FjaGUub3Zlcj0xKSx2b2lkIDA7YT90aGlzLl9yZWFycmFuZ2UodCxhLG51bGwsITApOnRoaXMuX3JlYXJyYW5nZSh0LG51bGwsdGhpcy5jb250YWluZXJzW3BdLmVsZW1lbnQsITApLHRoaXMuX3RyaWdnZXIoXCJjaGFuZ2VcIix0LHRoaXMuX3VpSGFzaCgpKSx0aGlzLmNvbnRhaW5lcnNbcF0uX3RyaWdnZXIoXCJjaGFuZ2VcIix0LHRoaXMuX3VpSGFzaCh0aGlzKSksdGhpcy5jdXJyZW50Q29udGFpbmVyPXRoaXMuY29udGFpbmVyc1twXSx0aGlzLm9wdGlvbnMucGxhY2Vob2xkZXIudXBkYXRlKHRoaXMuY3VycmVudENvbnRhaW5lcix0aGlzLnBsYWNlaG9sZGVyKSx0aGlzLmNvbnRhaW5lcnNbcF0uX3RyaWdnZXIoXCJvdmVyXCIsdCx0aGlzLl91aUhhc2godGhpcykpLHRoaXMuY29udGFpbmVyc1twXS5jb250YWluZXJDYWNoZS5vdmVyPTF9fSxfY3JlYXRlSGVscGVyOmZ1bmN0aW9uKHQpe3ZhciBpPXRoaXMub3B0aW9ucyxzPWUuaXNGdW5jdGlvbihpLmhlbHBlcik/ZShpLmhlbHBlci5hcHBseSh0aGlzLmVsZW1lbnRbMF0sW3QsdGhpcy5jdXJyZW50SXRlbV0pKTpcImNsb25lXCI9PT1pLmhlbHBlcj90aGlzLmN1cnJlbnRJdGVtLmNsb25lKCk6dGhpcy5jdXJyZW50SXRlbTtyZXR1cm4gcy5wYXJlbnRzKFwiYm9keVwiKS5sZW5ndGh8fGUoXCJwYXJlbnRcIiE9PWkuYXBwZW5kVG8/aS5hcHBlbmRUbzp0aGlzLmN1cnJlbnRJdGVtWzBdLnBhcmVudE5vZGUpWzBdLmFwcGVuZENoaWxkKHNbMF0pLHNbMF09PT10aGlzLmN1cnJlbnRJdGVtWzBdJiYodGhpcy5fc3RvcmVkQ1NTPXt3aWR0aDp0aGlzLmN1cnJlbnRJdGVtWzBdLnN0eWxlLndpZHRoLGhlaWdodDp0aGlzLmN1cnJlbnRJdGVtWzBdLnN0eWxlLmhlaWdodCxwb3NpdGlvbjp0aGlzLmN1cnJlbnRJdGVtLmNzcyhcInBvc2l0aW9uXCIpLHRvcDp0aGlzLmN1cnJlbnRJdGVtLmNzcyhcInRvcFwiKSxsZWZ0OnRoaXMuY3VycmVudEl0ZW0uY3NzKFwibGVmdFwiKX0pLCghc1swXS5zdHlsZS53aWR0aHx8aS5mb3JjZUhlbHBlclNpemUpJiZzLndpZHRoKHRoaXMuY3VycmVudEl0ZW0ud2lkdGgoKSksKCFzWzBdLnN0eWxlLmhlaWdodHx8aS5mb3JjZUhlbHBlclNpemUpJiZzLmhlaWdodCh0aGlzLmN1cnJlbnRJdGVtLmhlaWdodCgpKSxzfSxfYWRqdXN0T2Zmc2V0RnJvbUhlbHBlcjpmdW5jdGlvbih0KXtcInN0cmluZ1wiPT10eXBlb2YgdCYmKHQ9dC5zcGxpdChcIiBcIikpLGUuaXNBcnJheSh0KSYmKHQ9e2xlZnQ6K3RbMF0sdG9wOit0WzFdfHwwfSksXCJsZWZ0XCJpbiB0JiYodGhpcy5vZmZzZXQuY2xpY2subGVmdD10LmxlZnQrdGhpcy5tYXJnaW5zLmxlZnQpLFwicmlnaHRcImluIHQmJih0aGlzLm9mZnNldC5jbGljay5sZWZ0PXRoaXMuaGVscGVyUHJvcG9ydGlvbnMud2lkdGgtdC5yaWdodCt0aGlzLm1hcmdpbnMubGVmdCksXCJ0b3BcImluIHQmJih0aGlzLm9mZnNldC5jbGljay50b3A9dC50b3ArdGhpcy5tYXJnaW5zLnRvcCksXCJib3R0b21cImluIHQmJih0aGlzLm9mZnNldC5jbGljay50b3A9dGhpcy5oZWxwZXJQcm9wb3J0aW9ucy5oZWlnaHQtdC5ib3R0b20rdGhpcy5tYXJnaW5zLnRvcCl9LF9nZXRQYXJlbnRPZmZzZXQ6ZnVuY3Rpb24oKXt0aGlzLm9mZnNldFBhcmVudD10aGlzLmhlbHBlci5vZmZzZXRQYXJlbnQoKTt2YXIgdD10aGlzLm9mZnNldFBhcmVudC5vZmZzZXQoKTtyZXR1cm5cImFic29sdXRlXCI9PT10aGlzLmNzc1Bvc2l0aW9uJiZ0aGlzLnNjcm9sbFBhcmVudFswXSE9PXRoaXMuZG9jdW1lbnRbMF0mJmUuY29udGFpbnModGhpcy5zY3JvbGxQYXJlbnRbMF0sdGhpcy5vZmZzZXRQYXJlbnRbMF0pJiYodC5sZWZ0Kz10aGlzLnNjcm9sbFBhcmVudC5zY3JvbGxMZWZ0KCksdC50b3ArPXRoaXMuc2Nyb2xsUGFyZW50LnNjcm9sbFRvcCgpKSwodGhpcy5vZmZzZXRQYXJlbnRbMF09PT10aGlzLmRvY3VtZW50WzBdLmJvZHl8fHRoaXMub2Zmc2V0UGFyZW50WzBdLnRhZ05hbWUmJlwiaHRtbFwiPT09dGhpcy5vZmZzZXRQYXJlbnRbMF0udGFnTmFtZS50b0xvd2VyQ2FzZSgpJiZlLnVpLmllKSYmKHQ9e3RvcDowLGxlZnQ6MH0pLHt0b3A6dC50b3ArKHBhcnNlSW50KHRoaXMub2Zmc2V0UGFyZW50LmNzcyhcImJvcmRlclRvcFdpZHRoXCIpLDEwKXx8MCksbGVmdDp0LmxlZnQrKHBhcnNlSW50KHRoaXMub2Zmc2V0UGFyZW50LmNzcyhcImJvcmRlckxlZnRXaWR0aFwiKSwxMCl8fDApfX0sX2dldFJlbGF0aXZlT2Zmc2V0OmZ1bmN0aW9uKCl7aWYoXCJyZWxhdGl2ZVwiPT09dGhpcy5jc3NQb3NpdGlvbil7dmFyIGU9dGhpcy5jdXJyZW50SXRlbS5wb3NpdGlvbigpO3JldHVybnt0b3A6ZS50b3AtKHBhcnNlSW50KHRoaXMuaGVscGVyLmNzcyhcInRvcFwiKSwxMCl8fDApK3RoaXMuc2Nyb2xsUGFyZW50LnNjcm9sbFRvcCgpLGxlZnQ6ZS5sZWZ0LShwYXJzZUludCh0aGlzLmhlbHBlci5jc3MoXCJsZWZ0XCIpLDEwKXx8MCkrdGhpcy5zY3JvbGxQYXJlbnQuc2Nyb2xsTGVmdCgpfX1yZXR1cm57dG9wOjAsbGVmdDowfX0sX2NhY2hlTWFyZ2luczpmdW5jdGlvbigpe3RoaXMubWFyZ2lucz17bGVmdDpwYXJzZUludCh0aGlzLmN1cnJlbnRJdGVtLmNzcyhcIm1hcmdpbkxlZnRcIiksMTApfHwwLHRvcDpwYXJzZUludCh0aGlzLmN1cnJlbnRJdGVtLmNzcyhcIm1hcmdpblRvcFwiKSwxMCl8fDB9fSxfY2FjaGVIZWxwZXJQcm9wb3J0aW9uczpmdW5jdGlvbigpe3RoaXMuaGVscGVyUHJvcG9ydGlvbnM9e3dpZHRoOnRoaXMuaGVscGVyLm91dGVyV2lkdGgoKSxoZWlnaHQ6dGhpcy5oZWxwZXIub3V0ZXJIZWlnaHQoKX19LF9zZXRDb250YWlubWVudDpmdW5jdGlvbigpe3ZhciB0LGkscyxuPXRoaXMub3B0aW9ucztcInBhcmVudFwiPT09bi5jb250YWlubWVudCYmKG4uY29udGFpbm1lbnQ9dGhpcy5oZWxwZXJbMF0ucGFyZW50Tm9kZSksKFwiZG9jdW1lbnRcIj09PW4uY29udGFpbm1lbnR8fFwid2luZG93XCI9PT1uLmNvbnRhaW5tZW50KSYmKHRoaXMuY29udGFpbm1lbnQ9WzAtdGhpcy5vZmZzZXQucmVsYXRpdmUubGVmdC10aGlzLm9mZnNldC5wYXJlbnQubGVmdCwwLXRoaXMub2Zmc2V0LnJlbGF0aXZlLnRvcC10aGlzLm9mZnNldC5wYXJlbnQudG9wLFwiZG9jdW1lbnRcIj09PW4uY29udGFpbm1lbnQ/dGhpcy5kb2N1bWVudC53aWR0aCgpOnRoaXMud2luZG93LndpZHRoKCktdGhpcy5oZWxwZXJQcm9wb3J0aW9ucy53aWR0aC10aGlzLm1hcmdpbnMubGVmdCwoXCJkb2N1bWVudFwiPT09bi5jb250YWlubWVudD90aGlzLmRvY3VtZW50LndpZHRoKCk6dGhpcy53aW5kb3cuaGVpZ2h0KCl8fHRoaXMuZG9jdW1lbnRbMF0uYm9keS5wYXJlbnROb2RlLnNjcm9sbEhlaWdodCktdGhpcy5oZWxwZXJQcm9wb3J0aW9ucy5oZWlnaHQtdGhpcy5tYXJnaW5zLnRvcF0pLC9eKGRvY3VtZW50fHdpbmRvd3xwYXJlbnQpJC8udGVzdChuLmNvbnRhaW5tZW50KXx8KHQ9ZShuLmNvbnRhaW5tZW50KVswXSxpPWUobi5jb250YWlubWVudCkub2Zmc2V0KCkscz1cImhpZGRlblwiIT09ZSh0KS5jc3MoXCJvdmVyZmxvd1wiKSx0aGlzLmNvbnRhaW5tZW50PVtpLmxlZnQrKHBhcnNlSW50KGUodCkuY3NzKFwiYm9yZGVyTGVmdFdpZHRoXCIpLDEwKXx8MCkrKHBhcnNlSW50KGUodCkuY3NzKFwicGFkZGluZ0xlZnRcIiksMTApfHwwKS10aGlzLm1hcmdpbnMubGVmdCxpLnRvcCsocGFyc2VJbnQoZSh0KS5jc3MoXCJib3JkZXJUb3BXaWR0aFwiKSwxMCl8fDApKyhwYXJzZUludChlKHQpLmNzcyhcInBhZGRpbmdUb3BcIiksMTApfHwwKS10aGlzLm1hcmdpbnMudG9wLGkubGVmdCsocz9NYXRoLm1heCh0LnNjcm9sbFdpZHRoLHQub2Zmc2V0V2lkdGgpOnQub2Zmc2V0V2lkdGgpLShwYXJzZUludChlKHQpLmNzcyhcImJvcmRlckxlZnRXaWR0aFwiKSwxMCl8fDApLShwYXJzZUludChlKHQpLmNzcyhcInBhZGRpbmdSaWdodFwiKSwxMCl8fDApLXRoaXMuaGVscGVyUHJvcG9ydGlvbnMud2lkdGgtdGhpcy5tYXJnaW5zLmxlZnQsaS50b3ArKHM/TWF0aC5tYXgodC5zY3JvbGxIZWlnaHQsdC5vZmZzZXRIZWlnaHQpOnQub2Zmc2V0SGVpZ2h0KS0ocGFyc2VJbnQoZSh0KS5jc3MoXCJib3JkZXJUb3BXaWR0aFwiKSwxMCl8fDApLShwYXJzZUludChlKHQpLmNzcyhcInBhZGRpbmdCb3R0b21cIiksMTApfHwwKS10aGlzLmhlbHBlclByb3BvcnRpb25zLmhlaWdodC10aGlzLm1hcmdpbnMudG9wXSlcbn0sX2NvbnZlcnRQb3NpdGlvblRvOmZ1bmN0aW9uKHQsaSl7aXx8KGk9dGhpcy5wb3NpdGlvbik7dmFyIHM9XCJhYnNvbHV0ZVwiPT09dD8xOi0xLG49XCJhYnNvbHV0ZVwiIT09dGhpcy5jc3NQb3NpdGlvbnx8dGhpcy5zY3JvbGxQYXJlbnRbMF0hPT10aGlzLmRvY3VtZW50WzBdJiZlLmNvbnRhaW5zKHRoaXMuc2Nyb2xsUGFyZW50WzBdLHRoaXMub2Zmc2V0UGFyZW50WzBdKT90aGlzLnNjcm9sbFBhcmVudDp0aGlzLm9mZnNldFBhcmVudCxhPS8oaHRtbHxib2R5KS9pLnRlc3QoblswXS50YWdOYW1lKTtyZXR1cm57dG9wOmkudG9wK3RoaXMub2Zmc2V0LnJlbGF0aXZlLnRvcCpzK3RoaXMub2Zmc2V0LnBhcmVudC50b3Aqcy0oXCJmaXhlZFwiPT09dGhpcy5jc3NQb3NpdGlvbj8tdGhpcy5zY3JvbGxQYXJlbnQuc2Nyb2xsVG9wKCk6YT8wOm4uc2Nyb2xsVG9wKCkpKnMsbGVmdDppLmxlZnQrdGhpcy5vZmZzZXQucmVsYXRpdmUubGVmdCpzK3RoaXMub2Zmc2V0LnBhcmVudC5sZWZ0KnMtKFwiZml4ZWRcIj09PXRoaXMuY3NzUG9zaXRpb24/LXRoaXMuc2Nyb2xsUGFyZW50LnNjcm9sbExlZnQoKTphPzA6bi5zY3JvbGxMZWZ0KCkpKnN9fSxfZ2VuZXJhdGVQb3NpdGlvbjpmdW5jdGlvbih0KXt2YXIgaSxzLG49dGhpcy5vcHRpb25zLGE9dC5wYWdlWCxvPXQucGFnZVkscj1cImFic29sdXRlXCIhPT10aGlzLmNzc1Bvc2l0aW9ufHx0aGlzLnNjcm9sbFBhcmVudFswXSE9PXRoaXMuZG9jdW1lbnRbMF0mJmUuY29udGFpbnModGhpcy5zY3JvbGxQYXJlbnRbMF0sdGhpcy5vZmZzZXRQYXJlbnRbMF0pP3RoaXMuc2Nyb2xsUGFyZW50OnRoaXMub2Zmc2V0UGFyZW50LGg9LyhodG1sfGJvZHkpL2kudGVzdChyWzBdLnRhZ05hbWUpO3JldHVyblwicmVsYXRpdmVcIiE9PXRoaXMuY3NzUG9zaXRpb258fHRoaXMuc2Nyb2xsUGFyZW50WzBdIT09dGhpcy5kb2N1bWVudFswXSYmdGhpcy5zY3JvbGxQYXJlbnRbMF0hPT10aGlzLm9mZnNldFBhcmVudFswXXx8KHRoaXMub2Zmc2V0LnJlbGF0aXZlPXRoaXMuX2dldFJlbGF0aXZlT2Zmc2V0KCkpLHRoaXMub3JpZ2luYWxQb3NpdGlvbiYmKHRoaXMuY29udGFpbm1lbnQmJih0LnBhZ2VYLXRoaXMub2Zmc2V0LmNsaWNrLmxlZnQ8dGhpcy5jb250YWlubWVudFswXSYmKGE9dGhpcy5jb250YWlubWVudFswXSt0aGlzLm9mZnNldC5jbGljay5sZWZ0KSx0LnBhZ2VZLXRoaXMub2Zmc2V0LmNsaWNrLnRvcDx0aGlzLmNvbnRhaW5tZW50WzFdJiYobz10aGlzLmNvbnRhaW5tZW50WzFdK3RoaXMub2Zmc2V0LmNsaWNrLnRvcCksdC5wYWdlWC10aGlzLm9mZnNldC5jbGljay5sZWZ0PnRoaXMuY29udGFpbm1lbnRbMl0mJihhPXRoaXMuY29udGFpbm1lbnRbMl0rdGhpcy5vZmZzZXQuY2xpY2subGVmdCksdC5wYWdlWS10aGlzLm9mZnNldC5jbGljay50b3A+dGhpcy5jb250YWlubWVudFszXSYmKG89dGhpcy5jb250YWlubWVudFszXSt0aGlzLm9mZnNldC5jbGljay50b3ApKSxuLmdyaWQmJihpPXRoaXMub3JpZ2luYWxQYWdlWStNYXRoLnJvdW5kKChvLXRoaXMub3JpZ2luYWxQYWdlWSkvbi5ncmlkWzFdKSpuLmdyaWRbMV0sbz10aGlzLmNvbnRhaW5tZW50P2ktdGhpcy5vZmZzZXQuY2xpY2sudG9wPj10aGlzLmNvbnRhaW5tZW50WzFdJiZpLXRoaXMub2Zmc2V0LmNsaWNrLnRvcDw9dGhpcy5jb250YWlubWVudFszXT9pOmktdGhpcy5vZmZzZXQuY2xpY2sudG9wPj10aGlzLmNvbnRhaW5tZW50WzFdP2ktbi5ncmlkWzFdOmkrbi5ncmlkWzFdOmkscz10aGlzLm9yaWdpbmFsUGFnZVgrTWF0aC5yb3VuZCgoYS10aGlzLm9yaWdpbmFsUGFnZVgpL24uZ3JpZFswXSkqbi5ncmlkWzBdLGE9dGhpcy5jb250YWlubWVudD9zLXRoaXMub2Zmc2V0LmNsaWNrLmxlZnQ+PXRoaXMuY29udGFpbm1lbnRbMF0mJnMtdGhpcy5vZmZzZXQuY2xpY2subGVmdDw9dGhpcy5jb250YWlubWVudFsyXT9zOnMtdGhpcy5vZmZzZXQuY2xpY2subGVmdD49dGhpcy5jb250YWlubWVudFswXT9zLW4uZ3JpZFswXTpzK24uZ3JpZFswXTpzKSkse3RvcDpvLXRoaXMub2Zmc2V0LmNsaWNrLnRvcC10aGlzLm9mZnNldC5yZWxhdGl2ZS50b3AtdGhpcy5vZmZzZXQucGFyZW50LnRvcCsoXCJmaXhlZFwiPT09dGhpcy5jc3NQb3NpdGlvbj8tdGhpcy5zY3JvbGxQYXJlbnQuc2Nyb2xsVG9wKCk6aD8wOnIuc2Nyb2xsVG9wKCkpLGxlZnQ6YS10aGlzLm9mZnNldC5jbGljay5sZWZ0LXRoaXMub2Zmc2V0LnJlbGF0aXZlLmxlZnQtdGhpcy5vZmZzZXQucGFyZW50LmxlZnQrKFwiZml4ZWRcIj09PXRoaXMuY3NzUG9zaXRpb24/LXRoaXMuc2Nyb2xsUGFyZW50LnNjcm9sbExlZnQoKTpoPzA6ci5zY3JvbGxMZWZ0KCkpfX0sX3JlYXJyYW5nZTpmdW5jdGlvbihlLHQsaSxzKXtpP2lbMF0uYXBwZW5kQ2hpbGQodGhpcy5wbGFjZWhvbGRlclswXSk6dC5pdGVtWzBdLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHRoaXMucGxhY2Vob2xkZXJbMF0sXCJkb3duXCI9PT10aGlzLmRpcmVjdGlvbj90Lml0ZW1bMF06dC5pdGVtWzBdLm5leHRTaWJsaW5nKSx0aGlzLmNvdW50ZXI9dGhpcy5jb3VudGVyPysrdGhpcy5jb3VudGVyOjE7dmFyIG49dGhpcy5jb3VudGVyO3RoaXMuX2RlbGF5KGZ1bmN0aW9uKCl7bj09PXRoaXMuY291bnRlciYmdGhpcy5yZWZyZXNoUG9zaXRpb25zKCFzKX0pfSxfY2xlYXI6ZnVuY3Rpb24oZSx0KXtmdW5jdGlvbiBpKGUsdCxpKXtyZXR1cm4gZnVuY3Rpb24ocyl7aS5fdHJpZ2dlcihlLHMsdC5fdWlIYXNoKHQpKX19dGhpcy5yZXZlcnRpbmc9ITE7dmFyIHMsbj1bXTtpZighdGhpcy5fbm9GaW5hbFNvcnQmJnRoaXMuY3VycmVudEl0ZW0ucGFyZW50KCkubGVuZ3RoJiZ0aGlzLnBsYWNlaG9sZGVyLmJlZm9yZSh0aGlzLmN1cnJlbnRJdGVtKSx0aGlzLl9ub0ZpbmFsU29ydD1udWxsLHRoaXMuaGVscGVyWzBdPT09dGhpcy5jdXJyZW50SXRlbVswXSl7Zm9yKHMgaW4gdGhpcy5fc3RvcmVkQ1NTKShcImF1dG9cIj09PXRoaXMuX3N0b3JlZENTU1tzXXx8XCJzdGF0aWNcIj09PXRoaXMuX3N0b3JlZENTU1tzXSkmJih0aGlzLl9zdG9yZWRDU1Nbc109XCJcIik7dGhpcy5jdXJyZW50SXRlbS5jc3ModGhpcy5fc3RvcmVkQ1NTKS5yZW1vdmVDbGFzcyhcInVpLXNvcnRhYmxlLWhlbHBlclwiKX1lbHNlIHRoaXMuY3VycmVudEl0ZW0uc2hvdygpO2Zvcih0aGlzLmZyb21PdXRzaWRlJiYhdCYmbi5wdXNoKGZ1bmN0aW9uKGUpe3RoaXMuX3RyaWdnZXIoXCJyZWNlaXZlXCIsZSx0aGlzLl91aUhhc2godGhpcy5mcm9tT3V0c2lkZSkpfSksIXRoaXMuZnJvbU91dHNpZGUmJnRoaXMuZG9tUG9zaXRpb24ucHJldj09PXRoaXMuY3VycmVudEl0ZW0ucHJldigpLm5vdChcIi51aS1zb3J0YWJsZS1oZWxwZXJcIilbMF0mJnRoaXMuZG9tUG9zaXRpb24ucGFyZW50PT09dGhpcy5jdXJyZW50SXRlbS5wYXJlbnQoKVswXXx8dHx8bi5wdXNoKGZ1bmN0aW9uKGUpe3RoaXMuX3RyaWdnZXIoXCJ1cGRhdGVcIixlLHRoaXMuX3VpSGFzaCgpKX0pLHRoaXMhPT10aGlzLmN1cnJlbnRDb250YWluZXImJih0fHwobi5wdXNoKGZ1bmN0aW9uKGUpe3RoaXMuX3RyaWdnZXIoXCJyZW1vdmVcIixlLHRoaXMuX3VpSGFzaCgpKX0pLG4ucHVzaChmdW5jdGlvbihlKXtyZXR1cm4gZnVuY3Rpb24odCl7ZS5fdHJpZ2dlcihcInJlY2VpdmVcIix0LHRoaXMuX3VpSGFzaCh0aGlzKSl9fS5jYWxsKHRoaXMsdGhpcy5jdXJyZW50Q29udGFpbmVyKSksbi5wdXNoKGZ1bmN0aW9uKGUpe3JldHVybiBmdW5jdGlvbih0KXtlLl90cmlnZ2VyKFwidXBkYXRlXCIsdCx0aGlzLl91aUhhc2godGhpcykpfX0uY2FsbCh0aGlzLHRoaXMuY3VycmVudENvbnRhaW5lcikpKSkscz10aGlzLmNvbnRhaW5lcnMubGVuZ3RoLTE7cz49MDtzLS0pdHx8bi5wdXNoKGkoXCJkZWFjdGl2YXRlXCIsdGhpcyx0aGlzLmNvbnRhaW5lcnNbc10pKSx0aGlzLmNvbnRhaW5lcnNbc10uY29udGFpbmVyQ2FjaGUub3ZlciYmKG4ucHVzaChpKFwib3V0XCIsdGhpcyx0aGlzLmNvbnRhaW5lcnNbc10pKSx0aGlzLmNvbnRhaW5lcnNbc10uY29udGFpbmVyQ2FjaGUub3Zlcj0wKTtpZih0aGlzLnN0b3JlZEN1cnNvciYmKHRoaXMuZG9jdW1lbnQuZmluZChcImJvZHlcIikuY3NzKFwiY3Vyc29yXCIsdGhpcy5zdG9yZWRDdXJzb3IpLHRoaXMuc3RvcmVkU3R5bGVzaGVldC5yZW1vdmUoKSksdGhpcy5fc3RvcmVkT3BhY2l0eSYmdGhpcy5oZWxwZXIuY3NzKFwib3BhY2l0eVwiLHRoaXMuX3N0b3JlZE9wYWNpdHkpLHRoaXMuX3N0b3JlZFpJbmRleCYmdGhpcy5oZWxwZXIuY3NzKFwiekluZGV4XCIsXCJhdXRvXCI9PT10aGlzLl9zdG9yZWRaSW5kZXg/XCJcIjp0aGlzLl9zdG9yZWRaSW5kZXgpLHRoaXMuZHJhZ2dpbmc9ITEsdHx8dGhpcy5fdHJpZ2dlcihcImJlZm9yZVN0b3BcIixlLHRoaXMuX3VpSGFzaCgpKSx0aGlzLnBsYWNlaG9sZGVyWzBdLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodGhpcy5wbGFjZWhvbGRlclswXSksdGhpcy5jYW5jZWxIZWxwZXJSZW1vdmFsfHwodGhpcy5oZWxwZXJbMF0hPT10aGlzLmN1cnJlbnRJdGVtWzBdJiZ0aGlzLmhlbHBlci5yZW1vdmUoKSx0aGlzLmhlbHBlcj1udWxsKSwhdCl7Zm9yKHM9MDtuLmxlbmd0aD5zO3MrKyluW3NdLmNhbGwodGhpcyxlKTt0aGlzLl90cmlnZ2VyKFwic3RvcFwiLGUsdGhpcy5fdWlIYXNoKCkpfXJldHVybiB0aGlzLmZyb21PdXRzaWRlPSExLCF0aGlzLmNhbmNlbEhlbHBlclJlbW92YWx9LF90cmlnZ2VyOmZ1bmN0aW9uKCl7ZS5XaWRnZXQucHJvdG90eXBlLl90cmlnZ2VyLmFwcGx5KHRoaXMsYXJndW1lbnRzKT09PSExJiZ0aGlzLmNhbmNlbCgpfSxfdWlIYXNoOmZ1bmN0aW9uKHQpe3ZhciBpPXR8fHRoaXM7cmV0dXJue2hlbHBlcjppLmhlbHBlcixwbGFjZWhvbGRlcjppLnBsYWNlaG9sZGVyfHxlKFtdKSxwb3NpdGlvbjppLnBvc2l0aW9uLG9yaWdpbmFsUG9zaXRpb246aS5vcmlnaW5hbFBvc2l0aW9uLG9mZnNldDppLnBvc2l0aW9uQWJzLGl0ZW06aS5jdXJyZW50SXRlbSxzZW5kZXI6dD90LmVsZW1lbnQ6bnVsbH19fSl9KTtcbiIsIi8vIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjXG4vLyAjQ0hBTkdFTElTVCNcbi8qIGdsb2JhbCBDTVMsIHRyZWVfY29tcG9uZW50ICovXG5cbihmdW5jdGlvbiAoJCkge1xuICAgICd1c2Ugc3RyaWN0JztcbiAgICAvLyBDTVMuJCB3aWxsIGJlIHBhc3NlZCBmb3IgJFxuICAgICQoZG9jdW1lbnQpLnJlYWR5KGZ1bmN0aW9uICgpIHtcblxuICAgICAgICAvKiFcbiAgICAgICAgICogVHJlZU1hbmFnZXJcbiAgICAgICAgICogSGFuZGxlcyB0cmVldmlld1xuICAgICAgICAgKiBUT0RPIHRoaXMgd2lsbCBiZSByZWZhY3RvcmVkIGluIDMuMlxuICAgICAgICAgKi9cbiAgICAgICAgQ01TLlRyZWVNYW5hZ2VyID0gbmV3IENNUy5DbGFzcyh7XG5cbiAgICAgICAgICAgIG9wdGlvbnM6IHtcbiAgICAgICAgICAgICAgICAnbGFuZyc6IHt9XG4gICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbiAob3B0aW9ucykge1xuICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucyA9ICQuZXh0ZW5kKHRydWUsIHt9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMpO1xuXG4gICAgICAgICAgICAgICAgLy8gbG9hZCBpbnRlcm5hbCBmdW5jdGlvbnNcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5zZXR0aW5ncy5maWx0ZXJlZCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldHVwRnVuY3Rpb25zKCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0dXBUcmVlUHVibGlzaGluZygpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldHVwVUlIYWNrcygpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldHVwR2xvYmFscygpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldHVwVHJlZSgpO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIGluaXQgdHJlZSBjb21wb25lbnRcbiAgICAgICAgICAgICAgICAgICAgd2luZG93LmluaXRUcmVlKCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gd2hlbiBmaWx0ZXJlZCBpcyBhY3RpdmUsIHByZXZlbnQgdHJlZSBhY3Rpb25zXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0dXBGdW5jdGlvbnMoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXR1cFVJSGFja3MoKTtcbiAgICAgICAgICAgICAgICAgICAgJC5zeW5jQ29scygpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG5cbiAgICAgICAgICAgIHNldHVwRnVuY3Rpb25zOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzO1xuXG4gICAgICAgICAgICAgICAgJC5zeW5jQ29scyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgJCgnI3NpdGVtYXAgLmNvbC1zb2Z0cm9vdCcpLnN5bmNXaWR0aCgwKTtcbiAgICAgICAgICAgICAgICAgICAgJCgnI3NpdGVtYXAgLmNvbC1hcHBob29rJykuc3luY1dpZHRoKDApO1xuICAgICAgICAgICAgICAgICAgICAkKCcjc2l0ZW1hcCAuY29sLWxhbmd1YWdlJykuc3luY1dpZHRoKDApO1xuICAgICAgICAgICAgICAgICAgICAkKCcjc2l0ZW1hcCAuY29sLW5hdmlnYXRpb24nKS5zeW5jV2lkdGgoMCk7XG4gICAgICAgICAgICAgICAgICAgICQoJyNzaXRlbWFwIC5jb2wtYWN0aW9ucycpLnN5bmNXaWR0aCgwKTtcbiAgICAgICAgICAgICAgICAgICAgJCgnI3NpdGVtYXAgLmNvbC1pbmZvJykuc3luY1dpZHRoKDApO1xuXG4gICAgICAgICAgICAgICAgICAgIHRoYXQucmVmcmVzaENvbHVtbnMuY2FsbCgkKCd1bC50cmVlLWRlZmF1bHQgbGknKSk7XG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIC8qIENvbHVtcyB3aWR0aCBzeW5jICovXG4gICAgICAgICAgICAgICAgJC5mbi5zeW5jV2lkdGggPSBmdW5jdGlvbiAobWF4KSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB2aXNpYmxlID0gZmFsc2U7XG5cbiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkKHRoaXMpLmlzKCc6dmlzaWJsZScpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlzaWJsZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbCA9ICQodGhpcykud2lkdGgoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsID4gbWF4KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heCA9IHZhbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBpZiAodmlzaWJsZSAmJiBtYXggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykuY3NzKCd3aWR0aCcsIG1heCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICAvLyBqcXVlcnkuZnVuY3Rpb25hbFxuICAgICAgICAgICAgICAgICQuY3VycnkgPSBmdW5jdGlvbiAoZm4pIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPCAyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSAkLm1ha2VBcnJheShhcmd1bWVudHMpLnNsaWNlKDEsIGFyZ3VtZW50cy5sZW5ndGgpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXMsIGFyZ3MuY29uY2F0KCQubWFrZUFycmF5KGFyZ3VtZW50cykpKTtcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgJC5fX2NhbGxiYWNrUG9vbCA9IHt9O1xuXG4gICAgICAgICAgICAgICAgJC5jYWxsYmFja1JlZ2lzdGVyID0gZnVuY3Rpb24gKG5hbWUsIGZuIC8qLCBhcmcwLCBhcmcxLCAuLiovKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMikge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gY3JlYXRlIGN1cnJpZWQgZnVuY3Rpb25cbiAgICAgICAgICAgICAgICAgICAgICAgIGZuID0gJC5jdXJyeS5hcHBseSh0aGlzLCAkLm1ha2VBcnJheShhcmd1bWVudHMpLnNsaWNlKDEsIGFyZ3VtZW50cy5sZW5ndGgpKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAkLl9fY2FsbGJhY2tQb29sW25hbWVdID0gZm47XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuYW1lO1xuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICAkLmNhbGxiYWNrQ2FsbCA9IGZ1bmN0aW9uIChuYW1lLyosIGV4dHJhIGFyZzAsIGV4dHJhIGFyZzEsIC4uKi8pIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFuYW1lIHx8ICEobmFtZSBpbiAkLl9fY2FsbGJhY2tQb29sKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgJ05vIGNhbGxiYWNrIHJlZ2lzdGVyZWQgd2l0aCBuYW1lOiAnICsgbmFtZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAkLl9fY2FsbGJhY2tQb29sW25hbWVdLmFwcGx5KHRoaXMsICQubWFrZUFycmF5KGFyZ3VtZW50cykuc2xpY2UoMSwgYXJndW1lbnRzLmxlbmd0aCkpO1xuICAgICAgICAgICAgICAgICAgICAkLmNhbGxiYWNrUmVtb3ZlKG5hbWUpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmFtZTtcbiAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgJC5jYWxsYmFja1JlbW92ZSA9IGZ1bmN0aW9uIChuYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSAkLl9fY2FsbGJhY2tQb29sW25hbWVdO1xuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICAvLyB2ZXJ5IHNpbXBsZSB5ZWxsb3cgZmFkZSBwbHVnaW4uLlxuICAgICAgICAgICAgICAgICQuZm4ueWZ0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmVmZmVjdCgnaGlnaGxpZ2h0Jywge30sIDEwMDApO1xuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICAvLyBqcXVlcnkgcmVwbGFjZSBwbHVnaW4gOilcbiAgICAgICAgICAgICAgICAkLmZuLnJlcGxhY2UgPSBmdW5jdGlvbiAobykge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hZnRlcihvKS5yZW1vdmUoKS5lbmQoKTtcbiAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICBzZXR1cFRyZWVQdWJsaXNoaW5nOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgLy8gQUREIERJUkVDVCBQVUJMSVNISU5HXG4gICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzO1xuICAgICAgICAgICAgICAgIHZhciB0cmVlID0gJCgnLnRyZWUnKTtcbiAgICAgICAgICAgICAgICB2YXIgbGFuZ1RyaWdnZXIgPSAnLmNvbC1sYW5ndWFnZSAudHJpZ2dlci10b29sdGlwIHNwYW4nO1xuICAgICAgICAgICAgICAgIHZhciBsYW5nVG9vbHRpcHMgPSAnLmxhbmd1YWdlLXRvb2x0aXAnO1xuICAgICAgICAgICAgICAgIHZhciBsYW5nVGltZXIgPSBmdW5jdGlvbiAoKSB7fTtcbiAgICAgICAgICAgICAgICB2YXIgbGFuZ0RlbGF5ID0gMTAwO1xuICAgICAgICAgICAgICAgIHZhciBsYW5nRmFkZUR1cmF0aW9uID0gMjAwO1xuICAgICAgICAgICAgICAgIC8vIHdvcmthcm91bmQgZm9yIHRoZSBwdWJsaXNoaW5nIHRvb2x0aXAgb24gdG91Y2ggZGV2aWNlc1xuICAgICAgICAgICAgICAgIHZhciB0b3VjaFVzZWROb2RlO1xuXG4gICAgICAgICAgICAgICAgLy8gc2hvdyB0aGUgdG9vbHRpcFxuICAgICAgICAgICAgICAgIHRyZWUuZGVsZWdhdGUobGFuZ1RyaWdnZXIsICdwb2ludGVyb3ZlciB0b3VjaHN0YXJ0JywgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGVsID0gJCh0aGlzKS5jbG9zZXN0KCcuY29sLWxhbmd1YWdlJykuZmluZCgnLmxhbmd1YWdlLXRvb2x0aXAnKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGFuY2hvcnMgPSBlbC5maW5kKCdhJyk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzcGFuID0gJCh0aGlzKTtcblxuICAgICAgICAgICAgICAgICAgICAvLyBjbGVhciB0aW1lclxuICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQobGFuZ1RpbWVyKTtcblxuICAgICAgICAgICAgICAgICAgICAvLyBjYW5jZWwgaWYgdG9vbHRpcCBhbHJlYWR5IHZpc2libGVcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVsLmlzKCc6dmlzaWJsZScpICYmICF0b3VjaFVzZWROb2RlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAvLyBzZXQgY29ycmVjdCBwb3NpdGlvblxuICAgICAgICAgICAgICAgICAgICBlbC5jc3MoJ3JpZ2h0JywgMjAgKyAkKHRoaXMpLnBvc2l0aW9uKCkubGVmdCk7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gZmlndXJlIG91dCB3aGF0IHNob3VsZCBiZSBzaG93blxuICAgICAgICAgICAgICAgICAgICBhbmNob3JzLmhpZGUoKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNwYW4uaGFzQ2xhc3MoJ3VucHVibGlzaGVkJykgfHwgc3Bhbi5oYXNDbGFzcygndW5wdWJsaXNoZWRwYXJlbnQnKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYW5jaG9ycy5lcSgxKS5zaG93KCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHNwYW4uaGFzQ2xhc3MoJ3B1Ymxpc2hlZCcpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhbmNob3JzLmVxKDApLnNob3coKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoc3Bhbi5oYXNDbGFzcygnZGlydHknKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYW5jaG9ycy5zaG93KCkucGFyZW50KCkuYWRkQ2xhc3MoJ2xhbmd1YWdlLXRvb2x0aXAtbXVsdGlwbGUnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIC8vIGhpZGUgYWxsIGVsZW1lbnRzXG4gICAgICAgICAgICAgICAgICAgICQobGFuZ1Rvb2x0aXBzKS5mYWRlT3V0KGxhbmdEZWxheSk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGUudHlwZSA9PT0gJ3RvdWNoc3RhcnQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0b3VjaFVzZWROb2RlID0gdG91Y2hVc2VkTm9kZSA9PT0gZS50YXJnZXQgPyBmYWxzZSA6IGUudGFyZ2V0O1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRvdWNoVXNlZE5vZGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAvLyB1c2UgYSB0aW1lb3V0IHRvIGRpc3BsYXkgdGhlIHRvb2x0aXBcbiAgICAgICAgICAgICAgICAgICAgbGFuZ1RpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbC5zdG9wKHRydWUsIHRydWUpLmZhZGVJbihsYW5nRmFkZUR1cmF0aW9uKTtcbiAgICAgICAgICAgICAgICAgICAgfSwgbGFuZ0RlbGF5KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAvLyBoaWRlIHRoZSB0b29sdGlwIHdoZW4gbGVhdmluZyB0aGUgYXJlYVxuICAgICAgICAgICAgICAgIHRyZWUuZGVsZWdhdGUobGFuZ1RyaWdnZXIsICdwb2ludGVyb3V0JywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAodG91Y2hVc2VkTm9kZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIC8vIGNsZWFyIHRpbWVyXG4gICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChsYW5nVGltZXIpO1xuICAgICAgICAgICAgICAgICAgICAvLyBoaWRlIGFsbCBlbGVtZW50c1xuICAgICAgICAgICAgICAgICAgICBsYW5nVGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICQobGFuZ1Rvb2x0aXBzKS5mYWRlT3V0KGxhbmdGYWRlRHVyYXRpb24pO1xuICAgICAgICAgICAgICAgICAgICB9LCBsYW5nRGVsYXkgKiAyKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAvLyByZXNldCBoaWRpbmcgd2hlbiBlbnRlcmluZyB0aGUgdG9vbHRpcCBpdHNlbGZcbiAgICAgICAgICAgICAgICB0cmVlLmRlbGVnYXRlKGxhbmdUb29sdGlwcywgJ3BvaW50ZXJvdmVyJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAvLyBjbGVhciB0aW1lclxuICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQobGFuZ1RpbWVyKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB0cmVlLmRlbGVnYXRlKGxhbmdUb29sdGlwcywgJ3BvaW50ZXJvdXQnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGhpZGUgYWxsIGVsZW1lbnRzXG4gICAgICAgICAgICAgICAgICAgIGxhbmdUaW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgJChsYW5nVG9vbHRpcHMpLmZhZGVPdXQobGFuZ0ZhZGVEdXJhdGlvbik7XG4gICAgICAgICAgICAgICAgICAgIH0sIGxhbmdEZWxheSAqIDIpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIC8vIGF0dGFjaCBkb3VibGUgY2hlY2sgZXZlbnQgaWYgcHVibGlzaCBvciB1bnB1Ymxpc2ggc2hvdWxkIGJlIHRyaWdnZXJlZFxuICAgICAgICAgICAgICAgIHRyZWUuZGVsZWdhdGUoJy5sYW5ndWFnZS10b29sdGlwIGEnLCAnY2xpY2snLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gY2FuY2VsIGlmIG5vdCBjb25maXJtZWRcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFjb25maXJtKHRoYXQub3B0aW9ucy5sYW5nLnB1Ymxpc2gucmVwbGFjZSgnwqcnLCAkKHRoaXMpLnRleHQoKS50b0xvd2VyQ2FzZSgpKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIC8vIHNlbmQgcG9zdCByZXF1ZXN0IHRvIHByZXZlbnQgeHNzIGF0dGFja3NcbiAgICAgICAgICAgICAgICAgICAgJC5hamF4KHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdwb3N0JyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHVybDogJCh0aGlzKS5wcm9wKCdocmVmJyksXG4gICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgQ01TLkFQSS5IZWxwZXJzLnJlbG9hZEJyb3dzZXIoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZnVuY3Rpb24gKHJlcXVlc3QpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IocmVxdWVzdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSxcblxuICAgICAgICAgICAgc2V0dXBVSUhhY2tzOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgLy8gZW5hYmxlcyB0YWIgY2xpY2sgb24gdGl0bGUgZW50cnkgdG8gb3BlbiBpbiBuZXcgd2luZG93XG4gICAgICAgICAgICAgICAgJCgnLnRyZWUnKS5vbignY2xpY2snLCAnLmNvbDEgLnRpdGxlJywgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFlLm1ldGFLZXkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy50b3AubG9jYXRpb24uaHJlZiA9ICQodGhpcykuYXR0cignaHJlZicpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93Lm9wZW4oJCh0aGlzKS5hdHRyKCdocmVmJyksICdfYmxhbmsnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgLy8gYWRkcyBmdW5jdGlvbmFsaXR5IHRvIHRoZSBmaWx0ZXJcbiAgICAgICAgICAgICAgICAkKCcjY2hhbmdlbGlzdC1maWx0ZXItYnV0dG9uJykuYmluZCgnY2xpY2snLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICQoJyNjaGFuZ2VsaXN0LWZpbHRlcicpLnRvZ2dsZSgpO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgLy8gc2V0IGNvcnJlY3QgYWN0aXZlIGVudHJ5XG4gICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5wYXJlbnQgJiYgd2luZG93LnBhcmVudC5DTVMgJiYgd2luZG93LnBhcmVudC5DTVMuY29uZmlnKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBwYWdlX2lkID0gd2luZG93LnBhcmVudC5DTVMuY29uZmlnLnJlcXVlc3QucGFnZV9pZDtcblxuICAgICAgICAgICAgICAgICAgICAkKCdkaXZbZGF0YS1wYWdlX2lkPVwiJyArIHBhZ2VfaWQgKyAnXCJdJykuYWRkQ2xhc3MoJ2NvbnQtYWN0aXZlJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcblxuICAgICAgICAgICAgc2V0dXBHbG9iYWxzOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzO1xuICAgICAgICAgICAgICAgIHZhciBtc2cgPSAnJztcbiAgICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gbnVsbDtcblxuICAgICAgICAgICAgICAgIHdpbmRvdy5tb3ZlU3VjY2VzcyA9IGZ1bmN0aW9uIChub2RlKSB7XG4gICAgICAgICAgICAgICAgICAgICQuc3luY0NvbHMoKTtcblxuICAgICAgICAgICAgICAgICAgICBtc2cgPSAkKCc8c3BhbiBjbGFzcz1cInN1Y2Nlc3NcIj4nICsgdGhhdC5vcHRpb25zLmxhbmcuc3VjY2VzcyArICc8L3NwYW4+Jyk7XG4gICAgICAgICAgICAgICAgICAgIHBhcmVudCA9IHdpbmRvdy5wYXJlbnQ7XG5cbiAgICAgICAgICAgICAgICAgICAgbm9kZS5hZnRlcihtc2cpO1xuICAgICAgICAgICAgICAgICAgICBub2RlLnBhcmVudCgpLmZpbmQoJy5jb2wyJykuaGlkZSgpO1xuICAgICAgICAgICAgICAgICAgICBtc2cuZmFkZU91dCgxMDAwLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBub2RlLnBhcmVudCgpLmZpbmQoJy5jb2wyJykuc2hvdygpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgLy8gY2hlY2sgZm9yIHJlbG9hZCBjaGFuZ2VzXG4gICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuc2VsZiAhPT0gd2luZG93LnRvcCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LnBhcmVudC5DTVMuQVBJLkhlbHBlcnMucmVsb2FkQnJvd3NlcihmYWxzZSwgZmFsc2UsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LnBhcmVudC5DTVMuQVBJLlRvb2xiYXIub3Blbk1lc3NhZ2UodGhhdC5vcHRpb25zLmxhbmcuY2hhbmdlcywgZmFsc2UsIDApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIHdpbmRvdy5tb3ZlRXJyb3IgPSBmdW5jdGlvbiAobm9kZSwgbWVzc2FnZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAobWVzc2FnZSAmJiBtZXNzYWdlICE9PSAnZXJyb3InKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtc2cgPSAkKCc8c3BhbiBjbGFzcz1cInN1Y2Nlc3NcIj4nICsgbWVzc2FnZSArICc8L3NwYW4+Jyk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtc2cgPSAkKCc8c3BhbiBjbGFzcz1cInN1Y2Nlc3NcIj4nICsgdGhhdC5vcHRpb25zLmxhbmcuZXJyb3IgKyAnPC9zcGFuPicpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIG5vZGUucGFyZW50KCkuZmluZCgnLmNvbDInKS5oaWRlKCk7XG4gICAgICAgICAgICAgICAgICAgIG5vZGUuYWZ0ZXIobXNnKTtcbiAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICBzZXR1cFRyZWU6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7XG4gICAgICAgICAgICAgICAgdmFyIHRyZWU7XG4gICAgICAgICAgICAgICAgdmFyIG9yaWdpbiA9IHdpbmRvdy5sb2NhdGlvbi5wcm90b2NvbCArICcvLycgKyB3aW5kb3cubG9jYXRpb24uaG9zdG5hbWUgK1xuICAgICAgICAgICAgICAgICAgICAod2luZG93LmxvY2F0aW9uLnBvcnQgPyAnOicgKyB3aW5kb3cubG9jYXRpb24ucG9ydCA6ICcnKTtcbiAgICAgICAgICAgICAgICAvLyBnbG9iYWwgaW5pdFRyZWUgZnVuY3Rpb25cbiAgICAgICAgICAgICAgICB3aW5kb3cuaW5pdFRyZWUgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGpzaGludCBuZXdjYXA6IGZhbHNlXG4gICAgICAgICAgICAgICAgICAgIC8vIGpzY3M6ZGlzYWJsZSByZXF1aXJlQ2FwaXRhbGl6ZWRDb25zdHJ1Y3RvcnNcbiAgICAgICAgICAgICAgICAgICAgdHJlZSA9IG5ldyB0cmVlX2NvbXBvbmVudCgpO1xuICAgICAgICAgICAgICAgICAgICAvLyBqc2NzOmVuYWJsZSByZXF1aXJlQ2FwaXRhbGl6ZWRDb25zdHJ1Y3RvcnNcbiAgICAgICAgICAgICAgICAgICAgLy8ganNoaW50IG5ld2NhcDogdHJ1ZVxuICAgICAgICAgICAgICAgICAgICB2YXIgb3B0aW9ucyA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJ1bGVzOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xpY2thYmxlOiAnYWxsJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW5hbWVhYmxlOiAnbm9uZScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRhYmxlOiAnYWxsJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGFibGU6ICdhbGwnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRyYWdnYWJsZTogJ2FsbCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZHJhZ3J1bGVzOiAnYWxsJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkcm9wcGFibGU6ICdhbGwnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1ldGFkYXRhIDogJ21kYXRhJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VfaW5saW5lOiB0cnVlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9kcm9wcGFibGUgOiBbJ3RyZWVfZHJvcCddXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gaGFzIHRvIGJlIGFic29sdXRlIGZ1bGwgcGF0aFxuICAgICAgICAgICAgICAgICAgICAgICAgcGF0aDogb3JpZ2luICsgdGhhdC5vcHRpb25zLnNldHRpbmdzLnN0YXRpY1BhdGggKyAnY21zL2pzL2pzdHJlZS8nLFxuICAgICAgICAgICAgICAgICAgICAgICAgdWk6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb3RzOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJ0bDogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5pbWF0aW9uOiAwLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhvdmVyX21vZGU6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy90aGVtZV9wYXRoOiBzY3JpcHRfdXJsX3BhdGgoKSArICcvLi4vanN0cmVlL3RoZW1lcy8nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFfY2xhc3M6ICd0aXRsZScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dDogZmFsc2VcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICBjb29raWVzIDoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZWZpeDogJ2RqYW5nb2Ntc19ub2RlcydcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJlZm9yZW1vdmUgIDogZnVuY3Rpb24gKHdoYXQsIHdoZXJlLCBwb3NpdGlvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuaXRlbV9pZCA9IHdoYXQuaWQuc3BsaXQoJ3BhZ2VfJylbMV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy50YXJnZXRfaWQgPSB3aGVyZS5pZC5zcGxpdCgncGFnZV8nKVsxXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93Lm9sZF9ub2RlID0gd2hhdDtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJCh3aGF0KS5wYXJlbnQoKS5jaGlsZHJlbignbGknKS5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJCh3aGF0KS5uZXh0KCdsaScpLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5vbGRfdGFyZ2V0ID0gJCh3aGF0KS5uZXh0KCdsaScpWzBdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5vbGRfcG9zaXRpb24gPSAncmlnaHQnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQod2hhdCkucHJldignbGknKS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cub2xkX3RhcmdldCA9ICQod2hhdCkucHJldignbGknKVswXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cub2xkX3Bvc2l0aW9uID0gJ2xlZnQnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQod2hhdCkuYXR0cigncmVsJykgIT09ICd0b3Bub2RlJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5vbGRfdGFyZ2V0ID0gJCh3aGF0KS5wYXJlbnQoKS5wYXJlbnQoKVswXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cub2xkX3Bvc2l0aW9uID0gJ2luc2lkZSc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRVbmRvKHdoYXQsIHdoZXJlLCBwb3NpdGlvbik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb25tb3ZlOiBmdW5jdGlvbiAod2hhdCwgd2hlcmUsIHBvc2l0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5pdGVtX2lkID0gd2hhdC5pZC5zcGxpdCgncGFnZV8nKVsxXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LnRhcmdldF9pZCA9IHdoZXJlLmlkLnNwbGl0KCdwYWdlXycpWzFdO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwb3NpdGlvbiA9PT0gJ2JlZm9yZScpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uID0gJ2xlZnQnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHBvc2l0aW9uID09PSAnYWZ0ZXInKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiA9ICdyaWdodCc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocG9zaXRpb24gPT09ICdpbnNpZGUnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiA9ICdsYXN0LWNoaWxkJztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlVHJlZUl0ZW0od2hhdCwgd2luZG93Lml0ZW1faWQsIHdpbmRvdy50YXJnZXRfaWQsIHBvc2l0aW9uLCBmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9ubG9hZDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlQ2FsYygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCAyNTApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgICAgIGlmICghJCgkKCdkaXYudHJlZScpLmdldCgwKSkuaGFzQ2xhc3MoJ3Jvb3RfYWxsb3dfY2hpbGRyZW4nKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gZGlzYWxvdyBwb3NzaWJpbGl0eSBmb3IgYWRkaW5nIHN1Ym5vZGVzIHRvIG1haW4gdHJlZSwgdXNlciBkb2Vzbid0XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBoYXZlIHBlcm1pc3Npb25zIGZvciB0aGlzXG4gICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnJ1bGVzLmRyYWdydWxlcyA9IFsnbm9kZSBpbnNpZGUgdG9wbm9kZScsICd0b3Bub2RlIGluc2lkZSB0b3Bub2RlJywgJ25vZGUgKiBub2RlJ107XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICB0cmVlLmluaXQoJCgnZGl2LnRyZWUnKSwgb3B0aW9ucyk7XG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIHdpbmRvdy5zZWxlY3RlZF9wYWdlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgYWN0aW9uID0gZmFsc2U7XG5cbiAgICAgICAgICAgICAgICB2YXIgX29sZEFqYXggPSAkLmFqYXg7XG5cbiAgICAgICAgICAgICAgICAkLmFqYXggPSBmdW5jdGlvbiAocykge1xuICAgICAgICAgICAgICAgICAgICAvLyBqdXN0IG92ZXJyaWRlIGFqYXggZnVuY3Rpb24sIHNvIHRoZSBsb2FkZXIgbWVzc2FnZSBnZXRzIGRpc3BsYXllZFxuICAgICAgICAgICAgICAgICAgICAvLyBhbHdheXNcbiAgICAgICAgICAgICAgICAgICAgJCgnI2xvYWRlci1tZXNzYWdlJykuc2hvdygpO1xuXG4gICAgICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IHMuc3VjY2VzcyB8fCBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgcy5zdWNjZXNzID0gZnVuY3Rpb24gKGRhdGEsIHN0YXR1cykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZGF0YSwgc3RhdHVzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICQoJyNsb2FkZXItbWVzc2FnZScpLmhpZGUoKTtcbiAgICAgICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgICAgICAvLyBqdXN0IGZvciBkZWJ1Z2luZyEhXG4gICAgICAgICAgICAgICAgICAgIC8qcy5jb21wbGV0ZSA9IGZ1bmN0aW9uICh4aHIsIHN0YXR1cykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXR1cyA9PSAnZXJyb3InICYmIHRoYXQub3B0aW9ucy5zZXR0aW5ncy5kZWJ1Zykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJ2JvZHknKS5iZWZvcmUoeGhyLnJlc3BvbnNlVGV4dCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0qL1xuICAgICAgICAgICAgICAgICAgICAvLyBlbmQganVzdCBmb3IgZGVidWdpbmdcblxuICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBhZGQgZXJyb3Igc3RhdGUhXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBfb2xkQWpheChzKTtcbiAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgLy8gLy8gZGVmaW5lZCBidXQgbmV2ZXIgdXNlZFxuICAgICAgICAgICAgICAgIC8vIGZ1bmN0aW9uIHJlZnJlc2goKSB7XG4gICAgICAgICAgICAgICAgLy8gICAgIHdpbmRvdy5sb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmO1xuICAgICAgICAgICAgICAgIC8vIH1cblxuICAgICAgICAgICAgICAgIC8vIC8vIGRlZmluZWQgYnV0IG5ldmVyIHVzZWRcbiAgICAgICAgICAgICAgICAvLyBmdW5jdGlvbiByZWZyZXNoSWZDaGlsZHJlbihwYWdlSWQpIHtcbiAgICAgICAgICAgICAgICAvLyAgICAgcmV0dXJuICQoJyNwYWdlXycgKyBwYWdlSWQpLmZpbmQoJ2xpW2lkXj1wYWdlX10nKS5sZW5ndGggP1xuICAgICAgICAgICAgICAgIC8vICAgICByZWZyZXNoIDpcbiAgICAgICAgICAgICAgICAvLyAgICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gdHJ1ZTsgfTtcbiAgICAgICAgICAgICAgICAvLyB9XG5cbiAgICAgICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAgICAgKiBMb2FkcyByZW1vdGUgZGlhbG9nIHRvIGRpYWxvZ3MgZGl2LlxuICAgICAgICAgICAgICAgICAqXG4gICAgICAgICAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHVybFxuICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBkYXRhIERhdGEgdG8gYmUgc2VuZCBvdmVyIHBvc3RcbiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBub0RpYWxvZ0NhbGxiYWNrIEdldHMgY2FsbGVkIHdoZW4gcmVzcG9uc2UgaXMgZW1wdHkuXG4gICAgICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgU3RhbmRhcmQgY2FsbGJhY2sgZnVuY3Rpb24uXG4gICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gbG9hZERpYWxvZyh1cmwsIGRhdGEsIG5vRGlhbG9nQ2FsbGJhY2ssIGNhbGxiYWNrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChkYXRhID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAkLnBvc3QodXJsLCBkYXRhLCBmdW5jdGlvbiAocmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZSA9PT0gJycgJiYgbm9EaWFsb2dDYWxsYmFjaykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vRGlhbG9nQ2FsbGJhY2soKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICQoJyNkaWFsb2dzJykuZW1wdHkoKS5hcHBlbmQocmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2socmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBmdW5jdGlvbiBtYXJrX2NvcHlfbm9kZShpZCkge1xuICAgICAgICAgICAgICAgICAgICAkKCdhLm1vdmUtdGFyZ2V0LCBzcGFuLm1vdmUtdGFyZ2V0LWNvbnRhaW5lciwgc3Bhbi5saW5lJykuc2hvdygpO1xuICAgICAgICAgICAgICAgICAgICAkKCcjcGFnZV8nICsgaWQpLmFkZENsYXNzKCdzZWxlY3RlZCcpO1xuICAgICAgICAgICAgICAgICAgICAkKCcjcGFnZV8nICsgaWQpLnBhcmVudCgpLnBhcmVudCgpXG4gICAgICAgICAgICAgICAgICAgICAgICAuY2hpbGRyZW4oJ2Rpdi5jb250JykuZmluZCgnYS5tb3ZlLXRhcmdldC5maXJzdC1jaGlsZCwgc3Bhbi5zZWNvbmQnKS5oaWRlKCk7XG4gICAgICAgICAgICAgICAgICAgICQoJyNwYWdlXycgKyBpZCkucGFyZW50KCkucGFyZW50KClcbiAgICAgICAgICAgICAgICAgICAgICAgIC5jaGlsZHJlbigndWwnKS5jaGlsZHJlbignbGknKS5jaGlsZHJlbignZGl2LmNvbnQnKVxuICAgICAgICAgICAgICAgICAgICAgICAgLmZpbmQoJ2EubW92ZS10YXJnZXQubGVmdCwgYS5tb3ZlLXRhcmdldC5yaWdodCwgc3Bhbi5maXJzdCwgc3Bhbi5zZWNvbmQnKS5oaWRlKCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAnY29weSc7XG4gICAgICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgICAgICAgICAvLyBsZXQncyBzdGFydCBldmVudCBkZWxlZ2F0aW9uXG4gICAgICAgICAgICAgICAgJCgnI2NoYW5nZWxpc3QgbGknKS5vbignY2xpY2snLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgICAgICAvLyBJIHdhbnQgYSBsaW5rIHRvIGNoZWNrIHRoZSBjbGFzc1xuICAgICAgICAgICAgICAgICAgICBpZiAoZS50YXJnZXQudGFnTmFtZSA9PT0gJ0lNRycgfHwgZS50YXJnZXQudGFnTmFtZSA9PT0gJ1NQQU4nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cudGFyZ2V0ID0gZS50YXJnZXQucGFyZW50Tm9kZTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy50YXJnZXQgPSBlLnRhcmdldDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB2YXIganRhcmdldCA9ICQod2luZG93LnRhcmdldCk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBpZDtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHBhZ2VfaWQ7XG4gICAgICAgICAgICAgICAgICAgIGlmIChqdGFyZ2V0Lmhhc0NsYXNzKCdtb3ZlJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHByZXBhcmUgdHJlZSBmb3IgbW92ZSAvIGN1dCBwYXN0ZVxuICAgICAgICAgICAgICAgICAgICAgICAgaWQgPSBlLnRhcmdldC5pZC5zcGxpdCgnbW92ZS1saW5rLScpWzFdO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkID0gZS50YXJnZXQucGFyZW50Tm9kZS5pZC5zcGxpdCgnbW92ZS1saW5rLScpWzFdO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcGFnZV9pZCA9IGlkO1xuICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LnNlbGVjdGVkX3BhZ2UgPSBwYWdlX2lkO1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0gJ21vdmUnO1xuICAgICAgICAgICAgICAgICAgICAgICAgJCgnc3Bhbi5tb3ZlLXRhcmdldC1jb250YWluZXIsIHNwYW4ubGluZSwgYS5tb3ZlLXRhcmdldCcpLnNob3coKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICQoJyNwYWdlXycgKyBwYWdlX2lkKS5hZGRDbGFzcygnc2VsZWN0ZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICQoJyNwYWdlXycgKyBwYWdlX2lkICsgJyBzcGFuLm1vdmUtdGFyZ2V0LWNvbnRhaW5lcicpLmhpZGUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpZiAoanRhcmdldC5oYXNDbGFzcygnY29weScpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBwcmVwYXJlIHRyZWUgZm9yIGNvcHlcbiAgICAgICAgICAgICAgICAgICAgICAgIGlkID0gZS50YXJnZXQuaWQuc3BsaXQoJ2NvcHktbGluay0nKVsxXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZCA9IGUudGFyZ2V0LnBhcmVudE5vZGUuaWQuc3BsaXQoJ2NvcHktbGluay0nKVsxXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5zZWxlY3RlZF9wYWdlID0gaWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb24gPSBtYXJrX2NvcHlfbm9kZShpZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGp0YXJnZXQuaGFzQ2xhc3MoJ3ZpZXdwYWdlJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2aWV3X3BhZ2VfdXJsID0gJCgnIycgKyB3aW5kb3cudGFyZ2V0LmlkICsgJy1zZWxlY3QnKS52YWwoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2aWV3X3BhZ2VfdXJsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93Lm9wZW4odmlld19wYWdlX3VybCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpZiAoanRhcmdldC5oYXNDbGFzcygnYWRkbGluaycpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIS8jJC9nLnRlc3QoanRhcmdldC5hdHRyKCdocmVmJykpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhlcmUgaXMgdXJsIGluc3RlYWQgb2YgIyBpbnNpZGUgaHJlZiwgZm9sbG93IHRoaXMgdXJsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdXNlZCBpZiB1c2VyIGhhdmVzIGFkZF9wYWdlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICQoJ3RyJykucmVtb3ZlQ2xhc3MoJ3RhcmdldCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgJCgnI2NoYW5nZWxpc3QgdGFibGUnKS5yZW1vdmVDbGFzcygndGFibGUtc2VsZWN0ZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VfaWQgPSB3aW5kb3cudGFyZ2V0LmlkLnNwbGl0KCdhZGQtbGluay0nKVsxXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5zZWxlY3RlZF9wYWdlID0gcGFnZV9pZDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbiA9ICdhZGQnO1xuICAgICAgICAgICAgICAgICAgICAgICAgJCgndHInKS5yZW1vdmVDbGFzcygnc2VsZWN0ZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICQoJyNwYWdlLXJvdy0nICsgcGFnZV9pZCkuYWRkQ2xhc3MoJ3NlbGVjdGVkJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAkKCcubW92ZS10YXJnZXQtY29udGFpbmVyJykuaGlkZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgJCgnYS5tb3ZlLXRhcmdldCwgc3Bhbi5saW5lLCAjbW92ZS10YXJnZXQtJyArIHBhZ2VfaWQpLnNob3coKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAvLyBkb24ndCBhc3N1bWUgYWRtaW4gc2l0ZSBpcyByb290LWxldmVsXG4gICAgICAgICAgICAgICAgICAgIC8vIGdyYWIgYmFzZSB1cmwgdG8gY29uc3RydWN0IGZ1bGwgYWJzb2x1dGUgVVJMc1xuICAgICAgICAgICAgICAgICAgICB3aW5kb3cuYWRtaW5fYmFzZV91cmwgPSBkb2N1bWVudC5VUkwuc3BsaXQoJy9jbXMvcGFnZS8nKVswXSArICcvJztcblxuICAgICAgICAgICAgICAgICAgICB2YXIgcGFnZUlkO1xuICAgICAgICAgICAgICAgICAgICB2YXIgbGFuZ3VhZ2U7XG4gICAgICAgICAgICAgICAgICAgIC8vIGluIG5hdmlnYXRpb25cbiAgICAgICAgICAgICAgICAgICAgaWYgKGp0YXJnZXQuaGFzQ2xhc3MoJ25hdmlnYXRpb24tY2hlY2tib3gnKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgcGFnZUlkID0ganRhcmdldC5hdHRyKCduYW1lJykuc3BsaXQoJ25hdmlnYXRpb24tJylbMV07XG4gICAgICAgICAgICAgICAgICAgICAgICBsYW5ndWFnZSA9IGp0YXJnZXQuY2xvc2VzdCgnLmNvbnQnKS5maW5kKCdhW2xhbmddJykuYXR0cignbGFuZycpIHx8ICcnO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiBJIGRvbid0IHB1dCBkYXRhIGluIHRoZSBwb3N0LCBkamFuZ28gZG9lc24ndCBnZXQgaXRcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlbG9hZEl0ZW0oXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAganRhcmdldCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuYWRtaW5fYmFzZV91cmwgKyAnY21zL3BhZ2UvJyArIHBhZ2VJZCArICcvY2hhbmdlLW5hdmlnYXRpb24vP2xhbmd1YWdlPScgKyBsYW5ndWFnZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IDE6IDEgfVxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIC8vIGxhenkgbG9hZCBkZXNjZW5kYW50cyBvbiB0cmVlIG9wZW5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGp0YXJnZXQuaGFzQ2xhc3MoJ2Nsb3NlZCcpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBvbmx5IGxvYWQgdGhlbSBvbmNlXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoanRhcmdldC5maW5kKCd1bCA+IGxpJykubGVuZ3RoID09PSAwICYmICFqdGFyZ2V0Lmhhc0NsYXNzKCdsb2FkaW5nJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBrZWVwcyB0aGlzIGV2ZW50IGZyb20gZmlyaW5nIG11bHRpcGxlIHRpbWVzIGJlZm9yZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBkb20gYXMgY2hhbmdlZC4gaXQgc3RpbGwgbmVlZHMgdG8gcHJvcGFnYXRlIGZvclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBvdGhlciBjbGljayBldmVudCBvbiB0aGlzIGVsZW1lbnQgdG8gZmlyZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGp0YXJnZXQuYWRkQ2xhc3MoJ2xvYWRpbmcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWdlSWQgPSAkKGp0YXJnZXQpLmF0dHIoJ2lkJykuc3BsaXQoJ3BhZ2VfJylbMV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFuZ3VhZ2UgPSAkKGp0YXJnZXQpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5jaGlsZHJlbignZGl2LmNvbnQnKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuY2hpbGRyZW4oJ2Rpdi5jb2wxJylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmNoaWxkcmVuKCcudGl0bGUnKS5hdHRyKCdsYW5nJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJC5nZXQoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5hZG1pbl9iYXNlX3VybCArICdjbXMvcGFnZS8nICsgcGFnZUlkICsgJy8nICsgbGFuZ3VhZ2UgKyAnL2Rlc2NlbmRhbnRzLycsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHt9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAocikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAganRhcmdldC5jaGlsZHJlbigndWwnKS5hcHBlbmQocik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzaG93IG1vdmUgdGFyZ2V0cyBpZiBuZWVkZWRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkKCdzcGFuLm1vdmUtdGFyZ2V0LWNvbnRhaW5lcjp2aXNpYmxlJykubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGp0YXJnZXQuY2hpbGRyZW4oJ3VsJylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmZpbmQoJ2EubW92ZS10YXJnZXQsIHNwYW4ubW92ZS10YXJnZXQtY29udGFpbmVyLCBzcGFuLmxpbmUnKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuc2hvdygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVDYWxjKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZUNhbGMoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGlmIChqdGFyZ2V0Lmhhc0NsYXNzKCdtb3ZlLXRhcmdldCcpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoanRhcmdldC5oYXNDbGFzcygnbGVmdCcpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LnBvc2l0aW9uID0gJ2xlZnQnO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGp0YXJnZXQuaGFzQ2xhc3MoJ3JpZ2h0JykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cucG9zaXRpb24gPSAncmlnaHQnO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGp0YXJnZXQuaGFzQ2xhc3MoJ2xhc3QtY2hpbGQnKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5wb3NpdGlvbiA9ICdsYXN0LWNoaWxkJztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy50YXJnZXRfaWQgPSB3aW5kb3cudGFyZ2V0LnBhcmVudE5vZGUuaWQuc3BsaXQoJ21vdmUtdGFyZ2V0LScpWzFdO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWN0aW9uID09PSAnbW92ZScpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3ZlVHJlZUl0ZW0obnVsbCwgd2luZG93LnNlbGVjdGVkX3BhZ2UsIHdpbmRvdy50YXJnZXRfaWQsIHdpbmRvdy5wb3NpdGlvbiwgdHJlZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnLm1vdmUtdGFyZ2V0LWNvbnRhaW5lcicpLmhpZGUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYWN0aW9uID09PSAnY29weScpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuc2l0ZSA9ICQoJyNzaXRlLXNlbGVjdCcpWzBdLnZhbHVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvcHlUcmVlSXRlbSh3aW5kb3cuc2VsZWN0ZWRfcGFnZSwgd2luZG93LnRhcmdldF9pZCwgd2luZG93LnBvc2l0aW9uLCB3aW5kb3cuc2l0ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnLm1vdmUtdGFyZ2V0LWNvbnRhaW5lcicpLmhpZGUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYWN0aW9uID09PSAnYWRkJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5zaXRlID0gJCgnI3NpdGUtc2VsZWN0JylbMF0udmFsdWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSB3aW5kb3cubG9jYXRpb24uaHJlZi5zcGxpdCgnPycpWzBdLnNwbGl0KCcjJylbMF0gK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYWRkLz90YXJnZXQ9JyArIHdpbmRvdy50YXJnZXRfaWQgKyAnJmFtcDtwb3NpdGlvbj0nICsgd2luZG93LnBvc2l0aW9uICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyZhbXA7c2l0ZT0nICsgd2luZG93LnNpdGU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICQoJ2RpdiNzaXRlbWFwJykuc2hvdygpO1xuXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVDYWxjKCkge1xuICAgICAgICAgICAgICAgICAgICAkLnN5bmNDb2xzKCk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgJCh3aW5kb3cpLmJpbmQoJ3Jlc2l6ZScsIHJlQ2FsYyk7XG4gICAgICAgICAgICAgICAgLyogU2l0ZSBTZWxlY3RvciAqL1xuICAgICAgICAgICAgICAgICQoJyNzaXRlLXNlbGVjdCcpLmNoYW5nZShmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBmb3JtID0gJCh0aGlzKS5jbG9zZXN0KCdmb3JtJyk7XG4gICAgICAgICAgICAgICAgICAgIC8vIGFkZCBjb3JyZWN0IHZhbHVlIGZvciBjb3B5XG4gICAgICAgICAgICAgICAgICAgIGlmIChhY3Rpb24gPT09ICdjb3B5Jykge1xuICAgICAgICAgICAgICAgICAgICAgICAgJCgnI3NpdGUtY29weScpLnZhbCh3aW5kb3cuc2VsZWN0ZWRfcGFnZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgLy8gc3VibWl0IGZvcm1cbiAgICAgICAgICAgICAgICAgICAgZm9ybS5zdWJtaXQoKTtcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIC8vXG4gICAgICAgICAgICAgICAgLy8gSWYgYW4gQSBlbGVtZW50IGhhcyBhIGRhdGEtYXR0cmlidXRlICdhbHQtY2xhc3MnLiBBdCB0aGlzIHRpbWUsXG4gICAgICAgICAgICAgICAgLy8gdGhpcyBpcyBvbmx5IHRoZSBlZGl0IGJ1dHRvbiBpbiB0aGUgcGFnZS10cmVlLCBidXQgY291bGQgYmVcbiAgICAgICAgICAgICAgICAvLyBtb3JlIGluIGZ1dHVyZS4gSXQgaXMgaW1wb3J0YW50IHRoYXQgdGhlIENTUyBiZSB3cml0dGVuIGluIHN1Y2hcbiAgICAgICAgICAgICAgICAvLyBhIG1hbm5lciB0aGF0IHRoZSBhbHQtY2xhc3MgaXMgZGVmaW5lZCBhZnRlciB0aGUgbm9ybWFsIGNsYXNzLFxuICAgICAgICAgICAgICAgIC8vIHNvIHRoYXQgaXQgY2FuIGJlIG92ZXJyaWRkZW4gd2hlbiB0aGUgYWx0LWtleSBpcyBkZXByZXNzZWQuXG4gICAgICAgICAgICAgICAgLy9cbiAgICAgICAgICAgICAgICAvLyBOT1RFOiBUaGlzICdwcmV2aWV3JyBwYXJ0IG9mIHRoZSAnYWx0LWNsaWNrIHRvIFthbHRlcm5hdGl2ZVxuICAgICAgICAgICAgICAgIC8vIGZ1bmN0aW9uXScgZmVhdHVyZSBtYXkgbm90IHdvcmsgaW4gc29tZSBlbnZpcm9ubWVudHMgKFdpbmRvd3NcbiAgICAgICAgICAgICAgICAvLyBpbiBhIHNvbWUgdmlydHVhbCBtYWNoaW5lIGVudmlyb25tZW50cywgbm90YWJseSksIGJ1dCBpcyBvbmx5IGFcbiAgICAgICAgICAgICAgICAvLyBuaWNlLSdleHRyYScsIG5vdCBhIHJlcXVpcmVtZW50IGZvciB0aGUgZmVhdHVyZS5cbiAgICAgICAgICAgICAgICAvL1xuICAgICAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uKCdrZXlkb3duIGtleXVwJywgZnVuY3Rpb24gKGV2dCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXZ0LndoaWNoID09PSAxOCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgJCgnYVtkYXRhLWFsdC1jbGFzc10nKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2VsZiA9ICQodGhpcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi50b2dnbGVDbGFzcyhzZWxmLmRhdGEoJ2FsdC1jbGFzcycpLCBldnQudHlwZSA9PT0gJ2tleWRvd24nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAvL1xuICAgICAgICAgICAgICAgIC8vIElmIHRoZSBBLWVsZW1lbnQgaGFzIGEgZGF0YS1hdHRyaWJ1dGUgJ2FsdC1ocmVmJywgdGhlbiB0aGlzXG4gICAgICAgICAgICAgICAgLy8gY2xpY2staGFuZGxlciB1c2VzIHRoYXQgaW5zdGVhZCBvZiB0aGUgbm9ybWFsIGhyZWYgYXR0cmlidXRlIGFzXG4gICAgICAgICAgICAgICAgLy8gdGhlIGNsaWNrLWRlc3RpbmF0aW9uLiBBZ2FpbiwgY3VycmVudGx5IHRoaXMgaXMgb25seSBvbiB0aGVcbiAgICAgICAgICAgICAgICAvLyBlZGl0IGJ1dHRvbiwgYnV0IGNvdWxkIGJlIG1vcmUgaW4gZnV0dXJlLlxuICAgICAgICAgICAgICAgIC8vXG4gICAgICAgICAgICAgICAgJCgnYVtkYXRhLWFsdC1ocmVmXScpLm9uKCdjbGljaycsIGZ1bmN0aW9uIChldnQpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGhyZWY7XG4gICAgICAgICAgICAgICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXZ0LnNoaWZ0S2V5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBocmVmID0gJCh0aGlzKS5kYXRhKCdhbHQtaHJlZicpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaHJlZiA9ICQodGhpcykuYXR0cignaHJlZicpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbiA9IGhyZWY7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICB2YXIgY29weV9zcGxpdHMgPSB3aW5kb3cubG9jYXRpb24uaHJlZi5zcGxpdCgnY29weT0nKTtcbiAgICAgICAgICAgICAgICBpZiAoY29weV9zcGxpdHMubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgaWQgPSBjb3B5X3NwbGl0c1sxXS5zcGxpdCgnJicpWzBdO1xuICAgICAgICAgICAgICAgICAgICAvLyBqc2hpbnQgbGF0ZWRlZjogZmFsc2VcbiAgICAgICAgICAgICAgICAgICAgdmFyIGFjdGlvbiA9IG1hcmtfY29weV9ub2RlKGlkKTtcbiAgICAgICAgICAgICAgICAgICAgLy8ganNoaW50IGxhdGVkZWY6IHRydWVcbiAgICAgICAgICAgICAgICAgICAgd2luZG93LnNlbGVjdGVkX3BhZ2UgPSBpZDtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjb3B5VHJlZUl0ZW0oaXRlbV9pZCwgdGFyZ2V0X2lkLCBwb3NpdGlvbiwgc2l0ZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhhdC5vcHRpb25zLnNldHRpbmdzLnBlcm1pc3Npb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBsb2FkRGlhbG9nKCcuLycgKyBpdGVtX2lkICsgJy9kaWFsb2cvY29weS8nLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IHBvc2l0aW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldDogdGFyZ2V0X2lkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpdGU6IHNpdGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2s6ICQuY2FsbGJhY2tSZWdpc3RlcihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ19jb3B5VHJlZUl0ZW0nLCBfY29weVRyZWVJdGVtLCBpdGVtX2lkLCB0YXJnZXRfaWQsIHBvc2l0aW9uLCBzaXRlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb3B5VHJlZUl0ZW0oaXRlbV9pZCwgdGFyZ2V0X2lkLCBwb3NpdGlvbiwgc2l0ZSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gX2NvcHlUcmVlSXRlbShpdGVtX2lkLCB0YXJnZXRfaWQsIHBvc2l0aW9uLCBzaXRlLCBvcHRpb25zKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBkYXRhID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IHBvc2l0aW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiB0YXJnZXRfaWQsXG4gICAgICAgICAgICAgICAgICAgICAgICBzaXRlOiBzaXRlXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIGRhdGEgPSAkLmV4dGVuZChkYXRhLCBvcHRpb25zKTtcblxuICAgICAgICAgICAgICAgICAgICAkLnBvc3QoJy4vJyArIGl0ZW1faWQgKyAnL2NvcHktcGFnZS8nLCBkYXRhLCBmdW5jdGlvbiAoZGVjb2RlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3BvbnNlID0gZGVjb2RlZC5jb250ZW50O1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXR1cyA9IGRlY29kZWQuc3RhdHVzO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXR1cyA9PT0gMjAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVsb2FkIHRyZWVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cubG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24uaHJlZjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxlcnQocmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5tb3ZlRXJyb3IoJCgnI3BhZ2VfJyArIGl0ZW1faWQgKyAnIGRpdi5jb2wxOmVxKDApJyksIHJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgICAgICogUmVsb2FkcyB0cmVlIGl0ZW0gKG9uZSBsaW5lKS4gSWYgc29tZSBmaWx0ZXJpbmcgaXMgZm91bmQsIGFkZHNcbiAgICAgICAgICAgICAgICAgKiBmaWx0ZXJlZCB2YXJpYWJsZSBpbnRvIHBvc3RlZCBkYXRhLlxuICAgICAgICAgICAgICAgICAqXG4gICAgICAgICAgICAgICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0gZWwgQW55IGNoaWxkIGVsZW1lbnQgb2YgdHJlZSBpdGVtXG4gICAgICAgICAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHVybCBSZXF1ZXN0ZWQgdXJsXG4gICAgICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGRhdGEgT3B0aW9uYWwgcG9zdGVkIGRhdGFcbiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBPcHRpb25hbCBjYWxiYWNrIGZ1bmN0aW9uXG4gICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVsb2FkSXRlbShlbCwgdXJsLCBkYXRhLCBjYWxsYmFjaywgZXJyb3JDYWxsYmFjaykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhID0ge307XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpZiAoL1xcL1xcPy9pZy50ZXN0KHdpbmRvdy5sb2NhdGlvbi5ocmVmKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gcHJvYmFibHkgc29tZSBmaWx0ZXIgaGVyZSwgdGVsbCBiYWNrZW5kLCB3ZSBuZWVkIGEgZmlsdGVyZWRcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHZlcnNpb24gb2YgaXRlbVxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5maXRsZXJlZCA9IDE7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBvblN1Y2Nlc3MocmVzcG9uc2UsIHRleHRTdGF0dXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdGF0dXMgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRhcmdldCA9IG51bGw7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjaykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1cyA9IGNhbGxiYWNrKHJlc3BvbnNlLCB0ZXh0U3RhdHVzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0dXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoL3BhZ2VfXFxkKy8udGVzdCgkKGVsKS5hdHRyKCdpZCcpKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBvbmUgbGV2ZWwgaGlnaGVyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldCA9ICQoZWwpLmZpbmQoJ2Rpdi5jb250OmZpcnN0Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0ID0gJChlbCkucGFyZW50cygnZGl2LmNvbnQ6Zmlyc3QnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gdGFyZ2V0LnBhcmVudCgpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVtb3ZlIHRoZSBlbGVtZW50IGlmIHNvbWV0aGluZyB3ZW50IHdyb25nXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlID09PSAnTm90Rm91bmQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwYXJlbnQucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9yaWdpbiA9ICQoJy5tZXNzYWdlbGlzdCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldC5yZXBsYWNlKHJlc3BvbnNlKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtZXNzYWdlcyA9ICQocGFyZW50KS5maW5kKCcubWVzc2FnZWxpc3QnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWVzc2FnZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yaWdpbi5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZXMuaW5zZXJ0QWZ0ZXIoJy5icmVhZGNydW1icycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuZmluZCgnZGl2LmNvbnQ6Zmlyc3QnKS55ZnQoKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGVuc3VyZSBhZnRlciByZW1vdmFsIGV2ZXJ5dGhpbmcgaXMgYWxpZ25lZCBhZ2FpblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICQod2luZG93KS50cmlnZ2VyKCdyZXNpemUnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICQuYWpheCh7XG4gICAgICAgICAgICAgICAgICAgICAgICAndHlwZSc6ICdQT1NUJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICdkYXRhJzogZGF0YSxcbiAgICAgICAgICAgICAgICAgICAgICAgICd1cmwnOiB1cmwsXG4gICAgICAgICAgICAgICAgICAgICAgICAnc3VjY2Vzcyc6IG9uU3VjY2VzcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICdlcnJvcic6IGZ1bmN0aW9uIChYTUxIdHRwUmVxdWVzdCwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBlcnJvckNhbGxiYWNrIGlzIHBhc3NlZCB0aHJvdWdoIHRoZSByZWxvYWRJdGVtIGZ1bmN0aW9uXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yQ2FsbGJhY2spIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JDYWxsYmFjayhYTUxIdHRwUmVxdWVzdCwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAneGhyJzogKHdpbmRvdy5BY3RpdmVYT2JqZWN0KSA/XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyB3aW5kb3cuQWN0aXZlWE9iamVjdCgnTWljcm9zb2Z0LlhNTEhUVFAnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge31cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgd2luZG93LlhNTEh0dHBSZXF1ZXN0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBmdW5jdGlvbiBtb3ZlVHJlZUl0ZW0oanRhcmdldCwgaXRlbV9pZCwgdGFyZ2V0X2lkLCBwb3NpdGlvbiwgdHJlZSkge1xuICAgICAgICAgICAgICAgICAgICByZWxvYWRJdGVtKFxuICAgICAgICAgICAgICAgICAgICAgICAganRhcmdldCwgJy4vJyArIGl0ZW1faWQgKyAnL21vdmUtcGFnZS8nLFxuXG4gICAgICAgICAgICAgICAgICAgICAgICB7IHBvc2l0aW9uOiBwb3NpdGlvbiwgdGFyZ2V0OiB0YXJnZXRfaWQgfSxcblxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gb24gc3VjY2Vzc1xuICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGRlY29kZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzcG9uc2UgPSBkZWNvZGVkLmNvbnRlbnQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXR1cyA9IGRlY29kZWQuc3RhdHVzO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0dXMgPT09IDIwMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHJlZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRyZWVfcG9zID0geyAnbGVmdCc6ICdiZWZvcmUnLCAncmlnaHQnOiAnYWZ0ZXInIH1bcG9zaXRpb25dIHx8ICdpbnNpZGUnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJlZS5tb3ZlZChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnI3BhZ2VfJyArIGl0ZW1faWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnI3BhZ2VfJyArIHRhcmdldF9pZCArICcgYS50aXRsZScpWzBdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyZWVfcG9zLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93Lm1vdmVTdWNjZXNzKCQoJyNwYWdlXycgKyBpdGVtX2lkICsgJyBkaXYuY29sMTplcSgwKScpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93Lm1vdmVFcnJvcigkKCcjcGFnZV8nICsgaXRlbV9pZCArICcgZGl2LmNvbDE6ZXEoMCknKSwgcmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHZhciB1bmRvcyA9IFtdO1xuXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gYWRkVW5kbyhub2RlLCB0YXJnZXQsIHBvc2l0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIHVuZG9zLnB1c2goeyBub2RlOiBub2RlLCB0YXJnZXQ6IHRhcmdldCwgcG9zaXRpb246IHBvc2l0aW9uIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG5cbiAgICAgICAgICAgIHJlZnJlc2hDb2x1bW5zOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgJCgnZGl2LmNvbDInKS5jaGlsZHJlbignZGl2JykuZWFjaChmdW5jdGlvbiAoaW5kZXgsIGl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgJChpdGVtKS5jc3MoJ2Rpc3BsYXknLCAnYmxvY2snKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB2YXIgbWluX3dpZHRoID0gMTAwMDAwO1xuICAgICAgICAgICAgICAgIHZhciBtYXhfY29sMl93aWR0aCA9IDA7XG4gICAgICAgICAgICAgICAgdmFyIG1heF9jb2wyID0gbnVsbDtcbiAgICAgICAgICAgICAgICAkKHRoaXMpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgY29udCA9ICQodGhpcykuY2hpbGRyZW4oJ2Rpdi5jb250Jyk7XG4gICAgICAgICAgICAgICAgICAgIGlmICghY29udC5pcygnOnZpc2libGUnKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHZhciBjb2wxID0gY29udC5jaGlsZHJlbignZGl2LmNvbDEnKS5maW5kKCcudGl0bGUgc3BhbicpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgY29sMiA9IGNvbnQuY2hpbGRyZW4oJ2Rpdi5jb2wyJyk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjb2wxX3dpZHRoID0gY29sMS5vdXRlcldpZHRoKHRydWUpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgY29sMl93aWR0aCA9IGNvbDIub3V0ZXJXaWR0aCh0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRvdGFsX3dpZHRoID0gY29udC5vdXRlcldpZHRoKHRydWUpO1xuXG4gICAgICAgICAgICAgICAgICAgIHZhciBkaWYgPSB0b3RhbF93aWR0aCAtIGNvbDFfd2lkdGg7XG4gICAgICAgICAgICAgICAgICAgIGlmIChkaWYgPCBtaW5fd2lkdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1pbl93aWR0aCA9IGRpZjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoY29sMl93aWR0aCA+IG1heF9jb2wyX3dpZHRoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtYXhfY29sMl93aWR0aCA9IGNvbDJfd2lkdGg7XG4gICAgICAgICAgICAgICAgICAgICAgICBtYXhfY29sMiA9IGNvbDI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIHZhciBvZmZzZXQgPSA1MDtcbiAgICAgICAgICAgICAgICB2YXIgdyA9IDA7XG4gICAgICAgICAgICAgICAgdmFyIGhpZGRlbl9jb3VudCA9IDA7XG4gICAgICAgICAgICAgICAgdmFyIG1heF9yZWFjaGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaWYgKG1heF9jb2wyKSB7XG4gICAgICAgICAgICAgICAgICAgIG1heF9jb2wyLmNoaWxkcmVuKCdkaXYnKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbWF4X3JlYWNoZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3ICs9ICQodGhpcykub3V0ZXJXaWR0aCh0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1heF9yZWFjaGVkIHx8IHcgPiAobWluX3dpZHRoIC0gb2Zmc2V0KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhpZGRlbl9jb3VudCA9IGhpZGRlbl9jb3VudCArIDE7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4X3JlYWNoZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoaGlkZGVuX2NvdW50KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykuY2hpbGRyZW4oJ2Rpdi5jb250JykuY2hpbGRyZW4oJ2Rpdi5jb2wyJykuY2hpbGRyZW4oJ2RpdicpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5zbGljZSgtaGlkZGVuX2NvdW50KS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykuY3NzKCdkaXNwbGF5JywgJ25vbmUnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICQoJ2RpdiNzaXRlbWFwIHVsLmhlYWRlciBkaXYuY29sMicpLmNoaWxkcmVuKCkuc2xpY2UoLWhpZGRlbl9jb3VudCkuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5jc3MoJ2Rpc3BsYXknLCAnbm9uZScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSk7XG5cbiAgICB9KTtcbn0pKENNUy4kKTtcbiIsIi8vIGFsbCwgYnV0IHdpdGhvdXQganF1ZXJ5ICEhIChtb2RpZmllZCBieSBQZXRlciBDaWNtYW4pXG5cbi8vIGNzcy5qc1xuXG5mdW5jdGlvbiBnZXRfY3NzKHJ1bGVfbmFtZSxzdHlsZXNoZWV0LGRlbGV0ZV9mbGFnKXtpZighZG9jdW1lbnQuc3R5bGVTaGVldHMpcmV0dXJuIGZhbHNlO3J1bGVfbmFtZT1ydWxlX25hbWUudG9Mb3dlckNhc2UoKTtzdHlsZXNoZWV0PXN0eWxlc2hlZXR8fDA7Zm9yKHZhciBpPXN0eWxlc2hlZXQ7aTxkb2N1bWVudC5zdHlsZVNoZWV0cy5sZW5ndGg7aSsrKXt2YXIgc3R5bGVTaGVldD1kb2N1bWVudC5zdHlsZVNoZWV0c1tpXTtjc3NfcnVsZXM9ZG9jdW1lbnQuc3R5bGVTaGVldHNbaV0uY3NzUnVsZXN8fGRvY3VtZW50LnN0eWxlU2hlZXRzW2ldLnJ1bGVzO2lmKCFjc3NfcnVsZXMpY29udGludWU7dmFyIGo9MDtkb3tpZihjc3NfcnVsZXNbal0uc2VsZWN0b3JUZXh0LnRvTG93ZXJDYXNlKCk9PXJ1bGVfbmFtZSl7aWYoZGVsZXRlX2ZsYWc9PXRydWUpe2lmKGRvY3VtZW50LnN0eWxlU2hlZXRzW2ldLnJlbW92ZVJ1bGUpZG9jdW1lbnQuc3R5bGVTaGVldHNbaV0ucmVtb3ZlUnVsZShqKTtpZihkb2N1bWVudC5zdHlsZVNoZWV0c1tpXS5kZWxldGVSdWxlKWRvY3VtZW50LnN0eWxlU2hlZXRzW2ldLmRlbGV0ZVJ1bGUoaik7cmV0dXJuIHRydWU7fVxuZWxzZSByZXR1cm4gY3NzX3J1bGVzW2pdO319XG53aGlsZShjc3NfcnVsZXNbKytqXSk7fVxucmV0dXJuIGZhbHNlO31cbmZ1bmN0aW9uIGFkZF9jc3MocnVsZV9uYW1lLHN0eWxlc2hlZXQpe3J1bGVfbmFtZT1ydWxlX25hbWUudG9Mb3dlckNhc2UoKTtzdHlsZXNoZWV0PXN0eWxlc2hlZXR8fDA7aWYoIWRvY3VtZW50LnN0eWxlU2hlZXRzfHxnZXRfY3NzKHJ1bGVfbmFtZSxzdHlsZXNoZWV0KSlyZXR1cm4gZmFsc2U7KGRvY3VtZW50LnN0eWxlU2hlZXRzW3N0eWxlc2hlZXRdLmFkZFJ1bGUpP2RvY3VtZW50LnN0eWxlU2hlZXRzW3N0eWxlc2hlZXRdLmFkZFJ1bGUocnVsZV9uYW1lLG51bGwsMCk6ZG9jdW1lbnQuc3R5bGVTaGVldHNbc3R5bGVzaGVldF0uaW5zZXJ0UnVsZShydWxlX25hbWUrJyB7IH0nLDApO3JldHVybiBnZXRfY3NzKHJ1bGVfbmFtZSk7fVxuZnVuY3Rpb24gZ2V0X3NoZWV0X251bShocmVmX25hbWUpe2lmKCFkb2N1bWVudC5zdHlsZVNoZWV0cylyZXR1cm4gZmFsc2U7Zm9yKHZhciBpPTA7aTxkb2N1bWVudC5zdHlsZVNoZWV0cy5sZW5ndGg7aSsrKXtpZihkb2N1bWVudC5zdHlsZVNoZWV0c1tpXS5ocmVmJiZkb2N1bWVudC5zdHlsZVNoZWV0c1tpXS5ocmVmLnRvU3RyaW5nKCkubWF0Y2goaHJlZl9uYW1lKSlyZXR1cm4gaTt9XG5yZXR1cm4gZmFsc2U7fVxuZnVuY3Rpb24gcmVtb3ZlX2NzcyhydWxlX25hbWUsc3R5bGVzaGVldCl7cmV0dXJuIGdldF9jc3MocnVsZV9uYW1lLHN0eWxlc2hlZXQsdHJ1ZSk7fVxuZnVuY3Rpb24gYWRkX3NoZWV0KHVybCl7aWYoZG9jdW1lbnQuY3JlYXRlU3R5bGVTaGVldCl7ZG9jdW1lbnQuY3JlYXRlU3R5bGVTaGVldCh1cmwpO31cbmVsc2V7dmFyIHN0eWxlcz1cIkBpbXBvcnQgdXJsKCcgXCIrdXJsK1wiICcpO1wiO3ZhciBuZXdTUz1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaW5rJyk7bmV3U1MucmVsPSdzdHlsZXNoZWV0JztuZXdTUy5ocmVmPSdkYXRhOnRleHQvY3NzLCcrZXNjYXBlKHN0eWxlcyk7ZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJoZWFkXCIpWzBdLmFwcGVuZENoaWxkKG5ld1NTKTt9fVxuXG4vLyBqcXVlcnkubGlzdGVuLmpzXG47KGZ1bmN0aW9uKCQpe3ZhciBhPSdpbmRleGVyJyxoPSQuZXZlbnQsaj1oLnNwZWNpYWwsaz0kLmxpc3Rlbj1mdW5jdGlvbihjLGQsZSxmKXtpZih0eXBlb2YgZCE9J29iamVjdCcpe2Y9ZTtlPWQ7ZD1kb2N1bWVudH1vKGMuc3BsaXQoL1xccysvKSxmdW5jdGlvbihhKXthPWsuZml4ZXNbYV18fGE7dmFyIGI9bShkLGEpfHxtKGQsYSxuZXcgbihhLGQpKTtiLmFwcGVuZChlLGYpO2Iuc3RhcnQoKX0pfSxtPWZ1bmN0aW9uKGIsYyxkKXtyZXR1cm4gJC5kYXRhKGIsYysnLicrYSxkKX07JC5mblthXT1mdW5jdGlvbihhKXtyZXR1cm4gdGhpc1swXSYmbSh0aGlzWzBdLGEpfHxudWxsfTskW2FdPWZ1bmN0aW9uKGEpe3JldHVybiBtKGRvY3VtZW50LGEpfTskLmV4dGVuZChrLHtyZWdleDovXigoPzpcXHcqP3xcXCopKSg/OihbIy5dKShbXFx3LV0rKSk/JC8sZml4ZXM6e2ZvY3VzOidmb2N1c2luJyxibHVyOidmb2N1c291dCd9LGNhY2hlOmZ1bmN0aW9uKGEpe3RoaXMuY2FjaGluZz1hfX0pOyQuZWFjaChrLmZpeGVzLGZ1bmN0aW9uKGEsYil7altiXT17c2V0dXA6ZnVuY3Rpb24oKXtpZigkLmJyb3dzZXIubXNpZSlyZXR1cm4hMTt0aGlzLmFkZEV2ZW50TGlzdGVuZXIoYSxqW2JdLmhhbmRsZXIsITApfSx0ZWFyZG93bjpmdW5jdGlvbigpe2lmKCQuYnJvd3Nlci5tc2llKXJldHVybiExO3RoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcihhLGpbYl0uaGFuZGxlciwhMCl9LGhhbmRsZXI6ZnVuY3Rpb24oZSl7YXJndW1lbnRzWzBdPWU9aC5maXgoZSk7ZS50eXBlPWI7cmV0dXJuIGguaGFuZGxlLmFwcGx5KHRoaXMsYXJndW1lbnRzKX19fSk7JC5mbi5saXN0ZW49ZnVuY3Rpb24oYSxiLGMpe3JldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXtrKGEsdGhpcyxiLGMpfSl9O2Z1bmN0aW9uIG4oYSxiKXskLmV4dGVuZCh0aGlzLHtpZHM6e30sdGFnczp7fSxsaXN0ZW5lcjpiLGV2ZW50OmF9KTt0aGlzLmlkPW4uaW5zdGFuY2VzLnB1c2godGhpcyl9O24uaW5zdGFuY2VzPVtdO24ucHJvdG90eXBlPXtjb25zdHJ1Y3RvcjpuLGhhbmRsZTpmdW5jdGlvbihlKXt2YXIgYT1lLnN0b3BQcm9wYWdhdGlvbjtlLnN0b3BQcm9wYWdhdGlvbj1mdW5jdGlvbigpe2Uuc3RvcHBlZD0xO2EuYXBwbHkodGhpcyxhcmd1bWVudHMpfTttKHRoaXMsZS50eXBlKS5wYXJzZShlKTtlLnN0b3BQcm9wYWdhdGlvbj1hO2E9ZS5kYXRhPW51bGx9LG9uOjAsYnViYmxlczowLHN0YXJ0OmZ1bmN0aW9uKCl7dmFyIGE9dGhpcztpZighYS5vbil7aC5hZGQoYS5saXN0ZW5lcixhLmV2ZW50LGEuaGFuZGxlKTthLm9uPTF9fSxzdG9wOmZ1bmN0aW9uKCl7dmFyIGE9dGhpcztpZihhLm9uKXtoLnJlbW92ZShhLmxpc3RlbmVyLGEuZXZlbnQsYS5oYW5kbGUpO2Eub249MH19LGNhY2hlOmZ1bmN0aW9uKGEsYil7cmV0dXJuICQuZGF0YShhLCdsaXN0ZW5DYWNoZV8nK3RoaXMuaWQsYil9LHBhcnNlOmZ1bmN0aW9uKGUpe3ZhciB6PXRoaXMsYz1lLmRhdGF8fGUudGFyZ2V0LGQ9YXJndW1lbnRzLGY7aWYoIWsuY2FjaGluZ3x8IShmPXouY2FjaGUoYykpKXtmPVtdO2lmKGMuaWQmJnouaWRzW2MuaWRdKXAoZix6Lmlkc1tjLmlkXSk7byhbYy5ub2RlTmFtZSwnKiddLGZ1bmN0aW9uKGEpe3ZhciBiPXoudGFnc1thXTtpZihiKW8oKGMuY2xhc3NOYW1lKycgKicpLnNwbGl0KCcgJyksZnVuY3Rpb24oYSl7aWYoYSYmYlthXSlwKGYsYlthXSl9KX0pO2lmKGsuY2FjaGluZyl6LmNhY2hlKGMsZil9aWYoZlswXSl7byhmLGZ1bmN0aW9uKGEpe2lmKGEuYXBwbHkoYyxkKT09PSExKXtlLnByZXZlbnREZWZhdWx0KCk7ZS5zdG9wUHJvcGFnYXRpb24oKX19KX1pZighZS5zdG9wcGVkJiYoYz1jLnBhcmVudE5vZGUpJiYoYy5ub2RlTmFtZT09J0EnfHx6LmJ1YmJsZXMmJmMhPXoubGlzdGVuZXIpKXtlLmRhdGE9Yzt6LnBhcnNlKGUpfWY9ZD1jPW51bGx9LGFwcGVuZDpmdW5jdGlvbihmLGcpe3ZhciB6PXRoaXM7byhmLnNwbGl0KC9cXHMqLFxccyovKSxmdW5jdGlvbihhKXt2YXIgYj1rLnJlZ2V4LmV4ZWMoYSk7aWYoIWIpdGhyb3cnJC5saXN0ZW4gPiBcIicrYSsnXCIgaXMgbm90IGEgc3VwcG9ydGVkIHNlbGVjdG9yLic7dmFyIGM9YlsyXT09JyMnJiZiWzNdLGQ9YlsxXS50b1VwcGVyQ2FzZSgpfHwnKicsZT1iWzNdfHwnKic7aWYoYykoei5pZHNbY118fCh6Lmlkc1tjXT1bXSkpLnB1c2goZyk7ZWxzZSBpZihkKXtkPXoudGFnc1tkXT16LnRhZ3NbZF18fHt9OyhkW2VdfHwoZFtlXT1bXSkpLnB1c2goZyl9fSl9fTtmdW5jdGlvbiBvKGEsYixjKXtmb3IodmFyIGk9MCxsPWEubGVuZ3RoO2k8bDtpKyspYi5jYWxsKGMsYVtpXSxpKX07ZnVuY3Rpb24gcChhLGIpe2EucHVzaC5hcHBseShhLGIpO3JldHVybiBhfTskKHdpbmRvdykudW5sb2FkKGZ1bmN0aW9uKCl7aWYodHlwZW9mIG49PSdmdW5jdGlvbicpbyhuLmluc3RhbmNlcyxmdW5jdGlvbihiKXtiLnN0b3AoKTskLnJlbW92ZURhdGEoYi5saXN0ZW5lcixiLmV2ZW50KycuJythKTtiLmlkcz1iLm5hbWVzPWIubGlzdGVuZXI9bnVsbH0pfSl9KShqUXVlcnkpO1xuXG4vLyBzYXJpc3NhLmpzXG5cbmZ1bmN0aW9uIFNhcmlzc2EoKXt9XG5TYXJpc3NhLlZFUlNJT049XCIwLjkuOS40XCI7U2FyaXNzYS5QQVJTRURfT0s9XCJEb2N1bWVudCBjb250YWlucyBubyBwYXJzaW5nIGVycm9yc1wiO1Nhcmlzc2EuUEFSU0VEX0VNUFRZPVwiRG9jdW1lbnQgaXMgZW1wdHlcIjtTYXJpc3NhLlBBUlNFRF9VTktOT1dOX0VSUk9SPVwiTm90IHdlbGwtZm9ybWVkIG9yIG90aGVyIGVycm9yXCI7U2FyaXNzYS5JU19FTkFCTEVEX1RSQU5TRk9STV9OT0RFPWZhbHNlO1Nhcmlzc2EuUkVNT1RFX0NBTExfRkxBRz1cImdyLmFiaXNzLnNhcmlzc2EuUkVNT1RFX0NBTExfRkxBR1wiO1Nhcmlzc2EuX2xhc3RVbmlxdWVTdWZmaXg9MDtTYXJpc3NhLl9nZXRVbmlxdWVTdWZmaXg9ZnVuY3Rpb24oKXtyZXR1cm4gU2FyaXNzYS5fbGFzdFVuaXF1ZVN1ZmZpeCsrO307U2FyaXNzYS5fU0FSSVNTQV9JRVBSRUZJWDRYU0xQQVJBTT1cIlwiO1Nhcmlzc2EuX1NBUklTU0FfSEFTX0RPTV9JTVBMRU1FTlRBVElPTj1kb2N1bWVudC5pbXBsZW1lbnRhdGlvbiYmdHJ1ZTtTYXJpc3NhLl9TQVJJU1NBX0hBU19ET01fQ1JFQVRFX0RPQ1VNRU5UPVNhcmlzc2EuX1NBUklTU0FfSEFTX0RPTV9JTVBMRU1FTlRBVElPTiYmZG9jdW1lbnQuaW1wbGVtZW50YXRpb24uY3JlYXRlRG9jdW1lbnQ7U2FyaXNzYS5fU0FSSVNTQV9IQVNfRE9NX0ZFQVRVUkU9U2FyaXNzYS5fU0FSSVNTQV9IQVNfRE9NX0lNUExFTUVOVEFUSU9OJiZkb2N1bWVudC5pbXBsZW1lbnRhdGlvbi5oYXNGZWF0dXJlO1Nhcmlzc2EuX1NBUklTU0FfSVNfTU9aPVNhcmlzc2EuX1NBUklTU0FfSEFTX0RPTV9DUkVBVEVfRE9DVU1FTlQmJlNhcmlzc2EuX1NBUklTU0FfSEFTX0RPTV9GRUFUVVJFO1Nhcmlzc2EuX1NBUklTU0FfSVNfU0FGQVJJPW5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKS5pbmRleE9mKFwic2FmYXJpXCIpIT0tMXx8bmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpLmluZGV4T2YoXCJrb25xdWVyb3JcIikhPS0xO1Nhcmlzc2EuX1NBUklTU0FfSVNfU0FGQVJJX09MRD1TYXJpc3NhLl9TQVJJU1NBX0lTX1NBRkFSSSYmKHBhcnNlSW50KChuYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKC9BcHBsZVdlYktpdFxcLyhcXGQrKS8pfHx7fSlbMV0sMTApPDQyMCk7U2FyaXNzYS5fU0FSSVNTQV9JU19JRT1kb2N1bWVudC5hbGwmJndpbmRvdy5BY3RpdmVYT2JqZWN0JiZuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkuaW5kZXhPZihcIm1zaWVcIik+LTEmJm5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKS5pbmRleE9mKFwib3BlcmFcIik9PS0xO1Nhcmlzc2EuX1NBUklTU0FfSVNfT1BFUkE9bmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpLmluZGV4T2YoXCJvcGVyYVwiKSE9LTE7aWYoIXdpbmRvdy5Ob2RlfHwhTm9kZS5FTEVNRU5UX05PREUpe05vZGU9e0VMRU1FTlRfTk9ERToxLEFUVFJJQlVURV9OT0RFOjIsVEVYVF9OT0RFOjMsQ0RBVEFfU0VDVElPTl9OT0RFOjQsRU5USVRZX1JFRkVSRU5DRV9OT0RFOjUsRU5USVRZX05PREU6NixQUk9DRVNTSU5HX0lOU1RSVUNUSU9OX05PREU6NyxDT01NRU5UX05PREU6OCxET0NVTUVOVF9OT0RFOjksRE9DVU1FTlRfVFlQRV9OT0RFOjEwLERPQ1VNRU5UX0ZSQUdNRU5UX05PREU6MTEsTk9UQVRJT05fTk9ERToxMn07fVxuaWYoU2FyaXNzYS5fU0FSSVNTQV9JU19TQUZBUklfT0xEKXtIVE1MSHRtbEVsZW1lbnQ9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImh0bWxcIikuY29uc3RydWN0b3I7Tm9kZT1IVE1MRWxlbWVudD17fTtIVE1MRWxlbWVudC5wcm90b3R5cGU9SFRNTEh0bWxFbGVtZW50Ll9fcHJvdG9fXy5fX3Byb3RvX187SFRNTERvY3VtZW50PURvY3VtZW50PWRvY3VtZW50LmNvbnN0cnVjdG9yO3ZhciB4PW5ldyBET01QYXJzZXIoKTtYTUxEb2N1bWVudD14LmNvbnN0cnVjdG9yO0VsZW1lbnQ9eC5wYXJzZUZyb21TdHJpbmcoXCI8U2luZ2xlIC8+XCIsXCJ0ZXh0L3htbFwiKS5kb2N1bWVudEVsZW1lbnQuY29uc3RydWN0b3I7eD1udWxsO31cbmlmKHR5cGVvZiBYTUxEb2N1bWVudD09XCJ1bmRlZmluZWRcIiYmdHlwZW9mIERvY3VtZW50IT1cInVuZGVmaW5lZFwiKXtYTUxEb2N1bWVudD1Eb2N1bWVudDt9XG5pZihTYXJpc3NhLl9TQVJJU1NBX0lTX0lFKXtTYXJpc3NhLl9TQVJJU1NBX0lFUFJFRklYNFhTTFBBUkFNPVwieHNsOlwiO3ZhciBfU0FSSVNTQV9ET01fUFJPR0lEPVwiXCI7dmFyIF9TQVJJU1NBX1hNTEhUVFBfUFJPR0lEPVwiXCI7dmFyIF9TQVJJU1NBX0RPTV9YTUxXUklURVI9XCJcIjtTYXJpc3NhLnBpY2tSZWNlbnRQcm9nSUQ9ZnVuY3Rpb24oaWRMaXN0KXt2YXIgYkZvdW5kPWZhbHNlLGU7dmFyIG8yU3RvcmU7Zm9yKHZhciBpPTA7aTxpZExpc3QubGVuZ3RoJiYhYkZvdW5kO2krKyl7dHJ5e3ZhciBvRG9jPW5ldyBBY3RpdmVYT2JqZWN0KGlkTGlzdFtpXSk7bzJTdG9yZT1pZExpc3RbaV07YkZvdW5kPXRydWU7fWNhdGNoKG9iakV4Y2VwdGlvbil7ZT1vYmpFeGNlcHRpb247fX1cbmlmKCFiRm91bmQpe3Rocm93XCJDb3VsZCBub3QgcmV0cmlldmUgYSB2YWxpZCBwcm9nSUQgb2YgQ2xhc3M6IFwiK2lkTGlzdFtpZExpc3QubGVuZ3RoLTFdK1wiLiAob3JpZ2luYWwgZXhjZXB0aW9uOiBcIitlK1wiKVwiO31cbmlkTGlzdD1udWxsO3JldHVybiBvMlN0b3JlO307X1NBUklTU0FfRE9NX1BST0dJRD1udWxsO19TQVJJU1NBX1RIUkVBREVERE9NX1BST0dJRD1udWxsO19TQVJJU1NBX1hTTFRFTVBMQVRFX1BST0dJRD1udWxsO19TQVJJU1NBX1hNTEhUVFBfUFJPR0lEPW51bGw7WE1MSHR0cFJlcXVlc3Q9ZnVuY3Rpb24oKXtpZighX1NBUklTU0FfWE1MSFRUUF9QUk9HSUQpe19TQVJJU1NBX1hNTEhUVFBfUFJPR0lEPVNhcmlzc2EucGlja1JlY2VudFByb2dJRChbXCJNc3htbDIuWE1MSFRUUC42LjBcIixcIk1TWE1MMi5YTUxIVFRQLjMuMFwiLFwiTVNYTUwyLlhNTEhUVFBcIixcIk1pY3Jvc29mdC5YTUxIVFRQXCJdKTt9XG5yZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoX1NBUklTU0FfWE1MSFRUUF9QUk9HSUQpO307U2FyaXNzYS5nZXREb21Eb2N1bWVudD1mdW5jdGlvbihzVXJpLHNOYW1lKXtpZighX1NBUklTU0FfRE9NX1BST0dJRCl7X1NBUklTU0FfRE9NX1BST0dJRD1TYXJpc3NhLnBpY2tSZWNlbnRQcm9nSUQoW1wiTXN4bWwyLkRPTURvY3VtZW50LjYuMFwiLFwiTXN4bWwyLkRPTURvY3VtZW50LjMuMFwiLFwiTVNYTUwyLkRPTURvY3VtZW50XCIsXCJNU1hNTC5ET01Eb2N1bWVudFwiLFwiTWljcm9zb2Z0LlhNTERPTVwiXSk7fVxudmFyIG9Eb2M9bmV3IEFjdGl2ZVhPYmplY3QoX1NBUklTU0FfRE9NX1BST0dJRCk7aWYoc05hbWUpe3ZhciBwcmVmaXg9XCJcIjtpZihzVXJpKXtpZihzTmFtZS5pbmRleE9mKFwiOlwiKT4xKXtwcmVmaXg9c05hbWUuc3Vic3RyaW5nKDAsc05hbWUuaW5kZXhPZihcIjpcIikpO3NOYW1lPXNOYW1lLnN1YnN0cmluZyhzTmFtZS5pbmRleE9mKFwiOlwiKSsxKTt9ZWxzZXtwcmVmaXg9XCJhXCIrU2FyaXNzYS5fZ2V0VW5pcXVlU3VmZml4KCk7fX1cbmlmKHNVcmkpe29Eb2MubG9hZFhNTCgnPCcrcHJlZml4Kyc6JytzTmFtZStcIiB4bWxuczpcIitwcmVmaXgrXCI9XFxcIlwiK3NVcmkrXCJcXFwiXCIrXCIgLz5cIik7fWVsc2V7b0RvYy5sb2FkWE1MKCc8JytzTmFtZStcIiAvPlwiKTt9fVxucmV0dXJuIG9Eb2M7fTtTYXJpc3NhLmdldFBhcnNlRXJyb3JUZXh0PWZ1bmN0aW9uKG9Eb2Mpe3ZhciBwYXJzZUVycm9yVGV4dD1TYXJpc3NhLlBBUlNFRF9PSztpZihvRG9jJiZvRG9jLnBhcnNlRXJyb3ImJm9Eb2MucGFyc2VFcnJvci5lcnJvckNvZGUmJm9Eb2MucGFyc2VFcnJvci5lcnJvckNvZGUhPTApe3BhcnNlRXJyb3JUZXh0PVwiWE1MIFBhcnNpbmcgRXJyb3I6IFwiK29Eb2MucGFyc2VFcnJvci5yZWFzb24rXCJcXG5Mb2NhdGlvbjogXCIrb0RvYy5wYXJzZUVycm9yLnVybCtcIlxcbkxpbmUgTnVtYmVyIFwiK29Eb2MucGFyc2VFcnJvci5saW5lK1wiLCBDb2x1bW4gXCIrXG5vRG9jLnBhcnNlRXJyb3IubGluZXBvcytcIjpcXG5cIitvRG9jLnBhcnNlRXJyb3Iuc3JjVGV4dCtcIlxcblwiO2Zvcih2YXIgaT0wO2k8b0RvYy5wYXJzZUVycm9yLmxpbmVwb3M7aSsrKXtwYXJzZUVycm9yVGV4dCs9XCItXCI7fVxucGFyc2VFcnJvclRleHQrPVwiXlxcblwiO31cbmVsc2UgaWYob0RvYy5kb2N1bWVudEVsZW1lbnQ9PT1udWxsKXtwYXJzZUVycm9yVGV4dD1TYXJpc3NhLlBBUlNFRF9FTVBUWTt9XG5yZXR1cm4gcGFyc2VFcnJvclRleHQ7fTtTYXJpc3NhLnNldFhwYXRoTmFtZXNwYWNlcz1mdW5jdGlvbihvRG9jLHNOc1NldCl7b0RvYy5zZXRQcm9wZXJ0eShcIlNlbGVjdGlvbkxhbmd1YWdlXCIsXCJYUGF0aFwiKTtvRG9jLnNldFByb3BlcnR5KFwiU2VsZWN0aW9uTmFtZXNwYWNlc1wiLHNOc1NldCk7fTtYU0xUUHJvY2Vzc29yPWZ1bmN0aW9uKCl7aWYoIV9TQVJJU1NBX1hTTFRFTVBMQVRFX1BST0dJRCl7X1NBUklTU0FfWFNMVEVNUExBVEVfUFJPR0lEPVNhcmlzc2EucGlja1JlY2VudFByb2dJRChbXCJNc3htbDIuWFNMVGVtcGxhdGUuNi4wXCIsXCJNU1hNTDIuWFNMVGVtcGxhdGUuMy4wXCJdKTt9XG50aGlzLnRlbXBsYXRlPW5ldyBBY3RpdmVYT2JqZWN0KF9TQVJJU1NBX1hTTFRFTVBMQVRFX1BST0dJRCk7dGhpcy5wcm9jZXNzb3I9bnVsbDt9O1hTTFRQcm9jZXNzb3IucHJvdG90eXBlLmltcG9ydFN0eWxlc2hlZXQ9ZnVuY3Rpb24oeHNsRG9jKXtpZighX1NBUklTU0FfVEhSRUFERURET01fUFJPR0lEKXtfU0FSSVNTQV9USFJFQURFRERPTV9QUk9HSUQ9U2FyaXNzYS5waWNrUmVjZW50UHJvZ0lEKFtcIk1TWE1MMi5GcmVlVGhyZWFkZWRET01Eb2N1bWVudC42LjBcIixcIk1TWE1MMi5GcmVlVGhyZWFkZWRET01Eb2N1bWVudC4zLjBcIl0pO31cbnhzbERvYy5zZXRQcm9wZXJ0eShcIlNlbGVjdGlvbkxhbmd1YWdlXCIsXCJYUGF0aFwiKTt4c2xEb2Muc2V0UHJvcGVydHkoXCJTZWxlY3Rpb25OYW1lc3BhY2VzXCIsXCJ4bWxuczp4c2w9J2h0dHA6Ly93d3cudzMub3JnLzE5OTkvWFNML1RyYW5zZm9ybSdcIik7dmFyIGNvbnZlcnRlZD1uZXcgQWN0aXZlWE9iamVjdChfU0FSSVNTQV9USFJFQURFRERPTV9QUk9HSUQpO3RyeXtjb252ZXJ0ZWQucmVzb2x2ZUV4dGVybmFscz10cnVlO2NvbnZlcnRlZC5zZXRQcm9wZXJ0eShcIkFsbG93RG9jdW1lbnRGdW5jdGlvblwiLHRydWUpO31cbmNhdGNoKGUpe31cbmlmKHhzbERvYy51cmwmJnhzbERvYy5zZWxlY3RTaW5nbGVOb2RlKFwiLy94c2w6Kltsb2NhbC1uYW1lKCkgPSAnaW1wb3J0JyBvciBsb2NhbC1uYW1lKCkgPSAnaW5jbHVkZSddXCIpIT1udWxsKXtjb252ZXJ0ZWQuYXN5bmM9ZmFsc2U7Y29udmVydGVkLmxvYWQoeHNsRG9jLnVybCk7fVxuZWxzZXtjb252ZXJ0ZWQubG9hZFhNTCh4c2xEb2MueG1sKTt9XG5jb252ZXJ0ZWQuc2V0UHJvcGVydHkoXCJTZWxlY3Rpb25OYW1lc3BhY2VzXCIsXCJ4bWxuczp4c2w9J2h0dHA6Ly93d3cudzMub3JnLzE5OTkvWFNML1RyYW5zZm9ybSdcIik7dmFyIG91dHB1dD1jb252ZXJ0ZWQuc2VsZWN0U2luZ2xlTm9kZShcIi8veHNsOm91dHB1dFwiKTtpZihvdXRwdXQpe3RoaXMub3V0cHV0TWV0aG9kPW91dHB1dC5nZXRBdHRyaWJ1dGUoXCJtZXRob2RcIik7fVxuZWxzZXtkZWxldGUgdGhpcy5vdXRwdXRNZXRob2Q7fVxudGhpcy50ZW1wbGF0ZS5zdHlsZXNoZWV0PWNvbnZlcnRlZDt0aGlzLnByb2Nlc3Nvcj10aGlzLnRlbXBsYXRlLmNyZWF0ZVByb2Nlc3NvcigpO3RoaXMucGFyYW1zU2V0PVtdO307WFNMVFByb2Nlc3Nvci5wcm90b3R5cGUudHJhbnNmb3JtVG9Eb2N1bWVudD1mdW5jdGlvbihzb3VyY2VEb2Mpe3ZhciBvdXREb2M7aWYoX1NBUklTU0FfVEhSRUFERURET01fUFJPR0lEKXt0aGlzLnByb2Nlc3Nvci5pbnB1dD1zb3VyY2VEb2M7b3V0RG9jPW5ldyBBY3RpdmVYT2JqZWN0KF9TQVJJU1NBX0RPTV9QUk9HSUQpO3RoaXMucHJvY2Vzc29yLm91dHB1dD1vdXREb2M7dGhpcy5wcm9jZXNzb3IudHJhbnNmb3JtKCk7cmV0dXJuIG91dERvYzt9XG5lbHNle2lmKCFfU0FSSVNTQV9ET01fWE1MV1JJVEVSKXtfU0FSSVNTQV9ET01fWE1MV1JJVEVSPVNhcmlzc2EucGlja1JlY2VudFByb2dJRChbXCJNc3htbDIuTVhYTUxXcml0ZXIuNi4wXCIsXCJNc3htbDIuTVhYTUxXcml0ZXIuMy4wXCIsXCJNU1hNTDIuTVhYTUxXcml0ZXJcIixcIk1TWE1MLk1YWE1MV3JpdGVyXCIsXCJNaWNyb3NvZnQuWE1MRE9NXCJdKTt9XG50aGlzLnByb2Nlc3Nvci5pbnB1dD1zb3VyY2VEb2M7b3V0RG9jPW5ldyBBY3RpdmVYT2JqZWN0KF9TQVJJU1NBX0RPTV9YTUxXUklURVIpO3RoaXMucHJvY2Vzc29yLm91dHB1dD1vdXREb2M7dGhpcy5wcm9jZXNzb3IudHJhbnNmb3JtKCk7dmFyIG9Eb2M9bmV3IEFjdGl2ZVhPYmplY3QoX1NBUklTU0FfRE9NX1BST0dJRCk7b0RvYy5sb2FkWE1MKG91dERvYy5vdXRwdXQrXCJcIik7cmV0dXJuIG9Eb2M7fX07WFNMVFByb2Nlc3Nvci5wcm90b3R5cGUudHJhbnNmb3JtVG9GcmFnbWVudD1mdW5jdGlvbihzb3VyY2VEb2Msb3duZXJEb2Mpe3RoaXMucHJvY2Vzc29yLmlucHV0PXNvdXJjZURvYzt0aGlzLnByb2Nlc3Nvci50cmFuc2Zvcm0oKTt2YXIgcz10aGlzLnByb2Nlc3Nvci5vdXRwdXQ7dmFyIGY9b3duZXJEb2MuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpO3ZhciBjb250YWluZXI7aWYodGhpcy5vdXRwdXRNZXRob2Q9PSd0ZXh0Jyl7Zi5hcHBlbmRDaGlsZChvd25lckRvYy5jcmVhdGVUZXh0Tm9kZShzKSk7fWVsc2UgaWYob3duZXJEb2MuYm9keSYmb3duZXJEb2MuYm9keS5pbm5lckhUTUwpe2NvbnRhaW5lcj1vd25lckRvYy5jcmVhdGVFbGVtZW50KCdkaXYnKTtjb250YWluZXIuaW5uZXJIVE1MPXM7d2hpbGUoY29udGFpbmVyLmhhc0NoaWxkTm9kZXMoKSl7Zi5hcHBlbmRDaGlsZChjb250YWluZXIuZmlyc3RDaGlsZCk7fX1cbmVsc2V7dmFyIG9Eb2M9bmV3IEFjdGl2ZVhPYmplY3QoX1NBUklTU0FfRE9NX1BST0dJRCk7aWYocy5zdWJzdHJpbmcoMCw1KT09Jzw/eG1sJyl7cz1zLnN1YnN0cmluZyhzLmluZGV4T2YoJz8+JykrMik7fVxudmFyIHhtbD0nJy5jb25jYXQoJzxteT4nLHMsJzwvbXk+Jyk7b0RvYy5sb2FkWE1MKHhtbCk7Y29udGFpbmVyPW9Eb2MuZG9jdW1lbnRFbGVtZW50O3doaWxlKGNvbnRhaW5lci5oYXNDaGlsZE5vZGVzKCkpe2YuYXBwZW5kQ2hpbGQoY29udGFpbmVyLmZpcnN0Q2hpbGQpO319XG5yZXR1cm4gZjt9O1hTTFRQcm9jZXNzb3IucHJvdG90eXBlLnNldFBhcmFtZXRlcj1mdW5jdGlvbihuc1VSSSxuYW1lLHZhbHVlKXt2YWx1ZT12YWx1ZT92YWx1ZTpcIlwiO2lmKG5zVVJJKXt0aGlzLnByb2Nlc3Nvci5hZGRQYXJhbWV0ZXIobmFtZSx2YWx1ZSxuc1VSSSk7fWVsc2V7dGhpcy5wcm9jZXNzb3IuYWRkUGFyYW1ldGVyKG5hbWUsdmFsdWUpO31cbm5zVVJJPVwiXCIrKG5zVVJJfHxcIlwiKTtpZighdGhpcy5wYXJhbXNTZXRbbnNVUkldKXt0aGlzLnBhcmFtc1NldFtuc1VSSV09W107fVxudGhpcy5wYXJhbXNTZXRbbnNVUkldW25hbWVdPXZhbHVlO307WFNMVFByb2Nlc3Nvci5wcm90b3R5cGUuZ2V0UGFyYW1ldGVyPWZ1bmN0aW9uKG5zVVJJLG5hbWUpe25zVVJJPVwiXCIrKG5zVVJJfHxcIlwiKTtpZih0aGlzLnBhcmFtc1NldFtuc1VSSV0mJnRoaXMucGFyYW1zU2V0W25zVVJJXVtuYW1lXSl7cmV0dXJuIHRoaXMucGFyYW1zU2V0W25zVVJJXVtuYW1lXTt9ZWxzZXtyZXR1cm4gbnVsbDt9fTtYU0xUUHJvY2Vzc29yLnByb3RvdHlwZS5jbGVhclBhcmFtZXRlcnM9ZnVuY3Rpb24oKXtmb3IodmFyIG5zVVJJIGluIHRoaXMucGFyYW1zU2V0KXtmb3IodmFyIG5hbWUgaW4gdGhpcy5wYXJhbXNTZXRbbnNVUkldKXtpZihuc1VSSSE9XCJcIil7dGhpcy5wcm9jZXNzb3IuYWRkUGFyYW1ldGVyKG5hbWUsXCJcIixuc1VSSSk7fWVsc2V7dGhpcy5wcm9jZXNzb3IuYWRkUGFyYW1ldGVyKG5hbWUsXCJcIik7fX19XG50aGlzLnBhcmFtc1NldD1bXTt9O31lbHNle2lmKFNhcmlzc2EuX1NBUklTU0FfSEFTX0RPTV9DUkVBVEVfRE9DVU1FTlQpe1Nhcmlzc2EuX19oYW5kbGVMb2FkX189ZnVuY3Rpb24ob0RvYyl7U2FyaXNzYS5fX3NldFJlYWR5U3RhdGVfXyhvRG9jLDQpO307X3Nhcmlzc2FfWE1MRG9jdW1lbnRfb25sb2FkPWZ1bmN0aW9uKCl7U2FyaXNzYS5fX2hhbmRsZUxvYWRfXyh0aGlzKTt9O1Nhcmlzc2EuX19zZXRSZWFkeVN0YXRlX189ZnVuY3Rpb24ob0RvYyxpUmVhZHlTdGF0ZSl7b0RvYy5yZWFkeVN0YXRlPWlSZWFkeVN0YXRlO29Eb2MucmVhZHlzdGF0ZT1pUmVhZHlTdGF0ZTtpZihvRG9jLm9ucmVhZHlzdGF0ZWNoYW5nZSE9bnVsbCYmdHlwZW9mIG9Eb2Mub25yZWFkeXN0YXRlY2hhbmdlPT1cImZ1bmN0aW9uXCIpe29Eb2Mub25yZWFkeXN0YXRlY2hhbmdlKCk7fX07U2FyaXNzYS5nZXREb21Eb2N1bWVudD1mdW5jdGlvbihzVXJpLHNOYW1lKXt2YXIgb0RvYz1kb2N1bWVudC5pbXBsZW1lbnRhdGlvbi5jcmVhdGVEb2N1bWVudChzVXJpP3NVcmk6bnVsbCxzTmFtZT9zTmFtZTpudWxsLG51bGwpO2lmKCFvRG9jLm9ucmVhZHlzdGF0ZWNoYW5nZSl7b0RvYy5vbnJlYWR5c3RhdGVjaGFuZ2U9bnVsbDt9XG5pZighb0RvYy5yZWFkeVN0YXRlKXtvRG9jLnJlYWR5U3RhdGU9MDt9XG5vRG9jLmFkZEV2ZW50TGlzdGVuZXIoXCJsb2FkXCIsX3Nhcmlzc2FfWE1MRG9jdW1lbnRfb25sb2FkLGZhbHNlKTtyZXR1cm4gb0RvYzt9O2lmKHdpbmRvdy5YTUxEb2N1bWVudCl7fVxuZWxzZSBpZihTYXJpc3NhLl9TQVJJU1NBX0hBU19ET01fRkVBVFVSRSYmd2luZG93LkRvY3VtZW50JiYhRG9jdW1lbnQucHJvdG90eXBlLmxvYWQmJmRvY3VtZW50LmltcGxlbWVudGF0aW9uLmhhc0ZlYXR1cmUoJ0xTJywnMy4wJykpe1Nhcmlzc2EuZ2V0RG9tRG9jdW1lbnQ9ZnVuY3Rpb24oc1VyaSxzTmFtZSl7dmFyIG9Eb2M9ZG9jdW1lbnQuaW1wbGVtZW50YXRpb24uY3JlYXRlRG9jdW1lbnQoc1VyaT9zVXJpOm51bGwsc05hbWU/c05hbWU6bnVsbCxudWxsKTtyZXR1cm4gb0RvYzt9O31cbmVsc2V7U2FyaXNzYS5nZXREb21Eb2N1bWVudD1mdW5jdGlvbihzVXJpLHNOYW1lKXt2YXIgb0RvYz1kb2N1bWVudC5pbXBsZW1lbnRhdGlvbi5jcmVhdGVEb2N1bWVudChzVXJpP3NVcmk6bnVsbCxzTmFtZT9zTmFtZTpudWxsLG51bGwpO2lmKG9Eb2MmJihzVXJpfHxzTmFtZSkmJiFvRG9jLmRvY3VtZW50RWxlbWVudCl7b0RvYy5hcHBlbmRDaGlsZChvRG9jLmNyZWF0ZUVsZW1lbnROUyhzVXJpLHNOYW1lKSk7fVxucmV0dXJuIG9Eb2M7fTt9fX1cbmlmKCF3aW5kb3cuRE9NUGFyc2VyKXtpZihTYXJpc3NhLl9TQVJJU1NBX0lTX1NBRkFSSSl7RE9NUGFyc2VyPWZ1bmN0aW9uKCl7fTtET01QYXJzZXIucHJvdG90eXBlLnBhcnNlRnJvbVN0cmluZz1mdW5jdGlvbihzWG1sLGNvbnRlbnRUeXBlKXt2YXIgeG1saHR0cD1uZXcgWE1MSHR0cFJlcXVlc3QoKTt4bWxodHRwLm9wZW4oXCJHRVRcIixcImRhdGE6dGV4dC94bWw7Y2hhcnNldD11dGYtOCxcIitlbmNvZGVVUklDb21wb25lbnQoc1htbCksZmFsc2UpO3htbGh0dHAuc2VuZChudWxsKTtyZXR1cm4geG1saHR0cC5yZXNwb25zZVhNTDt9O31lbHNlIGlmKFNhcmlzc2EuZ2V0RG9tRG9jdW1lbnQmJlNhcmlzc2EuZ2V0RG9tRG9jdW1lbnQoKSYmU2FyaXNzYS5nZXREb21Eb2N1bWVudChudWxsLFwiYmFyXCIpLnhtbCl7RE9NUGFyc2VyPWZ1bmN0aW9uKCl7fTtET01QYXJzZXIucHJvdG90eXBlLnBhcnNlRnJvbVN0cmluZz1mdW5jdGlvbihzWG1sLGNvbnRlbnRUeXBlKXt2YXIgZG9jPVNhcmlzc2EuZ2V0RG9tRG9jdW1lbnQoKTtkb2MubG9hZFhNTChzWG1sKTtyZXR1cm4gZG9jO307fX1cbmlmKCh0eXBlb2YoZG9jdW1lbnQuaW1wb3J0Tm9kZSk9PVwidW5kZWZpbmVkXCIpJiZTYXJpc3NhLl9TQVJJU1NBX0lTX0lFKXt0cnl7ZG9jdW1lbnQuaW1wb3J0Tm9kZT1mdW5jdGlvbihvTm9kZSxiQ2hpbGRyZW4pe3ZhciB0bXA7aWYob05vZGUubm9kZU5hbWU9PScjdGV4dCcpe3JldHVybiBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShvTm9kZS5kYXRhKTt9XG5lbHNle2lmKG9Ob2RlLm5vZGVOYW1lPT1cInRib2R5XCJ8fG9Ob2RlLm5vZGVOYW1lPT1cInRyXCIpe3RtcD1kb2N1bWVudC5jcmVhdGVFbGVtZW50KFwidGFibGVcIik7fVxuZWxzZSBpZihvTm9kZS5ub2RlTmFtZT09XCJ0ZFwiKXt0bXA9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInRyXCIpO31cbmVsc2UgaWYob05vZGUubm9kZU5hbWU9PVwib3B0aW9uXCIpe3RtcD1kb2N1bWVudC5jcmVhdGVFbGVtZW50KFwic2VsZWN0XCIpO31cbmVsc2V7dG1wPWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7fVxuaWYoYkNoaWxkcmVuKXt0bXAuaW5uZXJIVE1MPW9Ob2RlLnhtbD9vTm9kZS54bWw6b05vZGUub3V0ZXJIVE1MO31lbHNle3RtcC5pbm5lckhUTUw9b05vZGUueG1sP29Ob2RlLmNsb25lTm9kZShmYWxzZSkueG1sOm9Ob2RlLmNsb25lTm9kZShmYWxzZSkub3V0ZXJIVE1MO31cbnJldHVybiB0bXAuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCIqXCIpWzBdO319O31jYXRjaChlKXt9fVxuaWYoIVNhcmlzc2EuZ2V0UGFyc2VFcnJvclRleHQpe1Nhcmlzc2EuZ2V0UGFyc2VFcnJvclRleHQ9ZnVuY3Rpb24ob0RvYyl7dmFyIHBhcnNlRXJyb3JUZXh0PVNhcmlzc2EuUEFSU0VEX09LO2lmKCghb0RvYyl8fCghb0RvYy5kb2N1bWVudEVsZW1lbnQpKXtwYXJzZUVycm9yVGV4dD1TYXJpc3NhLlBBUlNFRF9FTVBUWTt9ZWxzZSBpZihvRG9jLmRvY3VtZW50RWxlbWVudC50YWdOYW1lPT1cInBhcnNlcmVycm9yXCIpe3BhcnNlRXJyb3JUZXh0PW9Eb2MuZG9jdW1lbnRFbGVtZW50LmZpcnN0Q2hpbGQuZGF0YTtwYXJzZUVycm9yVGV4dCs9XCJcXG5cIitvRG9jLmRvY3VtZW50RWxlbWVudC5maXJzdENoaWxkLm5leHRTaWJsaW5nLmZpcnN0Q2hpbGQuZGF0YTt9ZWxzZSBpZihvRG9jLmdldEVsZW1lbnRzQnlUYWdOYW1lKFwicGFyc2VyZXJyb3JcIikubGVuZ3RoPjApe3ZhciBwYXJzZXJlcnJvcj1vRG9jLmdldEVsZW1lbnRzQnlUYWdOYW1lKFwicGFyc2VyZXJyb3JcIilbMF07cGFyc2VFcnJvclRleHQ9U2FyaXNzYS5nZXRUZXh0KHBhcnNlcmVycm9yLHRydWUpK1wiXFxuXCI7fWVsc2UgaWYob0RvYy5wYXJzZUVycm9yJiZvRG9jLnBhcnNlRXJyb3IuZXJyb3JDb2RlIT0wKXtwYXJzZUVycm9yVGV4dD1TYXJpc3NhLlBBUlNFRF9VTktOT1dOX0VSUk9SO31cbnJldHVybiBwYXJzZUVycm9yVGV4dDt9O31cblNhcmlzc2EuZ2V0VGV4dD1mdW5jdGlvbihvTm9kZSxkZWVwKXt2YXIgcz1cIlwiO3ZhciBub2Rlcz1vTm9kZS5jaGlsZE5vZGVzO2Zvcih2YXIgaT0wO2k8bm9kZXMubGVuZ3RoO2krKyl7dmFyIG5vZGU9bm9kZXNbaV07dmFyIG5vZGVUeXBlPW5vZGUubm9kZVR5cGU7aWYobm9kZVR5cGU9PU5vZGUuVEVYVF9OT0RFfHxub2RlVHlwZT09Tm9kZS5DREFUQV9TRUNUSU9OX05PREUpe3MrPW5vZGUuZGF0YTt9ZWxzZSBpZihkZWVwPT09dHJ1ZSYmKG5vZGVUeXBlPT1Ob2RlLkVMRU1FTlRfTk9ERXx8bm9kZVR5cGU9PU5vZGUuRE9DVU1FTlRfTk9ERXx8bm9kZVR5cGU9PU5vZGUuRE9DVU1FTlRfRlJBR01FTlRfTk9ERSkpe3MrPVNhcmlzc2EuZ2V0VGV4dChub2RlLHRydWUpO319XG5yZXR1cm4gczt9O2lmKCF3aW5kb3cuWE1MU2VyaWFsaXplciYmU2FyaXNzYS5nZXREb21Eb2N1bWVudCYmU2FyaXNzYS5nZXREb21Eb2N1bWVudChcIlwiLFwiZm9vXCIsbnVsbCkueG1sKXtYTUxTZXJpYWxpemVyPWZ1bmN0aW9uKCl7fTtYTUxTZXJpYWxpemVyLnByb3RvdHlwZS5zZXJpYWxpemVUb1N0cmluZz1mdW5jdGlvbihvTm9kZSl7cmV0dXJuIG9Ob2RlLnhtbDt9O31cblNhcmlzc2Euc3RyaXBUYWdzPWZ1bmN0aW9uKHMpe3JldHVybiBzP3MucmVwbGFjZSgvPFtePl0rPi9nLFwiXCIpOnM7fTtTYXJpc3NhLmNsZWFyQ2hpbGROb2Rlcz1mdW5jdGlvbihvTm9kZSl7d2hpbGUob05vZGUuZmlyc3RDaGlsZCl7b05vZGUucmVtb3ZlQ2hpbGQob05vZGUuZmlyc3RDaGlsZCk7fX07U2FyaXNzYS5jb3B5Q2hpbGROb2Rlcz1mdW5jdGlvbihub2RlRnJvbSxub2RlVG8sYlByZXNlcnZlRXhpc3Rpbmcpe2lmKFNhcmlzc2EuX1NBUklTU0FfSVNfU0FGQVJJJiZub2RlVG8ubm9kZVR5cGU9PU5vZGUuRE9DVU1FTlRfTk9ERSl7bm9kZVRvPW5vZGVUby5kb2N1bWVudEVsZW1lbnQ7fVxuaWYoKCFub2RlRnJvbSl8fCghbm9kZVRvKSl7dGhyb3dcIkJvdGggc291cmNlIGFuZCBkZXN0aW5hdGlvbiBub2RlcyBtdXN0IGJlIHByb3ZpZGVkXCI7fVxuaWYoIWJQcmVzZXJ2ZUV4aXN0aW5nKXtTYXJpc3NhLmNsZWFyQ2hpbGROb2Rlcyhub2RlVG8pO31cbnZhciBvd25lckRvYz1ub2RlVG8ubm9kZVR5cGU9PU5vZGUuRE9DVU1FTlRfTk9ERT9ub2RlVG86bm9kZVRvLm93bmVyRG9jdW1lbnQ7dmFyIG5vZGVzPW5vZGVGcm9tLmNoaWxkTm9kZXM7dmFyIGk7aWYodHlwZW9mKG93bmVyRG9jLmltcG9ydE5vZGUpIT1cInVuZGVmaW5lZFwiKXtmb3IoaT0wO2k8bm9kZXMubGVuZ3RoO2krKyl7bm9kZVRvLmFwcGVuZENoaWxkKG93bmVyRG9jLmltcG9ydE5vZGUobm9kZXNbaV0sdHJ1ZSkpO319ZWxzZXtmb3IoaT0wO2k8bm9kZXMubGVuZ3RoO2krKyl7bm9kZVRvLmFwcGVuZENoaWxkKG5vZGVzW2ldLmNsb25lTm9kZSh0cnVlKSk7fX19O1Nhcmlzc2EubW92ZUNoaWxkTm9kZXM9ZnVuY3Rpb24obm9kZUZyb20sbm9kZVRvLGJQcmVzZXJ2ZUV4aXN0aW5nKXtpZigoIW5vZGVGcm9tKXx8KCFub2RlVG8pKXt0aHJvd1wiQm90aCBzb3VyY2UgYW5kIGRlc3RpbmF0aW9uIG5vZGVzIG11c3QgYmUgcHJvdmlkZWRcIjt9XG5pZighYlByZXNlcnZlRXhpc3Rpbmcpe1Nhcmlzc2EuY2xlYXJDaGlsZE5vZGVzKG5vZGVUbyk7fVxudmFyIG5vZGVzPW5vZGVGcm9tLmNoaWxkTm9kZXM7aWYobm9kZUZyb20ub3duZXJEb2N1bWVudD09bm9kZVRvLm93bmVyRG9jdW1lbnQpe3doaWxlKG5vZGVGcm9tLmZpcnN0Q2hpbGQpe25vZGVUby5hcHBlbmRDaGlsZChub2RlRnJvbS5maXJzdENoaWxkKTt9fWVsc2V7dmFyIG93bmVyRG9jPW5vZGVUby5ub2RlVHlwZT09Tm9kZS5ET0NVTUVOVF9OT0RFP25vZGVUbzpub2RlVG8ub3duZXJEb2N1bWVudDt2YXIgaTtpZih0eXBlb2Yob3duZXJEb2MuaW1wb3J0Tm9kZSkhPVwidW5kZWZpbmVkXCIpe2ZvcihpPTA7aTxub2Rlcy5sZW5ndGg7aSsrKXtub2RlVG8uYXBwZW5kQ2hpbGQob3duZXJEb2MuaW1wb3J0Tm9kZShub2Rlc1tpXSx0cnVlKSk7fX1lbHNle2ZvcihpPTA7aTxub2Rlcy5sZW5ndGg7aSsrKXtub2RlVG8uYXBwZW5kQ2hpbGQobm9kZXNbaV0uY2xvbmVOb2RlKHRydWUpKTt9fVxuU2FyaXNzYS5jbGVhckNoaWxkTm9kZXMobm9kZUZyb20pO319O1Nhcmlzc2EueG1saXplPWZ1bmN0aW9uKGFueU9iamVjdCxvYmplY3ROYW1lLGluZGVudFNwYWNlKXtpbmRlbnRTcGFjZT1pbmRlbnRTcGFjZT9pbmRlbnRTcGFjZTonJzt2YXIgcz1pbmRlbnRTcGFjZSsnPCcrb2JqZWN0TmFtZSsnPic7dmFyIGlzTGVhZj1mYWxzZTtpZighKGFueU9iamVjdCBpbnN0YW5jZW9mIE9iamVjdCl8fGFueU9iamVjdCBpbnN0YW5jZW9mIE51bWJlcnx8YW55T2JqZWN0IGluc3RhbmNlb2YgU3RyaW5nfHxhbnlPYmplY3QgaW5zdGFuY2VvZiBCb29sZWFufHxhbnlPYmplY3QgaW5zdGFuY2VvZiBEYXRlKXtzKz1TYXJpc3NhLmVzY2FwZShcIlwiK2FueU9iamVjdCk7aXNMZWFmPXRydWU7fWVsc2V7cys9XCJcXG5cIjt2YXIgaXNBcnJheUl0ZW09YW55T2JqZWN0IGluc3RhbmNlb2YgQXJyYXk7Zm9yKHZhciBuYW1lIGluIGFueU9iamVjdCl7cys9U2FyaXNzYS54bWxpemUoYW55T2JqZWN0W25hbWVdLChpc0FycmF5SXRlbT9cImFycmF5LWl0ZW0ga2V5PVxcXCJcIituYW1lK1wiXFxcIlwiOm5hbWUpLGluZGVudFNwYWNlK1wiICAgXCIpO31cbnMrPWluZGVudFNwYWNlO31cbnJldHVybihzKz0ob2JqZWN0TmFtZS5pbmRleE9mKCcgJykhPS0xP1wiPC9hcnJheS1pdGVtPlxcblwiOlwiPC9cIitvYmplY3ROYW1lK1wiPlxcblwiKSk7fTtTYXJpc3NhLmVzY2FwZT1mdW5jdGlvbihzWG1sKXtyZXR1cm4gc1htbC5yZXBsYWNlKC8mL2csXCImYW1wO1wiKS5yZXBsYWNlKC88L2csXCImbHQ7XCIpLnJlcGxhY2UoLz4vZyxcIiZndDtcIikucmVwbGFjZSgvXCIvZyxcIiZxdW90O1wiKS5yZXBsYWNlKC8nL2csXCImYXBvcztcIik7fTtTYXJpc3NhLnVuZXNjYXBlPWZ1bmN0aW9uKHNYbWwpe3JldHVybiBzWG1sLnJlcGxhY2UoLyZhcG9zOy9nLFwiJ1wiKS5yZXBsYWNlKC8mcXVvdDsvZyxcIlxcXCJcIikucmVwbGFjZSgvJmd0Oy9nLFwiPlwiKS5yZXBsYWNlKC8mbHQ7L2csXCI8XCIpLnJlcGxhY2UoLyZhbXA7L2csXCImXCIpO307U2FyaXNzYS51cGRhdGVDdXJzb3I9ZnVuY3Rpb24ob1RhcmdldEVsZW1lbnQsc1ZhbHVlKXtpZihvVGFyZ2V0RWxlbWVudCYmb1RhcmdldEVsZW1lbnQuc3R5bGUmJm9UYXJnZXRFbGVtZW50LnN0eWxlLmN1cnNvciE9dW5kZWZpbmVkKXtvVGFyZ2V0RWxlbWVudC5zdHlsZS5jdXJzb3I9c1ZhbHVlO319O1Nhcmlzc2EudXBkYXRlQ29udGVudEZyb21VUkk9ZnVuY3Rpb24oc0Zyb21Vcmwsb1RhcmdldEVsZW1lbnQseHNsdHByb2MsY2FsbGJhY2ssc2tpcENhY2hlKXt0cnl7U2FyaXNzYS51cGRhdGVDdXJzb3Iob1RhcmdldEVsZW1lbnQsXCJ3YWl0XCIpO3ZhciB4bWxodHRwPW5ldyBYTUxIdHRwUmVxdWVzdCgpO3htbGh0dHAub3BlbihcIkdFVFwiLHNGcm9tVXJsLHRydWUpO3htbGh0dHAub25yZWFkeXN0YXRlY2hhbmdlPWZ1bmN0aW9uKCl7aWYoeG1saHR0cC5yZWFkeVN0YXRlPT00KXt0cnl7dmFyIG9Eb21Eb2M9eG1saHR0cC5yZXNwb25zZVhNTDtpZihvRG9tRG9jJiZTYXJpc3NhLmdldFBhcnNlRXJyb3JUZXh0KG9Eb21Eb2MpPT1TYXJpc3NhLlBBUlNFRF9PSyl7U2FyaXNzYS51cGRhdGVDb250ZW50RnJvbU5vZGUoeG1saHR0cC5yZXNwb25zZVhNTCxvVGFyZ2V0RWxlbWVudCx4c2x0cHJvYyk7aWYoY2FsbGJhY2spe2NhbGxiYWNrKHNGcm9tVXJsLG9UYXJnZXRFbGVtZW50KTt9fVxuZWxzZXt0aHJvdyBTYXJpc3NhLmdldFBhcnNlRXJyb3JUZXh0KG9Eb21Eb2MpO319XG5jYXRjaChlKXtpZihjYWxsYmFjayl7Y2FsbGJhY2soc0Zyb21Vcmwsb1RhcmdldEVsZW1lbnQsZSk7fVxuZWxzZXt0aHJvdyBlO319fX07aWYoc2tpcENhY2hlKXt2YXIgb2xkYWdlPVwiU2F0LCAxIEphbiAyMDAwIDAwOjAwOjAwIEdNVFwiO3htbGh0dHAuc2V0UmVxdWVzdEhlYWRlcihcIklmLU1vZGlmaWVkLVNpbmNlXCIsb2xkYWdlKTt9XG54bWxodHRwLnNlbmQoXCJcIik7fVxuY2F0Y2goZSl7U2FyaXNzYS51cGRhdGVDdXJzb3Iob1RhcmdldEVsZW1lbnQsXCJhdXRvXCIpO2lmKGNhbGxiYWNrKXtjYWxsYmFjayhzRnJvbVVybCxvVGFyZ2V0RWxlbWVudCxlKTt9XG5lbHNle3Rocm93IGU7fX19O1Nhcmlzc2EudXBkYXRlQ29udGVudEZyb21Ob2RlPWZ1bmN0aW9uKG9Ob2RlLG9UYXJnZXRFbGVtZW50LHhzbHRwcm9jKXt0cnl7U2FyaXNzYS51cGRhdGVDdXJzb3Iob1RhcmdldEVsZW1lbnQsXCJ3YWl0XCIpO1Nhcmlzc2EuY2xlYXJDaGlsZE5vZGVzKG9UYXJnZXRFbGVtZW50KTt2YXIgb3duZXJEb2M9b05vZGUubm9kZVR5cGU9PU5vZGUuRE9DVU1FTlRfTk9ERT9vTm9kZTpvTm9kZS5vd25lckRvY3VtZW50O2lmKG93bmVyRG9jLnBhcnNlRXJyb3ImJm93bmVyRG9jLnBhcnNlRXJyb3IuZXJyb3JDb2RlIT0wKXt2YXIgcHJlPWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJwcmVcIik7cHJlLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKFNhcmlzc2EuZ2V0UGFyc2VFcnJvclRleHQob3duZXJEb2MpKSk7b1RhcmdldEVsZW1lbnQuYXBwZW5kQ2hpbGQocHJlKTt9XG5lbHNle2lmKHhzbHRwcm9jKXtvTm9kZT14c2x0cHJvYy50cmFuc2Zvcm1Ub0RvY3VtZW50KG9Ob2RlKTt9XG5pZihvVGFyZ2V0RWxlbWVudC50YWdOYW1lLnRvTG93ZXJDYXNlKCk9PVwidGV4dGFyZWFcInx8b1RhcmdldEVsZW1lbnQudGFnTmFtZS50b0xvd2VyQ2FzZSgpPT1cImlucHV0XCIpe29UYXJnZXRFbGVtZW50LnZhbHVlPW5ldyBYTUxTZXJpYWxpemVyKCkuc2VyaWFsaXplVG9TdHJpbmcob05vZGUpO31cbmVsc2V7dHJ5e29UYXJnZXRFbGVtZW50LmFwcGVuZENoaWxkKG9UYXJnZXRFbGVtZW50Lm93bmVyRG9jdW1lbnQuaW1wb3J0Tm9kZShvTm9kZSx0cnVlKSk7fVxuY2F0Y2goZSl7b1RhcmdldEVsZW1lbnQuaW5uZXJIVE1MPW5ldyBYTUxTZXJpYWxpemVyKCkuc2VyaWFsaXplVG9TdHJpbmcob05vZGUpO319fX1cbmNhdGNoKGUpe3Rocm93IGU7fVxuZmluYWxseXtTYXJpc3NhLnVwZGF0ZUN1cnNvcihvVGFyZ2V0RWxlbWVudCxcImF1dG9cIik7fX07U2FyaXNzYS5mb3JtVG9RdWVyeVN0cmluZz1mdW5jdGlvbihvRm9ybSl7dmFyIHFzPVwiXCI7Zm9yKHZhciBpPTA7aTxvRm9ybS5lbGVtZW50cy5sZW5ndGg7aSsrKXt2YXIgb0ZpZWxkPW9Gb3JtLmVsZW1lbnRzW2ldO3ZhciBzRmllbGROYW1lPW9GaWVsZC5nZXRBdHRyaWJ1dGUoXCJuYW1lXCIpP29GaWVsZC5nZXRBdHRyaWJ1dGUoXCJuYW1lXCIpOm9GaWVsZC5nZXRBdHRyaWJ1dGUoXCJpZFwiKTtpZihzRmllbGROYW1lJiYoKCFvRmllbGQuZGlzYWJsZWQpfHxvRmllbGQudHlwZT09XCJoaWRkZW5cIikpe3N3aXRjaChvRmllbGQudHlwZSl7Y2FzZVwiaGlkZGVuXCI6Y2FzZVwidGV4dFwiOmNhc2VcInRleHRhcmVhXCI6Y2FzZVwicGFzc3dvcmRcIjpxcys9c0ZpZWxkTmFtZStcIj1cIitlbmNvZGVVUklDb21wb25lbnQob0ZpZWxkLnZhbHVlKStcIiZcIjticmVhaztjYXNlXCJzZWxlY3Qtb25lXCI6cXMrPXNGaWVsZE5hbWUrXCI9XCIrZW5jb2RlVVJJQ29tcG9uZW50KG9GaWVsZC5vcHRpb25zW29GaWVsZC5zZWxlY3RlZEluZGV4XS52YWx1ZSkrXCImXCI7YnJlYWs7Y2FzZVwic2VsZWN0LW11bHRpcGxlXCI6Zm9yKHZhciBqPTA7ajxvRmllbGQubGVuZ3RoO2orKyl7dmFyIG9wdEVsZW09b0ZpZWxkLm9wdGlvbnNbal07aWYob3B0RWxlbS5zZWxlY3RlZD09PXRydWUpe3FzKz1zRmllbGROYW1lK1wiW11cIitcIj1cIitlbmNvZGVVUklDb21wb25lbnQob3B0RWxlbS52YWx1ZSkrXCImXCI7fX1cbmJyZWFrO2Nhc2VcImNoZWNrYm94XCI6Y2FzZVwicmFkaW9cIjppZihvRmllbGQuY2hlY2tlZCl7cXMrPXNGaWVsZE5hbWUrXCI9XCIrZW5jb2RlVVJJQ29tcG9uZW50KG9GaWVsZC52YWx1ZSkrXCImXCI7fVxuYnJlYWs7fX19XG5yZXR1cm4gcXMuc3Vic3RyKDAscXMubGVuZ3RoLTEpO307U2FyaXNzYS51cGRhdGVDb250ZW50RnJvbUZvcm09ZnVuY3Rpb24ob0Zvcm0sb1RhcmdldEVsZW1lbnQseHNsdHByb2MsY2FsbGJhY2spe3RyeXtTYXJpc3NhLnVwZGF0ZUN1cnNvcihvVGFyZ2V0RWxlbWVudCxcIndhaXRcIik7dmFyIHBhcmFtcz1TYXJpc3NhLmZvcm1Ub1F1ZXJ5U3RyaW5nKG9Gb3JtKStcIiZcIitTYXJpc3NhLlJFTU9URV9DQUxMX0ZMQUcrXCI9dHJ1ZVwiO3ZhciB4bWxodHRwPW5ldyBYTUxIdHRwUmVxdWVzdCgpO3ZhciBiVXNlR2V0PW9Gb3JtLmdldEF0dHJpYnV0ZShcIm1ldGhvZFwiKSYmb0Zvcm0uZ2V0QXR0cmlidXRlKFwibWV0aG9kXCIpLnRvTG93ZXJDYXNlKCk9PVwiZ2V0XCI7aWYoYlVzZUdldCl7eG1saHR0cC5vcGVuKFwiR0VUXCIsb0Zvcm0uZ2V0QXR0cmlidXRlKFwiYWN0aW9uXCIpK1wiP1wiK3BhcmFtcyx0cnVlKTt9XG5lbHNle3htbGh0dHAub3BlbignUE9TVCcsb0Zvcm0uZ2V0QXR0cmlidXRlKFwiYWN0aW9uXCIpLHRydWUpO3htbGh0dHAuc2V0UmVxdWVzdEhlYWRlcihcIkNvbnRlbnQtdHlwZVwiLFwiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkXCIpO3htbGh0dHAuc2V0UmVxdWVzdEhlYWRlcihcIkNvbnRlbnQtbGVuZ3RoXCIscGFyYW1zLmxlbmd0aCk7eG1saHR0cC5zZXRSZXF1ZXN0SGVhZGVyKFwiQ29ubmVjdGlvblwiLFwiY2xvc2VcIik7fVxueG1saHR0cC5vbnJlYWR5c3RhdGVjaGFuZ2U9ZnVuY3Rpb24oKXt0cnl7aWYoeG1saHR0cC5yZWFkeVN0YXRlPT00KXt2YXIgb0RvbURvYz14bWxodHRwLnJlc3BvbnNlWE1MO2lmKG9Eb21Eb2MmJlNhcmlzc2EuZ2V0UGFyc2VFcnJvclRleHQob0RvbURvYyk9PVNhcmlzc2EuUEFSU0VEX09LKXtTYXJpc3NhLnVwZGF0ZUNvbnRlbnRGcm9tTm9kZSh4bWxodHRwLnJlc3BvbnNlWE1MLG9UYXJnZXRFbGVtZW50LHhzbHRwcm9jKTtpZihjYWxsYmFjayl7Y2FsbGJhY2sob0Zvcm0sb1RhcmdldEVsZW1lbnQpO319XG5lbHNle3Rocm93IFNhcmlzc2EuZ2V0UGFyc2VFcnJvclRleHQob0RvbURvYyk7fX19XG5jYXRjaChlKXtpZihjYWxsYmFjayl7Y2FsbGJhY2sob0Zvcm0sb1RhcmdldEVsZW1lbnQsZSk7fVxuZWxzZXt0aHJvdyBlO319fTt4bWxodHRwLnNlbmQoYlVzZUdldD9cIlwiOnBhcmFtcyk7fVxuY2F0Y2goZSl7U2FyaXNzYS51cGRhdGVDdXJzb3Iob1RhcmdldEVsZW1lbnQsXCJhdXRvXCIpO2lmKGNhbGxiYWNrKXtjYWxsYmFjayhvRm9ybSxvVGFyZ2V0RWxlbWVudCxlKTt9XG5lbHNle3Rocm93IGU7fX1cbnJldHVybiBmYWxzZTt9O1Nhcmlzc2EuRlVOQ1RJT05fTkFNRV9SRUdFWFA9bmV3IFJlZ0V4cChcIlwiKTtTYXJpc3NhLmdldEZ1bmN0aW9uTmFtZT1mdW5jdGlvbihvRnVuYyxiRm9yY2Upe3ZhciBuYW1lO2lmKCFuYW1lKXtpZihiRm9yY2Upe25hbWU9XCJTYXJpc3NhQW5vbnltb3VzXCIrU2FyaXNzYS5fZ2V0VW5pcXVlU3VmZml4KCk7d2luZG93W25hbWVdPW9GdW5jO31cbmVsc2V7bmFtZT1udWxsO319XG5pZihuYW1lKXt3aW5kb3dbbmFtZV09b0Z1bmM7fVxucmV0dXJuIG5hbWU7fTtTYXJpc3NhLnNldFJlbW90ZUpzb25DYWxsYmFjaz1mdW5jdGlvbih1cmwsY2FsbGJhY2ssY2FsbGJhY2tQYXJhbSl7aWYoIWNhbGxiYWNrUGFyYW0pe2NhbGxiYWNrUGFyYW09XCJjYWxsYmFja1wiO31cbnZhciBjYWxsYmFja0Z1bmN0aW9uTmFtZT1TYXJpc3NhLmdldEZ1bmN0aW9uTmFtZShjYWxsYmFjayx0cnVlKTt2YXIgaWQ9XCJzYXJpc3NhX2pzb25fc2NyaXB0X2lkX1wiK1Nhcmlzc2EuX2dldFVuaXF1ZVN1ZmZpeCgpO3ZhciBvSGVhZD1kb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShcImhlYWRcIilbMF07dmFyIHNjcmlwdFRhZz1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTtzY3JpcHRUYWcudHlwZT0ndGV4dC9qYXZhc2NyaXB0JztzY3JpcHRUYWcuaWQ9aWQ7c2NyaXB0VGFnLm9ubG9hZD1mdW5jdGlvbigpe307aWYodXJsLmluZGV4T2YoXCI/XCIpIT0tMSl7dXJsKz0oXCImXCIrY2FsbGJhY2tQYXJhbStcIj1cIitjYWxsYmFja0Z1bmN0aW9uTmFtZSk7fVxuZWxzZXt1cmwrPShcIj9cIitjYWxsYmFja1BhcmFtK1wiPVwiK2NhbGxiYWNrRnVuY3Rpb25OYW1lKTt9XG5zY3JpcHRUYWcuc3JjPXVybDtvSGVhZC5hcHBlbmRDaGlsZChzY3JpcHRUYWcpO3JldHVybiBpZDt9O1xuXG4vLyBzYXJpc3NhX2llZW11X3hwYXRoLmpzXG5cbmlmKFNhcmlzc2EuX1NBUklTU0FfSEFTX0RPTV9GRUFUVVJFJiZkb2N1bWVudC5pbXBsZW1lbnRhdGlvbi5oYXNGZWF0dXJlKFwiWFBhdGhcIixcIjMuMFwiKSl7U2FyaXNzYU5vZGVMaXN0PWZ1bmN0aW9uKGkpe3RoaXMubGVuZ3RoPWk7fTtTYXJpc3NhTm9kZUxpc3QucHJvdG90eXBlPVtdO1Nhcmlzc2FOb2RlTGlzdC5wcm90b3R5cGUuY29uc3RydWN0b3I9QXJyYXk7U2FyaXNzYU5vZGVMaXN0LnByb3RvdHlwZS5pdGVtPWZ1bmN0aW9uKGkpe3JldHVybihpPDB8fGk+PXRoaXMubGVuZ3RoKT9udWxsOnRoaXNbaV07fTtTYXJpc3NhTm9kZUxpc3QucHJvdG90eXBlLmV4cHI9XCJcIjtpZih3aW5kb3cuWE1MRG9jdW1lbnQmJighWE1MRG9jdW1lbnQucHJvdG90eXBlLnNldFByb3BlcnR5KSl7WE1MRG9jdW1lbnQucHJvdG90eXBlLnNldFByb3BlcnR5PWZ1bmN0aW9uKHgseSl7fTt9XG5TYXJpc3NhLnNldFhwYXRoTmFtZXNwYWNlcz1mdW5jdGlvbihvRG9jLHNOc1NldCl7b0RvYy5fc2FyaXNzYV91c2VDdXN0b21SZXNvbHZlcj10cnVlO3ZhciBuYW1lc3BhY2VzPXNOc1NldC5pbmRleE9mKFwiIFwiKT4tMT9zTnNTZXQuc3BsaXQoXCIgXCIpOltzTnNTZXRdO29Eb2MuX3Nhcmlzc2FfeHBhdGhOYW1lc3BhY2VzPVtdO2Zvcih2YXIgaT0wO2k8bmFtZXNwYWNlcy5sZW5ndGg7aSsrKXt2YXIgbnM9bmFtZXNwYWNlc1tpXTt2YXIgY29sb25Qb3M9bnMuaW5kZXhPZihcIjpcIik7dmFyIGFzc2lnblBvcz1ucy5pbmRleE9mKFwiPVwiKTtpZihjb2xvblBvcz4wJiZhc3NpZ25Qb3M+Y29sb25Qb3MrMSl7dmFyIHByZWZpeD1ucy5zdWJzdHJpbmcoY29sb25Qb3MrMSxhc3NpZ25Qb3MpO3ZhciB1cmk9bnMuc3Vic3RyaW5nKGFzc2lnblBvcysyLG5zLmxlbmd0aC0xKTtvRG9jLl9zYXJpc3NhX3hwYXRoTmFtZXNwYWNlc1twcmVmaXhdPXVyaTt9ZWxzZXt0aHJvd1wiQmFkIGZvcm1hdCBvbiBuYW1lc3BhY2UgZGVjbGFyYXRpb24ocykgZ2l2ZW5cIjt9fX07WE1MRG9jdW1lbnQucHJvdG90eXBlLl9zYXJpc3NhX3VzZUN1c3RvbVJlc29sdmVyPWZhbHNlO1hNTERvY3VtZW50LnByb3RvdHlwZS5fc2FyaXNzYV94cGF0aE5hbWVzcGFjZXM9W107WE1MRG9jdW1lbnQucHJvdG90eXBlLnNlbGVjdE5vZGVzPWZ1bmN0aW9uKHNFeHByLGNvbnRleHROb2RlLHJldHVyblNpbmdsZSl7dmFyIG5zRG9jPXRoaXM7dmFyIG5zcmVzb2x2ZXI7aWYodGhpcy5fc2FyaXNzYV91c2VDdXN0b21SZXNvbHZlcil7bnNyZXNvbHZlcj1mdW5jdGlvbihwcmVmaXgpe3ZhciBzPW5zRG9jLl9zYXJpc3NhX3hwYXRoTmFtZXNwYWNlc1twcmVmaXhdO2lmKHMpe3JldHVybiBzO31cbmVsc2V7dGhyb3dcIk5vIG5hbWVzcGFjZSBVUkkgZm91bmQgZm9yIHByZWZpeDogJ1wiK3ByZWZpeCtcIidcIjt9fTt9XG5lbHNle25zcmVzb2x2ZXI9dGhpcy5jcmVhdGVOU1Jlc29sdmVyKHRoaXMuZG9jdW1lbnRFbGVtZW50KTt9XG52YXIgcmVzdWx0PW51bGw7aWYoIXJldHVyblNpbmdsZSl7dmFyIG9SZXN1bHQ9dGhpcy5ldmFsdWF0ZShzRXhwciwoY29udGV4dE5vZGU/Y29udGV4dE5vZGU6dGhpcyksbnNyZXNvbHZlcixYUGF0aFJlc3VsdC5PUkRFUkVEX05PREVfU05BUFNIT1RfVFlQRSxudWxsKTt2YXIgbm9kZUxpc3Q9bmV3IFNhcmlzc2FOb2RlTGlzdChvUmVzdWx0LnNuYXBzaG90TGVuZ3RoKTtub2RlTGlzdC5leHByPXNFeHByO2Zvcih2YXIgaT0wO2k8bm9kZUxpc3QubGVuZ3RoO2krKyl7bm9kZUxpc3RbaV09b1Jlc3VsdC5zbmFwc2hvdEl0ZW0oaSk7fVxucmVzdWx0PW5vZGVMaXN0O31cbmVsc2V7cmVzdWx0PXRoaXMuZXZhbHVhdGUoc0V4cHIsKGNvbnRleHROb2RlP2NvbnRleHROb2RlOnRoaXMpLG5zcmVzb2x2ZXIsWFBhdGhSZXN1bHQuRklSU1RfT1JERVJFRF9OT0RFX1RZUEUsbnVsbCkuc2luZ2xlTm9kZVZhbHVlO31cbnJldHVybiByZXN1bHQ7fTtFbGVtZW50LnByb3RvdHlwZS5zZWxlY3ROb2Rlcz1mdW5jdGlvbihzRXhwcil7dmFyIGRvYz10aGlzLm93bmVyRG9jdW1lbnQ7aWYoZG9jLnNlbGVjdE5vZGVzKXtyZXR1cm4gZG9jLnNlbGVjdE5vZGVzKHNFeHByLHRoaXMpO31cbmVsc2V7dGhyb3dcIk1ldGhvZCBzZWxlY3ROb2RlcyBpcyBvbmx5IHN1cHBvcnRlZCBieSBYTUwgRWxlbWVudHNcIjt9fTtYTUxEb2N1bWVudC5wcm90b3R5cGUuc2VsZWN0U2luZ2xlTm9kZT1mdW5jdGlvbihzRXhwcixjb250ZXh0Tm9kZSl7dmFyIGN0eD1jb250ZXh0Tm9kZT9jb250ZXh0Tm9kZTpudWxsO3JldHVybiB0aGlzLnNlbGVjdE5vZGVzKHNFeHByLGN0eCx0cnVlKTt9O0VsZW1lbnQucHJvdG90eXBlLnNlbGVjdFNpbmdsZU5vZGU9ZnVuY3Rpb24oc0V4cHIpe3ZhciBkb2M9dGhpcy5vd25lckRvY3VtZW50O2lmKGRvYy5zZWxlY3RTaW5nbGVOb2RlKXtyZXR1cm4gZG9jLnNlbGVjdFNpbmdsZU5vZGUoc0V4cHIsdGhpcyk7fVxuZWxzZXt0aHJvd1wiTWV0aG9kIHNlbGVjdE5vZGVzIGlzIG9ubHkgc3VwcG9ydGVkIGJ5IFhNTCBFbGVtZW50c1wiO319O1Nhcmlzc2EuSVNfRU5BQkxFRF9TRUxFQ1RfTk9ERVM9dHJ1ZTt9XG5cbi8vIGpxdWVyeS54c2x0LmpzXG5cbnZhciB4c2xUcmFuc2Zvcm09e3ZlcnNpb246MjAwNzEyMDMsZGVidWc6ZmFsc2UsaW5pdDpmdW5jdGlvbigpe3RyeXtwYXJzZUZsb2F0KGpRdWVyeS5mbi5qcXVlcnkpPj0xO31jYXRjaChlKXthbGVydCgneHNsVHJhbnNmb3JtIHJlcXVpcmVzIGpRdWVyeSAxLjAuNCBvciBncmVhdGVyIC4uLiBwbGVhc2UgbG9hZCBpdCBwcmlvciB0byB4c2xUcmFuc2Zvcm0nKTt9XG50cnl7U2FyaXNzYTt9Y2F0Y2goZSl7YWxlcnQoJ01pc3NpbmcgU2FyaXNzYSAuLi4gcGxlYXNlIGxvYWQgaXQgcHJpb3IgdG8geHNsVHJhbnNmb3JtJyk7fVxuaWYoIWpRdWVyeS5sb2cpe2pRdWVyeS5sb2c9ZnVuY3Rpb24oKXt9O2pRdWVyeS5mbi5kZWJ1Zz1mdW5jdGlvbigpe307fVxuaWYodGhpcy5kZWJ1ZylqUXVlcnkubG9nKCd4c2xUcmFuc2Zvcm06aW5pdCgpOiB2ZXJzaW9uICcreHNsVHJhbnNmb3JtLnZlcnNpb24pO30sWE1MU2VyaWFsaXplcjpuZXcgWE1MU2VyaWFsaXplcigpLHNlcmlhbGl6ZTpmdW5jdGlvbihkYXRhKXtpZih0aGlzLmRlYnVnKWpRdWVyeS5sb2coJ3NlcmlhbGl6ZSgpOiByZWNlaXZlZCAnK3R5cGVvZihkYXRhKSk7aWYodHlwZW9mKGRhdGEpPT0nc3RyaW5nJyl7cmV0dXJuIGRhdGE7fVxucmV0dXJuIHRoaXMuWE1MU2VyaWFsaXplci5zZXJpYWxpemVUb1N0cmluZyhkYXRhKTt9LGxvYWQ6ZnVuY3Rpb24oeG1sLG1ldGgpe2lmKHRoaXMuZGVidWcpalF1ZXJ5LmxvZygnbG9hZCgpOiByZWNlaXZlZCAnK3R5cGVvZih4bWwpKTt2YXIgcjtpZih0eXBlb2YoeG1sKT09J29iamVjdCcpe3JldHVybiB4bWw7fVxuaWYoeG1sLnN1YnN0cmluZygwLDEpPT0nPCcpe3I9dGhpcy5sb2FkU3RyaW5nKHhtbCk7fWVsc2V7cj10aGlzLmxvYWRGaWxlKHhtbCxtZXRoKTt9XG5pZihyKXtyLnNldFByb3BlcnR5KCdTZWxlY3Rpb25OYW1lc3BhY2VzJywneG1sbnM6eHNsPVwiaHR0cDovL3d3dy53My5vcmcvMTk5OS9YU0wvVHJhbnNmb3JtXCInKTtyLnNldFByb3BlcnR5KCdTZWxlY3Rpb25MYW5ndWFnZScsJ1hQYXRoJyk7cmV0dXJuIHI7fWVsc2V7aWYodGhpcy5kZWJ1ZykkLmxvZygnVW5hYmxlIHRvIGxvYWQgJyt4bWwpO3JldHVybiBmYWxzZTt9fSxsb2FkU3RyaW5nOmZ1bmN0aW9uKHN0cil7aWYodGhpcy5kZWJ1ZylqUXVlcnkubG9nKCdsb2FkU3RyaW5nKCk6ICcrc3RyKyc6OicrdHlwZW9mKHN0cikpO3ZhciBwPW5ldyBET01QYXJzZXIoKTt2YXIgeG1sPXAucGFyc2VGcm9tU3RyaW5nKHN0ciwndGV4dC94bWwnKTtpZigheG1sKXtpZih0aGlzLmRlYnVnKWpRdWVyeS5sb2coJ2xvYWRTdHJpbmcoKTogcGFyc2VGcm9tU3RyaW5nKCkgZmFpbGVkJyk7cmV0dXJuIGZhbHNlO31cbnJldHVybiB4bWw7fSxsb2FkRmlsZTpmdW5jdGlvbih1cmwsbWV0aCl7aWYodGhpcy5kZWJ1ZylqUXVlcnkubG9nKCdsb2FkRmlsZSgpOiAnK3VybCsnOjonK3R5cGVvZih1cmwpKTtpZighdXJsKXtpZih0aGlzLmRlYnVnKWpRdWVyeS5sb2coJ0VSUk9SOiBsb2FkRmlsZSgpIG1pc3NpbmcgdXJsJyk7cmV0dXJuIGZhbHNlO31cbnZhciBkb2M7dGhpcy54aHJzdWNjZXNzPWZ1bmN0aW9uKGRhdGEsc3RyKXtpZih0aGlzLmRlYnVnKWpRdWVyeS5sb2coJ2xvYWRGaWxlKCkgY29tcGxldGVkIHN1Y2Nlc3NmdWxseSAoJytzdHIrJyknKTtkb2M9ZGF0YTtyZXR1cm4gdHJ1ZTt9O3RoaXMueGhyZXJyb3I9ZnVuY3Rpb24oeGhyLGVycil7d2luZG93LkRFQlVHPXRydWU7aWYodGhpcy5kZWJ1ZylqUXVlcnkubG9nKCdsb2FkRmlsZSgpIGZhaWxlZCB0byBsb2FkIHRoZSByZXF1ZXN0ZWQgZmlsZTogKCcrZXJyKycpIC0geG1sOiAnK3hoci5yZXNwb25zZVhNTCsnIC0gdGV4dDogJyt4aHIucmVzcG9uc2VUZXh0KTtkb2M9bnVsbDtyZXR1cm4gZmFsc2U7fTtpZighbWV0aCltZXRoPVwiR0VUXCI7JC5hamF4KHt0eXBlOm1ldGgsdXJsOnVybCxhc3luYzpmYWxzZSxzdWNjZXNzOnRoaXMueGhyc3VjY2VzcyxlcnJvcjp0aGlzLnhocmVycm9yfSk7aWYoIWRvYyl7aWYodGhpcy5kZWJ1ZylqUXVlcnkubG9nKCdFUlJPUjogZG9jdW1lbnQgJyt1cmwrJyBub3QgZm91bmQgKDQwNCksIG9yIHVuYWJsZSB0byBsb2FkJyk7cmV0dXJuIGZhbHNlO31cbmlmKGRvYy5sZW5ndGg9PTApe2lmKHRoaXMuZGVidWcpalF1ZXJ5LmxvZygnRVJST1I6IGRvY3VtZW50ICcrdXJsKycgbG9hZGVkIGluIGxvYWRGaWxlKCkgaGFzIG5vIGRhdGEnKTtyZXR1cm4gZmFsc2U7fVxucmV0dXJuIGRvYzt9LHRyYW5zZm9ybTpmdW5jdGlvbih4c2wseG1sLG9wdGlvbnMpe3ZhciBsb2c9eyd4c2wnOnhzbCwneG1sJzp4bWwsJ29wdGlvbnMnOm9wdGlvbnN9O2lmKHRoaXMuZGVidWcpalF1ZXJ5LmxvZygndHJhbnNmb3JtKCk6ICcreHNsKyc6OicreG1sKyc6Oicrb3B0aW9ucy50b1N0cmluZygpKTtvcHRpb25zPW9wdGlvbnN8fHt9O3ZhciB4bWw9eydyZXF1ZXN0Jzp4bWwsJ2RvYyc6dGhpcy5sb2FkKHhtbCxvcHRpb25zLm1ldGgpfTtpZihvcHRpb25zLnhwYXRoJiZ4bWwuZG9jJiYhalF1ZXJ5LmJyb3dzZXIubXNpZSl7eG1sLmRvYz14bWwuZG9jLnNlbGVjdFNpbmdsZU5vZGUob3B0aW9ucy54cGF0aC50b1N0cmluZygpKTtpZih0aGlzLmRlYnVnKSQubG9nKCd0cmFuc2Zvcm0oKTogeHBhdGggaGFzIGJlZW4gcnVuLi4ucmVzdWx0aW5nIGRvYzogJysodGhpcy5zZXJpYWxpemUoeG1sLmRvYykpKTt9XG52YXIgcmVzdWx0PXsneHNsJzp0aGlzLmxvYWQoeHNsLG9wdGlvbnMubWV0aCl9O3Jlc3VsdC5qc29uPWZhbHNlO2lmKG9wdGlvbnMuanNvbiYmeG1sLmRvYyl7cmVzdWx0Lmpzb249eG1sLmRvYy5zZWxlY3RTaW5nbGVOb2RlKG9wdGlvbnMuanNvbi50b1N0cmluZygpKTt9XG52YXIgcHJvY2Vzc29yPW5ldyBYU0xUUHJvY2Vzc29yKCk7cHJvY2Vzc29yLmltcG9ydFN0eWxlc2hlZXQocmVzdWx0LnhzbCk7aWYob3B0aW9ucy5wYXJhbXMmJnByb2Nlc3Nvcil7aWYodGhpcy5kZWJ1ZylqUXVlcnkubG9nKCd0cmFuc2Zvcm0oKTogcmVjZWl2ZWQgeHNsIHBhcmFtczogJytvcHRpb25zLnBhcmFtcy50b1N0cmluZygpKTtmb3Ioa2V5IGluIG9wdGlvbnMucGFyYW1zKXtwcm9jZXNzb3Iuc2V0UGFyYW1ldGVyKG51bGwsa2V5LnRvU3RyaW5nKCksb3B0aW9ucy5wYXJhbXNba2V5XS50b1N0cmluZygpKTt9fVxucmVzdWx0LmRvYz1wcm9jZXNzb3IudHJhbnNmb3JtVG9Eb2N1bWVudCh4bWwuZG9jKTt2YXIgZXJyb3JUeHQ9U2FyaXNzYS5nZXRQYXJzZUVycm9yVGV4dChyZXN1bHQuZG9jKTtpZih0aGlzLmRlYnVnKWpRdWVyeS5sb2coJ3RyYW5zZm9ybSgpOiBTYXJpc3NhIHBhcnNlIHRleHQ6ICcrZXJyb3JUeHQpO2lmKGVycm9yVHh0IT1TYXJpc3NhLlBBUlNFRF9PSyl7cmVzdWx0LnN0cmluZz1TYXJpc3NhLmdldFBhcnNlRXJyb3JUZXh0KHJlc3VsdC5kb2MpKycgOjogdXNpbmcgJyt4c2wrJyA9PiAnK3htbC5yZXF1ZXN0O2lmKHRoaXMuZGVidWcpalF1ZXJ5LmxvZygndHJhbnNmb3JtKCk6IGVycm9yIGluIHRyYW5zZm9ybWF0aW9uOiAnK1Nhcmlzc2EuZ2V0UGFyc2VFcnJvclRleHQocmVzdWx0LmRvYykpO3JldHVybiByZXN1bHQ7fVxucmVzdWx0LnN0cmluZz10aGlzLnNlcmlhbGl6ZShyZXN1bHQuZG9jKTtyZXN1bHQuc2NyaXB0cz1qUXVlcnkoJ3NjcmlwdCcscmVzdWx0LmRvYykudGV4dCgpO3JldHVybiByZXN1bHQ7fX07eHNsVHJhbnNmb3JtLmluaXQoKTtqUXVlcnkuZm4uZ2V0VHJhbnNmb3JtPWZ1bmN0aW9uKHhzbCx4bWwsb3B0aW9ucyl7dmFyIHNldHRpbmdzPXthcHBlbmQ6ZmFsc2UscGFyYW1zOnt9LHhwYXRoOicnLGV2YWw6dHJ1ZSxjYWxsYmFjazonJyxqc29uOmZhbHNlLG1ldGg6XCJHRVRcIn07alF1ZXJ5LmV4dGVuZChzZXR0aW5ncyxvcHRpb25zKTtpZih4c2xUcmFuc2Zvcm0uZGVidWcpalF1ZXJ5LmxvZygnZ2V0VHJhbnNmb3JtOiAnK3hzbCsnOjonK3htbCsnOjonK3NldHRpbmdzLnRvU3RyaW5nKCkpO2lmKCF4c2x8fCF4bWwpe2lmKHhzbFRyYW5zZm9ybS5kZWJ1ZylqUXVlcnkubG9nKCdnZXRUcmFuc2Zvcm06IG1pc3NpbmcgeHNsIG9yIHhtbCcpO3JldHVybjt9XG5yZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7dmFyIHRyYW5zPXhzbFRyYW5zZm9ybS50cmFuc2Zvcm0oeHNsLHhtbCxzZXR0aW5ncyk7dmFyIHJlPXRyYW5zLnN0cmluZy5tYXRjaCgvPFxcP3htbC4qP1xcPz4vKTtpZihyZSl7dHJhbnMuc3RyaW5nPXRyYW5zLnN0cmluZy5yZXBsYWNlKHJlLCcnKTtpZih4c2xUcmFuc2Zvcm0uZGVidWcpalF1ZXJ5LmxvZygnZ2V0VHJhbnNmb3JtKCk6IGZvdW5kIGFuIHhtbCBkZWNsYXJhdGlvbiBhbmQgcmVtb3ZlZCBpdCcpO31cbnRyeXtpZihzZXR0aW5ncy5hcHBlbmQpJCh0aGlzKS5hcHBlbmQodHJhbnMuc3RyaW5nKTtlbHNlIGlmKHNldHRpbmdzLnJlcGwpJCh0aGlzKS5yZXBsYWNlV2l0aCh0cmFucy5zdHJpbmcpO2Vsc2UgJCh0aGlzKS5odG1sKHRyYW5zLnN0cmluZyk7fWNhdGNoKGUpe2lmKHhzbFRyYW5zZm9ybS5kZWJ1ZykkLmxvZygnZ2V0VHJhbnNmb3JtOiBlcnJvciBwbGFjaW5nIHJlc3VsdHMgb2YgdHJhbnNmb3JtIGludG8gZWxlbWVudCwgZmFsbGluZyBiYWNrIHRvIGlubmVySFRNTDogJytlLnRvU3RyaW5nKCkpOyQodGhpcylbMF0uaW5uZXJIVE1MPXRyYW5zLnN0cmluZzt9XG5pZihzZXR0aW5ncy5ldmFsJiZ0cmFucy5zY3JpcHRzKXtpZih0cmFucy5zY3JpcHRzLmxlbmd0aD4wKXtpZih4c2xUcmFuc2Zvcm0uZGVidWcpalF1ZXJ5LmxvZygnRm91bmQgdGV4dC9qYXZhc2NyaXB0IGluIHRyYW5zZm9ybWVkIHJlc3VsdCcpO2V2YWwuY2FsbCh3aW5kb3csdHJhbnMuc2NyaXB0cyk7fX1cbmlmKHNldHRpbmdzLmNhbGxiYWNrJiZqUXVlcnkuaXNGdW5jdGlvbihzZXR0aW5ncy5jYWxsYmFjaykpe3ZhciBqc29uPWZhbHNlO2lmKHNldHRpbmdzLmpzb24mJnRyYW5zLmpzb24pZXZhbChcImpzb24gPSBcIit0cmFucy5qc29uLmZpcnN0Q2hpbGQuZGF0YSk7c2V0dGluZ3MuY2FsbGJhY2suYXBwbHkod2luZG93LFt0cmFucy5zdHJpbmcsanNvbl0pO319KTt9O1xuXG4vLyBqcXVlcnkubWV0YWRhdGEuanNcblxuKGZ1bmN0aW9uKCQpeyQuZXh0ZW5kKHttZXRhZGF0YTp7ZGVmYXVsdHM6e3R5cGU6J2NsYXNzJyxuYW1lOidtZXRhZGF0YScsY3JlOi8oey4qfSkvLHNpbmdsZTonbWV0YWRhdGEnfSxzZXRUeXBlOmZ1bmN0aW9uKHR5cGUsbmFtZSl7dGhpcy5kZWZhdWx0cy50eXBlPXR5cGU7dGhpcy5kZWZhdWx0cy5uYW1lPW5hbWU7fSxnZXQ6ZnVuY3Rpb24oZWxlbSxvcHRzKXt2YXIgc2V0dGluZ3M9JC5leHRlbmQoe30sdGhpcy5kZWZhdWx0cyxvcHRzKTtpZighc2V0dGluZ3Muc2luZ2xlLmxlbmd0aClzZXR0aW5ncy5zaW5nbGU9J21ldGFkYXRhJzt2YXIgZGF0YT0kLmRhdGEoZWxlbSxzZXR0aW5ncy5zaW5nbGUpO2lmKGRhdGEpcmV0dXJuIGRhdGE7ZGF0YT1cInt9XCI7aWYoc2V0dGluZ3MudHlwZT09XCJjbGFzc1wiKXt2YXIgbT1zZXR0aW5ncy5jcmUuZXhlYyhlbGVtLmNsYXNzTmFtZSk7aWYobSlcbmRhdGE9bVsxXTt9ZWxzZSBpZihzZXR0aW5ncy50eXBlPT1cImVsZW1cIil7aWYoIWVsZW0uZ2V0RWxlbWVudHNCeVRhZ05hbWUpXG5yZXR1cm4gdW5kZWZpbmVkO3ZhciBlPWVsZW0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoc2V0dGluZ3MubmFtZSk7aWYoZS5sZW5ndGgpXG5kYXRhPSQudHJpbShlWzBdLmlubmVySFRNTCk7fWVsc2UgaWYoZWxlbS5nZXRBdHRyaWJ1dGUhPXVuZGVmaW5lZCl7dmFyIGF0dHI9ZWxlbS5nZXRBdHRyaWJ1dGUoc2V0dGluZ3MubmFtZSk7aWYoYXR0cilcbmRhdGE9YXR0cjt9XG5pZihkYXRhLmluZGV4T2YoJ3snKTwwKVxuZGF0YT1cIntcIitkYXRhK1wifVwiO2RhdGE9ZXZhbChcIihcIitkYXRhK1wiKVwiKTskLmRhdGEoZWxlbSxzZXR0aW5ncy5zaW5nbGUsZGF0YSk7cmV0dXJuIGRhdGE7fX19KTskLmZuLm1ldGFkYXRhPWZ1bmN0aW9uKG9wdHMpe3JldHVybiAkLm1ldGFkYXRhLmdldCh0aGlzWzBdLG9wdHMpO307fSkoalF1ZXJ5KTtcblxuLy8ganF1ZXJ5LmNvb2tpZS5qc1xuXG5qUXVlcnkuY29va2llPWZ1bmN0aW9uKG5hbWUsdmFsdWUsb3B0aW9ucyl7aWYodHlwZW9mIHZhbHVlIT0ndW5kZWZpbmVkJyl7b3B0aW9ucz1vcHRpb25zfHx7fTtpZih2YWx1ZT09PW51bGwpe3ZhbHVlPScnO29wdGlvbnMuZXhwaXJlcz0tMTt9XG52YXIgZXhwaXJlcz0nJztpZihvcHRpb25zLmV4cGlyZXMmJih0eXBlb2Ygb3B0aW9ucy5leHBpcmVzPT0nbnVtYmVyJ3x8b3B0aW9ucy5leHBpcmVzLnRvVVRDU3RyaW5nKSl7dmFyIGRhdGU7aWYodHlwZW9mIG9wdGlvbnMuZXhwaXJlcz09J251bWJlcicpe2RhdGU9bmV3IERhdGUoKTtkYXRlLnNldFRpbWUoZGF0ZS5nZXRUaW1lKCkrKG9wdGlvbnMuZXhwaXJlcyoyNCo2MCo2MCoxMDAwKSk7fWVsc2V7ZGF0ZT1vcHRpb25zLmV4cGlyZXM7fVxuZXhwaXJlcz0nOyBleHBpcmVzPScrZGF0ZS50b1VUQ1N0cmluZygpO31cbnZhciBwYXRoPW9wdGlvbnMucGF0aD8nOyBwYXRoPScrKG9wdGlvbnMucGF0aCk6Jyc7dmFyIGRvbWFpbj1vcHRpb25zLmRvbWFpbj8nOyBkb21haW49Jysob3B0aW9ucy5kb21haW4pOicnO3ZhciBzZWN1cmU9b3B0aW9ucy5zZWN1cmU/Jzsgc2VjdXJlJzonJztkb2N1bWVudC5jb29raWU9W25hbWUsJz0nLGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSksZXhwaXJlcyxwYXRoLGRvbWFpbixzZWN1cmVdLmpvaW4oJycpO31lbHNle3ZhciBjb29raWVWYWx1ZT1udWxsO2lmKGRvY3VtZW50LmNvb2tpZSYmZG9jdW1lbnQuY29va2llIT0nJyl7dmFyIGNvb2tpZXM9ZG9jdW1lbnQuY29va2llLnNwbGl0KCc7Jyk7Zm9yKHZhciBpPTA7aTxjb29raWVzLmxlbmd0aDtpKyspe3ZhciBjb29raWU9alF1ZXJ5LnRyaW0oY29va2llc1tpXSk7aWYoY29va2llLnN1YnN0cmluZygwLG5hbWUubGVuZ3RoKzEpPT0obmFtZSsnPScpKXtjb29raWVWYWx1ZT1kZWNvZGVVUklDb21wb25lbnQoY29va2llLnN1YnN0cmluZyhuYW1lLmxlbmd0aCsxKSk7YnJlYWs7fX19XG5yZXR1cm4gY29va2llVmFsdWU7fX07IiwiLypcbiAqIGpzVHJlZSAwLjkuNVxuICpcbiAqIENvcHlyaWdodCAoYykgMjAwOCBJdmFuIEJvemhhbm92ICh2YWthdGEuY29tKVxuICpcbiAqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBhbmQgR1BMIGxpY2Vuc2VzOlxuICogICBodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocFxuICogICBodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvZ3BsLmh0bWxcbiAqXG4gKiBEYXRlOiAyMDA5LTAxLTAzXG4gKlxuICovXG4vL2pzaGludCBpZ25vcmU6c3RhcnRcbi8vanNjczpkaXNhYmxlXG5cbi8vIGJyb3dzZXIgZml4XG5qUXVlcnkuYnJvd3NlciA9IHt9O1xualF1ZXJ5LmJyb3dzZXIubW96aWxsYSA9IC9tb3ppbGxhLy50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSkgJiYgIS93ZWJraXQvLnRlc3QobmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpKTtcbmpRdWVyeS5icm93c2VyLndlYmtpdCA9IC93ZWJraXQvLnRlc3QobmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpKTtcbmpRdWVyeS5icm93c2VyLm9wZXJhID0gL29wZXJhLy50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSk7XG5qUXVlcnkuYnJvd3Nlci5tc2llID0gL21zaWUvLnRlc3QobmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpKTtcblxuLy8galF1ZXJ5IHBsdWdpblxualF1ZXJ5LmZuLnRyZWUgPSBmdW5jdGlvbiAob3B0cykge1xuICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7XG4gICAgICAgIGlmKHRyZWVfY29tcG9uZW50Lmluc3QgJiYgdHJlZV9jb21wb25lbnQuaW5zdFtqUXVlcnkodGhpcykuYXR0cignaWQnKV0pIHtcbiAgICAgICAgICAgIHRyZWVfY29tcG9uZW50Lmluc3RbalF1ZXJ5KHRoaXMpLmF0dHIoJ2lkJyldLmRlc3Ryb3koKTtcbiAgICAgICAgfVxuICAgICAgICBpZihvcHRzICE9PSBmYWxzZSkge1xuICAgICAgICAgICAgdmFyIHRtcCA9IG5ldyB0cmVlX2NvbXBvbmVudCgpO1xuICAgICAgICAgICAgdG1wLmluaXQodGhpcywgb3B0cyk7XG4gICAgICAgIH1cbiAgICB9KTtcbn07XG5cbi8vIGNvcmVcbmZ1bmN0aW9uIHRyZWVfY29tcG9uZW50ICgpIHtcbiAgICAvLyBpbnN0YW5jZSBtYW5hZ2VyXG4gICAgaWYodHlwZW9mIHRyZWVfY29tcG9uZW50Lmluc3QgPT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgICB0cmVlX2NvbXBvbmVudC5jbnRyID0gMDtcbiAgICAgICAgdHJlZV9jb21wb25lbnQuaW5zdCA9IFtdO1xuICAgICAgICB0cmVlX2NvbXBvbmVudC5kcm9wID0gW107XG5cbiAgICAgICAgdHJlZV9jb21wb25lbnQuZm9jdXNJbnN0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcmV0dXJuIHRyZWVfY29tcG9uZW50Lmluc3RbdHJlZV9jb21wb25lbnQuZm9jdXNlZF07XG4gICAgICAgIH1cbiAgICAgICAgdHJlZV9jb21wb25lbnQubW91c2Vkb3duID0gZnVuY3Rpb24oZXZlbnQpIHtcbiAgICAgICAgICAgICQoJ2h0bWwnKS5hdHRyKCdkYXRhLXRvdWNoLWFjdGlvbicsICdub25lJyk7XG4gICAgICAgICAgICB2YXIgX3RoaXMgPSB0cmVlX2NvbXBvbmVudC5mb2N1c0luc3QoKTtcbiAgICAgICAgICAgIGlmKCFfdGhpcykgcmV0dXJuO1xuXG4gICAgICAgICAgICB2YXIgdG1wID0galF1ZXJ5KGV2ZW50LnRhcmdldCk7XG4gICAgICAgICAgICBpZih0cmVlX2NvbXBvbmVudC5kcm9wLmxlbmd0aCAmJiB0bXAuaXMoXCIuXCIgKyB0cmVlX2NvbXBvbmVudC5kcm9wLmpvaW4oXCIsIC5cIikpICkge1xuICAgICAgICAgICAgICAgIF90aGlzLmRyYWcgPSBqUXVlcnkoXCI8bGkgaWQ9J2RyYWdnZWQnIGNsYXNzPSdkcmFnZ2VkIGZvcmVpZ24gXCIgKyBldmVudC50YXJnZXQuY2xhc3NOYW1lICsgXCInPjxhIGhyZWY9JyMnPlwiICsgdG1wLnRleHQoKSArIFwiPC9hPjwvbGk+XCIpO1xuICAgICAgICAgICAgICAgIF90aGlzLl9kcmFnID0gX3RoaXMuZHJhZztcbiAgICAgICAgICAgICAgICBfdGhpcy5pc2Rvd24gICAgPSB0cnVlO1xuICAgICAgICAgICAgICAgIF90aGlzLmZvcmVpZ24gICAgPSB0bXA7XG4gICAgICAgICAgICAgICAgdG1wLmJsdXIoKTtcbiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH07XG4gICAgICAgIHRyZWVfY29tcG9uZW50Lm1vdXNldXAgPSBmdW5jdGlvbihldmVudCkge1xuICAgICAgICAgICAgJCgnaHRtbCcpLnJlbW92ZUF0dHIoJ2RhdGEtdG91Y2gtYWN0aW9uJyk7XG4gICAgICAgICAgICB2YXIgX3RoaXMgPSB0cmVlX2NvbXBvbmVudC5mb2N1c0luc3QoKTtcbiAgICAgICAgICAgIGlmKCFfdGhpcykgcmV0dXJuO1xuXG5cbiAgICAgICAgICAgIC8vIENMRUFSIFRJTUVPVVQgRk9SIE9QRU5JTkcgSE9WRVJFRCBOT0RFUyBXSElMRSBEUkFHR0lOR1xuICAgICAgICAgICAgaWYodHJlZV9jb21wb25lbnQudG8pICAgIGNsZWFyVGltZW91dCh0cmVlX2NvbXBvbmVudC50byk7XG4gICAgICAgICAgICBpZih0cmVlX2NvbXBvbmVudC5zdG8pICAgIGNsZWFyVGltZW91dCh0cmVlX2NvbXBvbmVudC5zdG8pO1xuICAgICAgICAgICAgaWYoX3RoaXMuZm9yZWlnbiA9PT0gZmFsc2UgJiYgX3RoaXMuZHJhZyAmJiBfdGhpcy5kcmFnLnBhcmVudE5vZGUgJiYgX3RoaXMuZHJhZy5wYXJlbnROb2RlID09IGpRdWVyeShfdGhpcy5jb250YWluZXIpLmNoaWxkcmVuKFwidWw6ZXEoMClcIikuZ2V0KDApKSB7XG4gICAgICAgICAgICAgICAgalF1ZXJ5KF90aGlzLmRyYWcpLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgIC8vIENBTEwgRlVOQ1RJT04gRk9SIENPTVBMRVRJTkcgTU9WRVxuICAgICAgICAgICAgICAgIGlmKF90aGlzLm1vdmVUeXBlKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB0bXAgPSB0cmVlX2NvbXBvbmVudC5pbnN0W2pRdWVyeShfdGhpcy5tb3ZlUmVmKS5wYXJlbnRzKFwiLnRyZWU6ZXEoMClcIikuYXR0cihcImlkXCIpXTtcbiAgICAgICAgICAgICAgICAgICAgaWYodG1wKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0bXAubW92ZWQoX3RoaXMuY29udGFpbmVyLmZpbmQoXCJsaS5kcmFnZ2VkXCIpLCBfdGhpcy5tb3ZlUmVmLCBfdGhpcy5tb3ZlVHlwZSwgZmFsc2UsIChfdGhpcy5zZXR0aW5ncy5ydWxlcy5kcmFnX2NvcHkgPT0gXCJvblwiIHx8IChfdGhpcy5zZXR0aW5ncy5ydWxlcy5kcmFnX2NvcHkgPT0gXCJjdHJsXCIgJiYgZXZlbnQuY3RybEtleSkgKSApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIF90aGlzLm1vdmVUeXBlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgX3RoaXMubW92ZVJlZiA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYoX3RoaXMuZHJhZyAmJiBfdGhpcy5mb3JlaWduICE9PSBmYWxzZSkge1xuICAgICAgICAgICAgICAgIGpRdWVyeShfdGhpcy5kcmFnKS5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICBpZihfdGhpcy5tb3ZlVHlwZSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgdG1wID0gdHJlZV9jb21wb25lbnQuaW5zdFtqUXVlcnkoX3RoaXMubW92ZVJlZikucGFyZW50cyhcIi50cmVlOmVxKDApXCIpLmF0dHIoXCJpZFwiKV07XG4gICAgICAgICAgICAgICAgICAgIGlmKHRtcCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdG1wLnNldHRpbmdzLmNhbGxiYWNrLm9uZHJvcC5jYWxsKG51bGwsIF90aGlzLmZvcmVpZ24uZ2V0KDApLCBfdGhpcy5nZXRfbm9kZSggX3RoaXMubW92ZVJlZikuZ2V0KDApLCBfdGhpcy5tb3ZlVHlwZSwgX3RoaXMpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIF90aGlzLmZvcmVpZ24gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBfdGhpcy5tb3ZlVHlwZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIF90aGlzLm1vdmVSZWYgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIFJFU0VUIEVWRVJZVEhJTkdcbiAgICAgICAgICAgIGpRdWVyeShcIiNtYXJrZXJcIikuaGlkZSgpO1xuICAgICAgICAgICAgX3RoaXMuX2RyYWcgICAgICAgID0gZmFsc2U7XG4gICAgICAgICAgICBfdGhpcy5kcmFnICAgICAgICA9IGZhbHNlO1xuICAgICAgICAgICAgX3RoaXMuaXNkb3duICAgID0gZmFsc2U7XG4gICAgICAgICAgICBfdGhpcy5hcHBlbmRlZCAgICA9IGZhbHNlO1xuICAgICAgICAgICAgX3RoaXMuY29udGFpbmVyLmZpbmQoXCJsaS5kcmFnZ2VkXCIpLnJlbW92ZUNsYXNzKFwiZHJhZ2dlZFwiKTtcbiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfTtcbiAgICAgICAgdHJlZV9jb21wb25lbnQubW91c2Vtb3ZlID0gZnVuY3Rpb24oZXZlbnQpIHtcbiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRyZWVfY29tcG9uZW50LmZvY3VzSW5zdCgpO1xuICAgICAgICAgICAgaWYoIV90aGlzKSByZXR1cm47XG5cbiAgICAgICAgICAgIGlmKF90aGlzLmxvY2tlZCkgcmV0dXJuIF90aGlzLmVycm9yKFwiTE9DS0VEXCIpO1xuICAgICAgICAgICAgaWYoX3RoaXMuaXNkb3duKSB7XG4gICAgICAgICAgICAgICAgLy8gQ0xFQVIgVElNRU9VVCBGT1IgT1BFTklORyBIT1ZFUkVEIE5PREVTIFdISUxFIERSQUdHSU5HXG4gICAgICAgICAgICAgICAgaWYodHJlZV9jb21wb25lbnQudG8pIGNsZWFyVGltZW91dCh0cmVlX2NvbXBvbmVudC50byk7XG4gICAgICAgICAgICAgICAgaWYoIV90aGlzLmFwcGVuZGVkKSB7XG4gICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRhaW5lci5jaGlsZHJlbihcInVsOmVxKDApXCIpLmFwcGVuZChfdGhpcy5kcmFnKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRtcCA9IGpRdWVyeShfdGhpcy5kcmFnKS5vZmZzZXRQYXJlbnQoKTtcbiAgICAgICAgICAgICAgICAgICAgaWYodG1wLmlzKFwiaHRtbFwiKSkgdG1wID0galF1ZXJ5KFwiYm9keVwiKTtcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMucG8gPSB0bXAub2Zmc2V0KCk7XG4gICAgICAgICAgICAgICAgICAgIF90aGlzLmFwcGVuZGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgalF1ZXJ5KF90aGlzLmRyYWcpLmNzcyh7IFwibGVmdFwiIDogKGV2ZW50Lm9yaWdpbmFsRXZlbnQucGFnZVggLSBfdGhpcy5wby5sZWZ0IC0gKF90aGlzLnNldHRpbmdzLnVpLnJ0bCA/IGpRdWVyeShfdGhpcy5kcmFnKS53aWR0aCgpIDogLTUgKSApLCBcInRvcFwiIDogKGV2ZW50Lm9yaWdpbmFsRXZlbnQucGFnZVkgLSBfdGhpcy5wby50b3AgICsgKGpRdWVyeS5icm93c2VyLm9wZXJhID8gX3RoaXMuY29udGFpbmVyLnNjcm9sbFRvcCgpIDogMCkgKyAxNSkgfSk7XG5cbiAgICAgICAgICAgICAgICBpZihldmVudC50YXJnZXQudGFnTmFtZSA9PSBcIklNR1wiICYmIGV2ZW50LnRhcmdldC5pZCA9PSBcIm1hcmtlclwiKSByZXR1cm4gZmFsc2U7XG5cbiAgICAgICAgICAgICAgICB2YXIgY250ID0galF1ZXJ5KGV2ZW50LnRhcmdldCkucGFyZW50cyhcIi50cmVlOmVxKDApXCIpO1xuXG4gICAgICAgICAgICAgICAgLy8gaWYgbm90IG1vdmluZyBvdmVyIGEgdHJlZVxuICAgICAgICAgICAgICAgIGlmKGNudC5zaXplKCkgPT0gMCkge1xuICAgICAgICAgICAgICAgICAgICBpZih0cmVlX2NvbXBvbmVudC5zdG8pIGNsZWFyVGltZW91dCh0cmVlX2NvbXBvbmVudC5zdG8pO1xuICAgICAgICAgICAgICAgICAgICBpZihqUXVlcnkoX3RoaXMuZHJhZykuY2hpbGRyZW4oXCJJTUdcIikuc2l6ZSgpID09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeShfdGhpcy5kcmFnKS5hcHBlbmQoXCI8aW1nIGNsYXNzPSdyZW1vdmVpY29uJyBzdHlsZT0ncG9zaXRpb246YWJzb2x1dGU7IFwiICsgKF90aGlzLnNldHRpbmdzLnVpLnJ0bCA/IFwicmlnaHRcIiA6IFwibGVmdFwiICkgKyBcIjo0cHg7IHRvcDowcHg7JyBzcmM9J1wiICsgX3RoaXMuc2V0dGluZ3MudWkudGhlbWVfcGF0aCArIFwiZGVmYXVsdC9yZW1vdmUuZ2lmJyAvPlwiKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBfdGhpcy5tb3ZlVHlwZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBfdGhpcy5tb3ZlUmVmICA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBqUXVlcnkoXCIjbWFya2VyXCIpLmhpZGUoKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHRyZWVfY29tcG9uZW50Lmluc3RbY250LmF0dHIoXCJpZFwiKV0ub2ZmX2hlaWdodCgpO1xuXG4gICAgICAgICAgICAgICAgLy8gaWYgbW92aW5nIG92ZXIgYW5vdGhlciB0cmVlIGFuZCBtdWx0aXRyZWUgaXMgZmFsc2VcbiAgICAgICAgICAgICAgICBpZiggX3RoaXMuZm9yZWlnbiA9PT0gZmFsc2UgJiYgY250LmdldCgwKSAhPSBfdGhpcy5jb250YWluZXIuZ2V0KDApICYmICghX3RoaXMuc2V0dGluZ3MucnVsZXMubXVsdGl0cmVlIHx8ICF0cmVlX2NvbXBvbmVudC5pbnN0W2NudC5hdHRyKFwiaWRcIildLnNldHRpbmdzLnJ1bGVzLm11bHRpdHJlZSkgKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmKGpRdWVyeShfdGhpcy5kcmFnKS5jaGlsZHJlbihcIklNR1wiKS5zaXplKCkgPT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5KF90aGlzLmRyYWcpLmFwcGVuZChcIjxpbWcgY2xhc3M9J3JlbW92ZWljb24nIHN0eWxlPSdwb3NpdGlvbjphYnNvbHV0ZTsgXCIgKyAoX3RoaXMuc2V0dGluZ3MudWkucnRsID8gXCJyaWdodFwiIDogXCJsZWZ0XCIgKSArIFwiOjRweDsgdG9wOjBweDsnIHNyYz0nXCIgKyBfdGhpcy5zZXR0aW5ncy51aS50aGVtZV9wYXRoICsgXCJkZWZhdWx0L3JlbW92ZS5naWYnIC8+XCIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIF90aGlzLm1vdmVUeXBlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIF90aGlzLm1vdmVSZWYgID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGpRdWVyeShcIiNtYXJrZXJcIikuaGlkZSgpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYodHJlZV9jb21wb25lbnQuc3RvKSBjbGVhclRpbWVvdXQodHJlZV9jb21wb25lbnQuc3RvKTtcbiAgICAgICAgICAgICAgICB0cmVlX2NvbXBvbmVudC5zdG8gPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsgdHJlZV9jb21wb25lbnQuaW5zdFtjbnQuYXR0cihcImlkXCIpXS5zY3JvbGxDaGVjayhldmVudC5vcmlnaW5hbEV2ZW50LnBhZ2VYLGV2ZW50Lm9yaWdpbmFsRXZlbnQucGFnZVkpOyB9LCA1MCk7XG5cbiAgICAgICAgICAgICAgICB2YXIgbW92ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgdmFyIHN0ID0gY250LnNjcm9sbFRvcCgpO1xuXG4gICAgICAgICAgICAgICAgaWYoZXZlbnQudGFyZ2V0LnRhZ05hbWUgPT0gXCJBXCIgJiYgZXZlbnQudGFyZ2V0LmNsYXNzTmFtZT09XCJ0aXRsZVwiKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGp1c3QgaW4gY2FzZSBpZiBob3ZlciBpcyBvdmVyIHRoZSBkcmFnZ2FibGVcbiAgICAgICAgICAgICAgICAgICAgaWYoalF1ZXJ5KGV2ZW50LnRhcmdldCkuaXMoXCIjZHJhZ2dlZFwiKSkgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgICAgICAgICAgICAgIHZhciBnb1RvID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgeCA6IChqUXVlcnkoZXZlbnQudGFyZ2V0KS5vZmZzZXQoKS5sZWZ0IC0gMSksXG4gICAgICAgICAgICAgICAgICAgICAgICB5IDogKGV2ZW50Lm9yaWdpbmFsRXZlbnQucGFnZVkgLSB0cmVlX2NvbXBvbmVudC5pbnN0W2NudC5hdHRyKFwiaWRcIildLm9mZnNldC50b3ApXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYoY250Lmhhc0NsYXNzKFwicnRsXCIpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBnb1RvLnggKz0galF1ZXJ5KGV2ZW50LnRhcmdldCkud2lkdGgoKSAtIDg7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYoIChnb1RvLnkgKyBzdCklX3RoaXMubGlfaGVpZ2h0IDwgX3RoaXMubGlfaGVpZ2h0LzMgKyAxICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbW92ID0gXCJiZWZvcmVcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGdvVG8ueSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQucGFnZVkgLSAoZ29Uby55ICsgc3QpJV90aGlzLmxpX2hlaWdodCAtIDIgO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYoKGdvVG8ueSArIHN0KSVfdGhpcy5saV9oZWlnaHQgPiBfdGhpcy5saV9oZWlnaHQqMi8zIC0gMSApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vdiA9IFwiYWZ0ZXJcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGdvVG8ueSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQucGFnZVkgLSAoZ29Uby55ICsgc3QpJV90aGlzLmxpX2hlaWdodCArIF90aGlzLmxpX2hlaWdodCAtIDIgO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgbW92ID0gXCJpbnNpZGVcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGdvVG8ueCAtPSAyO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYoY250Lmhhc0NsYXNzKFwicnRsXCIpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZ29Uby54ICs9IDM2O1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZ29Uby55ID0gZXZlbnQub3JpZ2luYWxFdmVudC5wYWdlWSAtIChnb1RvLnkgKyBzdCklX3RoaXMubGlfaGVpZ2h0ICsgTWF0aC5mbG9vcihfdGhpcy5saV9oZWlnaHQvMikgLSAyIDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKF90aGlzLmdldF9ub2RlKGV2ZW50LnRhcmdldCkuaGFzQ2xhc3MoXCJjbG9zZWRcIikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmVlX2NvbXBvbmVudC50byA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uICgpIHsgX3RoaXMub3Blbl9icmFuY2goX3RoaXMuZ2V0X25vZGUoZXZlbnQudGFyZ2V0KSk7IH0sIDUwMCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpZih0cmVlX2NvbXBvbmVudC5pbnN0W2NudC5hdHRyKFwiaWRcIildLmNoZWNrTW92ZShfdGhpcy5jb250YWluZXIuZmluZChcImxpLmRyYWdnZWRcIiksIGpRdWVyeShldmVudC50YXJnZXQpLCBtb3YpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZihtb3YgPT0gXCJpbnNpZGVcIikgICAgalF1ZXJ5KFwiI21hcmtlclwiKS5hdHRyKFwic3JjXCIsIF90aGlzLnNldHRpbmdzLnVpLnRoZW1lX3BhdGggKyBcImRlZmF1bHQvcGx1cy5naWZcIikud2lkdGgoMTQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoY250Lmhhc0NsYXNzKFwicnRsXCIpKSAgICB7IGpRdWVyeShcIiNtYXJrZXJcIikuYXR0cihcInNyY1wiLCBfdGhpcy5zZXR0aW5ncy51aS50aGVtZV9wYXRoICsgXCJkZWZhdWx0L21hcmtlcl9ydGwuZ2lmXCIpLndpZHRoKDQwKTsgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgICAgICAgICAgICAgICAgICAgIHsgalF1ZXJ5KFwiI21hcmtlclwiKS5hdHRyKFwic3JjXCIsIF90aGlzLnNldHRpbmdzLnVpLnRoZW1lX3BhdGggKyBcImRlZmF1bHQvbWFya2VyLmdpZlwiKS53aWR0aCg0MCk7IH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLm1vdmVUeXBlICAgID0gbW92O1xuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMubW92ZVJlZiAgICA9IGV2ZW50LnRhcmdldDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeShfdGhpcy5kcmFnKS5jaGlsZHJlbihcIklNR1wiKS5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeShcIiNtYXJrZXJcIikuY3NzKHsgXCJsZWZ0XCIgOiBnb1RvLngtMSAsIFwidG9wXCIgOiBnb1RvLnktMiB9KS5zaG93KCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZihqUXVlcnkoX3RoaXMuZHJhZykuY2hpbGRyZW4oXCJJTUdcIikuc2l6ZSgpID09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkoX3RoaXMuZHJhZykuYXBwZW5kKFwiPGltZyBjbGFzcz0ncmVtb3ZlaWNvbicgc3R5bGU9J3Bvc2l0aW9uOmFic29sdXRlOyBcIiArIChfdGhpcy5zZXR0aW5ncy51aS5ydGwgPyBcInJpZ2h0OjBweDtcIiA6IFwibGVmdDo0cHg7XCIgKSArIFwiIHRvcDowcHg7JyBzcmM9J1wiICsgX3RoaXMuc2V0dGluZ3MudWkudGhlbWVfcGF0aCArIFwiZGVmYXVsdC9yZW1vdmUuZ2lmJyAvPlwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLm1vdmVUeXBlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5tb3ZlUmVmID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkoXCIjbWFya2VyXCIpLmhpZGUoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYoalF1ZXJ5KF90aGlzLmRyYWcpLmNoaWxkcmVuKFwiSU1HXCIpLnNpemUoKSA9PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkoX3RoaXMuZHJhZykuYXBwZW5kKFwiPGltZyBjbGFzcz0ncmVtb3ZlaWNvbicgc3R5bGU9J3Bvc2l0aW9uOmFic29sdXRlOyBcIiArIChfdGhpcy5zZXR0aW5ncy51aS5ydGwgPyBcInJpZ2h0OjBweDtcIiA6IFwibGVmdDo0cHg7XCIgKSArIFwiIHRvcDowcHg7JyBzcmM9J1wiICsgX3RoaXMuc2V0dGluZ3MudWkudGhlbWVfcGF0aCArIFwiZGVmYXVsdC9yZW1vdmUuZ2lmJyAvPlwiKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBfdGhpcy5tb3ZlVHlwZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBfdGhpcy5tb3ZlUmVmID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGpRdWVyeShcIiNtYXJrZXJcIikuaGlkZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9O1xuICAgIH1cbiAgICByZXR1cm4ge1xuICAgICAgICBjbnRyIDogdHJlZV9jb21wb25lbnQuY250ciArKyxcbiAgICAgICAgc2V0dGluZ3MgOiB7XG4gICAgICAgICAgICBkYXRhICAgIDoge1xuICAgICAgICAgICAgICAgIHR5cGUgICAgOiBcInByZWRlZmluZWRcIiwgICAgLy8gRU5VTSBbanNvbiwgeG1sX2ZsYXQsIHhtbF9uZXN0ZWQsIHByZWRlZmluZWRdXG4gICAgICAgICAgICAgICAgbWV0aG9kICAgIDogXCJHRVRcIiwgICAgICAgIC8vIEhPVyBUTyBSRVFVRVNUIEZJTEVTXG4gICAgICAgICAgICAgICAgYXN5bmMgICAgOiBmYWxzZSwgICAgICAgIC8vIEJPT0wgLSBhc3luYyBsb2FkaW5nIG9ub3BlblxuICAgICAgICAgICAgICAgIGFzeW5jX2RhdGEgOiBmdW5jdGlvbiAoTk9ERSkgeyByZXR1cm4geyBpZCA6IGpRdWVyeShOT0RFKS5hdHRyKFwiaWRcIikgfHwgMCB9IH0sIC8vIFBBUkFNRVRFUlMgUEFTU0VEIFRPIFNFUlZFUlxuICAgICAgICAgICAgICAgIHVybCAgICAgICAgOiBmYWxzZSwgICAgICAgIC8vIEZBTFNFIG9yIFNUUklORyAtIHVybCB0byBkb2N1bWVudCB0byBiZSB1c2VkIChhc3luYyBvciBub3QpXG4gICAgICAgICAgICAgICAganNvbiAgICA6IGZhbHNlICAgICAgICAgICAgLy8gRkFMU0Ugb3IgT0JKRUNUIGlmIHR5cGUgaXMgSlNPTiBhbmQgYXN5bmMgaXMgZmFsc2UgLSB0aGUgdHJlZSBkdW1wIGFzIGpzb25cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzZWxlY3RlZCAgICA6IGZhbHNlLCAgICAgICAgLy8gRkFMU0Ugb3IgU1RSSU5HIG9yIEFSUkFZXG4gICAgICAgICAgICBvcGVuZWQgICAgICAgIDogW10sICAgICAgICAgICAgLy8gQVJSQVkgT0YgSU5JVElBTExZIE9QRU5FRCBOT0RFU1xuICAgICAgICAgICAgbGFuZ3VhZ2VzICAgIDogW10sICAgICAgICAgICAgLy8gQVJSQVkgb2Ygc3RyaW5nIHZhbHVlcyAod2hpY2ggd2lsbCBiZSB1c2VkIGFzIENTUyBjbGFzc2VzIC0gc2kgdGhleSBtdXN0IGJlIHZhbGlkKVxuICAgICAgICAgICAgcGF0aCAgICAgICAgOiBmYWxzZSwgICAgICAgIC8vIEZBTFNFIG9yIFNUUklORyAoaWYgZmFsc2UgLSB3aWxsIGJlIGF1dG9kZXRlY3RlZClcbiAgICAgICAgICAgIGNvb2tpZXMgICAgICAgIDogZmFsc2UsICAgICAgICAvLyBGQUxTRSBvciBPQkpFQ1QgKHByZWZpeCwgb3B0cyAtIGZyb20ganFDb29raWUgLSBleHBpcmVzLCBwYXRoLCBkb21haW4sIHNlY3VyZSlcbiAgICAgICAgICAgIHVpICAgICAgICA6IHtcbiAgICAgICAgICAgICAgICBkb3RzICAgICAgICA6IHRydWUsICAgICAgICAvLyBCT09MIC0gZG90cyBvciBubyBkb3RzXG4gICAgICAgICAgICAgICAgcnRsICAgICAgICAgICAgOiBmYWxzZSwgICAgLy8gQk9PTCAtIGlzIHRoZSB0cmVlIHJpZ2h0LXRvLWxlZnRcbiAgICAgICAgICAgICAgICBhbmltYXRpb24gICAgOiAwLCAgICAgICAgLy8gSU5UIC0gZHVyYXRpb24gb2Ygb3Blbi9jbG9zZSBhbmltYXRpb25zIGluIG1pbGlzZWNvbmRzXG4gICAgICAgICAgICAgICAgaG92ZXJfbW9kZSAgICA6IHRydWUsICAgICAgICAvLyBTSE9VTEQgZ2V0XyogZnVuY3Rpb25zIGNoYWdlIGZvY3VzIG9yIGNoYW5nZSBob3ZlcmVkIGl0ZW1cbiAgICAgICAgICAgICAgICBzY3JvbGxfc3BkICAgIDogNCxcbiAgICAgICAgICAgICAgICB0aGVtZV9wYXRoICAgIDogZmFsc2UsICAgIC8vIFBhdGggdG8gdGhlbWVzXG4gICAgICAgICAgICAgICAgdGhlbWVfbmFtZSAgICA6IFwiZGVmYXVsdFwiLC8vIE5hbWUgb2YgdGhlbWVcbiAgICAgICAgICAgICAgICBjb250ZXh0ICAgICAgICA6IFtcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWQgICAgICAgIDogXCJjcmVhdGVcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsICAgIDogXCJDcmVhdGVcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIGljb24gICAgOiBcImNyZWF0ZS5wbmdcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIHZpc2libGUgICAgOiBmdW5jdGlvbiAoTk9ERSwgVFJFRV9PQkopIHsgaWYoTk9ERS5sZW5ndGggIT0gMSkgcmV0dXJuIGZhbHNlOyByZXR1cm4gVFJFRV9PQkouY2hlY2soXCJjcmVhdGFibGVcIiwgTk9ERSk7IH0sXG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb24gICAgOiBmdW5jdGlvbiAoTk9ERSwgVFJFRV9PQkopIHsgVFJFRV9PQkouY3JlYXRlKGZhbHNlLCBOT0RFKTsgfVxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBcInNlcGFyYXRvclwiLFxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZCAgICAgICAgOiBcInJlbmFtZVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWwgICAgOiBcIlJlbmFtZVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgaWNvbiAgICA6IFwicmVuYW1lLnBuZ1wiLFxuICAgICAgICAgICAgICAgICAgICAgICAgdmlzaWJsZSAgICA6IGZ1bmN0aW9uIChOT0RFLCBUUkVFX09CSikgeyBpZihOT0RFLmxlbmd0aCAhPSAxKSByZXR1cm4gZmFsc2U7IHJldHVybiBUUkVFX09CSi5jaGVjayhcInJlbmFtZWFibGVcIiwgTk9ERSk7IH0sXG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb24gICAgOiBmdW5jdGlvbiAoTk9ERSwgVFJFRV9PQkopIHsgVFJFRV9PQkoucmVuYW1lKCk7IH1cbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWQgICAgICAgIDogXCJkZWxldGVcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsICAgIDogXCJEZWxldGVcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIGljb24gICAgOiBcInJlbW92ZS5naWZcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIHZpc2libGUgICAgOiBmdW5jdGlvbiAoTk9ERSwgVFJFRV9PQkopIHsgcmV0dXJuIFRSRUVfT0JKLmNoZWNrKFwiZGVsZXRhYmxlXCIsIE5PREUpOyB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uICAgIDogZnVuY3Rpb24gKE5PREUsIFRSRUVfT0JKKSB7IE5PREUuZWFjaCggZnVuY3Rpb24gKCkgeyBUUkVFX09CSi5yZW1vdmUodGhpcyk7IH0pOyB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgcnVsZXMgICAgOiB7XG4gICAgICAgICAgICAgICAgbXVsdGlwbGUgICAgOiBmYWxzZSwgICAgLy8gRkFMU0UgfCBDVFJMIHwgT04gLSBtdWx0aXBsZSBzZWxlY3Rpb24gb2ZmLyB3aXRoIG9yIHdpdGhvdXQgaG9sZGluZyBDdHJsXG4gICAgICAgICAgICAgICAgbWV0YWRhdGEgICAgOiBmYWxzZSwgICAgLy8gRkFMU0Ugb3IgU1RSSU5HIC0gYXR0cmlidXRlIG5hbWUgKHVzZSBtZXRhZGF0YSBwbHVnaW4pXG4gICAgICAgICAgICAgICAgdHlwZV9hdHRyICAgIDogXCJyZWxcIiwgICAgLy8gU1RSSU5HIGF0dHJpYnV0ZSBuYW1lICh3aGVyZSBpcyB0aGUgdHlwZSBzdG9yZWQgaWYgbm8gbWV0YWRhdGEpXG4gICAgICAgICAgICAgICAgbXVsdGl0cmVlICAgIDogZmFsc2UsICAgIC8vIEJPT0wgLSBpcyBkcmFnIG4gZHJvcCBiZXR3ZWVuIHRyZWVzIGFsbG93ZWRcbiAgICAgICAgICAgICAgICBjcmVhdGVhdCAgICA6IFwiYm90dG9tXCIsICAgIC8vIFNUUklORyAodG9wIG9yIGJvdHRvbSkgbmV3IG5vZGVzIGdldCBpbnNlcnRlZCBhdCB0b3Agb3IgYm90dG9tXG4gICAgICAgICAgICAgICAgdXNlX2lubGluZSAgICA6IGZhbHNlLCAgICAvLyBDSEVDSyBGT1IgSU5MSU5FIFJVTEVTIC0gUkVRVUlSRVMgTUVUQURBVEFcbiAgICAgICAgICAgICAgICBjbGlja2FibGUgICAgOiBcImFsbFwiLCAgICAvLyB3aGljaCBub2RlIHR5cGVzIGNhbiB0aGUgdXNlciBzZWxlY3QgfCBkZWZhdWx0IC0gYWxsXG4gICAgICAgICAgICAgICAgcmVuYW1lYWJsZSAgICA6IFwiYWxsXCIsICAgIC8vIHdoaWNoIG5vZGUgdHlwZXMgY2FuIHRoZSB1c2VyIHNlbGVjdCB8IGRlZmF1bHQgLSBhbGxcbiAgICAgICAgICAgICAgICBkZWxldGFibGUgICAgOiBcImFsbFwiLCAgICAvLyB3aGljaCBub2RlIHR5cGVzIGNhbiB0aGUgdXNlciBkZWxldGUgfCBkZWZhdWx0IC0gYWxsXG4gICAgICAgICAgICAgICAgY3JlYXRhYmxlICAgIDogXCJhbGxcIiwgICAgLy8gd2hpY2ggbm9kZSB0eXBlcyBjYW4gdGhlIHVzZXIgY3JlYXRlIGluIHwgZGVmYXVsdCAtIGFsbFxuICAgICAgICAgICAgICAgIGRyYWdnYWJsZSAgICA6IFwibm9uZVwiLCAgICAvLyB3aGljaCBub2RlIHR5cGVzIGNhbiB0aGUgdXNlciBtb3ZlIHwgZGVmYXVsdCAtIG5vbmUgfCBcImFsbFwiXG4gICAgICAgICAgICAgICAgZHJhZ3J1bGVzICAgIDogXCJhbGxcIiwgICAgLy8gd2hhdCBtb3ZlIG9wZXJhdGlvbnMgYmV0d2VlbiBub2RlcyBhcmUgYWxsb3dlZCB8IGRlZmF1bHQgLSBub25lIHwgXCJhbGxcIlxuICAgICAgICAgICAgICAgIGRyYWdfY29weSAgICA6IGZhbHNlLCAgICAvLyBGQUxTRSB8IENUUkwgfCBPTiAtIGRyYWcgdG8gY29weSBvZmYvIHdpdGggb3Igd2l0aG91dCBob2xkaW5nIEN0cmxcbiAgICAgICAgICAgICAgICBkcm9wcGFibGUgICAgOiBbXVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGxhbmcgOiB7XG4gICAgICAgICAgICAgICAgbmV3X25vZGUgICAgOiBcIk5ldyBmb2xkZXJcIixcbiAgICAgICAgICAgICAgICBsb2FkaW5nICAgICAgICA6IFwiTG9hZGluZyAuLi5cIlxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGNhbGxiYWNrICAgIDogeyAgICAgICAgICAgICAgICAvLyB2YXJpb3VzIGNhbGxiYWNrcyB0byBhdHRhY2ggY3VzdG9tIGxvZ2ljIHRvXG4gICAgICAgICAgICAgICAgLy8gYmVmb3JlIGZvY3VzICAtIHNob3VsZCByZXR1cm4gdHJ1ZSB8IGZhbHNlXG4gICAgICAgICAgICAgICAgYmVmb3JlY2hhbmdlOiBmdW5jdGlvbihOT0RFLFRSRUVfT0JKKSB7IHJldHVybiB0cnVlIH0sXG4gICAgICAgICAgICAgICAgLy8gYmVmb3JlIG1vdmUgICAtIHNob3VsZCByZXR1cm4gdHJ1ZSB8IGZhbHNlXG4gICAgICAgICAgICAgICAgYmVmb3JlbW92ZSAgOiBmdW5jdGlvbihOT0RFLFJFRl9OT0RFLFRZUEUsVFJFRV9PQkopIHsgcmV0dXJuIHRydWUgfSxcbiAgICAgICAgICAgICAgICAvLyBiZWZvcmUgY3JlYXRlIC0gc2hvdWxkIHJldHVybiB0cnVlIHwgZmFsc2VcbiAgICAgICAgICAgICAgICBiZWZvcmVjcmVhdGU6IGZ1bmN0aW9uKE5PREUsUkVGX05PREUsVFlQRSxUUkVFX09CSikgeyByZXR1cm4gdHJ1ZSB9LFxuICAgICAgICAgICAgICAgIC8vIGJlZm9yZSByZW5hbWUgLSBzaG91bGQgcmV0dXJuIHRydWUgfCBmYWxzZVxuICAgICAgICAgICAgICAgIGJlZm9yZXJlbmFtZTogZnVuY3Rpb24oTk9ERSxMQU5HLFRSRUVfT0JKKSB7IHJldHVybiB0cnVlIH0sXG4gICAgICAgICAgICAgICAgLy8gYmVmb3JlIGRlbGV0ZSAtIHNob3VsZCByZXR1cm4gdHJ1ZSB8IGZhbHNlXG4gICAgICAgICAgICAgICAgYmVmb3JlZGVsZXRlOiBmdW5jdGlvbihOT0RFLFRSRUVfT0JKKSB7IHJldHVybiB0cnVlIH0sXG5cbiAgICAgICAgICAgICAgICBvbmNoYW5nZSAgICA6IGZ1bmN0aW9uKE5PREUsVFJFRV9PQkopIHsgfSwgICAgICAgICAgICAgICAgICAgIC8vIGZvY3VzIGNoYW5nZWRcbiAgICAgICAgICAgICAgICBvbnJlbmFtZSAgICA6IGZ1bmN0aW9uKE5PREUsTEFORyxUUkVFX09CSikgeyB9LCAgICAgICAgICAgICAgICAvLyBub2RlIHJlbmFtZWQgSVNORVcgLSBUUlVFfEZBTFNFLCBjdXJyZW50IGxhbmd1YWdlXG4gICAgICAgICAgICAgICAgb25tb3ZlICAgICAgICA6IGZ1bmN0aW9uKE5PREUsUkVGX05PREUsVFlQRSxUUkVFX09CSikgeyB9LCAgICAvLyBtb3ZlIGNvbXBsZXRlZCAoVFlQRSBpcyBCRUxPV3xBQk9WRXxJTlNJREUpXG4gICAgICAgICAgICAgICAgb25jb3B5ICAgICAgICA6IGZ1bmN0aW9uKE5PREUsUkVGX05PREUsVFlQRSxUUkVFX09CSikgeyB9LCAgICAvLyBjb3B5IGNvbXBsZXRlZCAoVFlQRSBpcyBCRUxPV3xBQk9WRXxJTlNJREUpXG4gICAgICAgICAgICAgICAgb25jcmVhdGUgICAgOiBmdW5jdGlvbihOT0RFLFJFRl9OT0RFLFRZUEUsVFJFRV9PQkopIHsgfSwgICAgLy8gbm9kZSBjcmVhdGVkLCBwYXJlbnQgbm9kZSAoVFlQRSBpcyBpbnNlcnRBdClcbiAgICAgICAgICAgICAgICBvbmRlbGV0ZSAgICA6IGZ1bmN0aW9uKE5PREUsIFRSRUVfT0JKKSB7IH0sICAgICAgICAgICAgICAgICAgICAvLyBub2RlIGRlbGV0ZWRcbiAgICAgICAgICAgICAgICBvbm9wZW4gICAgICAgIDogZnVuY3Rpb24oTk9ERSwgVFJFRV9PQkopIHsgfSwgICAgICAgICAgICAgICAgICAgIC8vIG5vZGUgb3BlbmVkXG4gICAgICAgICAgICAgICAgb25jbG9zZSAgICAgICAgOiBmdW5jdGlvbihOT0RFLCBUUkVFX09CSikgeyB9LCAgICAgICAgICAgICAgICAgICAgLy8gbm9kZSBjbG9zZWRcbiAgICAgICAgICAgICAgICBlcnJvciAgICAgICAgOiBmdW5jdGlvbihURVhULCBUUkVFX09CSikgeyB9LCAgICAgICAgICAgICAgICAgICAgLy8gZXJyb3Igb2NjdXJlZFxuICAgICAgICAgICAgICAgIC8vIGRvdWJsZSBjbGljayBvbiBub2RlIC0gZGVmYXVsdHMgdG8gb3Blbi9jbG9zZSAmIHNlbGVjdFxuICAgICAgICAgICAgICAgIG9uZGJsY2xrICAgIDogZnVuY3Rpb24oTk9ERSwgVFJFRV9PQkopIHsgVFJFRV9PQkoudG9nZ2xlX2JyYW5jaC5jYWxsKFRSRUVfT0JKLCBOT0RFKTsgVFJFRV9PQkouc2VsZWN0X2JyYW5jaC5jYWxsKFRSRUVfT0JKLCBOT0RFKTsgfSxcbiAgICAgICAgICAgICAgICAvLyByaWdodCBjbGljayAtIHRvIHByZXZlbnQgdXNlOiBFVi5wcmV2ZW50RGVmYXVsdCgpOyBFVi5zdG9wUHJvcGFnYXRpb24oKTsgcmV0dXJuIGZhbHNlXG4gICAgICAgICAgICAgICAgb25yZ3RjbGsgICAgOiBmdW5jdGlvbihOT0RFLCBUUkVFX09CSiwgRVYpIHsgfSxcbiAgICAgICAgICAgICAgICBvbmxvYWQgICAgICAgIDogZnVuY3Rpb24oVFJFRV9PQkopIHsgfSxcbiAgICAgICAgICAgICAgICBvbmZvY3VzICAgICAgICA6IGZ1bmN0aW9uKFRSRUVfT0JKKSB7IH0sXG4gICAgICAgICAgICAgICAgb25kcm9wICAgICAgICA6IGZ1bmN0aW9uKE5PREUsUkVGX05PREUsVFlQRSxUUkVFX09CSikge31cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgLy8gSU5JVElBTElaQVRJT05cbiAgICAgICAgaW5pdCA6IGZ1bmN0aW9uKGVsZW0sIG9wdHMpIHtcbiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XG4gICAgICAgICAgICB0aGlzLmNvbnRhaW5lciAgICAgICAgPSBqUXVlcnkoZWxlbSk7XG4gICAgICAgICAgICBpZih0aGlzLmNvbnRhaW5lci5zaXplID09IDApIHsgYWxlcnQoXCJJbnZhbGlkIGNvbnRhaW5lciBub2RlIVwiKTsgcmV0dXJuIH1cblxuICAgICAgICAgICAgdHJlZV9jb21wb25lbnQuaW5zdFt0aGlzLmNudHJdID0gdGhpcztcbiAgICAgICAgICAgIGlmKCF0aGlzLmNvbnRhaW5lci5hdHRyKFwiaWRcIikpIHRoaXMuY29udGFpbmVyLmF0dHIoXCJpZFwiLFwianN0cmVlX1wiICsgdGhpcy5jbnRyKTtcbiAgICAgICAgICAgIHRyZWVfY29tcG9uZW50Lmluc3RbdGhpcy5jb250YWluZXIuYXR0cihcImlkXCIpXSA9IHRyZWVfY29tcG9uZW50Lmluc3RbdGhpcy5jbnRyXTtcbiAgICAgICAgICAgIHRyZWVfY29tcG9uZW50LmZvY3VzZWQgPSB0aGlzLmNudHI7XG5cbiAgICAgICAgICAgIC8vIE1FUkdFIE9QVElPTlMgV0lUSCBERUZBVUxUU1xuICAgICAgICAgICAgaWYob3B0cyAmJiBvcHRzLmNvb2tpZXMpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldHRpbmdzLmNvb2tpZXMgPSBqUXVlcnkuZXh0ZW5kKHt9LHRoaXMuc2V0dGluZ3MuY29va2llcyxvcHRzLmNvb2tpZXMpO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBvcHRzLmNvb2tpZXM7XG4gICAgICAgICAgICAgICAgaWYoIXRoaXMuc2V0dGluZ3MuY29va2llcy5vcHRzKSB0aGlzLnNldHRpbmdzLmNvb2tpZXMub3B0cyA9IHt9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYob3B0cyAmJiBvcHRzLmNhbGxiYWNrKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXR0aW5ncy5jYWxsYmFjayA9IGpRdWVyeS5leHRlbmQoe30sdGhpcy5zZXR0aW5ncy5jYWxsYmFjayxvcHRzLmNhbGxiYWNrKTtcbiAgICAgICAgICAgICAgICBkZWxldGUgb3B0cy5jYWxsYmFjaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmKG9wdHMgJiYgb3B0cy5kYXRhKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXR0aW5ncy5kYXRhID0galF1ZXJ5LmV4dGVuZCh7fSx0aGlzLnNldHRpbmdzLmRhdGEsb3B0cy5kYXRhKTtcbiAgICAgICAgICAgICAgICBkZWxldGUgb3B0cy5kYXRhO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYob3B0cyAmJiBvcHRzLnVpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXR0aW5ncy51aSA9IGpRdWVyeS5leHRlbmQoe30sdGhpcy5zZXR0aW5ncy51aSxvcHRzLnVpKTtcbiAgICAgICAgICAgICAgICBkZWxldGUgb3B0cy51aTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmKG9wdHMgJiYgb3B0cy5ydWxlcykge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0dGluZ3MucnVsZXMgPSBqUXVlcnkuZXh0ZW5kKHt9LHRoaXMuc2V0dGluZ3MucnVsZXMsb3B0cy5ydWxlcyk7XG4gICAgICAgICAgICAgICAgZGVsZXRlIG9wdHMucnVsZXM7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZihvcHRzICYmIG9wdHMubGFuZykge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0dGluZ3MubGFuZyA9IGpRdWVyeS5leHRlbmQoe30sdGhpcy5zZXR0aW5ncy5sYW5nLG9wdHMubGFuZyk7XG4gICAgICAgICAgICAgICAgZGVsZXRlIG9wdHMubGFuZztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuc2V0dGluZ3MgICAgICAgID0galF1ZXJ5LmV4dGVuZCh7fSx0aGlzLnNldHRpbmdzLG9wdHMpO1xuXG4gICAgICAgICAgICAvLyBQQVRIIFRPIElNQUdFUyBBTkQgWFNMXG4gICAgICAgICAgICBpZih0aGlzLnNldHRpbmdzLnBhdGggPT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnBhdGggPSBcIlwiO1xuICAgICAgICAgICAgICAgIGpRdWVyeShcInNjcmlwdFwiKS5lYWNoKCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuc3JjLnRvU3RyaW5nKCkubWF0Y2goL3RyZWVfY29tcG9uZW50Lio/anMuKiQvKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMucGF0aCA9IHRoaXMuc3JjLnRvU3RyaW5nKCkucmVwbGFjZSgvdHJlZV9jb21wb25lbnQuKj9qcy4qJC8sIFwiXCIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHRoaXMucGF0aCA9IHRoaXMuc2V0dGluZ3MucGF0aDtcblxuICAgICAgICAgICAgLy8gREVBTCBXSVRIIExBTkdVQUdFIFZFUlNJT05TXG4gICAgICAgICAgICB0aGlzLmN1cnJlbnRfbGFuZyAgICA9IHRoaXMuc2V0dGluZ3MubGFuZ3VhZ2VzICYmIHRoaXMuc2V0dGluZ3MubGFuZ3VhZ2VzLmxlbmd0aCA/IHRoaXMuc2V0dGluZ3MubGFuZ3VhZ2VzWzBdIDogZmFsc2U7XG4gICAgICAgICAgICBpZih0aGlzLnNldHRpbmdzLmxhbmd1YWdlcyAmJiB0aGlzLnNldHRpbmdzLmxhbmd1YWdlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNuID0gZ2V0X3NoZWV0X251bShcInRyZWVfY29tcG9uZW50LmNzc1wiKTtcbiAgICAgICAgICAgICAgICB2YXIgc3QgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB2YXIgaWQgPSB0aGlzLmNvbnRhaW5lci5hdHRyKFwiaWRcIikgPyBcIiNcIiArIHRoaXMuY29udGFpbmVyLmF0dHIoXCJpZFwiKSA6IFwiLnRyZWVcIjtcbiAgICAgICAgICAgICAgICBmb3IodmFyIGxuID0gMDsgbG4gPCB0aGlzLnNldHRpbmdzLmxhbmd1YWdlcy5sZW5ndGg7IGxuKyspIHtcbiAgICAgICAgICAgICAgICAgICAgc3QgPSBhZGRfY3NzKGlkICsgXCIgLlwiICsgdGhpcy5zZXR0aW5ncy5sYW5ndWFnZXNbbG5dLCB0aGlzLnNuKTtcbiAgICAgICAgICAgICAgICAgICAgaWYoc3QgIT09IGZhbHNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnNldHRpbmdzLmxhbmd1YWdlc1tsbl0gPT0gdGhpcy5jdXJyZW50X2xhbmcpICAgIHN0LnN0eWxlLmRpc3BsYXkgPSBcImlubGluZVwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdC5zdHlsZS5kaXNwbGF5ID0gXCJub25lXCI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIERST1BQQUJMRVNcbiAgICAgICAgICAgIGlmKHRoaXMuc2V0dGluZ3MucnVsZXMuZHJvcHBhYmxlLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIGZvcihpIGluIHRoaXMuc2V0dGluZ3MucnVsZXMuZHJvcHBhYmxlKSB7XG4gICAgICAgICAgICAgICAgICAgIHRyZWVfY29tcG9uZW50LmRyb3AucHVzaCh0aGlzLnNldHRpbmdzLnJ1bGVzLmRyb3BwYWJsZVtpXSk7XG4gICAgICAgICAgICAgICAgICAgIHRyZWVfY29tcG9uZW50LmRyb3AgPSBqUXVlcnkudW5pcXVlKHRyZWVfY29tcG9uZW50LmRyb3ApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gVEhFTUVTXG4gICAgICAgICAgICBpZih0aGlzLnNldHRpbmdzLnVpLnRoZW1lX3BhdGggPT09IGZhbHNlKSB0aGlzLnNldHRpbmdzLnVpLnRoZW1lX3BhdGggPSB0aGlzLnBhdGggKyBcInRoZW1lcy9cIjtcbiAgICAgICAgICAgIHRoaXMudGhlbWUgPSB0aGlzLnNldHRpbmdzLnVpLnRoZW1lX3BhdGggKyBfdGhpcy5zZXR0aW5ncy51aS50aGVtZV9uYW1lICsgXCIvXCI7XG4gICAgICAgICAgICBhZGRfc2hlZXQoX3RoaXMuc2V0dGluZ3MudWkudGhlbWVfcGF0aCArIFwiZGVmYXVsdC9zdHlsZS5jc3NcIik7XG4gICAgICAgICAgICBpZih0aGlzLnNldHRpbmdzLnVpLnRoZW1lX25hbWUgIT0gXCJkZWZhdWx0XCIpIGFkZF9zaGVldChfdGhpcy50aGVtZSArIFwic3R5bGUuY3NzXCIpO1xuXG4gICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGRDbGFzcyhcInRyZWVcIik7XG4gICAgICAgICAgICBpZih0aGlzLnNldHRpbmdzLnVpLnJ0bCkgdGhpcy5jb250YWluZXIuYWRkQ2xhc3MoXCJydGxcIik7XG4gICAgICAgICAgICBpZih0aGlzLnNldHRpbmdzLnJ1bGVzLm11bHRpcGxlKSB0aGlzLnNlbGVjdGVkX2FyciA9IFtdO1xuICAgICAgICAgICAgdGhpcy5vZmZzZXQgPSBmYWxzZTtcblxuICAgICAgICAgICAgaWYodGhpcy5zZXR0aW5ncy51aS5kb3RzID09IGZhbHNlKSB0aGlzLmNvbnRhaW5lci5hZGRDbGFzcyhcIm5vX2RvdHNcIik7XG5cbiAgICAgICAgICAgIC8vIENPTlRFWFQgTUVOVVxuICAgICAgICAgICAgdGhpcy5jb250ZXh0ID0gZmFsc2U7XG4gICAgICAgICAgICBpZih0aGlzLnNldHRpbmdzLnVpLmNvbnRleHQgIT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICB2YXIgc3RyID0gJzxkaXYgY2xhc3M9XCJjb250ZXh0XCI+JztcbiAgICAgICAgICAgICAgICBmb3IoaSBpbiB0aGlzLnNldHRpbmdzLnVpLmNvbnRleHQpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5zZXR0aW5ncy51aS5jb250ZXh0W2ldID09IFwic2VwYXJhdG9yXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0ciArPSBcIjxzcGFuIGNsYXNzPSdzZXBhcmF0b3InPiZuYnNwOzwvc3Bhbj5cIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHZhciBpY24gPSBcIlwiO1xuICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnNldHRpbmdzLnVpLmNvbnRleHRbaV0uaWNvbikgaWNuID0gJ2JhY2tncm91bmQtaW1hZ2U6dXJsKFxcJycgKyAoIHRoaXMuc2V0dGluZ3MudWkuY29udGV4dFtpXS5pY29uLmluZGV4T2YoXCIvXCIpID09IC0xID8gdGhpcy50aGVtZSArIHRoaXMuc2V0dGluZ3MudWkuY29udGV4dFtpXS5pY29uIDogdGhpcy5zZXR0aW5ncy51aS5jb250ZXh0W2ldLmljb24gKSArICdcXCcpOyc7XG4gICAgICAgICAgICAgICAgICAgIHN0ciArPSAnPGEgcmVsPVwiJyArIHRoaXMuc2V0dGluZ3MudWkuY29udGV4dFtpXS5pZCArICdcIiBocmVmPVwiI1wiIHN0eWxlPVwiJyArIGljbiArICdcIj4nICsgdGhpcy5zZXR0aW5ncy51aS5jb250ZXh0W2ldLmxhYmVsICsgJzwvYT4nO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzdHIgKz0gJzwvZGl2Pic7XG4gICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0ID0galF1ZXJ5KHN0cik7XG4gICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LmhpZGUoKTtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQuYXBwZW5kID0gZmFsc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuaG92ZXJlZCA9IGZhbHNlO1xuICAgICAgICAgICAgdGhpcy5sb2NrZWQgPSBmYWxzZTtcblxuICAgICAgICAgICAgLy8gQ1JFQVRFIERVTU1ZIEZPUiBNT1ZJTkdcbiAgICAgICAgICAgIGlmKHRoaXMuc2V0dGluZ3MucnVsZXMuZHJhZ2dhYmxlICE9IFwibm9uZVwiICYmIHRoaXMuc2V0dGluZ3MucnVsZXMuZHJhZ3J1bGVzICE9IFwibm9uZVwiKSB7XG4gICAgICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpcztcbiAgICAgICAgICAgICAgICBqUXVlcnkoXCI8aW1nPlwiKVxuICAgICAgICAgICAgICAgICAgICAuYXR0cih7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZCAgICAgICAgOiBcIm1hcmtlclwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3JjICAgIDogX3RoaXMuc2V0dGluZ3MudWkudGhlbWVfcGF0aCArIFwiZGVmYXVsdC9tYXJrZXIuZ2lmXCJcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgLmNzcyh7XG4gICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQgICAgICAgIDogXCI4cHhcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoICAgICAgICA6IFwiNDJweFwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheSAgICAgICAgOiBcImJsb2NrXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiAgICA6IFwiYWJzb2x1dGVcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIGxlZnQgICAgICAgIDogXCIzMHB4XCIsXG4gICAgICAgICAgICAgICAgICAgICAgICB0b3AgICAgICAgICAgICA6IFwiMzBweFwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgekluZGV4ICAgICAgICA6IFwiMTAwMFwiXG4gICAgICAgICAgICAgICAgICAgIH0pLmhpZGUoKS5hcHBlbmRUbyhcImJvZHlcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnJlZnJlc2goKTtcbiAgICAgICAgICAgIHRoaXMuYXR0YWNoRXZlbnRzKCk7XG4gICAgICAgICAgICB0aGlzLmZvY3VzKCk7XG4gICAgICAgIH0sXG4gICAgICAgIG9mZl9oZWlnaHQgOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZih0aGlzLm9mZnNldCA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5jc3MoeyBwb3NpdGlvbiA6IFwicmVsYXRpdmVcIiB9KTtcbiAgICAgICAgICAgICAgICB0aGlzLm9mZnNldCA9IHRoaXMuY29udGFpbmVyLm9mZnNldCgpO1xuICAgICAgICAgICAgICAgIHZhciB0bXAgPSAwO1xuICAgICAgICAgICAgICAgIHRtcCA9IHBhcnNlSW50KGpRdWVyeS5jc3ModGhpcy5jb250YWluZXIuZ2V0KDApLCBcInBhZGRpbmdUb3BcIiwgdHJ1ZSksMTApO1xuICAgICAgICAgICAgICAgIGlmKHRtcCkgdGhpcy5vZmZzZXQudG9wICs9IHRtcDtcbiAgICAgICAgICAgICAgICB0bXAgPSBwYXJzZUludChqUXVlcnkuY3NzKHRoaXMuY29udGFpbmVyLmdldCgwKSwgXCJib3JkZXJUb3BXaWR0aFwiLCB0cnVlKSwxMCk7XG4gICAgICAgICAgICAgICAgaWYodG1wKSB0aGlzLm9mZnNldC50b3AgKz0gdG1wO1xuICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmNzcyh7IHBvc2l0aW9uIDogXCJcIiB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmKCF0aGlzLmxpX2hlaWdodCkge1xuICAgICAgICAgICAgICAgIHZhciB0bXAgPSB0aGlzLmNvbnRhaW5lci5maW5kKFwidWwgbGk6ZXEoMClcIik7XG4gICAgICAgICAgICAgICAgdGhpcy5saV9oZWlnaHQgPSB0bXAuZmluZCgnLnRpdGxlOmZpcnN0JykuaGVpZ2h0KCkgKyAxO1xuICAgICAgICAgICAgICAgIGlmKCF0aGlzLmxpX2hlaWdodCkgdGhpcy5saV9oZWlnaHQgPSAxODtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgLy8gUkVQQUlOVCBUUkVFXG4gICAgICAgIHJlZnJlc2ggOiBmdW5jdGlvbiAob2JqKSB7XG4gICAgICAgICAgICBpZih0aGlzLmxvY2tlZCkgcmV0dXJuIHRoaXMuZXJyb3IoXCJMT0NLRURcIik7XG4gICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuXG4gICAgICAgICAgICAvLyBTQVZFIE9QRU5FRFxuICAgICAgICAgICAgdGhpcy5vcGVuZWQgPSBBcnJheSgpO1xuICAgICAgICAgICAgaWYodGhpcy5zZXR0aW5ncy5jb29raWVzICYmIGpRdWVyeS5jb29raWUodGhpcy5zZXR0aW5ncy5jb29raWVzLnByZWZpeCArICdfb3BlbicpKSB7XG4gICAgICAgICAgICAgICAgdmFyIHN0ciA9IGpRdWVyeS5jb29raWUodGhpcy5zZXR0aW5ncy5jb29raWVzLnByZWZpeCArICdfb3BlbicpO1xuICAgICAgICAgICAgICAgIHZhciB0bXAgPSBzdHIuc3BsaXQoXCIsXCIpO1xuICAgICAgICAgICAgICAgIGpRdWVyeS5lYWNoKHRtcCwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBfdGhpcy5vcGVuZWQucHVzaChcIiNcIiArIHRoaXMucmVwbGFjZSgvXiMvLFwiXCIpKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB0aGlzLnNldHRpbmdzLm9wZW5lZCA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZih0aGlzLnNldHRpbmdzLm9wZW5lZCAhPSBmYWxzZSkge1xuICAgICAgICAgICAgICAgIGpRdWVyeS5lYWNoKHRoaXMuc2V0dGluZ3Mub3BlbmVkLCBmdW5jdGlvbiAoaSwgaXRlbSkge1xuICAgICAgICAgICAgICAgICAgICBfdGhpcy5vcGVuZWQucHVzaChcIiNcIiArIHRoaXMucmVwbGFjZSgvXiMvLFwiXCIpKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB0aGlzLnNldHRpbmdzLm9wZW5lZCA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuZmluZChcImxpLm9wZW5cIikuZWFjaChmdW5jdGlvbiAoaSkgeyBfdGhpcy5vcGVuZWQucHVzaChcIiNcIiArIHRoaXMuaWQpOyB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gU0FWRSBTRUxFQ1RFRFxuICAgICAgICAgICAgaWYodGhpcy5zZWxlY3RlZCkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0dGluZ3Muc2VsZWN0ZWQgPSBBcnJheSgpO1xuICAgICAgICAgICAgICAgIGlmKHRoaXMuc2VsZWN0ZWRfYXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIGpRdWVyeS5lYWNoKHRoaXMuc2VsZWN0ZWRfYXJyLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5zZXR0aW5ncy5zZWxlY3RlZC5wdXNoKFwiI1wiICsgdGhpcy5hdHRyKFwiaWRcIikpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB0aGlzLnNldHRpbmdzLnNlbGVjdGVkLnB1c2goXCIjXCIgKyB0aGlzLnNlbGVjdGVkLmF0dHIoXCJpZFwiKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvKmVsc2UgaWYodGhpcy5zZXR0aW5ncy5jb29raWVzICYmIGpRdWVyeS5jb29raWUodGhpcy5zZXR0aW5ncy5jb29raWVzLnByZWZpeCArICdfc2VsZWN0ZWQnKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0dGluZ3Muc2VsZWN0ZWQgPSBBcnJheSgpO1xuICAgICAgICAgICAgICAgIHZhciBzdHIgPSBqUXVlcnkuY29va2llKHRoaXMuc2V0dGluZ3MuY29va2llcy5wcmVmaXggKyAnX3NlbGVjdGVkJyk7XG4gICAgICAgICAgICAgICAgdmFyIHRtcCA9IHN0ci5zcGxpdChcIixcIik7XG4gICAgICAgICAgICAgICAgalF1ZXJ5LmVhY2godG1wLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIF90aGlzLnNldHRpbmdzLnNlbGVjdGVkLnB1c2goXCIjXCIgKyB0aGlzLnJlcGxhY2UoL14jLyxcIlwiKSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9Ki9cbiAgICAgICAgICAgIGVsc2UgaWYodGhpcy5zZXR0aW5ncy5zZWxlY3RlZCAhPT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICB2YXIgdG1wID0gQXJyYXkoKTtcbiAgICAgICAgICAgICAgICBpZigodHlwZW9mIHRoaXMuc2V0dGluZ3Muc2VsZWN0ZWQpLnRvTG93ZXJDYXNlKCkgPT0gXCJvYmplY3RcIikge1xuICAgICAgICAgICAgICAgICAgICBqUXVlcnkuZWFjaCh0aGlzLnNldHRpbmdzLnNlbGVjdGVkLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0bXAucHVzaChcIiNcIiArIHRoaXMucmVwbGFjZSgvXiMvLFwiXCIpKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgdG1wLnB1c2goXCIjXCIgKyB0aGlzLnNldHRpbmdzLnNlbGVjdGVkLnJlcGxhY2UoL14jLyxcIlwiKSk7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXR0aW5ncy5zZWxlY3RlZCA9IHRtcDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYob2JqICYmIHRoaXMuc2V0dGluZ3MuZGF0YS5hc3luYykge1xuICAgICAgICAgICAgICAgIHRoaXMub3BlbmVkID0gQXJyYXkoKTtcbiAgICAgICAgICAgICAgICBvYmogPSB0aGlzLmdldF9ub2RlKG9iaik7XG4gICAgICAgICAgICAgICAgb2JqLmZpbmQoXCJsaS5vcGVuXCIpLmVhY2goZnVuY3Rpb24gKGkpIHsgX3RoaXMub3BlbmVkLnB1c2goXCIjXCIgKyB0aGlzLmlkKTsgfSk7XG4gICAgICAgICAgICAgICAgdGhpcy5jbG9zZV9icmFuY2gob2JqLCB0cnVlKTtcbiAgICAgICAgICAgICAgICBvYmouY2hpbGRyZW4oXCJ1bDplcSgwKVwiKS5odG1sKFwiXCIpO1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm9wZW5fYnJhbmNoKG9iaiwgdHJ1ZSwgZnVuY3Rpb24gKCkgeyBfdGhpcy5yZXNlbGVjdC5hcHBseShfdGhpcyk7IH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB2YXIgY2xzID0gXCJ0cmVlLWRlZmF1bHRcIjtcbiAgICAgICAgICAgIGlmKHRoaXMuc2V0dGluZ3MudWkudGhlbWVfbmFtZSAhPSBcImRlZmF1bHRcIikgY2xzICs9IFwiIHRyZWUtXCIgKyBfdGhpcy5zZXR0aW5ncy51aS50aGVtZV9uYW1lO1xuXG4gICAgICAgICAgICBpZih0aGlzLnNldHRpbmdzLmRhdGEudHlwZSA9PSBcInhtbF9mbGF0XCIgfHwgdGhpcy5zZXR0aW5ncy5kYXRhLnR5cGUgPT0gXCJ4bWxfbmVzdGVkXCIpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNjcnRvcCA9IHRoaXMuY29udGFpbmVyLmdldCgwKS5zY3JvbGxUb3A7XG4gICAgICAgICAgICAgICAgdmFyIHhzbCA9ICh0aGlzLnNldHRpbmdzLmRhdGEudHlwZSA9PSBcInhtbF9mbGF0XCIpID8gXCJmbGF0LnhzbFwiIDogXCJuZXN0ZWQueHNsXCI7XG4gICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuZ2V0VHJhbnNmb3JtKHRoaXMucGF0aCArIHhzbCwgdGhpcy5zZXR0aW5ncy5kYXRhLnVybCwgeyBwYXJhbXMgOiB7IHRoZW1lX25hbWUgOiBjbHMsIHRoZW1lX3BhdGggOiBfdGhpcy50aGVtZSB9LCBtZXRoIDogX3RoaXMuc2V0dGluZ3MuZGF0YS5tZXRob2QgLGNhbGxiYWNrOiBmdW5jdGlvbiAoKSB7IF90aGlzLnJlc2VsZWN0LmFwcGx5KF90aGlzKTsgfSB9KTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmKHRoaXMuc2V0dGluZ3MuZGF0YS50eXBlID09IFwianNvblwiKSB7XG4gICAgICAgICAgICAgICAgaWYodGhpcy5zZXR0aW5ncy5kYXRhLmpzb24pIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHN0ciA9IFwiXCI7XG4gICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuc2V0dGluZ3MuZGF0YS5qc29uLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IHRoaXMuc2V0dGluZ3MuZGF0YS5qc29uLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyICs9IHRoaXMucGFyc2VKU09OKHRoaXMuc2V0dGluZ3MuZGF0YS5qc29uW2ldKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHN0ciA9IHRoaXMucGFyc2VKU09OKHRoaXMuc2V0dGluZ3MuZGF0YS5qc29uKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuaHRtbChcIjx1bCBjbGFzcz0nXCIgKyBjbHMgKyBcIic+XCIgKyBzdHIgKyBcIjwvdWw+XCIpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5maW5kKFwibGk6bGFzdC1jaGlsZFwiKS5hZGRDbGFzcyhcImxhc3RcIikuZW5kKCkuZmluZChcImxpOmhhcyh1bClcIikubm90KFwiLm9wZW5cIikuYWRkQ2xhc3MoXCJjbG9zZWRcIik7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmZpbmQoXCJsaVwiKS5ub3QoXCIub3BlblwiKS5ub3QoXCIuY2xvc2VkXCIpLmFkZENsYXNzKFwibGVhZlwiKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXNlbGVjdCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpcztcbiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LmFqYXgoe1xuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSAgICAgICAgOiB0aGlzLnNldHRpbmdzLmRhdGEubWV0aG9kLFxuICAgICAgICAgICAgICAgICAgICAgICAgdXJsICAgICAgICAgICAgOiB0aGlzLnNldHRpbmdzLmRhdGEudXJsLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YSAgICAgICAgOiB0aGlzLnNldHRpbmdzLmRhdGEuYXN5bmNfZGF0YShmYWxzZSksXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhVHlwZSAgICA6IFwianNvblwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2VzcyAgICAgICAgOiBmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdHIgPSBcIlwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGRhdGEubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHIgKz0gX3RoaXMucGFyc2VKU09OKGRhdGFbaV0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHN0ciA9IF90aGlzLnBhcnNlSlNPTihkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250YWluZXIuaHRtbChcIjx1bCBjbGFzcz0nXCIgKyBjbHMgKyBcIic+XCIgKyBzdHIgKyBcIjwvdWw+XCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRhaW5lci5maW5kKFwibGk6bGFzdC1jaGlsZFwiKS5hZGRDbGFzcyhcImxhc3RcIikuZW5kKCkuZmluZChcImxpOmhhcyh1bClcIikubm90KFwiLm9wZW5cIikuYWRkQ2xhc3MoXCJjbG9zZWRcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udGFpbmVyLmZpbmQoXCJsaVwiKS5ub3QoXCIub3BlblwiKS5ub3QoXCIuY2xvc2VkXCIpLmFkZENsYXNzKFwibGVhZlwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5yZXNlbGVjdC5hcHBseShfdGhpcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmNoaWxkcmVuKFwidWw6ZXEoMClcIikuYXR0cihcImNsYXNzXCIsIGNscyk7XG4gICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuZmluZChcImxpOmxhc3QtY2hpbGRcIikuYWRkQ2xhc3MoXCJsYXN0XCIpLmVuZCgpLmZpbmQoXCJsaTpoYXModWwpXCIpLm5vdChcIi5vcGVuXCIpLmFkZENsYXNzKFwiY2xvc2VkXCIpO1xuICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmZpbmQoXCJsaVwiKS5ub3QoXCIub3BlblwiKS5ub3QoXCIuY2xvc2VkXCIpLmFkZENsYXNzKFwibGVhZlwiKTtcbiAgICAgICAgICAgICAgICB0aGlzLnJlc2VsZWN0KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIC8vIENPTlZFUlQgSlNPTiBUTyBIVE1MXG4gICAgICAgIHBhcnNlSlNPTiA6IGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgICAgICB2YXIgc3RyID0gXCJcIjtcbiAgICAgICAgICAgIHN0ciArPSBcIjxsaSBcIjtcbiAgICAgICAgICAgIHZhciBjbHMgPSBmYWxzZTtcbiAgICAgICAgICAgIGZvcihpIGluIGRhdGEuYXR0cmlidXRlcykge1xuICAgICAgICAgICAgICAgIGlmKGkgPT0gXCJjbGFzc1wiKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0ciArPSBcIiBjbGFzcz0nXCIgKyBkYXRhLmF0dHJpYnV0ZXNbaV0gKyBcIiBcIjtcbiAgICAgICAgICAgICAgICAgICAgaWYoZGF0YS5zdGF0ZSA9PSBcImNsb3NlZFwiIHx8IGRhdGEuc3RhdGUgPT0gXCJvcGVuXCIpIHN0ciArPSBcIiBcIiArIGRhdGEuc3RhdGUgKyBcIiBcIjtcbiAgICAgICAgICAgICAgICAgICAgc3RyICs9IFwiJyBcIjtcbiAgICAgICAgICAgICAgICAgICAgY2xzID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBzdHIgKz0gXCIgXCIgKyBpICsgXCI9J1wiICsgZGF0YS5hdHRyaWJ1dGVzW2ldICsgXCInIFwiO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYoIWNscyAmJiAoZGF0YS5zdGF0ZSA9PSBcImNsb3NlZFwiIHx8IGRhdGEuc3RhdGUgPT0gXCJvcGVuXCIpKSBzdHIgKz0gXCIgY2xhc3M9J1wiICsgZGF0YS5zdGF0ZSArIFwiJyBcIjtcbiAgICAgICAgICAgIHN0ciArPSBcIj5cIjtcbiAgICAgICAgICAgIGlmKHRoaXMuc2V0dGluZ3MubGFuZ3VhZ2VzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCB0aGlzLnNldHRpbmdzLmxhbmd1YWdlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgYXR0ciA9IFtdO1xuICAgICAgICAgICAgICAgICAgICBhdHRyW1wiaHJlZlwiXSA9IFwiI1wiO1xuICAgICAgICAgICAgICAgICAgICBhdHRyW1wic3R5bGVcIl0gPSBcIlwiO1xuICAgICAgICAgICAgICAgICAgICBhdHRyW1wiY2xhc3NcIl0gPSB0aGlzLnNldHRpbmdzLmxhbmd1YWdlc1tpXTtcbiAgICAgICAgICAgICAgICAgICAgaWYoZGF0YS5kYXRhW3RoaXMuc2V0dGluZ3MubGFuZ3VhZ2VzW2ldXSAmJiAodHlwZW9mIGRhdGEuZGF0YVt0aGlzLnNldHRpbmdzLmxhbmd1YWdlc1tpXV0uYXR0cmlidXRlcykudG9Mb3dlckNhc2UoKSAhPSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IoaiBpbiBkYXRhLmRhdGFbdGhpcy5zZXR0aW5ncy5sYW5ndWFnZXNbaV1dLmF0dHJpYnV0ZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihqID09IFwic3R5bGVcIiB8fCBqID09IFwiY2xhc3NcIikgICAgYXR0cltqXSArPSBcIiBcIiArIGRhdGEuZGF0YVt0aGlzLnNldHRpbmdzLmxhbmd1YWdlc1tpXV0uYXR0cmlidXRlc1tqXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyW2pdICA9IGRhdGEuZGF0YVt0aGlzLnNldHRpbmdzLmxhbmd1YWdlc1tpXV0uYXR0cmlidXRlc1tqXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZihkYXRhLmRhdGFbdGhpcy5zZXR0aW5ncy5sYW5ndWFnZXNbaV1dICYmIGRhdGEuZGF0YVt0aGlzLnNldHRpbmdzLmxhbmd1YWdlc1tpXV0uaWNvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGljbiA9IGRhdGEuZGF0YVt0aGlzLnNldHRpbmdzLmxhbmd1YWdlc1tpXV0uaWNvbi5pbmRleE9mKFwiL1wiKSA9PSAtMSA/IHRoaXMudGhlbWUgKyBkYXRhLmRhdGFbdGhpcy5zZXR0aW5ncy5sYW5ndWFnZXNbaV1dLmljb24gOiBkYXRhLmRhdGFbdGhpcy5zZXR0aW5ncy5sYW5ndWFnZXNbaV1dLmljb247XG4gICAgICAgICAgICAgICAgICAgICAgICBhdHRyW1wic3R5bGVcIl0gKz0gXCIgOyBiYWNrZ3JvdW5kLWltYWdlOnVybCgnXCIgKyBpY24gKyBcIicpOyBcIjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBzdHIgKz0gXCI8YVwiO1xuICAgICAgICAgICAgICAgICAgICBmb3IoaiBpbiBhdHRyKSBzdHIgKz0gJyAnICsgaiArICc9XCInICsgYXR0cltqXSArICdcIiAnO1xuICAgICAgICAgICAgICAgICAgICBzdHIgKz0gXCI+XCIgKyAoICh0eXBlb2YgZGF0YS5kYXRhW3RoaXMuc2V0dGluZ3MubGFuZ3VhZ2VzW2ldXS50aXRsZSkudG9Mb3dlckNhc2UoKSAhPSBcInVuZGVmaW5lZFwiID8gZGF0YS5kYXRhW3RoaXMuc2V0dGluZ3MubGFuZ3VhZ2VzW2ldXS50aXRsZSA6IGRhdGEuZGF0YVt0aGlzLnNldHRpbmdzLmxhbmd1YWdlc1tpXV0gKSArIFwiPC9hPlwiO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhciBhdHRyID0gW107XG4gICAgICAgICAgICAgICAgYXR0cltcImhyZWZcIl0gPSBcIiNcIjtcbiAgICAgICAgICAgICAgICBhdHRyW1wic3R5bGVcIl0gPSBcIlwiO1xuICAgICAgICAgICAgICAgIGF0dHJbXCJjbGFzc1wiXSA9IFwiXCI7XG4gICAgICAgICAgICAgICAgaWYoKHR5cGVvZiBkYXRhLmRhdGEuYXR0cmlidXRlcykudG9Mb3dlckNhc2UoKSAhPSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvcihpIGluIGRhdGEuZGF0YS5hdHRyaWJ1dGVzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZihpID09IFwic3R5bGVcIiB8fCBpID09IFwiY2xhc3NcIikgICAgYXR0cltpXSArPSBcIiBcIiArIGRhdGEuZGF0YS5hdHRyaWJ1dGVzW2ldO1xuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0cltpXSAgPSBkYXRhLmRhdGEuYXR0cmlidXRlc1tpXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZihkYXRhLmRhdGEuaWNvbikge1xuICAgICAgICAgICAgICAgICAgICB2YXIgaWNuID0gZGF0YS5kYXRhLmljb24uaW5kZXhPZihcIi9cIikgPT0gLTEgPyB0aGlzLnRoZW1lICsgZGF0YS5kYXRhLmljb24gOiBkYXRhLmRhdGEuaWNvbjtcbiAgICAgICAgICAgICAgICAgICAgYXR0cltcInN0eWxlXCJdICs9IFwiIDsgYmFja2dyb3VuZC1pbWFnZTp1cmwoJ1wiICsgaWNuICsgXCInKTtcIjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc3RyICs9IFwiPGFcIjtcbiAgICAgICAgICAgICAgICBmb3IoaSBpbiBhdHRyKSBzdHIgKz0gJyAnICsgaSArICc9XCInICsgYXR0cltpXSArICdcIiAnO1xuICAgICAgICAgICAgICAgIHN0ciArPSBcIj5cIiArICggKHR5cGVvZiBkYXRhLmRhdGEudGl0bGUpLnRvTG93ZXJDYXNlKCkgIT0gXCJ1bmRlZmluZWRcIiA/IGRhdGEuZGF0YS50aXRsZSA6IGRhdGEuZGF0YSApICsgXCI8L2E+XCI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZihkYXRhLmNoaWxkcmVuICYmIGRhdGEuY2hpbGRyZW4ubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgc3RyICs9ICc8dWw+JztcbiAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgZGF0YS5jaGlsZHJlbi5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBzdHIgKz0gdGhpcy5wYXJzZUpTT04oZGF0YS5jaGlsZHJlbltpXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHN0ciArPSAnPC91bD4nO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc3RyICs9IFwiPC9saT5cIjtcbiAgICAgICAgICAgIHJldHVybiBzdHI7XG4gICAgICAgIH0sXG4gICAgICAgIC8vIGdldEpTT04gZnJvbSBIVE1MXG4gICAgICAgIGdldEpTT04gOiBmdW5jdGlvbiAobm9kLCBvdXRlcl9hdHRyaWIsIGlubmVyX2F0dHJpYiwgZm9yY2UpIHtcbiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XG4gICAgICAgICAgICBpZighbm9kIHx8IGpRdWVyeShub2QpLnNpemUoKSA9PSAwKSB7XG4gICAgICAgICAgICAgICAgbm9kID0gdGhpcy5jb250YWluZXIuY2hpbGRyZW4oXCJ1bFwiKS5jaGlsZHJlbihcImxpXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBub2QgPSBqUXVlcnkobm9kKTtcblxuICAgICAgICAgICAgaWYobm9kLnNpemUoKSA+IDEpIHtcbiAgICAgICAgICAgICAgICB2YXIgYXJyID0gW107XG4gICAgICAgICAgICAgICAgbm9kLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBhcnIucHVzaChfdGhpcy5nZXRKU09OKHRoaXMsIG91dGVyX2F0dHJpYiwgaW5uZXJfYXR0cmliKSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGFycjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYoIW91dGVyX2F0dHJpYikgb3V0ZXJfYXR0cmliID0gWyBcImlkXCIsIFwicmVsXCIsIFwiY2xhc3NcIiBdO1xuICAgICAgICAgICAgaWYoIWlubmVyX2F0dHJpYikgaW5uZXJfYXR0cmliID0gWyBdO1xuICAgICAgICAgICAgdmFyIG9iaiA9IHsgYXR0cmlidXRlcyA6IHt9LCBkYXRhIDogZmFsc2UgfTtcbiAgICAgICAgICAgIGZvcihpIGluIG91dGVyX2F0dHJpYikge1xuICAgICAgICAgICAgICAgIG9iai5hdHRyaWJ1dGVzW291dGVyX2F0dHJpYltpXV0gPSBub2QuYXR0cihvdXRlcl9hdHRyaWJbaV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYodGhpcy5zZXR0aW5ncy5sYW5ndWFnZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgb2JqLmRhdGEgPSB7fTtcbiAgICAgICAgICAgICAgICBmb3IoaSBpbiB0aGlzLnNldHRpbmdzLmxhbmd1YWdlcykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgYSA9IG5vZC5jaGlsZHJlbihcImEuXCIgKyB0aGlzLnNldHRpbmdzLmxhbmd1YWdlc1tpXSk7XG4gICAgICAgICAgICAgICAgICAgIGlmKGZvcmNlIHx8IGlubmVyX2F0dHJpYi5sZW5ndGggfHwgYS5nZXQoMCkuc3R5bGUuYmFja2dyb3VuZEltYWdlLnRvU3RyaW5nKCkubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvYmouZGF0YVt0aGlzLnNldHRpbmdzLmxhbmd1YWdlc1tpXV0gPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9iai5kYXRhW3RoaXMuc2V0dGluZ3MubGFuZ3VhZ2VzW2ldXS50aXRsZSA9IGEudGV4dCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYoYS5nZXQoMCkuc3R5bGUuYmFja2dyb3VuZEltYWdlLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iai5kYXRhW3RoaXMuc2V0dGluZ3MubGFuZ3VhZ2VzW2ldXS5pY29uID0gYS5nZXQoMCkuc3R5bGUuYmFja2dyb3VuZEltYWdlLnJlcGxhY2UoXCJ1cmwoXCIsXCJcIikucmVwbGFjZShcIilcIixcIlwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGlubmVyX2F0dHJpYi5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmouZGF0YVt0aGlzLnNldHRpbmdzLmxhbmd1YWdlc1tpXV0uYXR0cmlidXRlcyA9IHt9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcihqIGluIGlubmVyX2F0dHJpYikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmouZGF0YVt0aGlzLnNldHRpbmdzLmxhbmd1YWdlc1tpXV0uYXR0cmlidXRlc1tpbm5lcl9hdHRyaWJbal1dID0gYS5hdHRyKGlubmVyX2F0dHJpYltqXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgb2JqLmRhdGFbdGhpcy5zZXR0aW5ncy5sYW5ndWFnZXNbaV1dID0gYS50ZXh0KCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB2YXIgYSA9IG5vZC5jaGlsZHJlbihcImFcIik7XG4gICAgICAgICAgICAgICAgaWYoZm9yY2UgfHwgaW5uZXJfYXR0cmliLmxlbmd0aCB8fCBhLmdldCgwKS5zdHlsZS5iYWNrZ3JvdW5kSW1hZ2UudG9TdHJpbmcoKS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgb2JqLmRhdGEgPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgb2JqLmRhdGEudGl0bGUgPSBhLnRleHQoKTtcbiAgICAgICAgICAgICAgICAgICAgaWYoYS5nZXQoMCkuc3R5bGUuYmFja2dyb3VuZEltYWdlLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgb2JqLmRhdGEuaWNvbiA9IGEuZ2V0KDApLnN0eWxlLmJhY2tncm91bmRJbWFnZS5yZXBsYWNlKFwidXJsKFwiLFwiXCIpLnJlcGxhY2UoXCIpXCIsXCJcIik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYoaW5uZXJfYXR0cmliLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgb2JqLmRhdGEuYXR0cmlidXRlcyA9IHt9O1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yKGogaW4gaW5uZXJfYXR0cmliKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqLmRhdGEuYXR0cmlidXRlc1tpbm5lcl9hdHRyaWJbal1dID0gYS5hdHRyKGlubmVyX2F0dHJpYltqXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG9iai5kYXRhID0gYS50ZXh0KCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZihub2QuY2hpbGRyZW4oXCJ1bFwiKS5zaXplKCkgPiAwKSB7XG4gICAgICAgICAgICAgICAgb2JqLmNoaWxkcmVuID0gW107XG4gICAgICAgICAgICAgICAgbm9kLmNoaWxkcmVuKFwidWxcIikuY2hpbGRyZW4oXCJsaVwiKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgb2JqLmNoaWxkcmVuLnB1c2goX3RoaXMuZ2V0SlNPTih0aGlzLCBvdXRlcl9hdHRyaWIsIGlubmVyX2F0dHJpYikpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIG9iajtcbiAgICAgICAgfSxcbiAgICAgICAgZm9jdXMgOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZih0aGlzLmxvY2tlZCkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgaWYodHJlZV9jb21wb25lbnQuZm9jdXNlZCAhPSB0aGlzLmNudHIpIHtcbiAgICAgICAgICAgICAgICB0cmVlX2NvbXBvbmVudC5mb2N1c2VkID0gdGhpcy5jbnRyO1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0dGluZ3MuY2FsbGJhY2sub25mb2N1cy5jYWxsKG51bGwsIHRoaXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBzaG93X2NvbnRleHQgOiBmdW5jdGlvbiAob2JqLCB4LCB5KSB7XG4gICAgICAgICAgICB2YXIgdG1wID0gdGhpcy5jb250ZXh0LnNob3coKS5vZmZzZXRQYXJlbnQoKTtcbiAgICAgICAgICAgIGlmKHRtcC5pcyhcImh0bWxcIikpIHRtcCA9IGpRdWVyeShcImJvZHlcIik7XG4gICAgICAgICAgICB0bXAgPSB0bXAub2Zmc2V0KCk7XG4gICAgICAgICAgICB0aGlzLmNvbnRleHQuY3NzKHsgXCJsZWZ0XCIgOiAoeCAtIHRtcC5sZWZ0IC0gKHRoaXMuc2V0dGluZ3MudWkucnRsID8galF1ZXJ5KHRoaXMuY29udGV4dCkud2lkdGgoKSA6IC01ICkgKSwgXCJ0b3BcIiA6ICh5IC0gdG1wLnRvcCAgKyAoalF1ZXJ5LmJyb3dzZXIub3BlcmEgPyB0aGlzLmNvbnRhaW5lci5zY3JvbGxUb3AoKSA6IDApICsgMTUpIH0pO1xuICAgICAgICB9LFxuICAgICAgICBoaWRlX2NvbnRleHQgOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB0aGlzLmNvbnRleHQuaGlkZSgpO1xuICAgICAgICB9LFxuICAgICAgICAvLyBBTEwgRVZFTlRTXG4gICAgICAgIGF0dGFjaEV2ZW50cyA6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XG5cbiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyXG4gICAgICAgICAgICAgICAgLmxpc3RlbihcImNsaWNrXCIsIFwibGlcIiwgZnVuY3Rpb24oZXZlbnQpIHsgLy8gV0hFTiBDTElDSyBJUyBPTiBUSEUgQVJST1dcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgICAgIF90aGlzLnRvZ2dsZV9icmFuY2guYXBwbHkoX3RoaXMsIFtldmVudC50YXJnZXRdKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5saXN0ZW4oXCJjbGlja1wiLCBcImEudGl0bGVcIiwgZnVuY3Rpb24gKGV2ZW50KSB7IC8vIFdIRU4gQ0xJQ0sgSVMgT04gVEhFIFRFWFQgT1IgSUNPTlxuICAgICAgICAgICAgICAgICAgICBpZihfdGhpcy5sb2NrZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBldmVudC50YXJnZXQuYmx1cigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLmVycm9yKFwiTE9DS0VEXCIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIF90aGlzLnNlbGVjdF9icmFuY2guYXBwbHkoX3RoaXMsIFtldmVudC50YXJnZXQsIGV2ZW50LmN0cmxLZXkgfHwgX3RoaXMuc2V0dGluZ3MucnVsZXMubXVsdGlwbGUgPT0gXCJvblwiXSk7XG4gICAgICAgICAgICAgICAgICAgIGlmKF90aGlzLmlucCkgeyBfdGhpcy5pbnAuYmx1cigpOyB9XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldC5ibHVyKCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5saXN0ZW4oXCJkYmxjbGlja1wiLCBcImEudGl0bGVcIiwgZnVuY3Rpb24gKGV2ZW50KSB7IC8vIFdIRU4gRE9VQkxFQ0xJQ0sgT04gVEVYVCBPUiBJQ09OXG4gICAgICAgICAgICAgICAgICAgIGlmKF90aGlzLmxvY2tlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQudGFyZ2V0LmJsdXIoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5lcnJvcihcIkxPQ0tFRFwiKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBfdGhpcy5zZXR0aW5ncy5jYWxsYmFjay5vbmRibGNsay5jYWxsKG51bGwsIF90aGlzLmdldF9ub2RlKGV2ZW50LnRhcmdldCkuZ2V0KDApLCBfdGhpcyk7XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICBldmVudC50YXJnZXQuYmx1cigpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLmxpc3RlbihcImNvbnRleHRtZW51XCIsIFwiYS50aXRsZVwiLCBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYoX3RoaXMubG9ja2VkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBldmVudC50YXJnZXQuYmx1cigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLmVycm9yKFwiTE9DS0VEXCIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIF90aGlzLnNldHRpbmdzLmNhbGxiYWNrLm9ucmd0Y2xrLmNhbGwobnVsbCwgX3RoaXMuZ2V0X25vZGUoZXZlbnQudGFyZ2V0KS5nZXQoMCksIF90aGlzLCBldmVudCk7XG4gICAgICAgICAgICAgICAgICAgIGlmKF90aGlzLmNvbnRleHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKF90aGlzLmNvbnRleHQuYXBwZW5kID09IGZhbHNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udGFpbmVyLmZpbmQoXCJ1bDplcSgwKVwiKS5hcHBlbmQoX3RoaXMuY29udGV4dCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29udGV4dC5hcHBlbmQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcihpIGluIF90aGlzLnNldHRpbmdzLnVpLmNvbnRleHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoX3RoaXMuc2V0dGluZ3MudWkuY29udGV4dFtpXSA9PSBcInNlcGFyYXRvclwiKSBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmdW5jID0gX3RoaXMuc2V0dGluZ3MudWkuY29udGV4dFtpXS5hY3Rpb247XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5jb250ZXh0LmNoaWxkcmVuKFwiW3JlbD1cIiArIF90aGlzLnNldHRpbmdzLnVpLmNvbnRleHRbaV0uaWQgK1wiXVwiKS5iaW5kKFwiY2xpY2tcIiwgZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuYy5jYWxsKG51bGwsIF90aGlzLnNlbGVjdGVkX2FyciB8fCBfdGhpcy5zZWxlY3RlZCwgX3RoaXMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmhpZGVfY29udGV4dCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9iaiA9IF90aGlzLmdldF9ub2RlKGV2ZW50LnRhcmdldCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZihfdGhpcy5pbnApIHsgX3RoaXMuaW5wLmJsdXIoKTsgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYob2JqKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIW9iai5jaGlsZHJlbihcImE6ZXEoMClcIikuaGFzQ2xhc3MoXCJjbGlja2VkXCIpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnNlbGVjdF9icmFuY2guYXBwbHkoX3RoaXMsIFtldmVudC50YXJnZXQsIGV2ZW50LmN0cmxLZXkgfHwgX3RoaXMuc2V0dGluZ3MucnVsZXMubXVsdGlwbGUgPT0gXCJvblwiXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldC5ibHVyKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbnRleHQuY2hpbGRyZW4oXCJsaVwiKS5zaG93KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGdvID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yKGkgaW4gX3RoaXMuc2V0dGluZ3MudWkuY29udGV4dCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihfdGhpcy5zZXR0aW5ncy51aS5jb250ZXh0W2ldID09IFwic2VwYXJhdG9yXCIpIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZighX3RoaXMuc2V0dGluZ3MudWkuY29udGV4dFtpXS52aXNpYmxlLmNhbGwobnVsbCwgX3RoaXMuc2VsZWN0ZWRfYXJyIHx8IF90aGlzLnNlbGVjdGVkLCBfdGhpcykpIF90aGlzLmNvbnRleHQuY2hpbGRyZW4oXCJbcmVsPVwiICsgX3RoaXMuc2V0dGluZ3MudWkuY29udGV4dFtpXS5pZCArXCJdXCIpLmhpZGUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBnbyA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGdvID09IHRydWUpIF90aGlzLnNob3dfY29udGV4dChvYmosIGV2ZW50Lm9yaWdpbmFsRXZlbnQucGFnZVgsIGV2ZW50Lm9yaWdpbmFsRXZlbnQucGFnZVkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLmxpc3RlbihcInBvaW50ZXJlbnRlclwiLCBcImEudGl0bGVcIiwgZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmKF90aGlzLmxvY2tlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLmVycm9yKFwiTE9DS0VEXCIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmKF90aGlzLnNldHRpbmdzLnVpLmhvdmVyX21vZGUgJiYgX3RoaXMuaG92ZXJlZCAhPT0gZmFsc2UgJiYgZXZlbnQudGFyZ2V0LnRhZ05hbWUgPT0gXCJBXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmhvdmVyZWQuY2hpbGRyZW4oXCJhXCIpLnJlbW92ZUNsYXNzKFwiaG92ZXJcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5ob3ZlcmVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIC8vIEFUVEFDSCBEUkFHICYgRFJPUCBPTkxZIElGIE5FRURFRFxuICAgICAgICAgICAgICAgIGlmKHRoaXMuc2V0dGluZ3MucnVsZXMuZHJhZ2dhYmxlICE9IFwibm9uZVwiICYmIHRoaXMuc2V0dGluZ3MucnVsZXMuZHJhZ3J1bGVzICE9IFwibm9uZVwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyXG4gICAgICAgICAgICAgICAgICAgICAgICAub24oJ3BvaW50ZXJ1cCBwb2ludGVyZG93bicsICcuY29sMicsIGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFfdGhpcy5fZHJhZykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAub24oXCJwb2ludGVyZG93blwiLCBcImEudGl0bGVcIiwgZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuZm9jdXMuYXBwbHkoX3RoaXMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKF90aGlzLmxvY2tlZCkgcmV0dXJuIF90aGlzLmVycm9yKFwiTE9DS0VEXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNFTEVDVCBMSVNUIElURU0gTk9ERVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvYmogPSBfdGhpcy5nZXRfbm9kZShldmVudC50YXJnZXQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElGIElURU0gSVMgRFJBR0dBQkxFXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoX3RoaXMuc2V0dGluZ3MucnVsZXMubXVsdGlwbGUgIT0gZmFsc2UgJiYgX3RoaXMuc2VsZWN0ZWRfYXJyLmxlbmd0aCA+IDEgJiYgb2JqLmNoaWxkcmVuKFwiYTplcSgwKVwiKS5oYXNDbGFzcyhcImNsaWNrZWRcIikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNvdW50ZXIgPSAwO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IoaSBpbiBfdGhpcy5zZWxlY3RlZF9hcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKF90aGlzLmNoZWNrKFwiZHJhZ2dhYmxlXCIsIF90aGlzLnNlbGVjdGVkX2FycltpXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5zZWxlY3RlZF9hcnJbaV0uYWRkQ2xhc3MoXCJkcmFnZ2VkXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50ZXIgKys7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoY291bnRlciA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKF90aGlzLmNoZWNrKFwiZHJhZ2dhYmxlXCIsIG9iaikpICAgIF90aGlzLl9kcmFnID0gb2JqO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuX2RyYWcgPSBfdGhpcy5jb250YWluZXIuZmluZChcImxpLmRyYWdnZWQ6ZXEoMClcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5pc2Rvd24gICAgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuZHJhZyAgICAgICAgPSBfdGhpcy5fZHJhZy5nZXQoMCkuY2xvbmVOb2RlKHRydWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuZHJhZy5pZCAgICA9IFwiZHJhZ2dlZFwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5KF90aGlzLmRyYWcpLmNoaWxkcmVuKFwiYVwiKS5odG1sKFwiTXVsdGlwbGUgc2VsZWN0aW9uXCIpLmVuZCgpLmNoaWxkcmVuKFwidWxcIikucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKF90aGlzLmNoZWNrKFwiZHJhZ2dhYmxlXCIsIG9iaikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLl9kcmFnICAgICAgICA9IG9iajtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmRyYWcgICAgICAgID0gb2JqLmdldCgwKS5jbG9uZU5vZGUodHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5kcmFnLmlkICAgID0gXCJkcmFnZ2VkXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5pc2Rvd24gICAgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuZm9yZWlnbiAgICA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqLmFkZENsYXNzKFwiZHJhZ2dlZFwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmouYmx1cigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC5saXN0ZW4oXCJwb2ludGVydXBcIiwgXCJsaVwiLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgLmxpc3RlbihcInBvaW50ZXJ1cFwiLCBcImEudGl0bGVcIiwgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIV90aGlzLl9kcmFnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgICAgICAgICBqUXVlcnkoJ2h0bWwnKVxuICAgICAgICAgICAgICAgICAgICAgICAgLmJpbmQoXCJwb2ludGVyZG93blwiLCAgICB0cmVlX2NvbXBvbmVudC5tb3VzZWRvd24pXG4gICAgICAgICAgICAgICAgICAgICAgICAuYmluZChcInBvaW50ZXJ1cFwiLCAgICB0cmVlX2NvbXBvbmVudC5tb3VzZXVwKVxuICAgICAgICAgICAgICAgICAgICAgICAgLmJpbmQoXCJwb2ludGVybW92ZVwiLCAgICB0cmVlX2NvbXBvbmVudC5tb3VzZW1vdmUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBFTkRJRiBPRiBEUkFHICYgRFJPUCBGVU5DVElPTlNcbiAgICAgICAgICAgIGlmKF90aGlzLmNvbnRleHQpIGpRdWVyeSgnaHRtbCcpLmJpbmQoXCJwb2ludGVydXBcIiwgZnVuY3Rpb24oKSB7IF90aGlzLmhpZGVfY29udGV4dCgpOyB9KTtcbiAgICAgICAgfSxcbiAgICAgICAgY2hlY2tNb3ZlIDogZnVuY3Rpb24gKE5PREVTLCBSRUZfTk9ERSwgVFlQRSkge1xuICAgICAgICAgICAgaWYodGhpcy5sb2NrZWQpIHJldHVybiB0aGlzLmVycm9yKFwiTE9DS0VEXCIpO1xuICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpcztcbiAgICAgICAgICAgIC8vIE9WRVIgU0VMRiBPUiBDSElMRFJFTlxuICAgICAgICAgICAgaWYoUkVGX05PREUucGFyZW50cyhcImxpLmRyYWdnZWRcIikuc2l6ZSgpID4gMCB8fCBSRUZfTk9ERS5pcyhcIi5kcmFnZ2VkXCIpKSByZXR1cm4gdGhpcy5lcnJvcihcIk1PVkU6IE5PREUgT1ZFUiBTRUxGXCIpO1xuICAgICAgICAgICAgLy8gQ0hFQ0sgQUdBSU5TVCBEUkFHX1JVTEVTXG4gICAgICAgICAgICBpZihOT0RFUy5zaXplKCkgPT0gMSkge1xuICAgICAgICAgICAgICAgIHZhciBOT0RFID0gTk9ERVMuZXEoMCk7XG4gICAgICAgICAgICAgICAgaWYoTk9ERS5oYXNDbGFzcyhcImZvcmVpZ25cIikpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5zZXR0aW5ncy5ydWxlcy5kcm9wcGFibGUubGVuZ3RoID09IDApIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgaWYoIU5PREUuaXMoXCIuXCIgKyB0aGlzLnNldHRpbmdzLnJ1bGVzLmRyb3BwYWJsZS5qb2luKFwiLCAuXCIpKSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB2YXIgb2sgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgZm9yKGkgaW4gdGhpcy5zZXR0aW5ncy5ydWxlcy5kcm9wcGFibGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKE5PREUuaXMoXCIuXCIgKyB0aGlzLnNldHRpbmdzLnJ1bGVzLmRyb3BwYWJsZVtpXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnNldHRpbmdzLnJ1bGVzLm1ldGFkYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5tZXRhZGF0YS5zZXRUeXBlKFwiYXR0clwiLCB0aGlzLnNldHRpbmdzLnJ1bGVzLm1ldGFkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTk9ERS5hdHRyKHRoaXMuc2V0dGluZ3MucnVsZXMubWV0YWRhdGEsIFwidHlwZTogJ1wiICsgdGhpcy5zZXR0aW5ncy5ydWxlcy5kcm9wcGFibGVbaV0gKyBcIidcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBOT0RFLmF0dHIodGhpcy5zZXR0aW5ncy5ydWxlcy50eXBlX2F0dHIsIHRoaXMuc2V0dGluZ3MucnVsZXMuZHJvcHBhYmxlW2ldKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb2sgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmKCFvaykgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZighdGhpcy5jaGVjayhcImRyYWdydWxlc1wiLCBbTk9ERSwgVFlQRSwgUkVGX05PREUucGFyZW50cyhcImxpOmVxKDApXCIpXSkpIHJldHVybiB0aGlzLmVycm9yKFwiTU9WRTogQUdBSU5TVCBEUkFHIFJVTEVTXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdmFyIG9rID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBOT0RFUy5lYWNoKGZ1bmN0aW9uIChpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmKG9rID09IGZhbHNlKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGlmKGkgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVmID0gTk9ERVMuZXEoIChpIC0gMSkgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtdiA9IFwiYWZ0ZXJcIjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZWYgPSBSRUZfTk9ERTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtdiA9IFRZUEU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYoIV90aGlzLmNoZWNrLmFwcGx5KF90aGlzLFtcImRyYWdydWxlc1wiLCBbalF1ZXJ5KHRoaXMpLCBtdiwgcmVmXV0pKSBvayA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGlmKG9rID09IGZhbHNlKSByZXR1cm4gdGhpcy5lcnJvcihcIk1PVkU6IEFHQUlOU1QgRFJBRyBSVUxFU1wiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIENIRUNLIEFHQUlOU1QgTUVUQURBVEFcbiAgICAgICAgICAgIGlmKHRoaXMuc2V0dGluZ3MucnVsZXMudXNlX2lubGluZSAmJiB0aGlzLnNldHRpbmdzLnJ1bGVzLm1ldGFkYXRhKSB7XG4gICAgICAgICAgICAgICAgdmFyIG5kID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaWYoVFlQRSA9PSBcImluc2lkZVwiKSAgICBuZCA9IFJFRl9OT0RFLnBhcmVudHMoXCJsaTplcSgwKVwiKTtcbiAgICAgICAgICAgICAgICBlbHNlICAgICAgICAgICAgICAgICAgICBuZCA9IFJFRl9OT0RFLnBhcmVudHMoXCJsaTplcSgxKVwiKTtcbiAgICAgICAgICAgICAgICBpZihuZC5zaXplKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gVkFMSUQgQ0hJTERSRU4gQ0hFQ0tcbiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mIG5kLm1ldGFkYXRhKClbXCJ2YWxpZF9jaGlsZHJlblwiXSAhPSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG1wID0gbmQubWV0YWRhdGEoKVtcInZhbGlkX2NoaWxkcmVuXCJdO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9rID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIE5PREVTLmVhY2goZnVuY3Rpb24gKGkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihvayA9PSBmYWxzZSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGpRdWVyeS5pbkFycmF5KF90aGlzLmdldF90eXBlKHRoaXMpLCB0bXApID09IC0xKSBvayA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZihvayA9PSBmYWxzZSkgcmV0dXJuIHRoaXMuZXJyb3IoXCJNT1ZFOiBOT1QgQSBWQUxJRCBDSElMRFwiKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAvLyBDSEVDSyBJRiBQQVJFTlQgSEFTIEZSRUUgU0xPVFMgRk9SIENISUxEUkVOXG4gICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZiBuZC5tZXRhZGF0YSgpW1wibWF4X2NoaWxkcmVuXCJdICE9IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKChuZC5jaGlsZHJlbihcInVsOmVxKDApXCIpLmNoaWxkcmVuKFwibGlcIikubm90KFwiLmRyYWdnZWRcIikuc2l6ZSgpICsgTk9ERVMuc2l6ZSgpKSA+IG5kLm1ldGFkYXRhKCkubWF4X2NoaWxkcmVuKSByZXR1cm4gdGhpcy5lcnJvcihcIk1PVkU6IE1BWCBDSElMRFJFTiBSRUFDSEVEXCIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIC8vIENIRUNLIEZPUiBNQVhERVBUSCBVUCBUSEUgQ0hBSU5cbiAgICAgICAgICAgICAgICAgICAgdmFyIGluY3IgPSAwO1xuICAgICAgICAgICAgICAgICAgICBOT0RFUy5lYWNoKGZ1bmN0aW9uIChpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgaSA9IDE7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IGpRdWVyeSh0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlKGkgPCAxMDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ID0gdC5jaGlsZHJlbihcInVsOmVxKDApXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHQuc2l6ZSgpID09IDApIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkgKytcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGluY3IgPSBNYXRoLm1heChpLGluY3IpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG9rID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgbmQucGFyZW50cyhcImxpXCIpLmVhY2goZnVuY3Rpb24oaSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYob2sgPT0gZmFsc2UpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGpRdWVyeSh0aGlzKS5tZXRhZGF0YSgpLm1heF9kZXB0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCAoaSArIGluY3IpID49IGpRdWVyeSh0aGlzKS5tZXRhZGF0YSgpLm1heF9kZXB0aCkgb2sgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIGlmKG9rID09IGZhbHNlKSByZXR1cm4gdGhpcy5lcnJvcihcIk1PVkU6IE1BWF9ERVBUSCBSRUFDSEVEXCIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9LFxuICAgICAgICAvLyBVU0VEIEFGVEVSIFJFRlJFU0hcbiAgICAgICAgcmVzZWxlY3QgOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuICAgICAgICAgICAgLy8gUkVPUEVOIEJSQU5DSEVTXG4gICAgICAgICAgICBpZih0aGlzLm9wZW5lZCAmJiB0aGlzLm9wZW5lZC5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICB2YXIgb3BuID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgZm9yKHZhciBqID0gMDsgaiA8IHRoaXMub3BlbmVkLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuc2V0dGluZ3MuZGF0YS5hc3luYykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5nZXRfbm9kZSh0aGlzLm9wZW5lZFtqXSkuc2l6ZSgpID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wbiA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRtcCA9IHRoaXMub3BlbmVkW2pdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLm9wZW5lZFtqXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9wZW5fYnJhbmNoKHRtcCwgdHJ1ZSwgZnVuY3Rpb24gKCkgeyBfdGhpcy5yZXNlbGVjdC5hcHBseShfdGhpcyk7IH0gKVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgdGhpcy5vcGVuX2JyYW5jaCh0aGlzLm9wZW5lZFtqXSwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmKHRoaXMuc2V0dGluZ3MuZGF0YS5hc3luYyAmJiBvcG4pIHJldHVybjtcbiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5vcGVuZWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBSRVBPU0lUSU9OIFNDUk9MTFxuICAgICAgICAgICAgaWYodGhpcy5zY3J0b3ApIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5zY3JvbGxUb3AoX3RoaXMuc2NydG9wKTtcbiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5zY3J0b3A7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBSRVNFTEVDVCBQUkVWSU9VU0xZIFNFTEVDVEVEXG4gICAgICAgICAgICBpZih0aGlzLnNldHRpbmdzLnNlbGVjdGVkICE9PSBmYWxzZSkge1xuICAgICAgICAgICAgICAgIGpRdWVyeS5lYWNoKHRoaXMuc2V0dGluZ3Muc2VsZWN0ZWQsIGZ1bmN0aW9uIChpKSB7XG4gICAgICAgICAgICAgICAgICAgIF90aGlzLnNlbGVjdF9icmFuY2goalF1ZXJ5KF90aGlzLnNldHRpbmdzLnNlbGVjdGVkW2ldKSwgKF90aGlzLnNldHRpbmdzLnJ1bGVzLm11bHRpcGxlICE9PSBmYWxzZSAmJiBpID4gMCkgKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB0aGlzLnNldHRpbmdzLnNlbGVjdGVkID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnNldHRpbmdzLmNhbGxiYWNrLm9ubG9hZC5jYWxsKG51bGwsIF90aGlzKTtcbiAgICAgICAgfSxcbiAgICAgICAgLy8gR0VUIFRIRSBFWFRFTkRFRCBMSSBFTEVNRU5UXG4gICAgICAgIGdldF9ub2RlIDogZnVuY3Rpb24gKG9iaikge1xuICAgICAgICAgICAgdmFyIG9iaiA9IGpRdWVyeShvYmopO1xuICAgICAgICAgICAgcmV0dXJuIG9iai5pcyhcImxpXCIpID8gb2JqIDogb2JqLnBhcmVudHMoXCJsaTplcSgwKVwiKTtcbiAgICAgICAgfSxcbiAgICAgICAgLy8gR0VUIFRIRSBUWVBFIE9GIFRIRSBOT0RFXG4gICAgICAgIGdldF90eXBlIDogZnVuY3Rpb24gKG9iaikge1xuICAgICAgICAgICAgb2JqID0gIW9iaiA/IHRoaXMuc2VsZWN0ZWQgOiB0aGlzLmdldF9ub2RlKG9iaik7XG4gICAgICAgICAgICBpZighb2JqKSByZXR1cm47XG4gICAgICAgICAgICBpZih0aGlzLnNldHRpbmdzLnJ1bGVzLm1ldGFkYXRhKSB7XG4gICAgICAgICAgICAgICAgalF1ZXJ5Lm1ldGFkYXRhLnNldFR5cGUoXCJhdHRyXCIsIHRoaXMuc2V0dGluZ3MucnVsZXMubWV0YWRhdGEpO1xuICAgICAgICAgICAgICAgIHZhciB0bXAgPSBvYmoubWV0YWRhdGEoKS50eXBlO1xuICAgICAgICAgICAgICAgIGlmKHRtcCkgcmV0dXJuIHRtcDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBvYmouYXR0cih0aGlzLnNldHRpbmdzLnJ1bGVzLnR5cGVfYXR0cik7XG4gICAgICAgIH0sXG4gICAgICAgIC8vIFNDUk9MTCBDT05UQUlORVIgV0hJTEUgRFJBR0dJTkdcbiAgICAgICAgc2Nyb2xsQ2hlY2sgOiBmdW5jdGlvbiAoeCx5KSB7XG4gICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuICAgICAgICAgICAgdmFyIGNudCA9IF90aGlzLmNvbnRhaW5lcjtcbiAgICAgICAgICAgIHZhciBvZmYgPSBfdGhpcy5vZmZzZXQ7XG5cbiAgICAgICAgICAgIHZhciBzdCA9IGNudC5zY3JvbGxUb3AoKTtcbiAgICAgICAgICAgIHZhciBzbCA9IGNudC5zY3JvbGxMZWZ0KCk7XG4gICAgICAgICAgICAvLyBERVRFQ1QgSE9SSVpPTlRBTCBTQ1JPTExcbiAgICAgICAgICAgIHZhciBoX2NvciA9IChjbnQuZ2V0KDApLnNjcm9sbFdpZHRoID4gY250LndpZHRoKCkpID8gNDAgOiAyMDtcblxuICAgICAgICAgICAgaWYoeSAtIG9mZi50b3AgPCAyMCkgICAgICAgICAgICAgICAgICAgICAgICBjbnQuc2Nyb2xsVG9wKE1hdGgubWF4KCAoc3QgLSBfdGhpcy5zZXR0aW5ncy51aS5zY3JvbGxfc3BkKSAsMCkpOyAgICAvLyBORUFSIFRPUFxuICAgICAgICAgICAgaWYoY250LmhlaWdodCgpIC0gKHkgLSBvZmYudG9wKSA8IGhfY29yKSAgICBjbnQuc2Nyb2xsVG9wKHN0ICsgX3RoaXMuc2V0dGluZ3MudWkuc2Nyb2xsX3NwZCk7ICAgICAgICAgICAgICAgICAgICAvLyBORUFSIEJPVFRPTVxuICAgICAgICAgICAgaWYoeCAtIG9mZi5sZWZ0IDwgMjApICAgICAgICAgICAgICAgICAgICAgICAgY250LnNjcm9sbExlZnQoTWF0aC5tYXgoIChzbCAtIF90aGlzLnNldHRpbmdzLnVpLnNjcm9sbF9zcGQpLDApKTsgICAgLy8gTkVBUiBMRUZUXG4gICAgICAgICAgICBpZihjbnQud2lkdGgoKSAtICh4IC0gb2ZmLmxlZnQpIDwgNDApICAgICAgICBjbnQuc2Nyb2xsTGVmdChzbCArIF90aGlzLnNldHRpbmdzLnVpLnNjcm9sbF9zcGQpOyAgICAgICAgICAgICAgICAgICAgLy8gTkVBUiBSSUdIVFxuXG4gICAgICAgICAgICBpZihjbnQuc2Nyb2xsTGVmdCgpICE9IHNsIHx8IGNudC5zY3JvbGxUb3AoKSAhPSBzdCkge1xuICAgICAgICAgICAgICAgIF90aGlzLm1vdmVUeXBlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgX3RoaXMubW92ZVJlZiA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGpRdWVyeShcIiNtYXJrZXJcIikuaGlkZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdHJlZV9jb21wb25lbnQuc3RvID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7IF90aGlzLnNjcm9sbENoZWNrKHgseSk7IH0sIDUwKTtcbiAgICAgICAgfSxcbiAgICAgICAgY2hlY2sgOiBmdW5jdGlvbiAocnVsZSwgbm9kZXMpIHtcbiAgICAgICAgICAgIGlmKHRoaXMubG9ja2VkKSByZXR1cm4gdGhpcy5lcnJvcihcIkxPQ0tFRFwiKTtcbiAgICAgICAgICAgIC8vIENIRUNLIExPQ0FMIFJVTEVTIElGIE1FVEFEQVRBXG4gICAgICAgICAgICBpZihydWxlICE9IFwiZHJhZ3J1bGVzXCIgJiYgdGhpcy5zZXR0aW5ncy5ydWxlcy51c2VfaW5saW5lICYmIHRoaXMuc2V0dGluZ3MucnVsZXMubWV0YWRhdGEpIHtcbiAgICAgICAgICAgICAgICBqUXVlcnkubWV0YWRhdGEuc2V0VHlwZShcImF0dHJcIiwgdGhpcy5zZXR0aW5ncy5ydWxlcy5tZXRhZGF0YSk7XG4gICAgICAgICAgICAgICAgaWYodHlwZW9mIHRoaXMuZ2V0X25vZGUobm9kZXMpLm1ldGFkYXRhKClbcnVsZV0gIT0gXCJ1bmRlZmluZWRcIikgcmV0dXJuIHRoaXMuZ2V0X25vZGUobm9kZXMpLm1ldGFkYXRhKClbcnVsZV07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZighdGhpcy5zZXR0aW5ncy5ydWxlc1tydWxlXSkgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICBpZih0aGlzLnNldHRpbmdzLnJ1bGVzW3J1bGVdID09IFwibm9uZVwiKSAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICBpZih0aGlzLnNldHRpbmdzLnJ1bGVzW3J1bGVdID09IFwiYWxsXCIpICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgaWYocnVsZSA9PSBcImRyYWdydWxlc1wiKSB7XG4gICAgICAgICAgICAgICAgdmFyIG5kcyA9IG5ldyBBcnJheSgpO1xuICAgICAgICAgICAgICAgIG5kc1swXSA9IHRoaXMuZ2V0X3R5cGUobm9kZXNbMF0pO1xuICAgICAgICAgICAgICAgIG5kc1sxXSA9IG5vZGVzWzFdO1xuICAgICAgICAgICAgICAgIG5kc1syXSA9IHRoaXMuZ2V0X3R5cGUobm9kZXNbMl0pO1xuICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCB0aGlzLnNldHRpbmdzLnJ1bGVzLmRyYWdydWxlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgciA9IHRoaXMuc2V0dGluZ3MucnVsZXMuZHJhZ3J1bGVzW2ldO1xuICAgICAgICAgICAgICAgICAgICB2YXIgbiA9IChyLmluZGV4T2YoXCIhXCIpID09PSAwKSA/IGZhbHNlIDogdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgaWYoIW4pIHIgPSByLnJlcGxhY2UoXCIhXCIsXCJcIik7XG4gICAgICAgICAgICAgICAgICAgIHZhciB0bXAgPSByLnNwbGl0KFwiIFwiKTtcbiAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBqID0gMDsgaiA8IDM7IGorKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYodG1wW2pdID09IG5kc1tqXSB8fCB0bXBbal0gPT0gXCIqXCIpIHRtcFtqXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYodG1wWzBdID09PSB0cnVlICYmIHRtcFsxXSA9PT0gdHJ1ZSAmJiB0bXBbMl0gPT09IHRydWUpIHJldHVybiBuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgcmV0dXJuIChqUXVlcnkuaW5BcnJheSh0aGlzLmdldF90eXBlKG5vZGVzKSx0aGlzLnNldHRpbmdzLnJ1bGVzW3J1bGVdKSAhPSAtMSkgPyB0cnVlIDogZmFsc2U7XG4gICAgICAgIH0sXG4gICAgICAgIGhvdmVyX2JyYW5jaCA6IGZ1bmN0aW9uIChvYmopIHtcbiAgICAgICAgICAgIGlmKHRoaXMubG9ja2VkKSByZXR1cm4gdGhpcy5lcnJvcihcIkxPQ0tFRFwiKTtcbiAgICAgICAgICAgIGlmKHRoaXMuc2V0dGluZ3MudWkuaG92ZXJfbW9kZSA9PSBmYWxzZSkgcmV0dXJuIHRoaXMuc2VsZWN0X2JyYW5jaChvYmopO1xuICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpcztcbiAgICAgICAgICAgIHZhciBvYmogPSBfdGhpcy5nZXRfbm9kZShvYmopO1xuICAgICAgICAgICAgaWYoIW9iai5zaXplKCkpIHJldHVybiB0aGlzLmVycm9yKFwiSE9WRVI6IE5PVCBBIFZBTElEIE5PREVcIik7XG4gICAgICAgICAgICAvLyBDSEVDSyBBR0FJTlNUIFJVTEVTIEZPUiBTRUxFQ1RBQkxFIE5PREVTXG4gICAgICAgICAgICBpZighX3RoaXMuY2hlY2soXCJjbGlja2FibGVcIiwgb2JqKSkgcmV0dXJuIHRoaXMuZXJyb3IoXCJTRUxFQ1Q6IE5PREUgTk9UIFNFTEVDVEFCTEVcIik7XG4gICAgICAgICAgICBpZih0aGlzLmhvdmVyZWQpIHRoaXMuaG92ZXJlZC5jaGlsZHJlbihcIkFcIikucmVtb3ZlQ2xhc3MoXCJob3ZlclwiKTtcblxuICAgICAgICAgICAgLy8gU0FWRSBORVdMWSBTRUxFQ1RFRFxuICAgICAgICAgICAgdGhpcy5ob3ZlcmVkID0gb2JqO1xuXG4gICAgICAgICAgICAvLyBGT0NVUyBORVcgTk9ERSBBTkQgT1BFTiBBTEwgUEFSRU5UIE5PREVTIElGIENMT1NFRFxuICAgICAgICAgICAgdGhpcy5ob3ZlcmVkLmNoaWxkcmVuKFwiYVwiKS5yZW1vdmVDbGFzcyhcImhvdmVyXCIpLmFkZENsYXNzKFwiaG92ZXJcIik7XG5cbiAgICAgICAgICAgIC8vIFNDUk9MTCBTRUxFQ1RFRCBOT0RFIElOVE8gVklFV1xuICAgICAgICAgICAgdmFyIG9mZl90ID0gdGhpcy5ob3ZlcmVkLm9mZnNldCgpLnRvcDtcbiAgICAgICAgICAgIHZhciBiZWdfdCA9IHRoaXMuY29udGFpbmVyLm9mZnNldCgpLnRvcDtcbiAgICAgICAgICAgIHZhciBlbmRfdCA9IGJlZ190ICsgdGhpcy5jb250YWluZXIuaGVpZ2h0KCk7XG4gICAgICAgICAgICB2YXIgaF9jb3IgPSAodGhpcy5jb250YWluZXIuZ2V0KDApLnNjcm9sbFdpZHRoID4gdGhpcy5jb250YWluZXIud2lkdGgoKSkgPyA0MCA6IDIwO1xuICAgICAgICAgICAgaWYob2ZmX3QgKyA1IDwgYmVnX3QpIHRoaXMuY29udGFpbmVyLnNjcm9sbFRvcCh0aGlzLmNvbnRhaW5lci5zY3JvbGxUb3AoKSAtIChiZWdfdCAtIG9mZl90ICsgNSkgKTtcbiAgICAgICAgICAgIGlmKG9mZl90ICsgaF9jb3IgPiBlbmRfdCkgdGhpcy5jb250YWluZXIuc2Nyb2xsVG9wKHRoaXMuY29udGFpbmVyLnNjcm9sbFRvcCgpICsgKG9mZl90ICsgaF9jb3IgLSBlbmRfdCkgKTtcbiAgICAgICAgfSxcbiAgICAgICAgc2VsZWN0X2JyYW5jaCA6IGZ1bmN0aW9uIChvYmosIG11bHRpcGxlKSB7XG4gICAgICAgICAgICBpZih0aGlzLmxvY2tlZCkgcmV0dXJuIHRoaXMuZXJyb3IoXCJMT0NLRURcIik7XG4gICAgICAgICAgICBpZighb2JqICYmIHRoaXMuaG92ZXJlZCAhPT0gZmFsc2UpIG9iaiA9IHRoaXMuaG92ZXJlZDtcbiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XG4gICAgICAgICAgICBvYmogPSBfdGhpcy5nZXRfbm9kZShvYmopO1xuICAgICAgICAgICAgaWYoIW9iai5zaXplKCkpIHJldHVybiB0aGlzLmVycm9yKFwiU0VMRUNUOiBOT1QgQSBWQUxJRCBOT0RFXCIpO1xuICAgICAgICAgICAgb2JqLmNoaWxkcmVuKFwiYVwiKS5yZW1vdmVDbGFzcyhcImhvdmVyXCIpO1xuICAgICAgICAgICAgLy8gQ0hFQ0sgQUdBSU5TVCBSVUxFUyBGT1IgU0VMRUNUQUJMRSBOT0RFU1xuICAgICAgICAgICAgaWYoIV90aGlzLmNoZWNrKFwiY2xpY2thYmxlXCIsIG9iaikpIHJldHVybiB0aGlzLmVycm9yKFwiU0VMRUNUOiBOT0RFIE5PVCBTRUxFQ1RBQkxFXCIpO1xuICAgICAgICAgICAgaWYoX3RoaXMuc2V0dGluZ3MuY2FsbGJhY2suYmVmb3JlY2hhbmdlLmNhbGwobnVsbCxvYmouZ2V0KDApLF90aGlzKSA9PT0gZmFsc2UpIHJldHVybiB0aGlzLmVycm9yKFwiU0VMRUNUOiBTVE9QUEVEIEJZIFVTRVJcIik7XG4gICAgICAgICAgICAvLyBJRiBtdWx0aXBsZSBBTkQgb2JqIElTIEFMUkVBRFkgU0VMRUNURUQgLSBERVNFTEVDVCBJVFxuICAgICAgICAgICAgaWYodGhpcy5zZXR0aW5ncy5ydWxlcy5tdWx0aXBsZSAhPSBmYWxzZSAmJiBtdWx0aXBsZSAmJiBvYmouY2hpbGRyZW4oXCJhLmNsaWNrZWRcIikuc2l6ZSgpID4gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRlc2VsZWN0X2JyYW5jaChvYmopO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYodGhpcy5zZXR0aW5ncy5ydWxlcy5tdWx0aXBsZSAhPSBmYWxzZSAmJiBtdWx0aXBsZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRfYXJyLnB1c2gob2JqKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmKHRoaXMuc2V0dGluZ3MucnVsZXMubXVsdGlwbGUgIT0gZmFsc2UgJiYgIW11bHRpcGxlKSB7XG4gICAgICAgICAgICAgICAgZm9yKGkgaW4gdGhpcy5zZWxlY3RlZF9hcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZF9hcnJbaV0uY2hpbGRyZW4oXCJBXCIpLnJlbW92ZUNsYXNzKFwiY2xpY2tlZFwiKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZF9hcnIgPSBbXTtcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkX2Fyci5wdXNoKG9iaik7XG4gICAgICAgICAgICAgICAgaWYodGhpcy5zZWxlY3RlZCkgdGhpcy5zZWxlY3RlZC5jaGlsZHJlbihcIkFcIikucmVtb3ZlQ2xhc3MoXCJjbGlja2VkXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYoIXRoaXMuc2V0dGluZ3MucnVsZXMubXVsdGlwbGUpIHtcbiAgICAgICAgICAgICAgICBpZih0aGlzLnNlbGVjdGVkKSB0aGlzLnNlbGVjdGVkLmNoaWxkcmVuKFwiQVwiKS5yZW1vdmVDbGFzcyhcImNsaWNrZWRcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBTQVZFIE5FV0xZIFNFTEVDVEVEXG4gICAgICAgICAgICB0aGlzLnNlbGVjdGVkID0gb2JqO1xuICAgICAgICAgICAgaWYodGhpcy5zZXR0aW5ncy51aS5ob3Zlcl9tb2RlICYmIHRoaXMuaG92ZXJlZCAhPT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmhvdmVyZWQuY2hpbGRyZW4oXCJBXCIpLnJlbW92ZUNsYXNzKFwiaG92ZXJcIik7XG4gICAgICAgICAgICAgICAgdGhpcy5ob3ZlcmVkID0gb2JqO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBGT0NVUyBORVcgTk9ERSBBTkQgT1BFTiBBTEwgUEFSRU5UIE5PREVTIElGIENMT1NFRFxuICAgICAgICAgICAgdGhpcy5zZWxlY3RlZC5jaGlsZHJlbihcImFcIikucmVtb3ZlQ2xhc3MoXCJjbGlja2VkXCIpLmFkZENsYXNzKFwiY2xpY2tlZFwiKS5lbmQoKS5wYXJlbnRzKFwibGkuY2xvc2VkXCIpLmVhY2goIGZ1bmN0aW9uICgpIHsgX3RoaXMub3Blbl9icmFuY2godGhpcywgdHJ1ZSk7IH0pO1xuXG4gICAgICAgICAgICAvLyBTQ1JPTEwgU0VMRUNURUQgTk9ERSBJTlRPIFZJRVdcbiAgICAgICAgICAgIHZhciBvZmZfdCA9IHRoaXMuc2VsZWN0ZWQub2Zmc2V0KCkudG9wO1xuICAgICAgICAgICAgdmFyIGJlZ190ID0gdGhpcy5jb250YWluZXIub2Zmc2V0KCkudG9wO1xuICAgICAgICAgICAgdmFyIGVuZF90ID0gYmVnX3QgKyB0aGlzLmNvbnRhaW5lci5oZWlnaHQoKTtcbiAgICAgICAgICAgIHZhciBoX2NvciA9ICh0aGlzLmNvbnRhaW5lci5nZXQoMCkuc2Nyb2xsV2lkdGggPiB0aGlzLmNvbnRhaW5lci53aWR0aCgpKSA/IDQwIDogMjA7XG4gICAgICAgICAgICBpZihvZmZfdCArIDUgPCBiZWdfdCkgdGhpcy5jb250YWluZXIuc2Nyb2xsVG9wKHRoaXMuY29udGFpbmVyLnNjcm9sbFRvcCgpIC0gKGJlZ190IC0gb2ZmX3QgKyA1KSApO1xuICAgICAgICAgICAgaWYob2ZmX3QgKyBoX2NvciA+IGVuZF90KSB0aGlzLmNvbnRhaW5lci5zY3JvbGxUb3AodGhpcy5jb250YWluZXIuc2Nyb2xsVG9wKCkgKyAob2ZmX3QgKyBoX2NvciAtIGVuZF90KSApO1xuXG4gICAgICAgICAgICB0aGlzLnNldF9jb29raWUoXCJzZWxlY3RlZFwiKTtcbiAgICAgICAgICAgIHRoaXMuc2V0dGluZ3MuY2FsbGJhY2sub25jaGFuZ2UuY2FsbChudWxsLCB0aGlzLnNlbGVjdGVkLmdldCgwKSwgX3RoaXMpO1xuICAgICAgICB9LFxuICAgICAgICBkZXNlbGVjdF9icmFuY2ggOiBmdW5jdGlvbiAob2JqKSB7XG4gICAgICAgICAgICBpZih0aGlzLmxvY2tlZCkgcmV0dXJuIHRoaXMuZXJyb3IoXCJMT0NLRURcIik7XG4gICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuICAgICAgICAgICAgdmFyIG9iaiA9IHRoaXMuZ2V0X25vZGUob2JqKTtcbiAgICAgICAgICAgIG9iai5jaGlsZHJlbihcImFcIikucmVtb3ZlQ2xhc3MoXCJjbGlja2VkXCIpO1xuICAgICAgICAgICAgaWYodGhpcy5zZXR0aW5ncy5ydWxlcy5tdWx0aXBsZSAhPSBmYWxzZSAmJiB0aGlzLnNlbGVjdGVkX2Fyci5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZF9hcnIgPSBbXTtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5maW5kKFwiYS5jbGlja2VkXCIpLmZpbHRlcihcIjpmaXJzdC1jaGlsZFwiKS5wYXJlbnQoKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMuc2VsZWN0ZWRfYXJyLnB1c2goalF1ZXJ5KHRoaXMpKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBpZihvYmouZ2V0KDApID09IHRoaXMuc2VsZWN0ZWQuZ2V0KDApKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWQgPSB0aGlzLnNlbGVjdGVkX2FyclswXTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRfY29va2llKFwic2VsZWN0ZWRcIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYodGhpcy5zZXR0aW5ncy5ydWxlcy5tdWx0aXBsZSAhPSBmYWxzZSkgdGhpcy5zZWxlY3RlZF9hcnIgPSBbXTtcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRfY29va2llKFwic2VsZWN0ZWRcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZih0aGlzLnNlbGVjdGVkKSAgICB0aGlzLnNldHRpbmdzLmNhbGxiYWNrLm9uY2hhbmdlLmNhbGwobnVsbCwgdGhpcy5zZWxlY3RlZC5nZXQoMCksIF90aGlzKTtcbiAgICAgICAgICAgIGVsc2UgICAgICAgICAgICAgICAgdGhpcy5zZXR0aW5ncy5jYWxsYmFjay5vbmNoYW5nZS5jYWxsKG51bGwsIGZhbHNlLCBfdGhpcyk7XG4gICAgICAgIH0sXG4gICAgICAgIHRvZ2dsZV9icmFuY2ggOiBmdW5jdGlvbiAob2JqKSB7XG4gICAgICAgICAgICBpZih0aGlzLmxvY2tlZCkgcmV0dXJuIHRoaXMuZXJyb3IoXCJMT0NLRURcIik7XG4gICAgICAgICAgICB2YXIgb2JqID0gdGhpcy5nZXRfbm9kZShvYmopO1xuICAgICAgICAgICAgaWYob2JqLmhhc0NsYXNzKFwiY2xvc2VkXCIpKSAgICByZXR1cm4gdGhpcy5vcGVuX2JyYW5jaChvYmopO1xuICAgICAgICAgICAgaWYob2JqLmhhc0NsYXNzKFwib3BlblwiKSkgICAgcmV0dXJuIHRoaXMuY2xvc2VfYnJhbmNoKG9iaik7XG4gICAgICAgIH0sXG4gICAgICAgIG9wZW5fYnJhbmNoIDogZnVuY3Rpb24gKG9iaiwgZGlzYWJsZV9hbmltYXRpb24sIGNhbGxiYWNrKSB7XG4gICAgICAgICAgICBpZih0aGlzLmxvY2tlZCkgcmV0dXJuIHRoaXMuZXJyb3IoXCJMT0NLRURcIik7XG4gICAgICAgICAgICB2YXIgb2JqID0gdGhpcy5nZXRfbm9kZShvYmopO1xuICAgICAgICAgICAgaWYoIW9iai5zaXplKCkpIHJldHVybiB0aGlzLmVycm9yKFwiT1BFTjogTk8gU1VDSCBOT0RFXCIpO1xuICAgICAgICAgICAgaWYob2JqLmhhc0NsYXNzKFwibGVhZlwiKSkgcmV0dXJuIHRoaXMuZXJyb3IoXCJPUEVOOiBPUEVOSU5HIExFQUYgTk9ERVwiKTtcblxuICAgICAgICAgICAgaWYodGhpcy5zZXR0aW5ncy5kYXRhLmFzeW5jICYmIG9iai5maW5kKFwibGlcIikuc2l6ZSgpID09IDApIHtcbiAgICAgICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuICAgICAgICAgICAgICAgIG9iai5jaGlsZHJlbihcInVsOmVxKDApXCIpLnJlbW92ZSgpLmVuZCgpLmFwcGVuZChcIjx1bD48bGkgY2xhc3M9J2xhc3QnPjxhIHN0eWxlPSdiYWNrZ3JvdW5kLWltYWdlOnVybChcIiArIF90aGlzLnNldHRpbmdzLnVpLnRoZW1lX3BhdGggKyBcImRlZmF1bHQvdGhyb2JiZXIuZ2lmKScgaHJlZj0nIyc+XCIgKyAoX3RoaXMuc2V0dGluZ3MubGFuZy5sb2FkaW5nIHx8IFwiTG9hZGluZyAuLi5cIikgKyBcIjwvYT48L2xpPjwvdWw+XCIpO1xuICAgICAgICAgICAgICAgIG9iai5yZW1vdmVDbGFzcyhcImNsb3NlZFwiKS5hZGRDbGFzcyhcIm9wZW5cIik7XG4gICAgICAgICAgICAgICAgaWYodGhpcy5zZXR0aW5ncy5kYXRhLnR5cGUgPT0gXCJ4bWxfZmxhdFwiIHx8IHRoaXMuc2V0dGluZ3MuZGF0YS50eXBlID09IFwieG1sX25lc3RlZFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB4c2wgPSAodGhpcy5zZXR0aW5ncy5kYXRhLnR5cGUgPT0gXCJ4bWxfZmxhdFwiKSA/IFwiZmxhdC54c2xcIiA6IFwibmVzdGVkLnhzbFwiO1xuICAgICAgICAgICAgICAgICAgICB2YXIgc3RyID0gKHRoaXMuc2V0dGluZ3MuZGF0YS51cmwuaW5kZXhPZihcIj9cIikgPT0gLTEpID8gXCI/aWQ9XCIgKyBlbmNvZGVVUklDb21wb25lbnQob2JqLmF0dHIoXCJpZFwiKSkgOiBcIiZpZD1cIiArIGVuY29kZVVSSUNvbXBvbmVudChvYmouYXR0cihcImlkXCIpKTtcbiAgICAgICAgICAgICAgICAgICAgb2JqLmNoaWxkcmVuKFwidWw6ZXEoMClcIikuZ2V0VHJhbnNmb3JtKHRoaXMucGF0aCArIHhzbCwgdGhpcy5zZXR0aW5ncy5kYXRhLnVybCArIHN0ciwgeyBwYXJhbXMgOiB7IHRoZW1lX3BhdGggOiBfdGhpcy50aGVtZSB9LCBtZXRoIDogdGhpcy5zZXR0aW5ncy5kYXRhLm1ldGhvZCwgcmVwbCA6IHRydWUsIGNhbGxiYWNrOiBmdW5jdGlvbiAoc3RyLCBqc29uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoc3RyLmxlbmd0aCA8IDE1KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iai5yZW1vdmVDbGFzcyhcImNsb3NlZFwiKS5yZW1vdmVDbGFzcyhcIm9wZW5cIikuYWRkQ2xhc3MoXCJsZWFmXCIpLmNoaWxkcmVuKFwidWxcIikucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGNhbGxiYWNrKSBjYWxsYmFjay5jYWxsKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMub3Blbl9icmFuY2guYXBwbHkoX3RoaXMsIFtvYmpdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihjYWxsYmFjaykgY2FsbGJhY2suY2FsbCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGpRdWVyeS5hamF4KHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgICAgICAgIDogdGhpcy5zZXR0aW5ncy5kYXRhLm1ldGhvZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHVybCAgICAgICAgICAgIDogdGhpcy5zZXR0aW5ncy5kYXRhLnVybCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgICAgICAgIDogdGhpcy5zZXR0aW5ncy5kYXRhLmFzeW5jX2RhdGEob2JqKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFUeXBlICAgIDogXCJqc29uXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzICAgICAgICA6IGZ1bmN0aW9uIChkYXRhLCB0ZXh0U3RhdHVzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWRhdGEgfHwgZGF0YS5sZW5ndGggPT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmoucmVtb3ZlQ2xhc3MoXCJjbG9zZWRcIikucmVtb3ZlQ2xhc3MoXCJvcGVuXCIpLmFkZENsYXNzKFwibGVhZlwiKS5jaGlsZHJlbihcInVsXCIpLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihjYWxsYmFjaykgY2FsbGJhY2suY2FsbCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdHIgPSBcIlwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGRhdGEubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHIgKz0gX3RoaXMucGFyc2VKU09OKGRhdGFbaV0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Ugc3RyID0gX3RoaXMucGFyc2VKU09OKGRhdGEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iai5jaGlsZHJlbihcInVsOmVxKDApXCIpLnJlcGxhY2VXaXRoKFwiPHVsPlwiICsgc3RyICsgXCI8L3VsPlwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmouZmluZChcImxpOmxhc3QtY2hpbGRcIikuYWRkQ2xhc3MoXCJsYXN0XCIpLmVuZCgpLmZpbmQoXCJsaTpoYXModWwpXCIpLm5vdChcIi5vcGVuXCIpLmFkZENsYXNzKFwiY2xvc2VkXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iai5maW5kKFwibGlcIikubm90KFwiLm9wZW5cIikubm90KFwiLmNsb3NlZFwiKS5hZGRDbGFzcyhcImxlYWZcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMub3Blbl9icmFuY2guYXBwbHkoX3RoaXMsIFtvYmpdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihjYWxsYmFjaykgY2FsbGJhY2suY2FsbCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZihwYXJzZUludCh0aGlzLnNldHRpbmdzLnVpLmFuaW1hdGlvbikgPiAwICYmICFkaXNhYmxlX2FuaW1hdGlvbiAmJiAhKGpRdWVyeS5icm93c2VyLm1zaWUgJiYgalF1ZXJ5LmJyb3dzZXIudmVyc2lvbiA8IDcpICkge1xuICAgICAgICAgICAgICAgICAgICBvYmouY2hpbGRyZW4oXCJ1bDplcSgwKVwiKS5jc3MoXCJkaXNwbGF5XCIsXCJub25lXCIpO1xuICAgICAgICAgICAgICAgICAgICBvYmoucmVtb3ZlQ2xhc3MoXCJjbG9zZWRcIikuYWRkQ2xhc3MoXCJvcGVuXCIpO1xuICAgICAgICAgICAgICAgICAgICBvYmouY2hpbGRyZW4oXCJ1bDplcSgwKVwiKS5zbGlkZURvd24ocGFyc2VJbnQodGhpcy5zZXR0aW5ncy51aS5hbmltYXRpb24pLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeSh0aGlzKS5jc3MoXCJkaXNwbGF5XCIsXCJcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZihjYWxsYmFjaykgY2FsbGJhY2suY2FsbCgpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBvYmoucmVtb3ZlQ2xhc3MoXCJjbG9zZWRcIikuYWRkQ2xhc3MoXCJvcGVuXCIpO1xuICAgICAgICAgICAgICAgICAgICBpZihjYWxsYmFjaykgY2FsbGJhY2suY2FsbCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLnNldF9jb29raWUoXCJvcGVuXCIpO1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0dGluZ3MuY2FsbGJhY2sub25vcGVuLmNhbGwobnVsbCwgb2JqLmdldCgwKSwgdGhpcyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIGNsb3NlX2JyYW5jaCA6IGZ1bmN0aW9uIChvYmosIGRpc2FibGVfYW5pbWF0aW9uKSB7XG4gICAgICAgICAgICBpZih0aGlzLmxvY2tlZCkgcmV0dXJuIHRoaXMuZXJyb3IoXCJMT0NLRURcIik7XG4gICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuICAgICAgICAgICAgdmFyIG9iaiA9IHRoaXMuZ2V0X25vZGUob2JqKTtcbiAgICAgICAgICAgIGlmKHBhcnNlSW50KHRoaXMuc2V0dGluZ3MudWkuYW5pbWF0aW9uKSA+IDAgJiYgIWRpc2FibGVfYW5pbWF0aW9uICYmICEoalF1ZXJ5LmJyb3dzZXIubXNpZSAmJiBqUXVlcnkuYnJvd3Nlci52ZXJzaW9uIDwgNykgJiYgb2JqLmNoaWxkcmVuKFwidWw6ZXEoMClcIikuc2l6ZSgpID09IDEpIHtcbiAgICAgICAgICAgICAgICBvYmouY2hpbGRyZW4oXCJ1bDplcSgwKVwiKS5zbGlkZVVwKHBhcnNlSW50KHRoaXMuc2V0dGluZ3MudWkuYW5pbWF0aW9uKSwgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIG9iai5yZW1vdmVDbGFzcyhcIm9wZW5cIikuYWRkQ2xhc3MoXCJjbG9zZWRcIik7XG4gICAgICAgICAgICAgICAgICAgIF90aGlzLnNldF9jb29raWUoXCJvcGVuXCIpO1xuICAgICAgICAgICAgICAgICAgICBqUXVlcnkodGhpcykuY3NzKFwiZGlzcGxheVwiLFwiXCIpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgb2JqLnJlbW92ZUNsYXNzKFwib3BlblwiKS5hZGRDbGFzcyhcImNsb3NlZFwiKTtcbiAgICAgICAgICAgICAgICB0aGlzLnNldF9jb29raWUoXCJvcGVuXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYodGhpcy5zZWxlY3RlZCAmJiBvYmouY2hpbGRyZW4oXCJ1bDplcSgwKVwiKS5maW5kKFwiYS5jbGlja2VkXCIpLnNpemUoKSA+IDApIHtcbiAgICAgICAgICAgICAgICBvYmouZmluZChcImxpOmhhcyhhLmNsaWNrZWQpXCIpLmVhY2goZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIF90aGlzLmRlc2VsZWN0X2JyYW5jaCh0aGlzKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBpZihvYmouY2hpbGRyZW4oXCJhLmNsaWNrZWRcIikuc2l6ZSgpID09IDApIHRoaXMuc2VsZWN0X2JyYW5jaChvYmosICh0aGlzLnNldHRpbmdzLnJ1bGVzLm11bHRpcGxlICE9IGZhbHNlICYmIHRoaXMuc2VsZWN0ZWRfYXJyLmxlbmd0aCA+IDApICk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnNldHRpbmdzLmNhbGxiYWNrLm9uY2xvc2UuY2FsbChudWxsLCBvYmouZ2V0KDApLCB0aGlzKTtcbiAgICAgICAgfSxcbiAgICAgICAgb3Blbl9hbGwgOiBmdW5jdGlvbiAob2JqKSB7XG4gICAgICAgICAgICBpZih0aGlzLmxvY2tlZCkgcmV0dXJuIHRoaXMuZXJyb3IoXCJMT0NLRURcIik7XG4gICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuICAgICAgICAgICAgb2JqID0gb2JqID8galF1ZXJ5KG9iaikgOiB0aGlzLmNvbnRhaW5lcjtcbiAgICAgICAgICAgIG9iai5maW5kKFwibGkuY2xvc2VkXCIpLmVhY2goIGZ1bmN0aW9uICgpIHsgdmFyIF9fdGhpcyA9IHRoaXM7IF90aGlzLm9wZW5fYnJhbmNoLmFwcGx5KF90aGlzLCBbdGhpcywgdHJ1ZSwgZnVuY3Rpb24oKSB7IF90aGlzLm9wZW5fYWxsLmFwcGx5KF90aGlzLCBbX190aGlzXSk7IH0gXSk7IH0pO1xuICAgICAgICB9LFxuICAgICAgICBjbG9zZV9hbGwgOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZih0aGlzLmxvY2tlZCkgcmV0dXJuIHRoaXMuZXJyb3IoXCJMT0NLRURcIik7XG4gICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuICAgICAgICAgICAgalF1ZXJ5KHRoaXMuY29udGFpbmVyKS5maW5kKFwibGkub3BlblwiKS5lYWNoKCBmdW5jdGlvbiAoKSB7IF90aGlzLmNsb3NlX2JyYW5jaCh0aGlzLCB0cnVlKTsgfSk7XG4gICAgICAgIH0sXG4gICAgICAgIHNob3dfbGFuZyA6IGZ1bmN0aW9uIChpKSB7XG4gICAgICAgICAgICBpZih0aGlzLmxvY2tlZCkgcmV0dXJuIHRoaXMuZXJyb3IoXCJMT0NLRURcIik7XG4gICAgICAgICAgICBpZih0aGlzLnNldHRpbmdzLmxhbmd1YWdlc1tpXSA9PSB0aGlzLmN1cnJlbnRfbGFuZykgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB2YXIgc3QgPSBmYWxzZTtcbiAgICAgICAgICAgIHZhciBpZCA9IHRoaXMuY29udGFpbmVyLmF0dHIoXCJpZFwiKSA/IFwiI1wiICsgdGhpcy5jb250YWluZXIuYXR0cihcImlkXCIpIDogXCIudHJlZVwiO1xuICAgICAgICAgICAgc3QgPSBnZXRfY3NzKGlkICsgXCIgLlwiICsgdGhpcy5jdXJyZW50X2xhbmcsIHRoaXMuc24pO1xuICAgICAgICAgICAgaWYoc3QgIT09IGZhbHNlKSBzdC5zdHlsZS5kaXNwbGF5ID0gXCJub25lXCI7XG4gICAgICAgICAgICBzdCA9IGdldF9jc3MoaWQgKyBcIiAuXCIgKyB0aGlzLnNldHRpbmdzLmxhbmd1YWdlc1tpXSwgdGhpcy5zbik7XG4gICAgICAgICAgICBpZihzdCAhPT0gZmFsc2UpIHN0LnN0eWxlLmRpc3BsYXkgPSBcImJsb2NrXCI7XG4gICAgICAgICAgICB0aGlzLmN1cnJlbnRfbGFuZyA9IHRoaXMuc2V0dGluZ3MubGFuZ3VhZ2VzW2ldO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0sXG4gICAgICAgIGN5Y2xlX2xhbmcgOiBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIGlmKHRoaXMubG9ja2VkKSByZXR1cm4gdGhpcy5lcnJvcihcIkxPQ0tFRFwiKTtcbiAgICAgICAgICAgIHZhciBpID0galF1ZXJ5LmluQXJyYXkodGhpcy5jdXJyZW50X2xhbmcsIHRoaXMuc2V0dGluZ3MubGFuZ3VhZ2VzKTtcbiAgICAgICAgICAgIGkgKys7XG4gICAgICAgICAgICBpZihpID4gdGhpcy5zZXR0aW5ncy5sYW5ndWFnZXMubGVuZ3RoIC0gMSkgaSA9IDA7XG4gICAgICAgICAgICB0aGlzLnNob3dfbGFuZyhpKTtcbiAgICAgICAgfSxcbiAgICAgICAgY3JlYXRlIDogZnVuY3Rpb24gKHR5cGUsIG9iaiwgZGF0YSwgaWNvbiwgaWQgKSB7XG4gICAgICAgICAgICBpZih0aGlzLmxvY2tlZCkgcmV0dXJuIHRoaXMuZXJyb3IoXCJMT0NLRURcIik7XG4gICAgICAgICAgICAvLyBOT1RISU5HIFNFTEVDVEVEXG4gICAgICAgICAgICBvYmogPSBvYmogPyB0aGlzLmdldF9ub2RlKG9iaikgOiB0aGlzLnNlbGVjdGVkO1xuICAgICAgICAgICAgaWYoIW9iaiB8fCAhb2JqLnNpemUoKSkgcmV0dXJuIHRoaXMuZXJyb3IoXCJDUkVBVEU6IE5PIE5PREUgU0VMRUNURURcIik7XG4gICAgICAgICAgICBpZighdGhpcy5jaGVjayhcImNyZWF0YWJsZVwiLCBvYmopKSByZXR1cm4gdGhpcy5lcnJvcihcIkNSRUFURTogQ0FOTk9UIENSRUFURSBJTiBOT0RFXCIpO1xuXG4gICAgICAgICAgICB2YXIgdCA9IHR5cGUgfHwgdGhpcy5nZXRfdHlwZShvYmopIHx8IFwiXCI7XG4gICAgICAgICAgICBpZih0aGlzLnNldHRpbmdzLnJ1bGVzLnVzZV9pbmxpbmUgJiYgdGhpcy5zZXR0aW5ncy5ydWxlcy5tZXRhZGF0YSkge1xuICAgICAgICAgICAgICAgIGpRdWVyeS5tZXRhZGF0YS5zZXRUeXBlKFwiYXR0clwiLCB0aGlzLnNldHRpbmdzLnJ1bGVzLm1ldGFkYXRhKTtcbiAgICAgICAgICAgICAgICBpZih0eXBlb2Ygb2JqLm1ldGFkYXRhKClbXCJ2YWxpZF9jaGlsZHJlblwiXSAhPSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmKGpRdWVyeS5pbkFycmF5KHQsIG9iai5tZXRhZGF0YSgpW1widmFsaWRfY2hpbGRyZW5cIl0pID09IC0xKSByZXR1cm4gdGhpcy5lcnJvcihcIkNSRUFURTogTk9ERSBOT1QgQSBWQUxJRCBDSElMRFwiKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYodHlwZW9mIG9iai5tZXRhZGF0YSgpW1wibWF4X2NoaWxkcmVuXCJdICE9IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYoIChvYmouY2hpbGRyZW4oXCJ1bDplcSgwKVwiKS5jaGlsZHJlbihcImxpXCIpLnNpemUoKSArIDEpID4gb2JqLm1ldGFkYXRhKCkubWF4X2NoaWxkcmVuKSByZXR1cm4gdGhpcy5lcnJvcihcIkNSRUFURTogTUFYX0NISUxEUkVOIFJFQUNIRURcIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhciBvayA9IHRydWU7XG4gICAgICAgICAgICAgICAgb2JqLnBhcmVudHMoXCJsaVwiKS5lYWNoKGZ1bmN0aW9uKGkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYoalF1ZXJ5KHRoaXMpLm1ldGFkYXRhKCkubWF4X2RlcHRoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiggKGkgKyAxKSA+PSBqUXVlcnkodGhpcykubWV0YWRhdGEoKS5tYXhfZGVwdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvayA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgaWYoIW9rKSByZXR1cm4gdGhpcy5lcnJvcihcIkNSRUFURTogTUFYX0RFUFRIIFJFQUNIRURcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZihvYmouaGFzQ2xhc3MoXCJjbG9zZWRcIikpIHtcbiAgICAgICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm9wZW5fYnJhbmNoKG9iaiwgdHJ1ZSwgZnVuY3Rpb24gKCkgeyBfdGhpcy5jcmVhdGUuYXBwbHkoX3RoaXMsIFt0eXBlLCBvYmosIGRhdGEsIGljb24sIGlkXSk7IH0gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYoaWQpICAgICRsaSA9IGpRdWVyeShcIjxsaSBpZD0nXCIgKyBpZCArIFwiJyAvPlwiKTtcbiAgICAgICAgICAgIGVsc2UgICAgJGxpID0galF1ZXJ5KFwiPGxpIC8+XCIpO1xuICAgICAgICAgICAgLy8gTkVXIE5PREUgSVMgT0YgUEFTU0VEIFRZUEUgT1IgUEFSRU5UJ1MgVFlQRVxuICAgICAgICAgICAgaWYodGhpcy5zZXR0aW5ncy5ydWxlcy5tZXRhZGF0YSkge1xuICAgICAgICAgICAgICAgIGpRdWVyeS5tZXRhZGF0YS5zZXRUeXBlKFwiYXR0clwiLCB0aGlzLnNldHRpbmdzLnJ1bGVzLm1ldGFkYXRhKTtcbiAgICAgICAgICAgICAgICAkbGkuYXR0cih0aGlzLnNldHRpbmdzLnJ1bGVzLm1ldGFkYXRhLCBcInR5cGU6ICdcIiArIHQgKyBcIidcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAkbGkuYXR0cih0aGlzLnNldHRpbmdzLnJ1bGVzLnR5cGVfYXR0ciwgdClcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdmFyIGljbiA9IFwiXCI7XG4gICAgICAgICAgICBpZigodHlwZW9mIGljb24pLnRvTG93ZXJDYXNlKCkgPT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgICAgICAgIGljbiA9IGljb247XG4gICAgICAgICAgICAgICAgaWNuID0gaWNuLmluZGV4T2YoXCIvXCIpID09IC0xID8gdGhpcy50aGVtZSArIGljbiA6IGljbjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmKHRoaXMuc2V0dGluZ3MubGFuZ3VhZ2VzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIGZvcihpID0gMDsgaSA8IHRoaXMuc2V0dGluZ3MubGFuZ3VhZ2VzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmKCh0eXBlb2YgZGF0YSkudG9Mb3dlckNhc2UoKSA9PSBcInN0cmluZ1wiKSB2YWwgPSBkYXRhO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmKGRhdGEgJiYgZGF0YVtpXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gZGF0YVtpXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmKHRoaXMuc2V0dGluZ3MubGFuZy5uZXdfbm9kZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYoKHR5cGVvZiB0aGlzLnNldHRpbmdzLmxhbmcubmV3X25vZGUpLnRvTG93ZXJDYXNlKCkgIT0gXCJzdHJpbmdcIiAmJiB0aGlzLnNldHRpbmdzLmxhbmcubmV3X25vZGVbaV0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gdGhpcy5zZXR0aW5ncy5sYW5nLm5ld19ub2RlW2ldO1xuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IHRoaXMuc2V0dGluZ3MubGFuZy5uZXdfbm9kZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IFwiTmV3IGZvbGRlclwiO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmKCh0eXBlb2YgaWNvbikudG9Mb3dlckNhc2UoKSAhPSBcInN0cmluZ1wiICYmIGljb24gJiYgaWNvbltpXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWNuID0gaWNvbltpXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGljbiA9IGljbi5pbmRleE9mKFwiL1wiKSA9PSAtMSA/IHRoaXMudGhlbWUgKyBpY24gOiBpY247XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgJGxpLmFwcGVuZChcIjxhIGhyZWY9JyMnXCIgKyAoIGljbi5sZW5ndGggPyBcIiBzdHlsZT0nYmFja2dyb3VuZC1pbWFnZTp1cmwoXFxcIlwiICsgaWNuICsgXCJcXFwiKTsnIFwiIDogXCIgXCIpICsgXCJjbGFzcz0nXCIgKyB0aGlzLnNldHRpbmdzLmxhbmd1YWdlc1tpXSArIFwiJz5cIiArIHZhbCArIFwiPC9hPlwiKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHsgJGxpLmFwcGVuZChcIjxhIGhyZWY9JyMnXCIgKyAoIGljbi5sZW5ndGggPyBcIiBzdHlsZT0nYmFja2dyb3VuZC1pbWFnZTp1cmwoXFxcIlwiICsgaWNuICsgXCJcXFwiKTsnIFwiIDogXCIgXCIpICsgXCI+XCIgKyAoZGF0YSB8fCB0aGlzLnNldHRpbmdzLmxhbmcubmV3X25vZGUgfHwgXCJOZXcgZm9sZGVyXCIpICsgXCI8L2E+XCIpOyB9XG4gICAgICAgICAgICAkbGkuYWRkQ2xhc3MoXCJsZWFmXCIpO1xuICAgICAgICAgICAgaWYodGhpcy5zZXR0aW5ncy5ydWxlcy5jcmVhdGVhdCA9PSBcInRvcFwiIHx8IG9iai5jaGlsZHJlbihcInVsXCIpLnNpemUoKSA9PSAwKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5tb3ZlZCgkbGksb2JqLmNoaWxkcmVuKFwiYTplcSgwKVwiKSxcImluc2lkZVwiLCB0cnVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMubW92ZWQoJGxpLG9iai5jaGlsZHJlbihcInVsOmVxKDApXCIpLmNoaWxkcmVuKFwibGk6bGFzdFwiKS5jaGlsZHJlbihcImE6ZXEoMClcIiksXCJhZnRlclwiLHRydWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5zZWxlY3RfYnJhbmNoKCRsaS5jaGlsZHJlbihcImE6ZXEoMClcIikpO1xuICAgICAgICAgICAgaWYoIWRhdGEpIHRoaXMucmVuYW1lKCk7XG4gICAgICAgICAgICByZXR1cm4gJGxpO1xuICAgICAgICB9LFxuICAgICAgICByZW5hbWUgOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZih0aGlzLmxvY2tlZCkgcmV0dXJuIHRoaXMuZXJyb3IoXCJMT0NLRURcIik7XG4gICAgICAgICAgICBpZih0aGlzLnNlbGVjdGVkKSB7XG4gICAgICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpcztcbiAgICAgICAgICAgICAgICBpZighdGhpcy5jaGVjayhcInJlbmFtZWFibGVcIiwgdGhpcy5zZWxlY3RlZCkpIHJldHVybiB0aGlzLmVycm9yKFwiUkVOQU1FOiBOT0RFIE5PVCBSRU5BTUFCTEVcIik7XG4gICAgICAgICAgICAgICAgaWYoIXRoaXMuc2V0dGluZ3MuY2FsbGJhY2suYmVmb3JlcmVuYW1lLmNhbGwobnVsbCx0aGlzLnNlbGVjdGVkLmdldCgwKSwgX3RoaXMuY3VycmVudF9sYW5nLCBfdGhpcykpIHJldHVybiB0aGlzLmVycm9yKFwiUkVOQU1FOiBTVE9QUEVEIEJZIFVTRVJcIik7XG4gICAgICAgICAgICAgICAgdmFyIG9iaiA9IHRoaXMuc2VsZWN0ZWQ7XG4gICAgICAgICAgICAgICAgaWYodGhpcy5jdXJyZW50X2xhbmcpICAgIG9iaiA9IG9iai5maW5kKFwiYS5cIiArIHRoaXMuY3VycmVudF9sYW5nKS5nZXQoMCk7XG4gICAgICAgICAgICAgICAgZWxzZSAgICAgICAgICAgICAgICAgICAgb2JqID0gb2JqLmZpbmQoXCJhOmZpcnN0XCIpLmdldCgwKTtcbiAgICAgICAgICAgICAgICBsYXN0X3ZhbHVlID0gb2JqLmlubmVySFRNTDtcbiAgICAgICAgICAgICAgICBfdGhpcy5pbnAgPSBqUXVlcnkoXCI8aW5wdXQgdHlwZT0ndGV4dCcgLz5cIik7XG4gICAgICAgICAgICAgICAgX3RoaXMuaW5wXG4gICAgICAgICAgICAgICAgICAgIC52YWwobGFzdF92YWx1ZSlcbiAgICAgICAgICAgICAgICAgICAgLmJpbmQoXCJwb2ludGVyZG93blwiLCAgICAgICAgZnVuY3Rpb24gKGV2ZW50KSB7IGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOyB9KVxuICAgICAgICAgICAgICAgICAgICAuYmluZChcInBvaW50ZXJ1cFwiLCAgICAgICAgZnVuY3Rpb24gKGV2ZW50KSB7IGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOyB9KVxuICAgICAgICAgICAgICAgICAgICAuYmluZChcImNsaWNrXCIsICAgICAgICAgICAgZnVuY3Rpb24gKGV2ZW50KSB7IGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOyB9KVxuICAgICAgICAgICAgICAgICAgICAuYmluZChcImtleXVwXCIsICAgICAgICAgICAgZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGtleSA9IGV2ZW50LmtleUNvZGUgfHwgZXZlbnQud2hpY2g7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoa2V5ID09IDI3KSB7IHRoaXMudmFsdWUgPSBsYXN0X3ZhbHVlOyB0aGlzLmJsdXIoKTsgcmV0dXJuIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihrZXkgPT0gMTMpIHsgdGhpcy5ibHVyKCk7IHJldHVybiB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBfdGhpcy5pbnAuYmx1cihmdW5jdGlvbihldmVudCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy52YWx1ZSA9PSBcIlwiKSB0aGlzLnZhbHVlID09IGxhc3RfdmFsdWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkob2JqKS5odG1sKCBqUXVlcnkob2JqKS5wYXJlbnQoKS5maW5kKFwiaW5wdXRcIikuZXEoMCkuYXR0cihcInZhbHVlXCIpICkuZ2V0KDApLnN0eWxlLmRpc3BsYXkgPSBcIlwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgalF1ZXJ5KG9iaikucHJldkFsbChcInNwYW5cIikucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnZhbHVlICE9IGxhc3RfdmFsdWUpIF90aGlzLnNldHRpbmdzLmNhbGxiYWNrLm9ucmVuYW1lLmNhbGwobnVsbCwgX3RoaXMuZ2V0X25vZGUob2JqKS5nZXQoMCksIF90aGlzLmN1cnJlbnRfbGFuZywgX3RoaXMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuaW5wID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHZhciBzcG4gPSBqUXVlcnkoXCI8c3BhbiAvPlwiKS5hZGRDbGFzcyhvYmouY2xhc3NOYW1lKS5hcHBlbmQoX3RoaXMuaW5wKTtcbiAgICAgICAgICAgICAgICBzcG4uYXR0cihcInN0eWxlXCIsIGpRdWVyeShvYmopLmF0dHIoXCJzdHlsZVwiKSk7XG4gICAgICAgICAgICAgICAgb2JqLnN0eWxlLmRpc3BsYXkgPSBcIm5vbmVcIjtcbiAgICAgICAgICAgICAgICBqUXVlcnkob2JqKS5wYXJlbnQoKS5wcmVwZW5kKHNwbik7XG4gICAgICAgICAgICAgICAgX3RoaXMuaW5wLmdldCgwKS5mb2N1cygpO1xuICAgICAgICAgICAgICAgIF90aGlzLmlucC5nZXQoMCkuc2VsZWN0KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHJldHVybiB0aGlzLmVycm9yKFwiUkVOQU1FOiBOTyBOT0RFIFNFTEVDVEVEXCIpO1xuICAgICAgICB9LFxuICAgICAgICAvLyBSRU1PVkUgTk9ERVNcbiAgICAgICAgcmVtb3ZlIDogZnVuY3Rpb24ob2JqKSB7XG4gICAgICAgICAgICBpZih0aGlzLmxvY2tlZCkgcmV0dXJuIHRoaXMuZXJyb3IoXCJMT0NLRURcIik7XG4gICAgICAgICAgICBpZihvYmopIHtcbiAgICAgICAgICAgICAgICBvYmogPSB0aGlzLmdldF9ub2RlKG9iaik7XG4gICAgICAgICAgICAgICAgaWYob2JqLnNpemUoKSkge1xuICAgICAgICAgICAgICAgICAgICBpZighdGhpcy5jaGVjayhcImRlbGV0YWJsZVwiLCBvYmopKSByZXR1cm4gdGhpcy5lcnJvcihcIkRFTEVURTogTk9ERSBOT1QgREVMRVRBQkxFXCIpO1xuICAgICAgICAgICAgICAgICAgICBpZighdGhpcy5zZXR0aW5ncy5jYWxsYmFjay5iZWZvcmVkZWxldGUuY2FsbChudWxsLG9iai5nZXQoMCksIF90aGlzKSkgcmV0dXJuIHRoaXMuZXJyb3IoXCJERUxFVEU6IFNUT1BQRUQgQlkgVVNFUlwiKTtcbiAgICAgICAgICAgICAgICAgICAgJHBhcmVudCA9IG9iai5wYXJlbnQoKTtcbiAgICAgICAgICAgICAgICAgICAgb2JqID0gb2JqLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICAkcGFyZW50LmNoaWxkcmVuKFwibGk6bGFzdFwiKS5hZGRDbGFzcyhcImxhc3RcIik7XG4gICAgICAgICAgICAgICAgICAgIGlmKCRwYXJlbnQuY2hpbGRyZW4oXCJsaVwiKS5zaXplKCkgPT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgJGxpID0gJHBhcmVudC5wYXJlbnRzKFwibGk6ZXEoMClcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAkbGkucmVtb3ZlQ2xhc3MoXCJvcGVuXCIpLnJlbW92ZUNsYXNzKFwiY2xvc2VkXCIpLmFkZENsYXNzKFwibGVhZlwiKS5jaGlsZHJlbihcInVsXCIpLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRfY29va2llKFwib3BlblwiKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldHRpbmdzLmNhbGxiYWNrLm9uZGVsZXRlLmNhbGwobnVsbCwgb2JqLCB0aGlzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmKHRoaXMuc2VsZWN0ZWQpIHtcbiAgICAgICAgICAgICAgICBpZighdGhpcy5jaGVjayhcImRlbGV0YWJsZVwiLCB0aGlzLnNlbGVjdGVkKSkgcmV0dXJuIHRoaXMuZXJyb3IoXCJERUxFVEU6IE5PREUgTk9UIERFTEVUQUJMRVwiKTtcbiAgICAgICAgICAgICAgICBpZighdGhpcy5zZXR0aW5ncy5jYWxsYmFjay5iZWZvcmVkZWxldGUuY2FsbChudWxsLHRoaXMuc2VsZWN0ZWQuZ2V0KDApLCBfdGhpcykpIHJldHVybiB0aGlzLmVycm9yKFwiREVMRVRFOiBTVE9QUEVEIEJZIFVTRVJcIik7XG4gICAgICAgICAgICAgICAgJHBhcmVudCA9IHRoaXMuc2VsZWN0ZWQucGFyZW50KCk7XG4gICAgICAgICAgICAgICAgdmFyIG9iaiA9IHRoaXMuc2VsZWN0ZWQ7XG4gICAgICAgICAgICAgICAgaWYodGhpcy5zZXR0aW5ncy5ydWxlcy5tdWx0aXBsZSA9PSBmYWxzZSB8fCB0aGlzLnNlbGVjdGVkX2Fyci5sZW5ndGggPT0gMSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgc3RvcCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIHZhciB0bXAgPSAodGhpcy5zZWxlY3RlZC5wcmV2KFwibGk6ZXEoMClcIikuc2l6ZSgpKSA/IHRoaXMuc2VsZWN0ZWQucHJldihcImxpOmVxKDApXCIpIDogdGhpcy5zZWxlY3RlZC5wYXJlbnRzKFwibGk6ZXEoMClcIik7XG4gICAgICAgICAgICAgICAgICAgIC8vIHRoaXMuZ2V0X3ByZXYodHJ1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG9iaiA9IG9iai5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAkcGFyZW50LmNoaWxkcmVuKFwibGk6bGFzdFwiKS5hZGRDbGFzcyhcImxhc3RcIik7XG4gICAgICAgICAgICAgICAgaWYoJHBhcmVudC5jaGlsZHJlbihcImxpXCIpLnNpemUoKSA9PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICRsaSA9ICRwYXJlbnQucGFyZW50cyhcImxpOmVxKDApXCIpO1xuICAgICAgICAgICAgICAgICAgICAkbGkucmVtb3ZlQ2xhc3MoXCJvcGVuXCIpLnJlbW92ZUNsYXNzKFwiY2xvc2VkXCIpLmFkZENsYXNzKFwibGVhZlwiKS5jaGlsZHJlbihcInVsXCIpLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldF9jb29raWUoXCJvcGVuXCIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvL3RoaXMuc2VsZWN0ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB0aGlzLnNldHRpbmdzLmNhbGxiYWNrLm9uZGVsZXRlLmNhbGwobnVsbCwgb2JqLCB0aGlzKTtcbiAgICAgICAgICAgICAgICBpZihzdG9wICYmIHRtcCkgdGhpcy5zZWxlY3RfYnJhbmNoKHRtcCk7XG4gICAgICAgICAgICAgICAgaWYodGhpcy5zZXR0aW5ncy5ydWxlcy5tdWx0aXBsZSAhPSBmYWxzZSAmJiAhc3RvcCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkX2FyciA9IFtdO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5maW5kKFwiYS5jbGlja2VkXCIpLmZpbHRlcihcIjpmaXJzdC1jaGlsZFwiKS5wYXJlbnQoKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnNlbGVjdGVkX2Fyci5wdXNoKGpRdWVyeSh0aGlzKSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnNlbGVjdGVkX2Fyci5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZF9hcnJbMF07XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSByZXR1cm4gdGhpcy5lcnJvcihcIkRFTEVURTogTk8gTk9ERSBTRUxFQ1RFRFwiKTtcbiAgICAgICAgfSxcbiAgICAgICAgLy8gRk9SIEVYUExPUkVSLUxJS0UgS0VZQk9BUkQgU0hPUlRDVVRTXG4gICAgICAgIGdldF9uZXh0IDogZnVuY3Rpb24oZm9yY2UpIHtcbiAgICAgICAgICAgIHZhciBvYmogPSB0aGlzLmhvdmVyZWQgfHwgdGhpcy5zZWxlY3RlZDtcbiAgICAgICAgICAgIGlmKG9iaikge1xuICAgICAgICAgICAgICAgIGlmKG9iai5oYXNDbGFzcyhcIm9wZW5cIikpICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZvcmNlID8gdGhpcy5zZWxlY3RfYnJhbmNoKG9iai5maW5kKFwibGk6ZXEoMClcIikpIDogdGhpcy5ob3Zlcl9icmFuY2gob2JqLmZpbmQoXCJsaTplcSgwKVwiKSk7XG4gICAgICAgICAgICAgICAgZWxzZSBpZihqUXVlcnkob2JqKS5uZXh0QWxsKFwibGlcIikuc2l6ZSgpID4gMCkgICAgcmV0dXJuIGZvcmNlID8gdGhpcy5zZWxlY3RfYnJhbmNoKG9iai5uZXh0QWxsKFwibGk6ZXEoMClcIikpIDogdGhpcy5ob3Zlcl9icmFuY2gob2JqLm5leHRBbGwoXCJsaTplcSgwKVwiKSk7XG4gICAgICAgICAgICAgICAgZWxzZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZvcmNlID8gdGhpcy5zZWxlY3RfYnJhbmNoKG9iai5wYXJlbnRzKFwibGlcIikubmV4dChcImxpXCIpLmVxKDApKSA6IHRoaXMuaG92ZXJfYnJhbmNoKG9iai5wYXJlbnRzKFwibGlcIikubmV4dChcImxpXCIpLmVxKDApKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgZ2V0X3ByZXYgOiBmdW5jdGlvbihmb3JjZSkge1xuICAgICAgICAgICAgdmFyIG9iaiA9IHRoaXMuaG92ZXJlZCB8fCB0aGlzLnNlbGVjdGVkO1xuICAgICAgICAgICAgaWYob2JqKSB7XG4gICAgICAgICAgICAgICAgaWYob2JqLnByZXYoXCJsaVwiKS5zaXplKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG9iaiA9IG9iai5wcmV2KFwibGlcIikuZXEoMCk7XG4gICAgICAgICAgICAgICAgICAgIHdoaWxlKG9iai5oYXNDbGFzcyhcIm9wZW5cIikpIG9iaiA9IG9iai5jaGlsZHJlbihcInVsOmVxKDApXCIpLmNoaWxkcmVuKFwibGk6bGFzdFwiKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZvcmNlID8gdGhpcy5zZWxlY3RfYnJhbmNoKG9iaikgOiB0aGlzLmhvdmVyX2JyYW5jaChvYmopO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHsgcmV0dXJuIGZvcmNlID8gdGhpcy5zZWxlY3RfYnJhbmNoKG9iai5wYXJlbnRzKFwibGk6ZXEoMClcIikpIDogdGhpcy5ob3Zlcl9icmFuY2gob2JqLnBhcmVudHMoXCJsaTplcSgwKVwiKSk7IH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgZ2V0X2xlZnQgOiBmdW5jdGlvbihmb3JjZSwgcnRsKSB7XG4gICAgICAgICAgICBpZih0aGlzLnNldHRpbmdzLnVpLnJ0bCAmJiAhcnRsKSByZXR1cm4gdGhpcy5nZXRfcmlnaHQoZm9yY2UsIHRydWUpO1xuICAgICAgICAgICAgdmFyIG9iaiA9IHRoaXMuaG92ZXJlZCB8fCB0aGlzLnNlbGVjdGVkO1xuICAgICAgICAgICAgaWYob2JqKSB7XG4gICAgICAgICAgICAgICAgaWYob2JqLmhhc0NsYXNzKFwib3BlblwiKSkgICAgdGhpcy5jbG9zZV9icmFuY2gob2JqKTtcbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZvcmNlID8gdGhpcy5zZWxlY3RfYnJhbmNoKG9iai5wYXJlbnRzKFwibGk6ZXEoMClcIikpIDogdGhpcy5ob3Zlcl9icmFuY2gob2JqLnBhcmVudHMoXCJsaTplcSgwKVwiKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBnZXRfcmlnaHQgOiBmdW5jdGlvbihmb3JjZSwgcnRsKSB7XG4gICAgICAgICAgICBpZih0aGlzLnNldHRpbmdzLnVpLnJ0bCAmJiAhcnRsKSByZXR1cm4gdGhpcy5nZXRfbGVmdChmb3JjZSwgdHJ1ZSk7XG4gICAgICAgICAgICB2YXIgb2JqID0gdGhpcy5ob3ZlcmVkIHx8IHRoaXMuc2VsZWN0ZWQ7XG4gICAgICAgICAgICBpZihvYmopIHtcbiAgICAgICAgICAgICAgICBpZihvYmouaGFzQ2xhc3MoXCJjbG9zZWRcIikpICAgIHRoaXMub3Blbl9icmFuY2gob2JqKTtcbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZvcmNlID8gdGhpcy5zZWxlY3RfYnJhbmNoKG9iai5maW5kKFwibGk6ZXEoMClcIikpIDogdGhpcy5ob3Zlcl9icmFuY2gob2JqLmZpbmQoXCJsaTplcSgwKVwiKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICB0b2dnbGVEb3RzIDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdGhpcy5jb250YWluZXIudG9nZ2xlQ2xhc3MoXCJub19kb3RzXCIpO1xuICAgICAgICB9LFxuICAgICAgICBzZXRfY29va2llIDogZnVuY3Rpb24gKHR5cGUpIHtcbiAgICAgICAgICAgIGlmKHRoaXMuc2V0dGluZ3MuY29va2llcyA9PT0gZmFsc2UpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIHN3aXRjaCh0eXBlKSB7XG4gICAgICAgICAgICAgICAgLypjYXNlIFwic2VsZWN0ZWRcIjpcbiAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5zZXR0aW5ncy5ydWxlcy5tdWx0aXBsZSAhPSBmYWxzZSAmJiB0aGlzLnNlbGVjdGVkX2Fyci5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsID0gQXJyYXkoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGpRdWVyeS5lYWNoKHRoaXMuc2VsZWN0ZWRfYXJyLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsLnB1c2godGhpcy5hdHRyKFwiaWRcIikpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSB2YWwuam9pbihcIixcIik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB2YXIgdmFsID0gdGhpcy5zZWxlY3RlZCA/IHRoaXMuc2VsZWN0ZWQuYXR0cihcImlkXCIpIDogZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGpRdWVyeS5jb29raWUodGhpcy5zZXR0aW5ncy5jb29raWVzLnByZWZpeCArICdfc2VsZWN0ZWQnLHZhbCx0aGlzLnNldHRpbmdzLmNvb2tpZXMub3B0cyk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrOyovXG4gICAgICAgICAgICAgICAgY2FzZSBcIm9wZW5cIjpcbiAgICAgICAgICAgICAgICAgICAgdmFyIHN0ciA9IFwiXCI7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmZpbmQoXCJsaS5vcGVuXCIpLmVhY2goZnVuY3Rpb24gKGkpIHsgc3RyICs9IHRoaXMuaWQgKyBcIixcIjsgfSk7XG4gICAgICAgICAgICAgICAgICAgIGpRdWVyeS5jb29raWUodGhpcy5zZXR0aW5ncy5jb29raWVzLnByZWZpeCArICdfb3Blbicsc3RyLnJlcGxhY2UoLywkL2lnLFwiXCIpLHRoaXMuc2V0dGluZ3MuY29va2llcy5vcHRzKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIG1vdmVkIDogZnVuY3Rpb24gKHdoYXQsIHdoZXJlLCBob3csIGlzX25ldywgaXNfY29weSkge1xuICAgICAgICAgICAgdmFyIHdoYXQgICAgPSBqUXVlcnkod2hhdCk7XG4gICAgICAgICAgICB2YXIgJHBhcmVudCAgICA9IGpRdWVyeSh3aGF0KS5wYXJlbnRzKFwidWw6ZXEoMClcIik7XG4gICAgICAgICAgICB2YXIgJHdoZXJlICAgID0galF1ZXJ5KHdoZXJlKTtcbiAgICAgICAgICAgIC8vIElGIE1VTFRJUExFXG4gICAgICAgICAgICBpZih3aGF0LnNpemUoKSA+IDEpIHtcbiAgICAgICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuICAgICAgICAgICAgICAgIHZhciB0bXAgPSB0aGlzLm1vdmVkKHdoYXQuZXEoMCksd2hlcmUsaG93LCBmYWxzZSwgaXNfY29weSk7XG4gICAgICAgICAgICAgICAgd2hhdC5lYWNoKGZ1bmN0aW9uIChpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmKGkgPT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB0bXAgPSBfdGhpcy5tb3ZlZCh0aGlzLCB0bXAuY2hpbGRyZW4oXCJhOmVxKDApXCIpLCBcImFmdGVyXCIsIGZhbHNlLCBpc19jb3B5KTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmKGlzX2NvcHkpIHtcbiAgICAgICAgICAgICAgICB3aGF0ID0gd2hhdC5jbG9uZSgpO1xuICAgICAgICAgICAgICAgIHdoYXQuZWFjaChmdW5jdGlvbiAoaSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmlkID0gdGhpcy5pZCArIFwiX2NvcHlcIjtcbiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5KHRoaXMpLmZpbmQoXCJsaVwiKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaWQgPSB0aGlzLmlkICsgXCJfY29weVwiO1xuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICBqUXVlcnkodGhpcykuZmluZChcImEuY2xpY2tlZFwiKS5yZW1vdmVDbGFzcyhcImNsaWNrZWRcIik7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZihpc19uZXcpIHtcbiAgICAgICAgICAgICAgICBpZighdGhpcy5zZXR0aW5ncy5jYWxsYmFjay5iZWZvcmVjcmVhdGUuY2FsbChudWxsLHRoaXMuZ2V0X25vZGUod2hhdCkuZ2V0KDApLCB0aGlzLmdldF9ub2RlKHdoZXJlKS5nZXQoMCksaG93LHRoaXMpKSByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZighdGhpcy5zZXR0aW5ncy5jYWxsYmFjay5iZWZvcmVtb3ZlLmNhbGwobnVsbCx0aGlzLmdldF9ub2RlKHdoYXQpLmdldCgwKSwgdGhpcy5nZXRfbm9kZSh3aGVyZSkuZ2V0KDApLGhvdyx0aGlzKSkgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZighaXNfbmV3KSB7XG4gICAgICAgICAgICAgICAgdmFyIHRtcCA9IGpRdWVyeSh3aGF0KS5wYXJlbnRzKFwiLnRyZWU6ZXEoMClcIik7XG4gICAgICAgICAgICAgICAgLy8gaWYgZGlmZmVyZW50IHRyZWVzXG4gICAgICAgICAgICAgICAgaWYodG1wLmdldCgwKSAhPSB0aGlzLmNvbnRhaW5lci5nZXQoMCkpIHtcbiAgICAgICAgICAgICAgICAgICAgdG1wID0gdHJlZV9jb21wb25lbnQuaW5zdFt0bXAuYXR0cihcImlkXCIpXTtcbiAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhlcmUgYXJlIGxhbmd1YWdlcyAtIG90aGVyd2lzZSAtIG5vIGNsZWFudXAgbmVlZGVkXG4gICAgICAgICAgICAgICAgICAgIGlmKHRtcC5zZXR0aW5ncy5sYW5ndWFnZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzID0gW107XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiBuZXcgdHJlZSBoYXMgbm8gbGFuZ3VhZ2VzIC0gdXNlIGN1cnJlbnQgdmlzaWJsZVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5zZXR0aW5ncy5sYW5ndWFnZXMubGVuZ3RoID09IDApIHJlcy5wdXNoKFwiLlwiICsgdG1wLmN1cnJlbnRfbGFuZyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IoaSBpbiB0aGlzLnNldHRpbmdzLmxhbmd1YWdlcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IoaiBpbiB0bXAuc2V0dGluZ3MubGFuZ3VhZ2VzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnNldHRpbmdzLmxhbmd1YWdlc1tpXSA9PSB0bXAuc2V0dGluZ3MubGFuZ3VhZ2VzW2pdKSByZXMucHVzaChcIi5cIiArIHRoaXMuc2V0dGluZ3MubGFuZ3VhZ2VzW2ldKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHJlcy5sZW5ndGggPT0gMCkgcmV0dXJuIHRoaXMuZXJyb3IoXCJNT1ZFOiBOTyBDT01NT04gTEFOR1VBR0VTXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgd2hhdC5maW5kKFwiYVwiKS5yZW1vdmVDbGFzcyhcImNsaWNrZWRcIikubm90KHJlcy5qb2luKFwiLFwiKSkucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIEFERCBOT0RFIFRPIE5FVyBQTEFDRVxuICAgICAgICAgICAgc3dpdGNoKGhvdykge1xuICAgICAgICAgICAgICAgIGNhc2UgXCJiZWZvcmVcIjpcbiAgICAgICAgICAgICAgICAgICAgJHdoZXJlLnBhcmVudHMoXCJ1bDplcSgwKVwiKS5jaGlsZHJlbihcImxpLmxhc3RcIikucmVtb3ZlQ2xhc3MoXCJsYXN0XCIpO1xuICAgICAgICAgICAgICAgICAgICAkd2hlcmUucGFyZW50cyhcImxpOmVxKDApXCIpLmJlZm9yZSh3aGF0LnJlbW92ZUNsYXNzKFwibGFzdFwiKSk7XG4gICAgICAgICAgICAgICAgICAgICR3aGVyZS5wYXJlbnRzKFwidWw6ZXEoMClcIikuY2hpbGRyZW4oXCJsaTpsYXN0XCIpLmFkZENsYXNzKFwibGFzdFwiKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSBcImFmdGVyXCI6XG4gICAgICAgICAgICAgICAgICAgICR3aGVyZS5wYXJlbnRzKFwidWw6ZXEoMClcIikuY2hpbGRyZW4oXCJsaS5sYXN0XCIpLnJlbW92ZUNsYXNzKFwibGFzdFwiKTtcbiAgICAgICAgICAgICAgICAgICAgJHdoZXJlLnBhcmVudHMoXCJsaTplcSgwKVwiKS5hZnRlcih3aGF0LnJlbW92ZUNsYXNzKFwibGFzdFwiKSk7XG4gICAgICAgICAgICAgICAgICAgICR3aGVyZS5wYXJlbnRzKFwidWw6ZXEoMClcIikuY2hpbGRyZW4oXCJsaTpsYXN0XCIpLmFkZENsYXNzKFwibGFzdFwiKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSBcImluc2lkZVwiOlxuICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnNldHRpbmdzLmRhdGEuYXN5bmMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvYmogPSB0aGlzLmdldF9ub2RlKCR3aGVyZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZihvYmouaGFzQ2xhc3MoXCJjbG9zZWRcIikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm9wZW5fYnJhbmNoKG9iaiwgdHJ1ZSwgZnVuY3Rpb24gKCkgeyBfdGhpcy5tb3ZlZC5hcHBseShfdGhpcywgW3doYXQsIHdoZXJlLCBob3csIGlzX25ldywgaXNfY29weV0pOyB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmKCR3aGVyZS5wYXJlbnRzKFwibGk6ZXEoMClcIikuY2hpbGRyZW4oXCJ1bDpmaXJzdFwiKS5zaXplKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuc2V0dGluZ3MucnVsZXMuY3JlYXRlYXQgPT0gXCJ0b3BcIikgICAgJHdoZXJlLnBhcmVudHMoXCJsaTplcSgwKVwiKS5jaGlsZHJlbihcInVsOmZpcnN0XCIpLnByZXBlbmQod2hhdC5yZW1vdmVDbGFzcyhcImxhc3RcIikpLmNoaWxkcmVuKFwibGk6bGFzdFwiKS5hZGRDbGFzcyhcImxhc3RcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR3aGVyZS5wYXJlbnRzKFwibGk6ZXEoMClcIikuY2hpbGRyZW4oXCJ1bDpmaXJzdFwiKS5jaGlsZHJlbihcIi5sYXN0XCIpLnJlbW92ZUNsYXNzKFwibGFzdFwiKS5lbmQoKS5hcHBlbmQod2hhdC5yZW1vdmVDbGFzcyhcImxhc3RcIikpLmNoaWxkcmVuKFwibGk6bGFzdFwiKS5hZGRDbGFzcyhcImxhc3RcIik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB3aGF0LmFkZENsYXNzKFwibGFzdFwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICR3aGVyZS5wYXJlbnRzKFwibGk6ZXEoMClcIikuYXBwZW5kKFwiPHVsLz5cIikucmVtb3ZlQ2xhc3MoXCJsZWFmXCIpLmFkZENsYXNzKFwiY2xvc2VkXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgJHdoZXJlLnBhcmVudHMoXCJsaTplcSgwKVwiKS5jaGlsZHJlbihcInVsOmZpcnN0XCIpLnByZXBlbmQod2hhdCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYoIXRoaXMuc2V0dGluZ3MuZGF0YS5hc3luYykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcGVuX2JyYW5jaCgkd2hlcmUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gQ0xFQU5VUCBPTEQgUEFSRU5UXG4gICAgICAgICAgICBpZigkcGFyZW50LmZpbmQoXCJsaVwiKS5zaXplKCkgPT0gMCkge1xuICAgICAgICAgICAgICAgIHZhciAkbGkgPSAkcGFyZW50LnBhcmVudCgpO1xuICAgICAgICAgICAgICAgICRsaS5yZW1vdmVDbGFzcyhcIm9wZW5cIikucmVtb3ZlQ2xhc3MoXCJjbG9zZWRcIikuYWRkQ2xhc3MoXCJsZWFmXCIpLmNoaWxkcmVuKFwidWxcIikucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgJGxpLnBhcmVudHMoXCJ1bDplcSgwKVwiKS5jaGlsZHJlbihcImxpLmxhc3RcIikucmVtb3ZlQ2xhc3MoXCJsYXN0XCIpLmVuZCgpLmNoaWxkcmVuKFwibGk6bGFzdFwiKS5hZGRDbGFzcyhcImxhc3RcIik7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRfY29va2llKFwib3BlblwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICRwYXJlbnQuY2hpbGRyZW4oXCJsaS5sYXN0XCIpLnJlbW92ZUNsYXNzKFwibGFzdFwiKTtcbiAgICAgICAgICAgICAgICAkcGFyZW50LmNoaWxkcmVuKFwibGk6bGFzdFwiKS5hZGRDbGFzcyhcImxhc3RcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZihpc19uZXcgJiYgaG93ICE9IFwiaW5zaWRlXCIpIHdoZXJlID0gdGhpcy5nZXRfbm9kZSh3aGVyZSkucGFyZW50cyhcImxpOmVxKDApXCIpO1xuICAgICAgICAgICAgaWYoaXNfY29weSkgICAgICAgIHRoaXMuc2V0dGluZ3MuY2FsbGJhY2sub25jb3B5LmNhbGwobnVsbCwgdGhpcy5nZXRfbm9kZSh3aGF0KS5nZXQoMCksIHRoaXMuZ2V0X25vZGUod2hlcmUpLmdldCgwKSwgaG93LCB0aGlzKVxuICAgICAgICAgICAgZWxzZSBpZihpc19uZXcpICAgIHRoaXMuc2V0dGluZ3MuY2FsbGJhY2sub25jcmVhdGUuY2FsbChudWxsLCB0aGlzLmdldF9ub2RlKHdoYXQpLmdldCgwKSwgdGhpcy5nZXRfbm9kZSh3aGVyZSkuZ2V0KDApLCB0aGlzLnNldHRpbmdzLmluc2VydEF0LCB0aGlzKTtcbiAgICAgICAgICAgIGVsc2UgICAgICAgICAgICB0aGlzLnNldHRpbmdzLmNhbGxiYWNrLm9ubW92ZS5jYWxsKG51bGwsIHRoaXMuZ2V0X25vZGUod2hhdCkuZ2V0KDApLCB0aGlzLmdldF9ub2RlKHdoZXJlKS5nZXQoMCksIGhvdywgdGhpcyk7XG4gICAgICAgICAgICByZXR1cm4gd2hhdDtcbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3IgOiBmdW5jdGlvbiAoY29kZSkge1xuICAgICAgICAgICAgdGhpcy5zZXR0aW5ncy5jYWxsYmFjay5lcnJvci5jYWxsKG51bGwsY29kZSx0aGlzKTtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSxcbiAgICAgICAgbG9jayA6IGZ1bmN0aW9uIChzdGF0ZSkge1xuICAgICAgICAgICAgdGhpcy5sb2NrZWQgPSBzdGF0ZTtcbiAgICAgICAgICAgIGlmKHRoaXMubG9ja2VkKSAgICB0aGlzLmNvbnRhaW5lci5hZGRDbGFzcyhcImxvY2tlZFwiKTtcbiAgICAgICAgICAgIGVsc2UgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5yZW1vdmVDbGFzcyhcImxvY2tlZFwiKTtcbiAgICAgICAgfSxcbiAgICAgICAgY3V0IDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYodGhpcy5sb2NrZWQpIHJldHVybiB0aGlzLmVycm9yKFwiTE9DS0VEXCIpO1xuICAgICAgICAgICAgaWYoIXRoaXMuc2VsZWN0ZWQpIHJldHVybiB0aGlzLmVycm9yKFwiQ1VUOiBOTyBOT0RFIFNFTEVDVEVEXCIpO1xuICAgICAgICAgICAgdGhpcy5jb3B5X25vZGVzID0gZmFsc2U7XG4gICAgICAgICAgICB0aGlzLmN1dF9ub2RlcyA9IHRoaXMuY29udGFpbmVyLmZpbmQoXCJhLmNsaWNrZWRcIikuZmlsdGVyKFwiOmZpcnN0LWNoaWxkXCIpLnBhcmVudCgpO1xuICAgICAgICB9LFxuICAgICAgICBjb3B5IDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYodGhpcy5sb2NrZWQpIHJldHVybiB0aGlzLmVycm9yKFwiTE9DS0VEXCIpO1xuICAgICAgICAgICAgaWYoIXRoaXMuc2VsZWN0ZWQpIHJldHVybiB0aGlzLmVycm9yKFwiQ09QWTogTk8gTk9ERSBTRUxFQ1RFRFwiKTtcbiAgICAgICAgICAgIHRoaXMuY29weV9ub2RlcyA9IHRoaXMuY29udGFpbmVyLmZpbmQoXCJhLmNsaWNrZWRcIikuZmlsdGVyKFwiOmZpcnN0LWNoaWxkXCIpLnBhcmVudCgpO1xuICAgICAgICAgICAgdGhpcy5jdXRfbm9kZXMgPSBmYWxzZTtcbiAgICAgICAgfSxcbiAgICAgICAgcGFzdGUgOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZih0aGlzLmxvY2tlZCkgcmV0dXJuIHRoaXMuZXJyb3IoXCJMT0NLRURcIik7XG4gICAgICAgICAgICBpZighdGhpcy5zZWxlY3RlZCkgcmV0dXJuIHRoaXMuZXJyb3IoXCJQQVNURTogTk8gTk9ERSBTRUxFQ1RFRFwiKTtcbiAgICAgICAgICAgIGlmKCF0aGlzLmNvcHlfbm9kZXMgJiYgIXRoaXMuY3V0X25vZGVzKSByZXR1cm4gdGhpcy5lcnJvcihcIlBBU1RFOiBOT1RISU5HIFRPIERPXCIpO1xuICAgICAgICAgICAgaWYodGhpcy5jb3B5X25vZGVzICYmIHRoaXMuY29weV9ub2Rlcy5zaXplKCkpIHtcbiAgICAgICAgICAgICAgICBpZighdGhpcy5jaGVja01vdmUodGhpcy5jb3B5X25vZGVzLCB0aGlzLnNlbGVjdGVkLmNoaWxkcmVuKFwiYTplcSgwKVwiKSwgXCJpbnNpZGVcIikpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB0aGlzLm1vdmVkKHRoaXMuY29weV9ub2RlcywgdGhpcy5zZWxlY3RlZC5jaGlsZHJlbihcImE6ZXEoMClcIiksIFwiaW5zaWRlXCIsIGZhbHNlLCB0cnVlKTtcbiAgICAgICAgICAgICAgICB0aGlzLmNvcHlfbm9kZXMgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmKHRoaXMuY3V0X25vZGVzICYmIHRoaXMuY3V0X25vZGVzLnNpemUoKSkge1xuICAgICAgICAgICAgICAgIGlmKCF0aGlzLmNoZWNrTW92ZSh0aGlzLmN1dF9ub2RlcywgdGhpcy5zZWxlY3RlZC5jaGlsZHJlbihcImE6ZXEoMClcIiksIFwiaW5zaWRlXCIpKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgdGhpcy5tb3ZlZCh0aGlzLmN1dF9ub2RlcywgdGhpcy5zZWxlY3RlZC5jaGlsZHJlbihcImE6ZXEoMClcIiksIFwiaW5zaWRlXCIpO1xuICAgICAgICAgICAgICAgIHRoaXMuY3V0X25vZGVzID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIHNlYXJjaCA6IGZ1bmN0aW9uKHN0cikge1xuICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpcztcbiAgICAgICAgICAgIGlmKCFzdHIgfHwgKHRoaXMuc3JjaCAmJiBzdHIgIT0gdGhpcy5zcmNoKSApIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNyY2ggPSBcIlwiO1xuICAgICAgICAgICAgICAgIHRoaXMuc3JjaF9vcG4gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5maW5kKFwiYS5zZWFyY2hcIikucmVtb3ZlQ2xhc3MoXCJzZWFyY2hcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnNyY2ggPSBzdHI7XG4gICAgICAgICAgICBpZighc3RyKSByZXR1cm47XG4gICAgICAgICAgICBpZih0aGlzLnNldHRpbmdzLmRhdGEuYXN5bmMpIHtcbiAgICAgICAgICAgICAgICBpZighdGhpcy5zcmNoX29wbikge1xuICAgICAgICAgICAgICAgICAgICB2YXIgZGQgPSBqUXVlcnkuZXh0ZW5kKCB7IFwic2VhcmNoXCIgOiBzdHIgfSAsIHRoaXMuc2V0dGluZ3MuZGF0YS5hc3luY19kYXRhKGZhbHNlKSApO1xuICAgICAgICAgICAgICAgICAgICBqUXVlcnkuYWpheCh7XG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlICAgICAgICA6IHRoaXMuc2V0dGluZ3MuZGF0YS5tZXRob2QsXG4gICAgICAgICAgICAgICAgICAgICAgICB1cmwgICAgICAgICAgICA6IHRoaXMuc2V0dGluZ3MuZGF0YS51cmwsXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhICAgICAgICA6IGRkLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVR5cGUgICAgOiBcInRleHRcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3MgICAgICAgIDogZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5zcmNoX29wbiA9IGpRdWVyeS51bmlxdWUoZGF0YS5zcGxpdChcIixcIikpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnNlYXJjaC5hcHBseShfdGhpcyxbc3RyXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIGlmKHRoaXMuc3JjaF9vcG4ubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuc3JjaF9vcG4gJiYgdGhpcy5zcmNoX29wbi5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvcG4gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaiA9IDA7IGogPCB0aGlzLnNyY2hfb3BuLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5nZXRfbm9kZShcIiNcIiArIHRoaXMuc3JjaF9vcG5bal0pLnNpemUoKSA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3BuID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRtcCA9IFwiI1wiICsgdGhpcy5zcmNoX29wbltqXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuc3JjaF9vcG5bal07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3Blbl9icmFuY2godG1wLCB0cnVlLCBmdW5jdGlvbiAoKSB7IF90aGlzLnNlYXJjaC5hcHBseShfdGhpcyxbc3RyXSk7IH0gKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZighb3BuKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zcmNoX29wbiA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5zZWFyY2guYXBwbHkoX3RoaXMsW3N0cl0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB2YXIgc2VsZWN0b3IgPSBcImFcIjtcbiAgICAgICAgICAgICAgICAgICAgLy8gSUYgTEFOR1VBR0UgVkVSU0lPTlNcbiAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5zZXR0aW5ncy5sYW5ndWFnZXMubGVuZ3RoKSBzZWxlY3RvciArPSBcIi5cIiArIHRoaXMuY3VycmVudF9sYW5nO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5maW5kKHNlbGVjdG9yICsgXCI6Y29udGFpbnMoJ1wiICsgc3RyICsgXCInKVwiKS5hZGRDbGFzcyhcInNlYXJjaFwiKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zcmNoX29wbiA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhciBzZWxlY3RvciA9IFwiYVwiO1xuICAgICAgICAgICAgICAgIC8vIElGIExBTkdVQUdFIFZFUlNJT05TXG4gICAgICAgICAgICAgICAgaWYodGhpcy5zZXR0aW5ncy5sYW5ndWFnZXMubGVuZ3RoKSBzZWxlY3RvciArPSBcIi5cIiArIHRoaXMuY3VycmVudF9sYW5nO1xuICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmZpbmQoc2VsZWN0b3IgKyBcIjpjb250YWlucygnXCIgKyBzdHIgKyBcIicpXCIpLmFkZENsYXNzKFwic2VhcmNoXCIpLnBhcmVudHMoXCJsaS5jbG9zZWRcIikuZWFjaCggZnVuY3Rpb24gKCkgeyBfdGhpcy5vcGVuX2JyYW5jaCh0aGlzLCB0cnVlKTsgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG5cbiAgICAgICAgZGVzdHJveSA6IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICB2YXIgZXZ0cyA9IFtcImNsaWNrXCIsXCJkYmxjbGlja1wiLFwiY29udGV4dG1lbnVcIixcInBvaW50ZXJvdmVyXCIsXCJwb2ludGVyZG93blwiXTtcbiAgICAgICAgICAgICAgICBmb3IoaSBpbiBldnRzKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBpZHhlciA9IHRoaXMuY29udGFpbmVyLmluZGV4ZXIoZXZ0c1tpXSk7XG4gICAgICAgICAgICAgICAgICAgIGlkeGVyLnN0b3AoKTtcbiAgICAgICAgICAgICAgICAgICAgalF1ZXJ5LnJlbW92ZURhdGEoIGlkeGVyLmxpc3RlbmVyLCBpZHhlci5ldmVudCArICcuaW5kZXhlcicgKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGNhdGNoKGVycikgeyB9XG4gICAgICAgICAgICB0aGlzLmNvbnRhaW5lci51bmJpbmQoKTtcblxuICAgICAgICAgICAgdGhpcy5jb250YWluZXIucmVtb3ZlQ2xhc3MoXCJ0cmVlXCIpLmNoaWxkcmVuKFwidWxcIikucmVtb3ZlQ2xhc3MoXCJ0cmVlLVwiICsgdGhpcy5zZXR0aW5ncy51aS50aGVtZV9uYW1lKS5maW5kKFwibGlcIikucmVtb3ZlQ2xhc3MoXCJsZWFmXCIpLnJlbW92ZUNsYXNzKFwib3BlblwiKS5yZW1vdmVDbGFzcyhcImNsb3NlZFwiKS5yZW1vdmVDbGFzcyhcImxhc3RcIikuY2hpbGRyZW4oXCJhXCIpLnJlbW92ZUNsYXNzKFwiY2xpY2tlZFwiKTtcblxuICAgICAgICAgICAgaWYodGhpcy5jbnRyID09IHRyZWVfY29tcG9uZW50LmZvY3VzZWQpIHtcbiAgICAgICAgICAgICAgICBmb3IoaSBpbiB0cmVlX2NvbXBvbmVudC5pbnN0KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmKGkgIT0gdGhpcy5jbnRyICYmIGkgIT0gdGhpcy5jb250YWluZXIuYXR0cihcImlkXCIpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0cmVlX2NvbXBvbmVudC5pbnN0W2ldLmZvY3VzKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGRlbGV0ZSB0cmVlX2NvbXBvbmVudC5pbnN0W3RoaXMuY250cl07XG4gICAgICAgICAgICBkZWxldGUgdHJlZV9jb21wb25lbnQuaW5zdFt0aGlzLmNvbnRhaW5lci5hdHRyKFwiaWRcIildO1xuICAgICAgICAgICAgdHJlZV9jb21wb25lbnQuY250ciAtLTtcbiAgICAgICAgfVxuICAgIH1cbn07XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=